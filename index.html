<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Lobby Setup</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #e8e8e8;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 600px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .hidden {
      display: none;
    }
    input {
      padding: 8px;
      font-size: 1em;
      margin-right: 10px;
    }
    button {
      margin: 5px;
      padding: 10px 20px;
      font-size: 1em;
    }
    pre {
      background: #f4f4f4;
      padding: 10px;
      border-radius: 5px;
      overflow-x: auto;
    }
  </style>
  <!-- Firebase App (the core Firebase SDK) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <!-- Firebase Realtime Database -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
  <div class="container">
    <!-- Set Name Section -->
    <div id="setNameDiv">
      <h2>Enter Your Name</h2>
      <input type="text" id="playerName" placeholder="Your name">
      <button id="setNameButton">Set Name</button>
    </div>

    <!-- Lobby Options: Create or Join -->
    <div id="lobbySelectDiv" class="hidden">
      <h2>Select an Option</h2>
      <button id="createButton">Create Lobby</button>
      <button id="joinButton">Join Lobby</button>
    </div>

    <!-- Join Lobby Input -->
    <div id="joinLobbyDiv" class="hidden">
      <h2>Enter Lobby ID</h2>
      <input type="text" id="lobbyIdInput" placeholder="Lobby ID">
      <button id="joinLobbySubmit">Join Lobby</button>
    </div>

    <!-- Lobby View -->
    <div id="lobbyDiv" class="hidden">
      <h2>Lobby</h2>
      <pre id="lobbyInfo"></pre>
      <!-- Only Host sees the Start Game button -->
      <div id="hostOptions" class="hidden">
        <button id="startGame">Start Game</button>
      </div>
    </div>
  </div>

  <script>
    // Firebase configuration (ensure these values match your Firebase project settings)
    const firebaseConfig = {
      apiKey: "AIzaSyCKy1KVoLdTH_nwpYVr8u_CT5e0hjBpFOc",
      authDomain: "truth-b65cd.firebaseapp.com",
      databaseURL: "https://truth-b65cd-default-rtdb.firebaseio.com",
      projectId: "truth-b65cd",
      storageBucket: "truth-b65cd.firebasestorage.app",
      messagingSenderId: "11180463959",
      appId: "1:11180463959:web:e860d37bdbf8e245e25012",
      measurementId: "G-HPYS4F4MYJ"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    let playerName = "";
    let role = "";
    let lobbyId = "";

    // When the player sets their name.
    document.getElementById("setNameButton").addEventListener("click", () => {
      const nameInput = document.getElementById("playerName").value.trim();
      if (nameInput === "") {
        alert("Please enter a valid name!");
        return;
      }
      playerName = nameInput;
      // Proceed to lobby options.
      document.getElementById("setNameDiv").classList.add("hidden");
      document.getElementById("lobbySelectDiv").classList.remove("hidden");
    });

    // Create Lobby – player becomes host.
    document.getElementById("createButton").addEventListener("click", () => {
      role = "host";
      // Create a new lobby in Firebase.
      let newLobbyRef = database.ref("lobbies").push();
      lobbyId = newLobbyRef.key;
      newLobbyRef.set({
        host: playerName,
        created: firebase.database.ServerValue.TIMESTAMP,
        players: { [playerName]: true }
      }, function(error) {
        if (error) {
          alert("Error creating lobby: " + error);
        } else {
          showLobby();
        }
      });
    });

    // Join Lobby – show input for Lobby ID.
    document.getElementById("joinButton").addEventListener("click", () => {
      role = "client";
      document.getElementById("lobbySelectDiv").classList.add("hidden");
      document.getElementById("joinLobbyDiv").classList.remove("hidden");
    });

    // Submit Lobby ID for joining.
    document.getElementById("joinLobbySubmit").addEventListener("click", () => {
      lobbyId = document.getElementById("lobbyIdInput").value.trim();
      if (lobbyId === "") {
        alert("Please enter a Lobby ID!");
        return;
      }
      // Verify that the lobby exists.
      database.ref("lobbies/" + lobbyId).once("value", function(snapshot) {
        if (snapshot.exists()) {
          // Add the player to the lobby in Firebase.
          database.ref("lobbies/" + lobbyId + "/players").update({
            [playerName]: true
          }, function(error) {
            if (error) {
              alert("Error joining lobby: " + error);
            } else {
              showLobby();
            }
          });
        } else {
          alert("Lobby ID not found. Please check and try again.");
        }
      });
    });

    function showLobby() {
      document.getElementById("lobbySelectDiv").classList.add("hidden");
      document.getElementById("joinLobbyDiv").classList.add("hidden");
      document.getElementById("lobbyDiv").classList.remove("hidden");
      // Display the lobby info.
      document.getElementById("lobbyInfo").innerText =
        "Lobby ID: " + lobbyId + "\nName: " + playerName + "\nRole: " + role;
      // Only Host should see the Start Game button.
      if (role === "host") {
        document.getElementById("hostOptions").classList.remove("hidden");
      }
    }

    // Start Game: Redirect both players to the game file.
    document.getElementById("startGame").addEventListener("click", () => {
      // Update the relative URL below so that it correctly points to your game page.
      window.location.href = "./game/game.html?lobbyId=" + lobbyId +
                             "&name=" + encodeURIComponent(playerName) +
                             "&role=" + role;
    });
  </script>
</body>
</html>
