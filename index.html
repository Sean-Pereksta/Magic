<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üê≠ Cat‚ÄôN Mice</title>
  <style>
    :root{
      --bg:#f7f8fb;
      --ink:#0f172a;
      --muted:#6b7280;
      --card:#ffffff;
      --br:#e5e7eb;
      --accent:#2563eb;
      --accent-2:#1d4ed8;
      --ring:#93c5fd;
      --good:#22c55e;
      --fab:#111827;
      --shadow: 0 10px 30px rgba(2,6,23,.08);
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      display:flex; flex-direction:column; min-height:100vh;
    }

    /* App bar */
    .appbar{
      position:sticky; top:0; z-index:1000;
      background:linear-gradient(90deg,#0b1220, #0f172a 55%, #0b1220);
      color:#fff; box-shadow: var(--shadow);
    }
    .appbar-inner{
      max-width:1200px; margin:auto; padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:10px; font-weight:700; letter-spacing:.3px;
    }
    .brand .logo{
      width:36px; height:36px; display:grid; place-items:center;
      background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12);
      border-radius:12px; font-size:20px;
    }

    /* Segmented tabs */
    .tabs{
      display:flex; gap:8px; background:rgba(255,255,255,.06);
      padding:6px; border-radius:999px; border:1px solid rgba(255,255,255,.12);
    }
    .tab-btn{
      appearance:none; border:none; cursor:pointer;
      padding:10px 16px; border-radius:999px; color:#dbeafe; background:transparent;
      font-weight:600; letter-spacing:.2px; transition:.2s ease;
    }
    .tab-btn:hover{ background:rgba(255,255,255,.08) }
    .tab-btn.active{
      color:#0b1220; background:#ffffff; box-shadow:0 2px 12px rgba(15,23,42,.25);
    }

    /* Viewport / iframe */
    .viewport{ flex:1; display:flex; }
    .frame-wrap{
      position:relative; flex:1; max-width:1200px; margin:18px auto;
      background:var(--card); border:1px solid var(--br); border-radius:var(--radius);
      overflow:hidden; box-shadow: var(--shadow);
    }
    iframe{
      width:100%; height:100%; min-height:60vh; border:none; display:block;
    }
    .loader{
      position:absolute; inset:0; display:grid; place-items:center;
      background:linear-gradient(180deg, rgba(247,248,251,.9), rgba(247,248,251,.96));
      transition:opacity .2s ease; pointer-events:none;
    }
    .loader.hide{ opacity:0; visibility:hidden }
    .spinner{
      width:36px; height:36px; border-radius:50%;
      border:3px solid #dbeafe; border-top-color:var(--accent);
      animation:spin 1s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Chat FAB */
    .fab{
      position:fixed; right:20px; bottom:20px; z-index:1100;
      width:56px; height:56px; border-radius:50%; border:none; cursor:pointer;
      background:var(--fab); color:#fff; font-size:22px;
      box-shadow:0 12px 30px rgba(2,6,23,.25);
      display:grid; place-items:center;
      transition:transform .12s ease, background .2s ease;
    }
    .fab:hover{ transform:translateY(-2px); background:#000 }

    /* Chat bottom sheet */
    .chat-sheet{
      position:fixed; left:50%; transform:translateX(-50%) translateY(100%);
      bottom:0; width:min(920px, 96vw); z-index:1200;
      background:var(--card); border:1px solid var(--br);
      border-bottom:none; border-top-left-radius:16px; border-top-right-radius:16px;
      box-shadow:0 -18px 40px rgba(2,6,23,.15);
      transition:transform .25s ease;
      display:flex; flex-direction:column; max-height:70vh;
    }
    .chat-sheet.open{ transform:translateX(-50%) translateY(0) }
    .chat-head{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 14px; border-bottom:1px solid var(--br);
      background:linear-gradient(180deg,#f8fafc,#fff);
    }
    .chat-head strong{ font-size:14px; letter-spacing:.3px }
    .close-chat{
      border:none; background:transparent; font-size:18px; cursor:pointer; color:var(--muted);
    }

    .chat-messages{
      padding:12px; overflow-y:auto; flex:1;
      scrollbar-width:thin; scrollbar-color:#cbd5e1 transparent;
    }
    .chat-messages::-webkit-scrollbar{ height:8px; width:8px }
    .chat-messages::-webkit-scrollbar-thumb{ background:#cbd5e1; border-radius:8px }

    .msg{
      display:grid; gap:4px; padding:8px 10px; border:1px solid var(--br);
      border-radius:10px; background:#fafafa; margin-bottom:10px;
    }
    .meta{ font-size:12px; color:var(--muted) }
    .text{ line-height:1.35 }

    .chat-input{
      display:flex; gap:8px; padding:12px; border-top:1px solid var(--br); background:#fff;
    }
    .chat-input input{
      border:1px solid var(--br); border-radius:10px; padding:10px 12px; outline:none;
      flex:1; font-size:14px; transition:box-shadow .15s ease, border-color .15s ease;
    }
    #chatName{ flex:0 0 160px }
    .chat-input input:focus{ border-color:var(--ring); box-shadow:0 0 0 4px rgba(147,197,253,.35) }
    .send{
      border:none; background:var(--accent); color:#fff; padding:10px 16px; border-radius:10px;
      font-weight:600; cursor:pointer; transition:background .15s ease, transform .1s ease;
    }
    .send:hover{ background:var(--accent-2) }
    .send:active{ transform:translateY(1px) }

    @media (max-width:640px){
      .appbar-inner{ flex-wrap:wrap; gap:10px }
      .tabs{ width:100%; justify-content:center }
      #chatName{ flex:0 0 110px }
    }
  </style>
</head>
<body>
  <!-- App Bar -->
  <header class="appbar">
    <div class="appbar-inner">
      <div class="brand">
        <div class="logo">üê≠</div>
        <div>Cat‚ÄôN Mice</div>
      </div>
      <div class="tabs" role="tablist" aria-label="Primary">
        <button class="tab-btn active" id="lobbyTab" role="tab" aria-selected="true" data-path="lobby/lobby">üéÆ Lobby</button>
        <button class="tab-btn" id="createUserTab" role="tab" aria-selected="false" data-path="username/username">‚ûï Create User</button>
      </div>
    </div>
  </header>

  <!-- Main content -->
  <main class="viewport">
    <div class="frame-wrap">
      <iframe id="contentFrame" src="https://catnmice.com/lobby/lobby.html" title="Cat‚ÄôN Mice"></iframe>
      <div class="loader" id="frameLoader" aria-hidden="false">
        <div class="spinner" aria-label="Loading"></div>
      </div>
    </div>
  </main>

  <!-- Chat Bottom Sheet -->
  <div id="chatContainer" class="chat-sheet" aria-hidden="true">
    <div class="chat-head">
      <strong>Lobby Chat</strong>
      <button class="close-chat" id="closeChat" aria-label="Close chat">‚úï</button>
    </div>
    <div id="chatMessages" class="chat-messages"></div>
    <div id="chatInput" class="chat-input">
      <input type="text" id="chatName" placeholder="Name" autocomplete="off" />
      <input type="text" id="chatMessage" placeholder="Type a message‚Ä¶ (Enter to send)" autocomplete="off" />
      <button id="sendBtn" class="send">Send</button>
    </div>
  </div>

  <!-- Floating Chat Button -->
  <button id="toggleChat" class="fab" aria-label="Toggle chat" aria-pressed="false">üí¨</button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyB7twY7z31ucB6pGA8JC_HrVMZhA8lNaJA",
      authDomain: "bible-game-246c0.firebaseapp.com",
      projectId: "bible-game-246c0",
      storageBucket: "bible-game-246c0.appspot.com",
      messagingSenderId: "959619818996",
      appId: "1:959619818996:web:5a9fbf492e23c765e445a1"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- UI Helpers ---
    const frame = document.getElementById("contentFrame");
    const loader = document.getElementById("frameLoader");
    frame.addEventListener("load", () => loader.classList.add("hide"));

    function setActiveTab(btn){
      document.querySelectorAll(".tab-btn").forEach(b=>{
        b.classList.toggle("active", b===btn);
        b.setAttribute("aria-selected", b===btn ? "true" : "false");
      });
    }

    function loadTab(path, btn){
      loader.classList.remove("hide");
      frame.src = `https://catnmice.com/${path}.html`;
      if(btn) setActiveTab(btn);
    }

    // --- Chat ---
    const chatContainer = document.getElementById("chatContainer");
    const toggleChat = document.getElementById("toggleChat");
    const closeChat = document.getElementById("closeChat");
    const chatMessages = document.getElementById("chatMessages");
    const nameInput = document.getElementById("chatName");
    const msgInput = document.getElementById("chatMessage");
    const sendBtn = document.getElementById("sendBtn");

    // Persist name
    nameInput.value = localStorage.getItem("catnmice_chat_name") || "";

    function hashColor(str){
      let h=0; for(let i=0;i<str.length;i++){ h = (h<<5)-h + str.charCodeAt(i); h|=0; }
      const hue = Math.abs(h)%360;
      return `hsl(${hue}deg 70% 35%)`;
    }

    function fmtTime(ts){
      try{
        const d = ts?.toDate ? ts.toDate() : (ts ? new Date(ts) : new Date());
        return d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
      }catch{ return "" }
    }

    async function sendMessage(){
      const name = nameInput.value.trim();
      const text = msgInput.value.trim();
      if(!name || !text) return;
      localStorage.setItem("catnmice_chat_name", name);
      try{
        await addDoc(collection(db, "chat"), {
          username: name,
          text,
          timestamp: serverTimestamp()
        });
        msgInput.value = "";
      }catch(e){
        console.warn("Chat send failed", e);
      }
    }

    function renderMessage({username="", text="", timestamp}){
      const wrap = document.createElement("div"); wrap.className = "msg";
      const meta = document.createElement("div"); meta.className = "meta";
      const who = document.createElement("span");
      who.textContent = username || "Someone";
      who.style.color = hashColor(username || "Someone");
      const dot = document.createElement("span"); dot.textContent = " ¬∑ ";
      dot.style.opacity = .6;
      const when = document.createElement("span"); when.textContent = fmtTime(timestamp);
      meta.appendChild(who); meta.appendChild(dot); meta.appendChild(when);

      const body = document.createElement("div"); body.className = "text";
      body.textContent = text; // safe textContent

      wrap.appendChild(meta);
      wrap.appendChild(body);
      return wrap;
    }

    function loadMessages(){
      const q = query(collection(db, "chat"), orderBy("timestamp","desc"), limit(50));
      onSnapshot(q, (snap)=>{
        const nearBottom = (chatMessages.scrollTop + chatMessages.clientHeight) > (chatMessages.scrollHeight - 60);
        chatMessages.innerHTML = "";
        // reverse to chronological
        [...snap.docs].reverse().forEach(d=>{
          const m = d.data();
          chatMessages.appendChild(renderMessage(m));
        });
        if(nearBottom) chatMessages.scrollTop = chatMessages.scrollHeight;
      });
    }

    // --- Events ---
    document.getElementById("lobbyTab").addEventListener("click", (e)=> loadTab("lobby/lobby", e.currentTarget));
    document.getElementById("createUserTab").addEventListener("click", (e)=> loadTab("username/username", e.currentTarget));

    toggleChat.addEventListener("click", ()=>{
      const open = chatContainer.classList.toggle("open");
      chatContainer.setAttribute("aria-hidden", open ? "false" : "true");
      toggleChat.setAttribute("aria-pressed", open ? "true" : "false");
      if(open) setTimeout(()=> msgInput.focus(), 120);
    });
    closeChat.addEventListener("click", ()=> toggleChat.click());

    sendBtn.addEventListener("click", sendMessage);
    msgInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter") sendMessage(); });

    // Init
    loadMessages();
  </script>
</body>
</html>

