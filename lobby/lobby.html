<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üïπÔ∏è Game Hub & Multiplayer Lobby</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <style>
    :root{
      --bg:#fef2f2; --ink:#111827; --muted:#6b7280; --card:#fff; --br:#f3e2e2;
      --accent:#b91c1c; --accent-2:#991b1b; --accent-soft:#fee2e2; --good:#16a34a; --bad:#ef4444;
      --shadow:0 10px 30px rgba(15,23,42,.08); --radius:16px; --radius-sm:12px;
      --tap:56px;
    }
    *{box-sizing:border-box}
    body{ margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial; color:var(--ink); background:var(--bg) }

    /* Logout (fixed, top-left) */
    .logout{
      position:fixed;
      top: calc(8px + env(safe-area-inset-top));
      left: calc(8px + env(safe-area-inset-left));
      z-index: 1000;
      padding:10px 14px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,.08);
      background:#fff;
      box-shadow: var(--shadow);
      font-weight:800;
      cursor:pointer;
      display:none; /* shown after login */
    }
    .logout:hover{ background:#fff5f5 }

    /* Header */
    .hero{
      background: radial-gradient(1200px 600px at 50% -200px, #ef4444 0%, #b91c1c 55%, #7f1d1d 100%);
      color:#fff; padding:28px 16px 18px; position:relative; overflow:hidden;
      box-shadow:var(--shadow);
      padding-top: calc(28px + env(safe-area-inset-top));
    }
    .hero-inner{ max-width:1200px; margin:0 auto; display:flex; align-items:center; justify-content:space-between; gap:16px; flex-wrap:wrap }
    .brand{ display:flex; align-items:center; gap:12px; }
    .logo{ width:44px; height:44px; display:grid; place-items:center; background:rgba(255,255,255,.1); border:1px solid rgba(255,255,255,.18); border-radius:14px; font-size:22px }
    .title{ font-weight:800; letter-spacing:.3px; font-size:1.35rem }
    .subtitle{ color:#ffe2e2; font-size:.95rem }

    /* Tabs */
    .tabs{ display:flex; gap:10px; background:rgba(255,255,255,.12); padding:6px; border-radius:999px; border:1px solid rgba(255,255,255,.22); overflow:auto; -webkit-overflow-scrolling:touch }
    .tab-btn{
      appearance:none; border:none; cursor:pointer; padding:10px 16px; border-radius:999px; color:#fff5f5; background:transparent;
      font-weight:700; letter-spacing:.2px; transition:.2s ease; white-space:nowrap
    }
    .tab-btn:hover{ background:rgba(255,255,255,.16) }
    .tab-btn[aria-selected="true"]{ background:#fff; color:#111827; box-shadow:0 2px 14px rgba(15,23,42,.25) }

    /* Daily Users pill (top-right) */
    .hud{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      background:#fff; color:#111827; border:1px solid rgba(255,255,255,.4);
      border-radius:999px; padding:8px 12px; font-weight:800; box-shadow:0 2px 10px rgba(0,0,0,.12);
    }
    .pill i{ font-style:normal; font-weight:900; }

    /* Layout */
    .shell{ max-width:1200px; margin:18px auto; padding:0 12px 28px }
    .grid{ display:grid; grid-template-columns:2fr 1fr; gap:18px }
    @media (max-width:980px){ .grid{ grid-template-columns:1fr } }

    /* Cards */
    .card{ background:var(--card); border:1px solid var(--br); border-radius:var(--radius); box-shadow:var(--shadow) }
    .card-head{ padding:14px 16px; border-bottom:1px solid var(--br); display:flex; align-items:center; justify-content:space-between; gap:12px }
    .card-title{ font-weight:800 }
    .card-body{ padding:14px 16px }

    /* Forms */
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center }
    .input, .select, .btn{
      padding:14px 12px; border:1px solid var(--br); border-radius:12px; background:#fff; font-size:16px; outline:none; min-height:44px;
    }
    .input:focus, .select:focus{ border-color:#fecaca; box-shadow:0 0 0 4px rgba(239,68,68,.25) }
    .btn{ cursor:pointer; font-weight:800; border-color:var(--accent); background:var(--accent); color:#fff; transition:background .2s }
    .btn:hover{ background:var(--accent-2) }
    .btn-ghost{ border-color:var(--br); background:#fff; color:#111827; font-weight:700 }
    .btn-ghost:hover{ background:#fff5f5 }
    .btn-lg{ min-height:var(--tap); font-size:17px }
    .btn-block{ width:100% }

    /* Resume banner */
    .resume{
      display:none; margin:12px 0 0; padding:12px; border:1px solid #fecaca; background:#fff1f2; color:#7f1d1d; border-radius:12px;
      display:flex; align-items:center; gap:10px; justify-content:space-between;
    }
    .resume .info{ font-weight:700 }
    .resume .actions{ display:flex; gap:8px; flex-wrap:wrap }

    /* Lobby list as cards */
    .lobbies{ display:grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap:14px }
    .lobby-card{ border:1px solid var(--br); border-radius:14px; padding:14px; background:#fff; display:flex; flex-direction:column; gap:10px }
    .badge{ display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; font-size:12px; background:var(--accent-soft); color:var(--accent); border:1px solid #fecaca; font-weight:700 }
    .subtle{ color:#6b7280; font-size:.96rem }
    .cap{ height:8px; background:#fff1f2; border:1px solid var(--br); border-radius:999px; overflow:hidden }
    .cap > i{ display:block; height:100%; width:0%; background:linear-gradient(90deg,#f59e0b,#ef4444,#b91c1c) }

    /* Players box */
    .players{ display:flex; flex-wrap:wrap; gap:8px }
    .chip{
      display:inline-flex; align-items:center; gap:6px; padding:8px 12px; border:1px solid var(--br); border-radius:999px; background:#fff7f7; font-size:14px
    }
    .dot{ width:10px; height:10px; border-radius:50% }

    /* Leaderboard */
    .ladder{ display:grid; gap:10px }
    .lb-row{ display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border:1px solid var(--br); border-radius:12px; background:#fff }
    .rank{ font-weight:900; width:28px; height:28px; border-radius:8px; display:grid; place-items:center; background:#fee2e2; color:#7f1d1d }

    /* Singleplayer catalog */
    .catalog{ display:grid; grid-template-columns: repeat(auto-fit, minmax(260px,1fr)); gap:14px }
    .game-card{ border:1px solid var(--br); border-radius:14px; padding:14px; background:#fff; display:flex; flex-direction:column; gap:10px }
    .game-title{ font-weight:800; display:flex; align-items:center; gap:8px }
    .game-desc{ color:var(--muted); line-height:1.45 }
    .play-row{ display:flex; justify-content:flex-end }

    /* Start/Leave buttons row */
    .controls{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px }
    #startBtn{ display:none }
    #error{ margin-top:6px; color:var(--bad); font-weight:700 }

    /* Mobile polish */
    @media (max-width:720px){
      .row{ flex-direction:column; align-items:stretch }
      .input, .select, .btn{ width:100% }
      .btn{ min-height:var(--tap) }
      .tab-btn{ padding:12px 16px }
      .hero-inner{ gap:12px }
      .lobby-card .btn{ width:100% }
      .subtitle{ font-size:.9rem }
      .card{ border-radius:20px }
      body{ padding-bottom: calc(env(safe-area-inset-bottom) + 8px) }
    }
  </style>
</head>
<body>
  <!-- Fixed Logout -->
  <button id="logoutBtn" class="logout" onclick="logout()">üö™ Logout</button>

  <!-- HERO -->
  <header class="hero">
    <div class="hero-inner">
      <div class="brand">
        <div class="logo" aria-hidden="true">üéÆ</div>
        <div>
          <div class="title">Game Hub</div>
          <div class="subtitle">Create a lobby, invite friends, or jump into solo play.</div>
        </div>
      </div>

      <!-- RIGHT HUD: tabs + Daily Users pill -->
      <div class="hud">
        <div id="dailyUsersPill" class="pill" title="Unique logins today (America/New_York)">
          üë§ Today: <i id="dailyUsersCount">0</i>
        </div>
        <div class="tabs" role="tablist" aria-label="Game Modes">
          <button id="tabbtn-multi" class="tab-btn" role="tab" aria-controls="panel-multi" aria-selected="true" onclick="showTab('multi')">üë• Multiplayer</button>
          <button id="tabbtn-single" class="tab-btn" role="tab" aria-controls="panel-single" aria-selected="false" onclick="showTab('single')">üéÆ Singleplayer</button>
        </div>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <div class="shell">
    <!-- MULTIPLAYER -->
    <section id="panel-multi" class="grid" role="tabpanel" aria-labelledby="tabbtn-multi">
      <div class="left">
        <div id="loginForm" class="card">
          <div class="card-head"><div class="card-title">Welcome</div></div>
          <div class="card-body">
            <div class="row" style="margin-bottom:8px">
              <input autocomplete="username" inputmode="text" type="text" id="username" class="input" placeholder="Username" />
              <input autocomplete="current-password" type="password" id="password" class="input" placeholder="Password" />
              <button class="btn btn-lg" onclick="login()">Login</button>
            </div>
            <div class="resume" id="resumeBanner" aria-live="polite" role="region">
              <div class="info">You have an unfinished session.</div>
              <div class="actions">
                <button class="btn-ghost btn-lg" id="resumeLobbyBtn">Rejoin Lobby</button>
                <button class="btn-ghost btn-lg" id="resumeGameBtn">Reopen Game</button>
                <button class="btn-ghost btn-lg" id="clearSessionBtn">Clear</button>
              </div>
            </div>
            <div id="error"></div>
          </div>
        </div>

        <div id="lobbyInterface" class="card" style="display:none">
          <div class="card-head">
            <div id="lobbyHeaderTitle" class="card-title">Start a Lobby</div>
          </div>
          <div class="card-body">
            <div class="row" style="align-items:flex-end">
              <div id="lobbyNameWrap" style="flex:1 1 220px">
                <label class="subtle">Lobby Name</label>
                <input type="text" id="lobbyName" class="input" placeholder="e.g., Friday Night Squad" />
              </div>
              <div style="flex:1 1 220px">
                <label class="subtle">Game</label>
                <select id="gameType" class="select">
                  <option value="cat">üê≠ Cat & Mouse</option>
                  <option value="grass">üåø Grass Realms</option>
                  <option value="estate">üè° Estate Defense</option>
                  <option value="mountain">üóª Mountain Blade Skirmish (4P)</option>
                  <option value="mountonline">üóªüåê Mountain Blade Online</option>
                  <option value="rock">‚úäüìÑ‚úÇÔ∏è Rock Paper Scissors MMO</option>
                  <option value="stockkings">üìà Stock Kings</option>
                  <option value="dutchblitz">üÉè Dutch Blitz Arena (4P)</option>
                  <option value="splinters">ü™Ñ Splinters (4P)</option>
                  <option value="spelltower">üóº Spell Tower (8P)</option>
                  <option value="zombiezone">üßü‚Äç‚ôÇÔ∏è Zombie Zone (4P)</option>
                  <option value="biblegame">üìñ Bible Game (12P)</option>
                  <option value="historyrush">üèõÔ∏è History Rush (4P)</option>
                  <option value="crowncouncil">üëë Crown & Council (4P)</option>
                  <option value="thegame">üÉè The Game (5P)</option>
                </select>
              </div>
              <button id="createBtn" class="btn btn-lg" onclick="startLobby()">Start Lobby</button>
            </div>

            <div id="availLobbiesCard" class="card" style="margin-top:14px">
              <div class="card-head"><div class="card-title">Available Lobbies</div></div>
              <div class="card-body">
                <div id="lobbyList" class="lobbies"><!-- Lobby cards injected here --></div>
              </div>
            </div>

            <div id="playersCard" class="card" style="margin-top:14px">
              <div class="card-head"><div class="card-title">Lobby Players</div></div>
              <div class="card-body">
                <div id="lobbyPlayers" class="players"><!-- chips injected --></div>
                <div class="controls">
                  <button id="startBtn" class="btn btn-lg">üöÄ Start Game</button>
                  <button class="btn-ghost btn-lg" onclick="leaveLobby()">‚ùå Leave Lobby</button>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>

      <!-- RIGHT SIDEBAR -->
      <aside class="right">
        <div id="winsLeaderboard" class="card">
          <div class="card-head"><div class="card-title">üèÜ Top Players</div></div>
          <div class="card-body">
            <div id="leaderboardEntries" class="ladder"><!-- rows --></div>
          </div>
        </div>
      </aside>
    </section>

    <!-- SINGLEPLAYER -->
    <section id="panel-single" class="card" role="tabpanel" aria-labelledby="tabbtn-single" style="display:none">
      <div class="card-head">
        <div class="card-title">Singleplayer</div>
      </div>
      <div class="card-body">
        <p class="subtle" style="margin-top:0">Pick a game to play solo.</p>
        <div id="catalog" class="catalog"><!-- game cards --></div>
      </div>
    </section>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore, collection, addDoc, doc, setDoc, updateDoc, onSnapshot,
      query, where, getDoc, getDocs, deleteDoc, limit, runTransaction
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ---------- ROUTES ----------
    const ROUTES = {
      cat:        "/game/catandmouse.html",
      grass:      "/game/grassrealms.html",
      estate:     "/game/estatedefense.html",
      mountain:   "/game/mountainblade.html",
      mountonline:"/game/mountonline.html",
      rock:       "/game/rock.html",
      stockkings: "/game/stockkings.html",
      dutchblitz: "/game/dutchblitz.html",
      splinters:  "/game/Splinters.html",
      spelltower: "/game/spelltower.html",
      zombiezone: "/game/zombiezone.html",
      biblegame:  "/game/biblegame.html",
      historyrush:"/game/historyrush.html",
      crowncouncil:"/game/crowncouncil.html",
      thegame:"/game/thegame.html",
      matchwars:  "/game/matchwars.html",
      flag:       "/game/Flag.html",
      microwars:  "/game/microwars.html",
      microwars2: "/game/microwaves2.html",
      microwars4: "/game/microwaves4.html",
      border:     "/game/border.html",
      mobamania:  "/game/CatLanes.html",
      versemem:   "/game/verse-memorizer.html"
    };

    const AUTO_REDIRECT_GAMES = new Set([
      "cat","grass","mountain","stockkings","dutchblitz","splinters","spelltower","thegame","zombiezone","biblegame",
      "historyrush","crowncouncil"
    ]);

    const MAX_PLAYERS = {
      mountain: 4,
      dutchblitz: 4,
      splinters: 4,
      spelltower: 8,
      zombiezone: 4,
      stockkings: 8,
      biblegame: 20,
      historyrush: 4,
      thegame: 5,
      crowncouncil: 4
    };
    const getMaxPlayers = (gameType, fallback = Infinity) =>
      typeof MAX_PLAYERS[gameType] === "number" ? MAX_PLAYERS[gameType] : fallback;

    const SINGLEPLAYER_GAMES = [
      { key: "versemem", title: "Verse Memorizer", emoji: "üìñüß†", desc: "Drill scripture, track streaks, and race the clock. Launches with your username.", route: ROUTES.versemem, requiresUser:true, autoUsername:true },
      { key: "microwars",  title: "Micro Wars",        emoji: "üî¨‚öîÔ∏è",    desc: "Blinkers & Soldiers RTS skirmishes.", route: ROUTES.microwars },
      { key: "microwars2", title: "Micro Wars Terran", emoji: "üõ∞Ô∏èü™ñ",    desc: "Terran-flavored variant.", route: ROUTES.microwars2 },
      { key: "microwars4", title: "Micro Wars Nexus",  emoji: "üí†‚ú®",    desc: "Altered tech flow.", route: ROUTES.microwars4 },
      { key: "mobamania",  title: "MOBA Mania",        emoji: "üßô‚Äç‚ôÇÔ∏èüõ°Ô∏èüí†", desc: "Single-lane hero brawler.", route: ROUTES.mobamania },
      { key: "matchwars",  title: "MatchWars",         emoji: "üß©‚öîÔ∏è",    desc: "Match to recruit & steamroll.", route: ROUTES.matchwars },
      { key: "trials",     title: "Trials",            emoji: "‚öîÔ∏è",      desc: "Survive", route: ROUTES.border },
      { key: "flag",       title: "Flag Fight",        emoji: "üèÅ‚öîÔ∏è",    desc: "Capture flags and crush the core.", route: ROUTES.flag }
    ];

    // ---------- FIREBASE ----------
    const firebaseConfig = {
      apiKey: "AIzaSyB7twY7z31ucB6pGA8JC_HrVMZhA8lNaJA",
      authDomain: "bible-game-246c0.firebaseapp.com",
      projectId: "bible-game-246c0",
      storageBucket: "bible-game-246c0.appspot.com",
      messagingSenderId: "959619818996",
      appId: "1:959619818996:web:5a9fbf492e23c765e445a1"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ---------- DAILY USERS (NY time) ----------
    const TZ = "America/New_York";
    const fmtYMD = new Intl.DateTimeFormat("en-CA",{ timeZone:TZ, year:"numeric", month:"2-digit", day:"2-digit" });
    const todayNY = () => fmtYMD.format(new Date()); // "YYYY-MM-DD"

    async function bumpDailyUsers(uniqueUser){
      const metricsRef = doc(db, "metrics", "dailyUsers");
      const now = Date.now();
      const today = todayNY();

      await runTransaction(db, async (tx)=>{
        const snap = await tx.get(metricsRef);
        if (!snap.exists()){
          // First ever record
          tx.set(metricsRef, {
            date: today,
            users: { [uniqueUser]: true },
            count: 1,
            updatedAt: now
          });
          return;
        }
        const data = snap.data() || {};
        const curDate = data.date;
        const curUsers = data.users || {};
        const curCount = typeof data.count === "number" ? data.count : Object.keys(curUsers).length;

        if (curDate !== today){
          // Archive previous day into dailyUsersLog/{curDate}
          const logRef = doc(db, "dailyUsersLog", String(curDate));
          tx.set(logRef, {
            date: curDate,
            count: curCount,
            users: Object.keys(curUsers),
            archivedAt: now
          }, { merge:true });

          // Reset to today with this user as #1
          tx.set(metricsRef, {
            date: today,
            users: { [uniqueUser]: true },
            count: 1,
            updatedAt: now
          });
          return;
        }

        // Same day ‚Äî only add if new unique user
        if (!curUsers[uniqueUser]){
          const nextUsers = { ...curUsers, [uniqueUser]: true };
          tx.update(metricsRef, {
            users: nextUsers,
            count: Object.keys(nextUsers).length,
            updatedAt: now
          });
        }else{
          // Touch updatedAt to reflect activity (optional)
          tx.update(metricsRef, { updatedAt: now });
        }
      });
    }

    // Live HUD listener
    (function listenDailyUsers(){
      const countEl = document.getElementById("dailyUsersCount");
      const pill = document.getElementById("dailyUsersPill");
      onSnapshot(doc(db,"metrics","dailyUsers"), (snap)=>{
        if (!snap.exists()){ countEl.textContent = "0"; return; }
        const d = snap.data();
        // If Firestore doc somehow has stale date, still show its count; bumpDailyUsers will roll on next login.
        const c = typeof d.count === "number" ? d.count : Object.keys(d.users||{}).length;
        countEl.textContent = String(c);
        pill.title = `Unique logins on ${d.date} (${TZ})`;
      });
    })();

    // ---------- STORAGE KEYS & SESSION HELPERS ----------
    const SK = {
      user: "gh.username",
      lastLobby: "gh.lastLobbyId",
      lastGame: "gh.lastGameType",
      lastTab: "gh.lastTab",
      nextRoute: "gh.nextRoute"
    };
    const save = (k,v)=> localStorage.setItem(k, v);
    const read = (k)=> localStorage.getItem(k);
    const del  = (k)=> localStorage.removeItem(k);

    function persistSession() {
      if (username) save(SK.user, username);
      const activeTab = isMultiVisible() ? "multi" : "single";
      save(SK.lastTab, activeTab);
    }
    function clearSession() {
      del(SK.user); del(SK.lastLobby); del(SK.lastGame); del(SK.lastTab); del(SK.nextRoute);
    }

    // ---------- TABS ----------
    function isMultiVisible(){ return document.getElementById('panel-multi').style.display !== 'none'; }
    window.showTab = function(which){
      const isMulti = which === 'multi';
      document.getElementById('panel-multi').style.display = isMulti ? 'grid' : 'none';
      document.getElementById('panel-single').style.display = isMulti ? 'none' : 'block';
      document.getElementById('tabbtn-multi').setAttribute('aria-selected', String(isMulti));
      document.getElementById('tabbtn-single').setAttribute('aria-selected', String(!isMulti));
      save(SK.lastTab, which);
    };

    function playSingle(g){
      if (g.requiresUser && !username){
        save(SK.nextRoute, g.key);
        showTab('multi');
        showError("üîí Please log in to play Verse Memorizer.");
        const u = document.getElementById('username'); if (u) u.focus();
        window.scrollTo({ top: 0, behavior: 'smooth' });
        return;
      }
      let url = g.route;
      if (g.autoUsername && username){
        url += (url.includes('?') ? '&' : '?') + `username=${encodeURIComponent(username)}`;
      }
      window.location.href = url;
    }

    function renderSingleplayer(){
      const el = document.getElementById('catalog');
      el.innerHTML = '';
      for(const g of SINGLEPLAYER_GAMES){
        const card = document.createElement('div'); card.className = 'game-card';
        const t = document.createElement('div'); t.className = 'game-title'; t.textContent = `${g.emoji} ${g.title}`;
        const d = document.createElement('div'); d.className = 'game-desc'; d.textContent = g.desc;
        const pr = document.createElement('div'); pr.className = 'play-row';
        const btn = document.createElement('button'); btn.className = 'btn btn-lg'; btn.textContent = 'Play';
        btn.addEventListener('click', ()=> playSingle(g));
        pr.appendChild(btn);
        card.appendChild(t); card.appendChild(d); card.appendChild(pr);
        el.appendChild(card);
      }
    }
    renderSingleplayer();

    // ---------- LOBBY LOGIC ----------
    const urlParams = new URLSearchParams(window.location.search);
    const urlUser = urlParams.get("username");
    let username = (urlUser ? urlUser.trim() : (read(SK.user) || "")).trim();
    let currentLobbyId = null;
    let isHost = false;
    let lobbyUnsub = null;

    if (urlUser) {
      history.replaceState({}, "", window.location.pathname);
    }

    const lastTab = read(SK.lastTab);
    if (lastTab === "single") showTab("single");

    if (username) { autoLogin(username); }

    function openPendingRouteIfAny(){
      const key = read(SK.nextRoute);
      if (!key) return;
      const g = SINGLEPLAYER_GAMES.find(x => x.key === key);
      del(SK.nextRoute);
      if (!g) return;
      let url = g.route;
      if (g.autoUsername && username){
        url += (url.includes('?') ? '&' : '?') + `username=${encodeURIComponent(username)}`;
      }
      window.location.href = url;
    }

    async function login() {
      username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value.trim();
      if (!username || !password) { return showError("‚ùå Enter username & password."); }
      const userRef = doc(db, "users", username);
      const userSnap = await getDoc(userRef);
      if (!userSnap.exists() || userSnap.data().password !== password) {
        return showError("‚ùå Invalid login.");
      }

      // ‚úÖ Count unique daily user (after successful auth)
      await bumpDailyUsers(username);

      enterLobbyUI();
      persistSession();
      maybeOfferResume();
      openPendingRouteIfAny();
    }

    async function autoLogin(name) {
      try{
        const userRef = doc(db, "users", name);
        const userSnap = await getDoc(userRef);
        if (!userSnap.exists()) { return showError("‚ùå Username not found in system."); }
        username = name;

        // ‚úÖ Count unique daily user for auto-login as well
        await bumpDailyUsers(username);

        enterLobbyUI();
        persistSession();
        maybeOfferResume();
        openPendingRouteIfAny();
      }catch(e){ /* ignore */ }
    }

    function enterLobbyUI() {
      document.getElementById("loginForm").style.display = "none";
      document.getElementById("lobbyInterface").style.display = "block";
      const lo = document.getElementById('logoutBtn'); if (lo) lo.style.display = 'inline-flex';
      loadLobbies();
      loadLeaderboard();
      if (!window.__lobbyPoll){
        window.__lobbyPoll = setInterval(loadLobbies, 5000);
      }
      document.getElementById("startBtn").addEventListener("click", startGame);
      document.getElementById("gameType").addEventListener("change", updateStartUI);
      updateStartUI();
    }

    function showLoginUI() {
      document.getElementById("loginForm").style.display = "block";
      document.getElementById("lobbyInterface").style.display = "none";
      const lo = document.getElementById('logoutBtn'); if (lo) lo.style.display = 'none';
    }

    function gameLabel(type){
      return type==='grass' ? 'üåø Grass Realms' :
             type==='estate'? 'üè° Estate Defense' :
             type==='mountain'?'üóª Mountain Blade Skirmish (4P)' :
             type==='mountonline'?'üóªüåê Mountain Blade Online' :
             type==='rock'?'‚úäüìÑ‚úÇÔ∏è RPS MMO' :
             type==='stockkings'?'üìà Stock Kings' :
             type==='dutchblitz'?'üÉè Dutch Blitz Arena (4P)' :
             type==='splinters'?'ü™Ñ Splinters (4P)' :
             type==='spelltower'?'üóº Spell Tower (8P)' :
             type==='zombiezone'?'üßü‚Äç‚ôÇÔ∏è Zombie Zone (4P)' :
             type==='biblegame'?'üìñ Bible Game (20P)' :
             type==='historyrush'?'üèõÔ∏è History Rush (4P)' :
             type==='thegame'?'üÉè The Game (5P)' :
             type==='crowncouncil'?'üëë Crown & Council (4P)' :
             'üê≠ Cat & Mouse';
    }

    function updateStartUI(){
      const gt = document.getElementById("gameType").value;
      const title = document.getElementById("lobbyHeaderTitle");
      const nameWrap = document.getElementById("lobbyNameWrap");
      const createBtn = document.getElementById("createBtn");
      const lobbiesCard = document.getElementById("availLobbiesCard");
      const playersCard = document.getElementById("playersCard");

      const isQuickPlay = (gt === "mountonline" || gt === "rock");

      title.textContent = isQuickPlay ? "Quick Play" : "Start a Lobby";
      nameWrap.style.display = isQuickPlay ? "none" : "block";
      createBtn.textContent = isQuickPlay ? "Play" : "Start Lobby";
      lobbiesCard.style.display = isQuickPlay ? "none" : "block";
      playersCard.style.display = isQuickPlay ? "none" : "block";
    }

    async function startLobby() {
      const gameType = document.getElementById("gameType").value;

      if (gameType === "mountonline" || gameType === "rock") {
        if (!username) return showError("‚ùå You must be logged in.");
        const route = ROUTES[gameType];
        save(SK.lastGame, gameType);
        window.location.href = `${route}?username=${encodeURIComponent(username)}`;
        return;
      }

      const name = document.getElementById("lobbyName").value.trim();
      if (!name) return showError("Please enter a lobby name.");

      if (!['cat','grass','estate','mountain','stockkings','thegame','dutchblitz','splinters','spelltower','zombiezone','biblegame','historyrush','crowncouncil'].includes(gameType)) {
        return showError("Invalid game type.");
      }
      const lobby = await addDoc(collection(db, "lobbies"), {
        name, gameType, status: "waiting", players: [username], host: username, createdAt: Date.now()
      });
      currentLobbyId = lobby.id; isHost = true;
      save(SK.lastLobby, currentLobbyId);
      save(SK.lastGame, gameType);
      listenToLobby();
    }

    async function loadLobbies() {
      const qy = query(collection(db, "lobbies"), where("status", "==", "waiting"));
      const snap = await getDocs(qy);
      const list = document.getElementById("lobbyList");
      list.innerHTML = "";

      if (snap.empty) {
        const none = document.createElement("div"); none.className = "subtle";
        none.textContent = "No open lobbies. Start one above!";
        list.appendChild(none); return;
      }

      snap.forEach(async (docSnap) => {
        const data = docSnap.data();
        if (!data.players || data.players.length === 0) {
          try { await deleteDoc(doc(db, "lobbies", docSnap.id)); } catch(e){}
          return;
        }

        const card = document.createElement("div"); card.className = "lobby-card";

        const head = document.createElement("div"); head.style.display="flex"; head.style.justifyContent="space-between"; head.style.alignItems="center"; head.style.gap="8px";
        const titleWrap = document.createElement("div");
        const title = document.createElement("div"); title.style.fontWeight="800"; title.textContent = data.name || "Lobby";
        const meta = document.createElement("div"); meta.className="subtle";

        const cap = getMaxPlayers(data.gameType);
        const playerCount = (data.players || []).length;

        meta.textContent =
          (isFinite(cap) ? `${playerCount}/${cap} players` : `${playerCount} players`) +
          ` ‚Äî Host: ${data.host || "?"}`;

        titleWrap.appendChild(title);
        titleWrap.appendChild(meta);

        const badge = document.createElement("span"); badge.className="badge"; badge.textContent = gameLabel(data.gameType);
        head.appendChild(titleWrap); head.appendChild(badge);

        const progress = document.createElement("div"); progress.className="cap";
        const fill = document.createElement("i"); progress.appendChild(fill);
        if (isFinite(cap)) {
          const pct = Math.min(100, Math.round((playerCount / cap) * 100));
          fill.style.width = pct + "%";
        } else { fill.style.width = "100%"; }

        const actions = document.createElement("div"); actions.style.display="flex"; actions.style.justifyContent="flex-end";
        const btn = document.createElement("button"); btn.className="btn btn-lg"; btn.textContent = "Join";
        if (isFinite(cap) && playerCount >= cap) {
          btn.disabled = true; btn.className="btn-ghost btn-lg"; btn.textContent="Full";
        } else {
          btn.addEventListener("click", ()=> joinLobby(docSnap.id));
        }
        actions.appendChild(btn);

        card.appendChild(head);
        card.appendChild(progress);
        card.appendChild(actions);
        list.appendChild(card);
      });
    }

    async function joinLobby(id) {
      if (lobbyUnsub) { lobbyUnsub(); lobbyUnsub = null; }
      const ref = doc(db, "lobbies", id);
      try {
        await runTransaction(db, async (tx) => {
          const snap = await tx.get(ref);
          if (!snap.exists()) throw new Error("gone");
          const d = snap.data(); const players = Array.isArray(d.players)? d.players : [];
          const cap = getMaxPlayers(d.gameType);
          if (players.includes(username)) return;
          if (isFinite(cap) && players.length >= cap) throw new Error("Lobby is full");
          tx.update(ref, { players: [...players, username] });
        });
      } catch (e) { return showError("‚ùå Lobby is full."); }

      const snap = await getDoc(ref);
      if (!snap.exists()) return showError("Lobby no longer exists.");
      const data = snap.data();
      currentLobbyId = id; isHost = data.host === username;
      save(SK.lastLobby, currentLobbyId);
      save(SK.lastGame, data.gameType);
      listenToLobby();
    }

    function listenToLobby() {
      if (!currentLobbyId) return;
      if (lobbyUnsub) { lobbyUnsub(); lobbyUnsub = null; }

      const ref = doc(db, "lobbies", currentLobbyId);
      lobbyUnsub = onSnapshot(ref, async (docSnap) => {
        if (!docSnap.exists()) return;
        const data = docSnap.data();

        if (!data.players || data.players.length === 0) {
          try { await deleteDoc(ref); } catch(e){}
          currentLobbyId = null; isHost=false;
          save(SK.lastLobby, "");
          document.getElementById("lobbyPlayers").innerHTML = "";
          document.getElementById("startBtn").style.display = "none";
          if (lobbyUnsub) { lobbyUnsub(); lobbyUnsub = null; }
          loadLobbies(); return;
        }

        const container = document.getElementById("lobbyPlayers");
        container.innerHTML = "";
        const headerBadge = document.createElement("div");
        headerBadge.className = "badge";
        headerBadge.textContent = gameLabel(data.gameType);
        container.appendChild(headerBadge);

        for (const player of (data.players || [])) {
          const userRef = doc(db, "users", player);
          const userSnap = await getDoc(userRef);
          const wins = userSnap.exists() ? (userSnap.data().wins || 0) : 0;

          let color = "#cd7f32";
          if (wins >= 5 && wins < 10) color = "#c0c0c0";
          else if (wins >= 10 && wins < 15) color = "#ffd700";
          else if (wins >= 15 && wins < 25) color = "#f59e0b";
          else if (wins >= 25) color = "#ef4444";

          const chip = document.createElement("div"); chip.className="chip";
          const dot = document.createElement("span"); dot.className="dot"; dot.style.background=color;
          const name = document.createElement("span"); name.textContent = player;
          const w = document.createElement("span"); w.className="subtle"; w.textContent = `(${wins} wins)`;
          chip.appendChild(dot); chip.appendChild(name); chip.appendChild(w);
          container.appendChild(chip);
        }

        const startBtn = document.getElementById("startBtn");
        startBtn.style.display = (data.host === username) ? "inline-block" : "none";

        if (AUTO_REDIRECT_GAMES.has(data.gameType) && data.status === "started") {
          const route = ROUTES[data.gameType] || ROUTES.cat;
          save(SK.lastGame, data.gameType);
          save(SK.lastLobby, currentLobbyId);
          window.location.href = `${route}?gameId=${docSnap.id}&username=${encodeURIComponent(username)}`;
        }
      });
    }

    // Estate Defense special-case
    async function joinOrCreateActiveEstate(extraPlayers) {
      const unique = (arr) => Array.from(new Set(arr.filter(Boolean)));
      const qActive = query(collection(db, "lobbies"), where("gameType","==","estate"), where("status","==","active"), limit(1));
      const snap = await getDocs(qActive);

      if (!snap.empty) {
        const targetRef = doc(db, "lobbies", snap.docs[0].id);
        try {
          const activeId = await runTransaction(db, async (tx) => {
            const cur = await tx.get(targetRef);
            if (!cur.exists()) throw new Error("gone");
            const d = cur.data();
            if (d.status !== "active" || d.gameType !== "estate") throw new Error("not_active");
            const merged = unique([...(d.players || []), ...extraPlayers]);
            tx.update(targetRef, { players: merged });
            return targetRef.id;
          });
          return activeId;
        } catch(e){ /* fall through */ }
      }

      const newRef = doc(collection(db, "lobbies"));
      const payload = {
        name:`Estate Defense ‚Äî ${new Date().toLocaleTimeString()}`,
        gameType:"estate", category:"estate-defense", status:"active",
        players:unique(extraPlayers), host:username, createdAt:Date.now()
      };
      await runTransaction(db, async (tx)=>{ tx.set(newRef, payload); });
      return newRef.id;
    }

    async function startGame() {
      if (!currentLobbyId) return;
      const ref = doc(db, "lobbies", currentLobbyId);
      const snap = await getDoc(ref); if (!snap.exists()) return;
      const data = snap.data();

      if (data.gameType === "estate") {
        const playersFromThisLobby = data.players || [username];
        const activeId = await joinOrCreateActiveEstate(playersFromThisLobby);
        try { await deleteDoc(ref); } catch(e){}
        const route = ROUTES.estate;
        save(SK.lastGame, "estate");
        save(SK.lastLobby, activeId);
        window.location.href = `${route}?gameId=${activeId}&username=${encodeURIComponent(username)}`;
        return;
      }
      await updateDoc(ref, { status: "started" });
    }

    async function leaveLobby() {
      if (!currentLobbyId) return;
      const ref = doc(db, "lobbies", currentLobbyId);
      const snap = await getDoc(ref);
      if (snap.exists()) {
        const data = snap.data();
        const players = (data.players || []).filter(p => p !== username);
        if (players.length > 0) { await updateDoc(ref, { players }); }
        else { try { await deleteDoc(ref); } catch(e){} }
      }
      currentLobbyId = null; isHost=false;
      if (lobbyUnsub) { lobbyUnsub(); lobbyUnsub=null; }
      document.getElementById("lobbyPlayers").innerHTML = "";
      document.getElementById("startBtn").style.display = "none";
      loadLobbies();
      save(SK.lastLobby, "");
    }

    async function loadLeaderboard() {
      const qy = query(collection(db, "users"));
      const snapshot = await getDocs(qy);
      const rows = [];
      snapshot.forEach(docSnap => rows.push({ name: docSnap.id, wins: docSnap.data().wins || 0 }));
      rows.sort((a,b)=> b.wins - a.wins);
      const box = document.getElementById("leaderboardEntries"); box.innerHTML = "";
      rows.slice(0,8).forEach((r, i)=>{
        const row = document.createElement("div"); row.className="lb-row";
        const left = document.createElement("div"); left.style.display="flex"; left.style.alignItems="center"; left.style.gap="10px";
        const rank = document.createElement("div"); rank.className="rank"; rank.textContent = i+1;
        const name = document.createElement("div"); name.style.fontWeight="800"; name.textContent = r.name;
        left.appendChild(rank); left.appendChild(name);
        const right = document.createElement("div"); right.className="subtle"; right.textContent = `üèÜ ${r.wins}`;
        row.appendChild(left); row.appendChild(right);
        box.appendChild(row);
      });
    }

    function showError(msg){
      const e = document.getElementById("error"); e.textContent = msg;
    }

    // ---------- RESUME BANNER ----------
    function maybeOfferResume(){
      const banner = document.getElementById("resumeBanner");
      const lastLobby = read(SK.lastLobby);
      const lastGame = read(SK.lastGame);

      const resumeLobbyBtn = document.getElementById("resumeLobbyBtn");
      const resumeGameBtn  = document.getElementById("resumeGameBtn");
      const clearBtn       = document.getElementById("clearSessionBtn");

      banner.style.display = "none";
      resumeLobbyBtn.style.display = "none";
      resumeGameBtn.style.display = "none";

      if (document.getElementById("lobbyInterface").style.display !== "none") return;

      if (lastLobby) {
        banner.style.display = "flex";
        resumeLobbyBtn.style.display = "inline-block";
        resumeLobbyBtn.onclick = ()=> joinLobby(lastLobby);
      }

      if (lastGame && ROUTES[lastGame]) {
        banner.style.display = "flex";
        resumeGameBtn.style.display = "inline-block";
        resumeGameBtn.onclick = ()=> {
          const route = ROUTES[lastGame];
          const gid = read(SK.lastLobby) || "";
          const glue = gid ? `?gameId=${gid}&username=${encodeURIComponent(username)}` : `?username=${encodeURIComponent(username)}`;
          window.location.href = route + glue;
        };
      }

      clearBtn.onclick = ()=> { clearSession(); banner.style.display="none"; };
    }

    // ---------- LOGOUT ----------
    window.logout = async function(){
      try {
        if (currentLobbyId) { await leaveLobby(); }
      } catch(e) { /* ignore */ }
      if (lobbyUnsub) { lobbyUnsub = null; }
      clearSession();
      username = "";
      showLoginUI();
      document.getElementById('resumeBanner').style.display = 'none';
      history.replaceState({}, "", window.location.pathname);
      document.getElementById('error').textContent = "";
    };

    // Initial UI
    if (!username) { showLoginUI(); maybeOfferResume(); }

    // Expose
    window.login = login;
    window.startLobby = startLobby;
    window.joinLobby = joinLobby;
    window.startGame = startGame;
    window.leaveLobby = leaveLobby;
  </script>
</body>
</html>













