<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>🕹️ Game Hub & Multiplayer Lobby</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#f6f7fb; --ink:#0f172a; --muted:#6b7280; --card:#fff; --br:#e5e7eb;
      --accent:#214a9a; --accent-2:#1a3b7b; --accent-soft:#e6eefc; --good:#16a34a; --bad:#ef4444;
      --shadow:0 10px 30px rgba(2,6,23,.08); --radius:16px; --radius-sm:12px;
    }
    *{box-sizing:border-box}
    body{ margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial; color:var(--ink); background:var(--bg) }

    /* Header */
    .hero{
      background: radial-gradient(1200px 600px at 50% -200px, #315bbd 0%, #1a2b53 55%, #0f1a35 100%);
      color:#fff; padding:28px 16px 18px; position:relative; overflow:hidden;
      box-shadow:var(--shadow);
    }
    .hero-inner{ max-width:1200px; margin:0 auto; display:flex; align-items:center; justify-content:space-between; gap:16px; flex-wrap:wrap }
    .brand{ display:flex; align-items:center; gap:12px; }
    .logo{ width:44px; height:44px; display:grid; place-items:center; background:rgba(255,255,255,.1); border:1px solid rgba(255,255,255,.18); border-radius:14px; font-size:22px }
    .title{ font-weight:800; letter-spacing:.3px; font-size:1.35rem }
    .subtitle{ color:#c7d7ff; font-size:.95rem }

    /* Tabs */
    .tabs{ display:flex; gap:10px; background:rgba(255,255,255,.1); padding:6px; border-radius:999px; border:1px solid rgba(255,255,255,.18) }
    .tab-btn{
      appearance:none; border:none; cursor:pointer; padding:10px 16px; border-radius:999px; color:#eaf1ff; background:transparent;
      font-weight:700; letter-spacing:.2px; transition:.2s ease; white-space:nowrap
    }
    .tab-btn:hover{ background:rgba(255,255,255,.14) }
    .tab-btn[aria-selected="true"]{ background:#fff; color:#0f172a; box-shadow:0 2px 14px rgba(15,23,42,.25) }

    /* Layout */
    .shell{ max-width:1200px; margin:18px auto; padding:0 12px 28px }
    .grid{ display:grid; grid-template-columns:2fr 1fr; gap:18px }
    @media (max-width:980px){ .grid{ grid-template-columns:1fr } }

    /* Cards */
    .card{ background:var(--card); border:1px solid var(--br); border-radius:var(--radius); box-shadow:var(--shadow) }
    .card-head{ padding:14px 16px; border-bottom:1px solid var(--br); display:flex; align-items:center; justify-content:space-between; gap:12px }
    .card-title{ font-weight:800 }
    .card-body{ padding:14px 16px }

    /* Forms */
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center }
    .input, .select, .btn{
      padding:11px 12px; border:1px solid var(--br); border-radius:12px; background:#fff; font-size:14px; outline:none;
    }
    .input:focus, .select:focus{ border-color:#93c5fd; box-shadow:0 0 0 4px rgba(147,197,253,.35) }
    .btn{ cursor:pointer; font-weight:800; border-color:var(--accent); background:var(--accent); color:#fff }
    .btn:hover{ background:var(--accent-2) }
    .btn-ghost{ border-color:var(--br); background:#fff; color:var(--ink); font-weight:700 }
    .btn-ghost:hover{ background:#f3f4f6 }

    /* Lobby list as cards */
    .lobbies{ display:grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap:14px }
    .lobby-card{ border:1px solid var(--br); border-radius:14px; padding:14px; background:#fff; display:flex; flex-direction:column; gap:10px }
    .badge{ display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; font-size:12px; background:var(--accent-soft); color:var(--accent); border:1px solid #cfe0ff; font-weight:700 }
    .subtle{ color:var(--muted); font-size:.92rem }
    .cap{ height:8px; background:#f1f5f9; border:1px solid var(--br); border-radius:999px; overflow:hidden }
    .cap > i{ display:block; height:100%; width:0%; background:linear-gradient(90deg,#7dd3fc,#60a5fa,#4f46e5) }

    /* Players box */
    .players{ display:flex; flex-wrap:wrap; gap:8px }
    .chip{
      display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid var(--br); border-radius:999px; background:#f8fafc; font-size:13px
    }
    .dot{ width:10px; height:10px; border-radius:50% }

    /* Leaderboard */
    .ladder{ display:grid; gap:10px }
    .lb-row{ display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border:1px solid var(--br); border-radius:12px; background:#fff }
    .rank{ font-weight:900; width:28px; height:28px; border-radius:8px; display:grid; place-items:center; background:#eef2ff; color:#3730a3 }

    /* Singleplayer catalog */
    .catalog{ display:grid; grid-template-columns: repeat(auto-fit, minmax(260px,1fr)); gap:14px }
    .game-card{ border:1px solid var(--br); border-radius:14px; padding:14px; background:#fff; display:flex; flex-direction:column; gap:10px }
    .game-title{ font-weight:800; display:flex; align-items:center; gap:8px }
    .game-desc{ color:var(--muted); line-height:1.45 }
    .play-row{ display:flex; justify-content:flex-end }

    /* Start/Leave buttons row */
    .controls{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px }
    #startBtn{ display:none }
    #error{ margin-top:6px; color:var(--bad); font-weight:700 }
  </style>
</head>
<body>
  <!-- HERO -->
  <header class="hero">
    <div class="hero-inner">
      <div class="brand">
        <div class="logo">🎮</div>
        <div>
          <div class="title">Game Hub</div>
          <div class="subtitle">Create a lobby, invite friends, or jump into solo play.</div>
        </div>
      </div>
      <div class="tabs" role="tablist" aria-label="Game Modes">
        <button id="tabbtn-multi" class="tab-btn" role="tab" aria-controls="panel-multi" aria-selected="true" onclick="showTab('multi')">👥 Multiplayer</button>
        <button id="tabbtn-single" class="tab-btn" role="tab" aria-controls="panel-single" aria-selected="false" onclick="showTab('single')">🎮 Singleplayer</button>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <div class="shell">
    <!-- MULTIPLAYER -->
    <section id="panel-multi" class="grid" role="tabpanel" aria-labelledby="tabbtn-multi">
      <div class="left">
        <div id="loginForm" class="card">
          <div class="card-head"><div class="card-title">Welcome</div></div>
          <div class="card-body">
            <div class="row">
              <input type="text" id="username" class="input" placeholder="Username" />
              <input type="password" id="password" class="input" placeholder="Password" />
              <button class="btn" onclick="login()">Login</button>
            </div>
            <div id="error"></div>
          </div>
        </div>

        <div id="lobbyInterface" class="card" style="display:none">
          <div class="card-head">
            <div class="card-title">Start a Lobby</div>
          </div>
          <div class="card-body">
            <div class="row" style="align-items:flex-end">
              <div style="flex:1 1 220px">
                <label class="subtle">Lobby Name</label>
                <input type="text" id="lobbyName" class="input" placeholder="e.g., Friday Night Squad" />
              </div>
              <div style="flex:1 1 220px">
                <label class="subtle">Game</label>
                <select id="gameType" class="select">
                  <option value="cat">🐭 Cat & Mouse</option>
                  <option value="grass">🌿 Grass Realms</option>
                  <option value="estate">🏡 Estate Defense</option>
                  <option value="mountain">🗻 Mountain Blade (4P)</option>
                  <option value="stockkings">📈 Stock Kings</option>
                </select>
              </div>
              <button class="btn" onclick="startLobby()">Start Lobby</button>
            </div>

            <div class="card" style="margin-top:14px">
              <div class="card-head"><div class="card-title">Available Lobbies</div></div>
              <div class="card-body">
                <div id="lobbyList" class="lobbies">
                  <!-- Lobby cards injected here -->
                </div>
              </div>
            </div>

            <div class="card" style="margin-top:14px">
              <div class="card-head"><div class="card-title">Lobby Players</div></div>
              <div class="card-body">
                <div id="lobbyPlayers" class="players"><!-- chips injected --></div>
                <div class="controls">
                  <button id="startBtn" class="btn">🚀 Start Game</button>
                  <button class="btn-ghost" onclick="leaveLobby()">❌ Leave Lobby</button>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>

      <!-- RIGHT SIDEBAR -->
      <aside class="right">
        <div id="winsLeaderboard" class="card">
          <div class="card-head"><div class="card-title">🏆 Top Players</div></div>
          <div class="card-body">
            <div id="leaderboardEntries" class="ladder"><!-- rows --></div>
          </div>
        </div>
      </aside>
    </section>

    <!-- SINGLEPLAYER -->
    <section id="panel-single" class="card" role="tabpanel" aria-labelledby="tabbtn-single" style="display:none">
      <div class="card-head">
        <div class="card-title">Singleplayer</div>
      </div>
      <div class="card-body">
        <p class="subtle" style="margin-top:0">Pick a game to play solo.</p>
        <div id="catalog" class="catalog"><!-- game cards --></div>
      </div>
    </section>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore, collection, addDoc, doc, updateDoc, onSnapshot,
      query, where, getDoc, getDocs, deleteDoc, limit, runTransaction
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ---------- ROUTES ----------
    const ROUTES = {
      cat:        "/game/catandmouse.html",
      grass:      "/game/grassrealms.html",
      estate:     "/game/estatedefense.html",
      mountain:   "/game/mountainblade.html",
      stockkings: "/game/stockkings.html",

      // Singleplayer
      matchwars:  "/game/matchwars.html",
      flag:       "/game/Flag.html",
      microwars:  "/game/microwars.html",
      microwars2: "/game/microwaves2.html",
      microwars4: "/game/microwaves4.html",
      mobamania:  "/game/CatLanes.html"
    };
    const AUTO_REDIRECT_GAMES = new Set(["cat","grass","mountain","stockkings"]);
    const MAX_PLAYERS = { mountain: 4, stockkings: 8 };
    const getMaxPlayers = (gameType, fallback = Infinity) =>
      typeof MAX_PLAYERS[gameType] === "number" ? MAX_PLAYERS[gameType] : fallback;

    // ---------- SINGLEPLAYER CATALOG ----------
    const SINGLEPLAYER_GAMES = [
      { key: "microwars",  title: "Micro Wars",        emoji: "🔬⚔️",    desc: "Blinkers & Soldiers RTS skirmishes. Drag-select, right-click to move/attack. Blink & Stim. Survive escalating waves.", route: ROUTES.microwars },
      { key: "microwars2", title: "Micro Wars Terran", emoji: "🛰️🪖",    desc: "Terran-flavored variant: faster recruits, tactical pressure, hold the line longer.", route: ROUTES.microwars2 },
      { key: "microwars4", title: "Micro Wars Nexus",  emoji: "💠✨",    desc: "Altered tech flow & pacing. Time your power spikes and stabilize.", route: ROUTES.microwars4 },
      { key: "mobamania",  title: "MOBA Mania",        emoji: "🧙‍♂️🛡️💠", desc: "Single-lane hero brawler with towers, minions, and abilities. Push to destroy the core.", route: ROUTES.mobamania },
      { key: "matchwars",  title: "MatchWars",         emoji: "🧩⚔️",    desc: "Match tiles to recruit, then steamroll the enemy stronghold. Quick & strategic.", route: ROUTES.matchwars },
      { key: "flag",       title: "Flag Fight",        emoji: "🏁⚔️",    desc: "Command your army to capture flags and crush the enemy.", route: ROUTES.flag }
    ];

    // ---------- FIREBASE ----------
    const firebaseConfig = {
      apiKey: "AIzaSyB7twY7z31ucB6pGA8JC_HrVMZhA8lNaJA",
      authDomain: "bible-game-246c0.firebaseapp.com",
      projectId: "bible-game-246c0",
      storageBucket: "bible-game-246c0.appspot.com",
      messagingSenderId: "959619818996",
      appId: "1:959619818996:web:5a9fbf492e23c765e445a1"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ---------- TABS ----------
    window.showTab = function(which){
      const isMulti = which === 'multi';
      document.getElementById('panel-multi').style.display = isMulti ? 'grid' : 'none';
      document.getElementById('panel-single').style.display = isMulti ? 'none' : 'block';
      document.getElementById('tabbtn-multi').setAttribute('aria-selected', String(isMulti));
      document.getElementById('tabbtn-single').setAttribute('aria-selected', String(!isMulti));
    };

    // Render Singleplayer
    function renderSingleplayer(){
      const el = document.getElementById('catalog');
      el.innerHTML = '';
      for(const g of SINGLEPLAYER_GAMES){
        const card = document.createElement('div'); card.className = 'game-card';
        const t = document.createElement('div'); t.className = 'game-title'; t.textContent = `${g.emoji} ${g.title}`;
        const d = document.createElement('div'); d.className = 'game-desc'; d.textContent = g.desc;
        const pr = document.createElement('div'); pr.className = 'play-row';
        const btn = document.createElement('button'); btn.className = 'btn'; btn.textContent = 'Play';
        btn.addEventListener('click', ()=> window.location.href = g.route);
        pr.appendChild(btn);
        card.appendChild(t); card.appendChild(d); card.appendChild(pr);
        el.appendChild(card);
      }
    }
    renderSingleplayer();

    // ---------- LOBBY LOGIC ----------
    const urlParams = new URLSearchParams(window.location.search);
    const autoUsername = urlParams.get("username");
    let username = autoUsername ? autoUsername.trim() : "";
    let currentLobbyId = null;
    let isHost = false;
    let lobbyUnsub = null;

    if (username) { autoLogin(username); }

    async function login() {
      username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value.trim();
      if (!username || !password) { return showError("❌ Enter username & password."); }
      const userRef = doc(db, "users", username);
      const userSnap = await getDoc(userRef);
      if (!userSnap.exists() || userSnap.data().password !== password) {
        return showError("❌ Invalid login.");
      }
      enterLobbyUI();
    }

    async function autoLogin(name) {
      const userRef = doc(db, "users", name);
      const userSnap = await getDoc(userRef);
      if (!userSnap.exists()) { return showError("❌ Username not found in system."); }
      username = name;
      enterLobbyUI();
    }

    function enterLobbyUI() {
      document.getElementById("loginForm").style.display = "none";
      document.getElementById("lobbyInterface").style.display = "block";
      loadLobbies();
      loadLeaderboard();
      setInterval(loadLobbies, 5000);
      document.getElementById("startBtn").addEventListener("click", startGame);
    }

    function gameLabel(type){
      return type==='grass' ? '🌿 Grass Realms' :
             type==='estate'? '🏡 Estate Defense' :
             type==='mountain'?'🗻 Mountain Blade (4P)' :
             type==='stockkings'?'📈 Stock Kings' : '🐭 Cat & Mouse';
    }

    async function startLobby() {
      const name = document.getElementById("lobbyName").value.trim();
      const gameType = document.getElementById("gameType").value;
      if (!name) return showError("Please enter a lobby name.");
      if (!['cat','grass','estate','mountain','stockkings'].includes(gameType)) {
        return showError("Invalid game type.");
      }
      const lobby = await addDoc(collection(db, "lobbies"), {
        name, gameType, status: "waiting", players: [username], host: username, createdAt: Date.now()
      });
      currentLobbyId = lobby.id; isHost = true; listenToLobby();
    }

    async function loadLobbies() {
      const qy = query(collection(db, "lobbies"), where("status", "==", "waiting"));
      const snap = await getDocs(qy);
      const list = document.getElementById("lobbyList");
      list.innerHTML = "";

      if (snap.empty) {
        const none = document.createElement("div"); none.className = "subtle";
        none.textContent = "No open lobbies. Start one above!";
        list.appendChild(none); return;
      }

      snap.forEach(async (docSnap) => {
        const data = docSnap.data();
        // auto-clean empty
        if (!data.players || data.players.length === 0) {
          try { await deleteDoc(doc(db, "lobbies", docSnap.id)); } catch(e){}
          return;
        }

        // Build a lobby card
        const card = document.createElement("div"); card.className = "lobby-card";

        const head = document.createElement("div"); head.style.display="flex"; head.style.justifyContent="space-between"; head.style.alignItems="center"; head.style.gap="8px";
        const titleWrap = document.createElement("div");
        const title = document.createElement("div"); title.style.fontWeight="800"; title.textContent = data.name || "Lobby";
        const meta = document.createElement("div"); meta.className="subtle";
        const cap = getMaxPlayers(data.gameType);
        const countTxt = isFinite(cap) ? `${(data.players||[]).length}/${cap} players` : `${(data.players||[]).length} players`;
        meta.textContent = `${countTxt} — Host: ${data.host||"?"}`;
        titleWrap.appendChild(title);
        titleWrap.appendChild(meta);

        const badge = document.createElement("span"); badge.className="badge"; badge.textContent = gameLabel(data.gameType);
        head.appendChild(titleWrap); head.appendChild(badge);

        const progress = document.createElement("div"); progress.className="cap";
        const fill = document.createElement("i"); progress.appendChild(fill);
        if (isFinite(cap)) {
          const pct = Math.min(100, Math.round(((data.players||[]).length / cap) * 100));
          fill.style.width = pct + "%";
        } else { fill.style.width = "100%"; }

        const actions = document.createElement("div"); actions.style.display="flex"; actions.style.justifyContent="flex-end";
        const btn = document.createElement("button"); btn.className="btn"; btn.textContent = "Join";
        if (isFinite(cap) && (data.players||[]).length >= cap) {
          btn.disabled = true; btn.className="btn-ghost"; btn.textContent="Full";
        } else {
          btn.addEventListener("click", ()=> joinLobby(docSnap.id));
        }
        actions.appendChild(btn);

        card.appendChild(head);
        card.appendChild(progress);
        card.appendChild(actions);
        list.appendChild(card);
      });
    }

    async function joinLobby(id) {
      if (lobbyUnsub) { lobbyUnsub(); lobbyUnsub = null; }
      const ref = doc(db, "lobbies", id);
      try {
        await runTransaction(db, async (tx) => {
          const snap = await tx.get(ref);
          if (!snap.exists()) throw new Error("gone");
          const d = snap.data(); const players = Array.isArray(d.players)? d.players : [];
          const cap = getMaxPlayers(d.gameType);
          if (players.includes(username)) return;
          if (isFinite(cap) && players.length >= cap) throw new Error("Lobby is full");
          tx.update(ref, { players: [...players, username] });
        });
      } catch (e) { return showError("❌ Lobby is full."); }

      const snap = await getDoc(ref);
      if (!snap.exists()) return showError("Lobby no longer exists.");
      const data = snap.data();
      currentLobbyId = id; isHost = data.host === username; listenToLobby();
    }

    function listenToLobby() {
      if (!currentLobbyId) return;
      if (lobbyUnsub) { lobbyUnsub(); lobbyUnsub = null; }

      const ref = doc(db, "lobbies", currentLobbyId);
      lobbyUnsub = onSnapshot(ref, async (docSnap) => {
        if (!docSnap.exists()) return;
        const data = docSnap.data();

        // auto-close if empty
        if (!data.players || data.players.length === 0) {
          try { await deleteDoc(ref); } catch(e){}
          currentLobbyId = null; isHost=false;
          document.getElementById("lobbyPlayers").innerHTML = "";
          document.getElementById("startBtn").style.display = "none";
          if (lobbyUnsub) { lobbyUnsub(); lobbyUnsub = null; }
          loadLobbies(); return;
        }

        // Render players as chips
        const container = document.getElementById("lobbyPlayers");
        container.innerHTML = "";
        const headerBadge = document.createElement("div");
        headerBadge.className = "badge";
        headerBadge.textContent = gameLabel(data.gameType);
        container.appendChild(headerBadge);

        for (const player of (data.players || [])) {
          const userRef = doc(db, "users", player);
          const userSnap = await getDoc(userRef);
          const wins = userSnap.exists() ? (userSnap.data().wins || 0) : 0;

          // color tiers
          let color = "#cd7f32";               // bronze
          if (wins >= 5 && wins < 10) color = "#c0c0c0";      // silver
          else if (wins >= 10 && wins < 15) color = "#ffd700"; // gold
          else if (wins >= 15 && wins < 25) color = "#3b82f6"; // sapphire
          else if (wins >= 25) color = "#ef4444";              // ruby

          const chip = document.createElement("div"); chip.className="chip";
          const dot = document.createElement("span"); dot.className="dot"; dot.style.background=color;
          const name = document.createElement("span"); name.textContent = player;
          const w = document.createElement("span"); w.className="subtle"; w.textContent = `(${wins} wins)`;
          chip.appendChild(dot); chip.appendChild(name); chip.appendChild(w);
          container.appendChild(chip);
        }

        // Host can start
        const startBtn = document.getElementById("startBtn");
        startBtn.style.display = (data.host === username) ? "inline-block" : "none";

        // Auto-redirect games on "started"
        if (AUTO_REDIRECT_GAMES.has(data.gameType) && data.status === "started") {
          const route = ROUTES[data.gameType] || ROUTES.cat;
          window.location.href = `${route}?gameId=${docSnap.id}&username=${encodeURIComponent(username)}`;
        }
      });
    }

    // Estate Defense special-case
    async function joinOrCreateActiveEstate(extraPlayers) {
      const unique = (arr) => Array.from(new Set(arr.filter(Boolean)));
      const qActive = query(collection(db, "lobbies"), where("gameType","==","estate"), where("status","==","active"), limit(1));
      const snap = await getDocs(qActive);

      if (!snap.empty) {
        const targetRef = doc(db, "lobbies", snap.docs[0].id);
        try {
          const activeId = await runTransaction(db, async (tx) => {
            const cur = await tx.get(targetRef);
            if (!cur.exists()) throw new Error("gone");
            const d = cur.data();
            if (d.status !== "active" || d.gameType !== "estate") throw new Error("not_active");
            const merged = unique([...(d.players || []), ...extraPlayers]);
            tx.update(targetRef, { players: merged });
            return targetRef.id;
          });
          return activeId;
        } catch(e){ /* fall through */ }
      }

      const newRef = doc(collection(db, "lobbies"));
      const payload = {
        name:`Estate Defense — ${new Date().toLocaleTimeString()}`,
        gameType:"estate", category:"estate-defense", status:"active",
        players:unique(extraPlayers), host:username, createdAt:Date.now()
      };
      await runTransaction(db, async (tx)=>{ tx.set(newRef, payload); });
      return newRef.id;
    }

    async function startGame() {
      if (!currentLobbyId) return;
      const ref = doc(db, "lobbies", currentLobbyId);
      const snap = await getDoc(ref); if (!snap.exists()) return;
      const data = snap.data();

      if (data.gameType === "estate") {
        const playersFromThisLobby = data.players || [username];
        const activeId = await joinOrCreateActiveEstate(playersFromThisLobby);
        try { await deleteDoc(ref); } catch(e){}
        const route = ROUTES.estate;
        window.location.href = `${route}?gameId=${activeId}&username=${encodeURIComponent(username)}`;
        return;
      }
      await updateDoc(ref, { status: "started" }); // others redirect via listener
    }

    async function leaveLobby() {
      if (!currentLobbyId) return;
      const ref = doc(db, "lobbies", currentLobbyId);
      const snap = await getDoc(ref);
      if (snap.exists()) {
        const data = snap.data();
        const players = (data.players || []).filter(p => p !== username);
        if (players.length > 0) { await updateDoc(ref, { players }); }
        else { try { await deleteDoc(ref); } catch(e){} }
      }
      currentLobbyId = null; isHost=false;
      if (lobbyUnsub) { lobbyUnsub(); lobbyUnsub=null; }
      document.getElementById("lobbyPlayers").innerHTML = "";
      document.getElementById("startBtn").style.display = "none";
      loadLobbies();
    }

    async function loadLeaderboard() {
      const qy = query(collection(db, "users"));
      const snapshot = await getDocs(qy);
      const rows = [];
      snapshot.forEach(docSnap => rows.push({ name: docSnap.id, wins: docSnap.data().wins || 0 }));
      rows.sort((a,b)=> b.wins - a.wins);
      const box = document.getElementById("leaderboardEntries"); box.innerHTML = "";
      rows.slice(0,8).forEach((r, i)=>{
        const row = document.createElement("div"); row.className="lb-row";
        const left = document.createElement("div"); left.style.display="flex"; left.style.alignItems="center"; left.style.gap="10px";
        const rank = document.createElement("div"); rank.className="rank"; rank.textContent = i+1;
        const name = document.createElement("div"); name.style.fontWeight="800"; name.textContent = r.name;
        left.appendChild(rank); left.appendChild(name);
        const right = document.createElement("div"); right.className="subtle"; right.textContent = `🏆 ${r.wins}`;
        row.appendChild(left); row.appendChild(right);
        box.appendChild(row);
      });
    }

    function showError(msg){
      const e = document.getElementById("error"); e.textContent = msg;
    }

    // Expose
    window.login = login;
    window.startLobby = startLobby;
    window.joinLobby = joinLobby;
    window.startGame = startGame;
    window.leaveLobby = leaveLobby;
  </script>
</body>
</html>







