<!-- LOBBY (mobile-first login polish) -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üïπÔ∏è Game Hub & Multiplayer Lobby</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <style>
    :root{
      --bg:#f6f7fb; --ink:#0f172a; --muted:#6b7280; --card:#fff; --br:#e5e7eb;
      --accent:#214a9a; --accent-2:#1a3b7b; --accent-soft:#e6eefc; --good:#16a34a; --bad:#ef4444;
      --shadow:0 10px 30px rgba(2,6,23,.08); --radius:16px; --radius-sm:12px;
      --tap:56px; /* comfortable touch target */
    }
    *{box-sizing:border-box}
    body{ margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial; color:var(--ink); background:var(--bg) }

    /* Header */
    .hero{
      background: radial-gradient(1200px 600px at 50% -200px, #315bbd 0%, #1a2b53 55%, #0f1a35 100%);
      color:#fff; padding:28px 16px 18px; position:relative; overflow:hidden;
      box-shadow:var(--shadow);
      padding-top: calc(28px + env(safe-area-inset-top));
    }
    .hero-inner{ max-width:1200px; margin:0 auto; display:flex; align-items:center; justify-content:space-between; gap:16px; flex-wrap:wrap }
    .brand{ display:flex; align-items:center; gap:12px; }
    .logo{ width:44px; height:44px; display:grid; place-items:center; background:rgba(255,255,255,.1); border:1px solid rgba(255,255,255,.18); border-radius:14px; font-size:22px }
    .title{ font-weight:800; letter-spacing:.3px; font-size:1.35rem }
    .subtitle{ color:#c7d7ff; font-size:.95rem }

    /* Tabs */
    .tabs{ display:flex; gap:10px; background:rgba(255,255,255,.1); padding:6px; border-radius:999px; border:1px solid rgba(255,255,255,.18); overflow:auto; -webkit-overflow-scrolling:touch }
    .tab-btn{
      appearance:none; border:none; cursor:pointer; padding:10px 16px; border-radius:999px; color:#eaf1ff; background:transparent;
      font-weight:700; letter-spacing:.2px; transition:.2s ease; white-space:nowrap
    }
    .tab-btn:hover{ background:rgba(255,255,255,.14) }
    .tab-btn[aria-selected="true"]{ background:#fff; color:#0f172a; box-shadow:0 2px 14px rgba(15,23,42,.25) }

    /* Layout */
    .shell{ max-width:1200px; margin:18px auto; padding:0 12px 28px }
    .grid{ display:grid; grid-template-columns:2fr 1fr; gap:18px }
    @media (max-width:980px){ .grid{ grid-template-columns:1fr } }

    /* Cards */
    .card{ background:var(--card); border:1px solid var(--br); border-radius:var(--radius); box-shadow:var(--shadow) }
    .card-head{ padding:14px 16px; border-bottom:1px solid var(--br); display:flex; align-items:center; justify-content:space-between; gap:12px }
    .card-title{ font-weight:800 }
    .card-body{ padding:14px 16px }

    /* Forms */
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center }
    .input, .select, .btn{
      padding:14px 12px; border:1px solid var(--br); border-radius:12px; background:#fff; font-size:16px; outline:none; min-height:44px;
    }
    .input:focus, .select:focus{ border-color:#93c5fd; box-shadow:0 0 0 4px rgba(147,197,253,.35) }
    .btn{ cursor:pointer; font-weight:800; border-color:var(--accent); background:var(--accent); color:#fff; transition:background .2s }
    .btn:hover{ background:var(--accent-2) }
    .btn-ghost{ border-color:var(--br); background:#fff; color:#0f172a; font-weight:700 }
    .btn-ghost:hover{ background:#f3f4f6 }
    .btn-lg{ min-height:var(--tap); font-size:17px }
    .btn-block{ width:100% }
    .field{ display:flex; flex-direction:column; gap:6px; flex:1 1 220px }
    .label{ font-size:.92rem; color:var(--muted) }

    /* Resume banner */
    .resume{
      display:none; margin:12px 0 0; padding:12px; border:1px solid #c7d2fe; background:#eef2ff; color:#1e1b4b; border-radius:12px;
      display:flex; align-items:center; gap:10px; justify-content:space-between;
    }
    .resume .info{ font-weight:700 }
    .resume .actions{ display:flex; gap:8px; flex-wrap:wrap }

    /* Lobby list as cards */
    .lobbies{ display:grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap:14px }
    .lobby-card{ border:1px solid var(--br); border-radius:14px; padding:14px; background:#fff; display:flex; flex-direction:column; gap:10px }
    .badge{ display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; font-size:12px; background:var(--accent-soft); color:var(--accent); border:1px solid #cfe0ff; font-weight:700 }
    .subtle{ color:var(--muted); font-size:.96rem }
    .cap{ height:8px; background:#f1f5f9; border:1px solid var(--br); border-radius:999px; overflow:hidden }
    .cap > i{ display:block; height:100%; width:0%; background:linear-gradient(90deg,#7dd3fc,#60a5fa,#4f46e5) }

    /* Players box */
    .players{ display:flex; flex-wrap:wrap; gap:8px }
    .chip{
      display:inline-flex; align-items:center; gap:6px; padding:8px 12px; border:1px solid var(--br); border-radius:999px; background:#f8fafc; font-size:14px
    }
    .dot{ width:10px; height:10px; border-radius:50% }

    /* Leaderboard */
    .ladder{ display:grid; gap:10px }
    .lb-row{ display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border:1px solid var(--br); border-radius:12px; background:#fff }
    .rank{ font-weight:900; width:28px; height:28px; border-radius:8px; display:grid; place-items:center; background:#eef2ff; color:#3730a3 }

    /* Singleplayer catalog */
    .catalog{ display:grid; grid-template-columns: repeat(auto-fit, minmax(260px,1fr)); gap:14px }
    .game-card{ border:1px solid var(--br); border-radius:14px; padding:14px; background:#fff; display:flex; flex-direction:column; gap:10px }
    .game-title{ font-weight:800; display:flex; align-items:center; gap:8px }
    .game-desc{ color:var(--muted); line-height:1.45 }
    .play-row{ display:flex; justify-content:flex-end }

    /* Start/Leave buttons row */
    .controls{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px }
    #startBtn{ display:none }
    #error{ margin-top:6px; color:var(--bad); font-weight:700 }

    /* ===== MOBILE-FIRST LOGIN ===== */
    /* Large, full-bleed ‚Äúlogin sheet‚Äù that feels different on mobile */
    @media (max-width:720px){
      .grid{ grid-template-columns:1fr }
      .row{ flex-direction:column; align-items:stretch }
      .input, .select, .btn{ width:100% }
      .btn{ min-height:var(--tap) }
      .tab-btn{ padding:12px 16px }
      .hero-inner{ gap:12px }
      .lobby-card .btn{ width:100% }
      .subtitle{ font-size:.9rem }
      .card{ border-radius:20px }
      body{ padding-bottom: calc(env(safe-area-inset-bottom) + 8px) }

      /* Make the login screen visually distinct */
      #loginForm.card{
        border:none; background:transparent; box-shadow:none; padding:0;
      }
      #loginForm .card-head{ display:none; }
      #loginForm .card-body{
        padding:0;
      }

      /* Mobile login sheet */
      .login-sheet{
        position:relative;
        margin:12px 0 0;
        background:linear-gradient(180deg,#15213e,#0f1933);
        color:#eaf1ff;
        border-radius:24px;
        padding:20px 16px;
        box-shadow:0 20px 50px rgba(2,6,23,.35);
        overflow:hidden;
      }
      .login-sheet .bigbrand{
        display:flex; align-items:center; gap:12px; margin-bottom:8px;
      }
      .login-sheet .bigbrand .logo{
        width:56px; height:56px; font-size:26px; border-radius:16px;
        background:rgba(255,255,255,.12); border-color:rgba(255,255,255,.24);
      }
      .login-sheet .headline{
        font-weight:900; font-size:1.25rem; letter-spacing:.3px;
      }
      .login-sheet .sub{
        color:#bcd3ff; font-size:.98rem; margin-top:2px;
      }

      /* Bigger inputs with higher contrast for the keyboard */
      .login-fields{ margin-top:12px; display:grid; gap:10px }
      .login-fields .input{
        background:#0c1226; border-color:#2b3a6a; color:#eaf1ff; font-size:18px; min-height:56px; border-radius:14px;
      }
      .login-fields .input::placeholder{ color:#9db4e5 }
      .login-fields .input:focus{ border-color:#7ba3ff; box-shadow:0 0 0 4px rgba(123,163,255,.28) }

      .login-actions{ margin-top:8px; display:grid; gap:10px }
      .login-actions .btn{
        font-size:18px; min-height:56px; border-radius:16px;
        touch-action:manipulation;
      }

      /* Sticky bottom safe-area spacer so the button stays tappable above home bar */
      .login-safe{
        height: calc(env(safe-area-inset-bottom) + 6px);
      }

      /* ‚ÄúResume session‚Äù banner harmonized with dark sheet */
      .resume{
        border-color:#7ba3ff; background:#0f1a39; color:#dbe7ff;
      }
      .btn-ghost{ background:#0c1226; color:#eaf1ff; border-color:#2b3a6a }
      .btn-ghost:hover{ background:#0f1630 }
    }

    /* Extra-fat targets for coarse pointers (some tablets) */
    @media (pointer:coarse){
      .btn, .input{ min-height:58px }
      .btn-lg{ min-height:64px }
    }

    /* 100dvh support so sheet can fill screen behind keyboard correctly */
    .vh { min-height: 100vh; }
    @supports (height: 100dvh){
      .vh { min-height: 100dvh; }
    }
  </style>
</head>
<body>
  <!-- HERO -->
  <header class="hero">
    <div class="hero-inner">
      <div class="brand">
        <div class="logo" aria-hidden="true">üéÆ</div>
        <div>
          <div class="title">Game Hub</div>
          <div class="subtitle">Create a lobby, invite friends, or jump into solo play.</div>
        </div>
      </div>
      <div class="tabs" role="tablist" aria-label="Game Modes">
        <button id="tabbtn-multi" class="tab-btn" role="tab" aria-controls="panel-multi" aria-selected="true" onclick="showTab('multi')">üë• Multiplayer</button>
        <button id="tabbtn-single" class="tab-btn" role="tab" aria-controls="panel-single" aria-selected="false" onclick="showTab('single')">üéÆ Singleplayer</button>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <div class="shell">
    <!-- MULTIPLAYER -->
    <section id="panel-multi" class="grid" role="tabpanel" aria-labelledby="tabbtn-multi">
      <div class="left">
        <!-- DESKTOP: normal card | MOBILE: transforms into full-bleed login sheet -->
        <div id="loginForm" class="card">
          <div class="card-head"><div class="card-title">Welcome</div></div>
          <div class="card-body">
            <!-- Mobile login sheet (same DOM, different CSS) -->
            <div class="login-sheet vh" id="loginSheet">
              <div class="bigbrand">
                <div class="logo">üîê</div>
                <div>
                  <div class="headline">Sign in to continue</div>
                  <div class="sub">Bigger inputs ‚Ä¢ Easier taps ‚Ä¢ Mobile-friendly</div>
                </div>
              </div>

              <div class="login-fields">
                <label class="label" for="username">Username</label>
                <input autocomplete="username" inputmode="text" type="text" id="username" class="input" placeholder="e.g., PixelKnight" />
                <label class="label" for="password">Password</label>
                <input autocomplete="current-password" type="password" id="password" class="input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
              </div>

              <div class="login-actions">
                <button class="btn btn-lg btn-block" onclick="login()">Login</button>
              </div>

              <div class="resume" id="resumeBanner" aria-live="polite" role="region" style="display:none">
                <div class="info">You have an unfinished session.</div>
                <div class="actions">
                  <button class="btn-ghost btn-lg" id="resumeLobbyBtn">Rejoin Lobby</button>
                  <button class="btn-ghost btn-lg" id="resumeGameBtn">Reopen Game</button>
                  <button class="btn-ghost btn-lg" id="clearSessionBtn">Clear</button>
                </div>
              </div>

              <div id="error"></div>
              <div class="login-safe" aria-hidden="true"></div>
            </div>
          </div>
        </div>

        <div id="lobbyInterface" class="card" style="display:none">
          <div class="card-head">
            <div id="lobbyHeaderTitle" class="card-title">Start a Lobby</div>
          </div>
          <div class="card-body">
            <div class="row" style="align-items:flex-end">
              <div id="lobbyNameWrap" class="field">
                <label class="label" for="lobbyName">Lobby Name</label>
                <input type="text" id="lobbyName" class="input" placeholder="e.g., Friday Night Squad" />
              </div>
              <div class="field">
                <label class="label" for="gameType">Game</label>
                <select id="gameType" class="select">
                  <option value="cat">üê≠ Cat & Mouse</option>
                  <option value="grass">üåø Grass Realms</option>
                  <option value="estate">üè° Estate Defense</option>
                  <option value="mountain">üóª Mountain Blade Skirmish (4P)</option>
                  <option value="mountonline">üóªüåê Mountain Blade Online</option>
                  <option value="stockkings">üìà Stock Kings</option>
                  <option value="dutchblitz">üÉè Dutch Blitz Arena (4P)</option>
                </select>
              </div>
              <button id="createBtn" class="btn btn-lg" onclick="startLobby()">Start Lobby</button>
            </div>

            <div id="availLobbiesCard" class="card" style="margin-top:14px">
              <div class="card-head"><div class="card-title">Available Lobbies</div></div>
              <div class="card-body">
                <div id="lobbyList" class="lobbies"><!-- Lobby cards injected here --></div>
              </div>
            </div>

            <div id="playersCard" class="card" style="margin-top:14px">
              <div class="card-head"><div class="card-title">Lobby Players</div></div>
              <div class="card-body">
                <div id="lobbyPlayers" class="players"><!-- chips injected --></div>
                <div class="controls">
                  <button id="startBtn" class="btn btn-lg">üöÄ Start Game</button>
                  <button class="btn-ghost btn-lg" onclick="leaveLobby()">‚ùå Leave Lobby</button>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>

      <!-- RIGHT SIDEBAR -->
      <aside class="right">
        <div id="winsLeaderboard" class="card">
          <div class="card-head"><div class="card-title">üèÜ Top Players</div></div>
          <div class="card-body">
            <div id="leaderboardEntries" class="ladder"><!-- rows --></div>
          </div>
        </div>
      </aside>
    </section>

    <!-- SINGLEPLAYER -->
    <section id="panel-single" class="card" role="tabpanel" aria-labelledby="tabbtn-single" style="display:none">
      <div class="card-head">
        <div class="card-title">Singleplayer</div>
      </div>
      <div class="card-body">
        <p class="subtle" style="margin-top:0">Pick a game to play solo.</p>
        <div id="catalog" class="catalog"><!-- game cards --></div>
      </div>
    </section>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore, collection, addDoc, doc, updateDoc, onSnapshot,
      query, where, getDoc, getDocs, deleteDoc, limit, runTransaction
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    /* ---------- ROUTES / CONST (same as before) ---------- */
    const ROUTES = {
      cat:        "/game/catandmouse.html",
      grass:      "/game/grassrealms.html",
      estate:     "/game/estatedefense.html",
      mountain:   "/game/mountainblade.html",
      mountonline:"/game/mountonline.html",
      stockkings: "/game/stockkings.html",
      dutchblitz: "/game/dutchblitz.html",
      matchwars:  "/game/matchwars.html",
      flag:       "/game/Flag.html",
      microwars:  "/game/microwars.html",
      microwars2: "/game/microwaves2.html",
      microwars4: "/game/microwaves4.html",
      border:     "/game/border.html",
      mobamania:  "/game/CatLanes.html"
    };
    const AUTO_REDIRECT_GAMES = new Set(["cat","grass","mountain","stockkings","dutchblitz"]);
    const MAX_PLAYERS = { mountain: 4, stockkings: 8, dutchblitz: 4 };
    const getMaxPlayers = (gameType, fallback = Infinity) =>
      typeof MAX_PLAYERS[gameType] === "number" ? MAX_PLAYERS[gameType] : fallback;

    const app = initializeApp({
      apiKey: "AIzaSyB7twY7z31ucB6pGA8JC_HrVMZhA8lNaJA",
      authDomain: "bible-game-246c0.firebaseapp.com",
      projectId: "bible-game-246c0",
      storageBucket: "bible-game-246c0.appspot.com",
      messagingSenderId: "959619818996",
      appId: "1:959619818996:web:5a9fbf492e23c765e445a1"
    });
    const db = getFirestore(app);

    /* ---------- SINGLEPLAYER (unchanged) ---------- */
    const SINGLEPLAYER_GAMES = [
      { key: "microwars",  title: "Micro Wars",        emoji: "üî¨‚öîÔ∏è",    desc: "Blinkers & Soldiers RTS skirmishes. Drag-select, right-click to move/attack. Blink & Stim. Survive escalating waves.", route: ROUTES.microwars },
      { key: "microwars2", title: "Micro Wars Terran", emoji: "üõ∞Ô∏èü™ñ",    desc: "Terran-flavored variant: faster recruits, tactical pressure, hold the line longer.", route: ROUTES.microwars2 },
      { key: "microwars4", title: "Micro Wars Nexus",  emoji: "üí†‚ú®",    desc: "Altered tech flow & pacing. Time your power spikes and stabilize.", route: ROUTES.microwars4 },
      { key: "mobamania",  title: "MOBA Mania",        emoji: "üßô‚Äç‚ôÇÔ∏èüõ°Ô∏èüí†", desc: "Single-lane hero brawler with towers, minions, and abilities. Push to destroy the core.", route: ROUTES.mobamania },
      { key: "matchwars",  title: "MatchWars",         emoji: "üß©‚öîÔ∏è",    desc: "Match tiles to recruit, then steamroll the enemy stronghold. Quick & strategic.", route: ROUTES.matchwars },
      { key: "trials",     title: "Trials",            emoji: "‚öîÔ∏è",      desc: "Survive", route: ROUTES.border },
      { key: "flag",       title: "Flag Fight",        emoji: "üèÅ‚öîÔ∏è",    desc: "Command your army to capture flags and crush the enemy.", route: ROUTES.flag }
    ];
    function renderSingleplayer(){
      const el = document.getElementById('catalog');
      el.innerHTML = '';
      for(const g of SINGLEPLAYER_GAMES){
        const card = document.createElement('div'); card.className = 'game-card';
        const t = document.createElement('div'); t.className = 'game-title'; t.textContent = `${g.emoji} ${g.title}`;
        const d = document.createElement('div'); d.className = 'game-desc'; d.textContent = g.desc;
        const pr = document.createElement('div'); pr.className = 'play-row';
        const btn = document.createElement('button'); btn.className = 'btn btn-lg'; btn.textContent = 'Play';
        btn.addEventListener('click', ()=> window.location.href = g.route);
        pr.appendChild(btn);
        card.appendChild(t); card.appendChild(d); card.appendChild(pr);
        el.appendChild(card);
      }
    }
    renderSingleplayer();

    /* ---------- KEEP-LOGGED-IN + RESUME ---------- */
    const SK = { user:"gh.username", lastLobby:"gh.lastLobbyId", lastGame:"gh.lastGameType", lastTab:"gh.lastTab" };
    const save = (k,v)=> localStorage.setItem(k, v);
    const read = (k)=> localStorage.getItem(k);
    const del  = (k)=> localStorage.removeItem(k);

    const urlParams = new URLSearchParams(window.location.search);
    const urlUser = urlParams.get("username");
    let username = (urlUser ? urlUser.trim() : (read(SK.user) || "")).trim();
    let currentLobbyId = null;
    let isHost = false;
    let lobbyUnsub = null;

    if (urlUser) history.replaceState({}, "", window.location.pathname);

    const lastTab = read(SK.lastTab);
    if (lastTab === "single") showTab("single");

    if (username) { autoLogin(username); } else { showLoginUI(); maybeOfferResume(); }

    function isMultiVisible(){ return document.getElementById('panel-multi').style.display !== 'none'; }
    window.showTab = function(which){
      const isMulti = which === 'multi';
      document.getElementById('panel-multi').style.display = isMulti ? 'grid' : 'none';
      document.getElementById('panel-single').style.display = isMulti ? 'none' : 'block';
      document.getElementById('tabbtn-multi').setAttribute('aria-selected', String(isMulti));
      document.getElementById('tabbtn-single').setAttribute('aria-selected', String(!isMulti));
      save(SK.lastTab, which);
    };

    function persistSession(){ if (username) save(SK.user, username); save(SK.lastTab, isMultiVisible() ? "multi":"single"); }
    function clearSession(){ del(SK.user); del(SK.lastLobby); del(SK.lastGame); }

    function showLoginUI(){
      document.getElementById("loginForm").style.display = "block";
      document.getElementById("lobbyInterface").style.display = "none";
    }
    function enterLobbyUI(){
      document.getElementById("loginForm").style.display = "none";
      document.getElementById("lobbyInterface").style.display = "block";
      loadLobbies();
      loadLeaderboard();
      if (!window.__lobbyPoll) window.__lobbyPoll = setInterval(loadLobbies, 5000);
      document.getElementById("startBtn").addEventListener("click", startGame);
      document.getElementById("gameType").addEventListener("change", updateStartUI);
      updateStartUI();
    }

    async function login() {
      username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value.trim();
      if (!username || !password) return showError("‚ùå Enter username & password.");
      const userRef = doc(db, "users", username);
      const userSnap = await getDoc(userRef);
      if (!userSnap.exists() || userSnap.data().password !== password) return showError("‚ùå Invalid login.");
      enterLobbyUI(); persistSession(); maybeOfferResume();
    }
    async function autoLogin(name){
      try{
        const userRef = doc(db, "users", name);
        const userSnap = await getDoc(userRef);
        if (!userSnap.exists()) return showError("‚ùå Username not found in system.");
        username = name; enterLobbyUI(); persistSession(); maybeOfferResume();
      }catch(e){}
    }

    function updateStartUI(){
      const gt = document.getElementById("gameType").value;
      const title = document.getElementById("lobbyHeaderTitle");
      const nameWrap = document.getElementById("lobbyNameWrap");
      const createBtn = document.getElementById("createBtn");
      const lobbiesCard = document.getElementById("availLobbiesCard");
      const playersCard = document.getElementById("playersCard");

      const isQuickPlay = (gt === "mountonline");
      title.textContent = isQuickPlay ? "Quick Play" : "Start a Lobby";
      nameWrap.style.display = isQuickPlay ? "none" : "flex";
      createBtn.textContent = isQuickPlay ? "Play" : "Start Lobby";
      lobbiesCard.style.display = isQuickPlay ? "none" : "block";
      playersCard.style.display = isQuickPlay ? "none" : "block";
    }

    function gameLabel(type){
      return type==='grass' ? 'üåø Grass Realms' :
             type==='estate'? 'üè° Estate Defense' :
             type==='mountain'?'üóª Mountain Blade Skirmish (4P)' :
             type==='mountonline'?'üóªüåê Mountain Blade Online' :
             type==='stockkings'?'üìà Stock Kings' :
             type==='dutchblitz'?'üÉè Dutch Blitz Arena (4P)' :
             'üê≠ Cat & Mouse';
    }

    async function startLobby() {
      const gameType = document.getElementById("gameType").value;
      if (gameType === "mountonline") {
        if (!username) return showError("‚ùå You must be logged in.");
        save(SK.lastGame, "mountonline");
        window.location.href = `${ROUTES.mountonline}?username=${encodeURIComponent(username)}`;
        return;
      }
      const name = document.getElementById("lobbyName").value.trim();
      if (!name) return showError("Please enter a lobby name.");
      if (!['cat','grass','estate','mountain','stockkings','dutchblitz'].includes(gameType)) return showError("Invalid game type.");
      const lobby = await addDoc(collection(db, "lobbies"), {
        name, gameType, status: "waiting", players: [username], host: username, createdAt: Date.now()
      });
      currentLobbyId = lobby.id; isHost = true;
      save(SK.lastLobby, currentLobbyId); save(SK.lastGame, gameType);
      listenToLobby();
    }

    async function loadLobbies() {
      const qy = query(collection(db, "lobbies"), where("status", "==", "waiting"));
      const snap = await getDocs(qy);
      const list = document.getElementById("lobbyList");
      list.innerHTML = "";

      if (snap.empty) {
        const none = document.createElement("div"); none.className = "subtle";
        none.textContent = "No open lobbies. Start one above!";
        list.appendChild(none); return;
      }

      snap.forEach(async (docSnap) => {
        const data = docSnap.data();
        if (!data.players || data.players.length === 0) { try { await deleteDoc(doc(db, "lobbies", docSnap.id)); } catch(e){} return; }

        const card = document.createElement("div"); card.className = "lobby-card";

        const head = document.createElement("div"); head.style.display="flex"; head.style.justifyContent="space-between"; head.style.alignItems="center"; head.style.gap="8px";
        const titleWrap = document.createElement("div");
        const title = document.createElement("div"); title.style.fontWeight="800"; title.textContent = data.name || "Lobby";
        const meta = document.createElement("div"); meta.className="subtle";
        const cap = getMaxPlayers(data.gameType);
        const countTxt = isFinite(cap) ? `${(data.players||[]).length}/${cap} players` : `${(data.players||[]).length} players`;
        meta.textContent = `${countTxt} ‚Äî Host: ${data.host||"?"}`;
        titleWrap.appendChild(title); titleWrap.appendChild(meta);

        const badge = document.createElement("span"); badge.className="badge"; badge.textContent = gameLabel(data.gameType);
        head.appendChild(titleWrap); head.appendChild(badge);

        const progress = document.createElement("div"); progress.className="cap";
        const fill = document.createElement("i"); progress.appendChild(fill);
        fill.style.width = isFinite(cap) ? Math.min(100, Math.round(((data.players||[]).length / cap) * 100)) + "%" : "100%";

        const actions = document.createElement("div"); actions.style.display="flex"; actions.style.justifyContent="flex-end";
        const btn = document.createElement("button"); btn.className="btn btn-lg"; btn.textContent = "Join";
        if (isFinite(cap) && (data.players||[]).length >= cap) { btn.disabled = true; btn.className="btn-ghost btn-lg"; btn.textContent="Full"; }
        else { btn.addEventListener("click", ()=> joinLobby(docSnap.id)); }
        actions.appendChild(btn);

        card.appendChild(head); card.appendChild(progress); card.appendChild(actions);
        list.appendChild(card);
      });
    }

    async function joinLobby(id) {
      if (lobbyUnsub) { lobbyUnsub(); lobbyUnsub = null; }
      const ref = doc(db, "lobbies", id);
      try {
        await runTransaction(db, async (tx) => {
          const snap = await tx.get(ref);
          if (!snap.exists()) throw new Error("gone");
          const d = snap.data(); const players = Array.isArray(d.players)? d.players : [];
          const cap = getMaxPlayers(d.gameType);
          if (players.includes(username)) return;
          if (isFinite(cap) && players.length >= cap) throw new Error("Lobby is full");
          tx.update(ref, { players: [...players, username] });
        });
      } catch (e) { return showError("‚ùå Lobby is full."); }

      const snap = await getDoc(ref);
      if (!snap.exists()) return showError("Lobby no longer exists.");
      const data = snap.data();
      currentLobbyId = id; isHost = data.host === username;
      save(SK.lastLobby, currentLobbyId); save(SK.lastGame, data.gameType);
      listenToLobby();
    }

    function listenToLobby() {
      if (!currentLobbyId) return;
      if (lobbyUnsub) { lobbyUnsub(); lobbyUnsub = null; }

      const ref = doc(db, "lobbies", currentLobbyId);
      lobbyUnsub = onSnapshot(ref, async (docSnap) => {
        if (!docSnap.exists()) return;
        const data = docSnap.data();

        if (!data.players || data.players.length === 0) {
          try { await deleteDoc(ref); } catch(e){}
          currentLobbyId = null; isHost=false; save(SK.lastLobby, "");
          document.getElementById("lobbyPlayers").innerHTML = "";
          document.getElementById("startBtn").style.display = "none";
          if (lobbyUnsub) { lobbyUnsub(); lobbyUnsub = null; }
          loadLobbies(); return;
        }

        const container = document.getElementById("lobbyPlayers");
        container.innerHTML = "";
        const headerBadge = document.createElement("div");
        headerBadge.className = "badge";
        headerBadge.textContent = gameLabel(data.gameType);
        container.appendChild(headerBadge);

        for (const player of (data.players || [])) {
          const userRef = doc(db, "users", player);
          const userSnap = await getDoc(userRef);
          const wins = userSnap.exists() ? (userSnap.data().wins || 0) : 0;

          let color = "#cd7f32";
          if (wins >= 5 && wins < 10) color = "#c0c0c0";
          else if (wins >= 10 && wins < 15) color = "#ffd700";
          else if (wins >= 15 && wins < 25) color = "#3b82f6";
          else if (wins >= 25) color = "#ef4444";

          const chip = document.createElement("div"); chip.className="chip";
          const dot = document.createElement("span"); dot.className="dot"; dot.style.background=color;
          const name = document.createElement("span"); name.textContent = player;
          const w = document.createElement("span"); w.className="subtle"; w.textContent = `(${wins} wins)`;
          chip.appendChild(dot); chip.appendChild(name); chip.appendChild(w);
          container.appendChild(chip);
        }

        const startBtn = document.getElementById("startBtn");
        startBtn.style.display = (data.host === username) ? "inline-block" : "none";

        if (AUTO_REDIRECT_GAMES.has(data.gameType) && data.status === "started") {
          const route = ROUTES[data.gameType] || ROUTES.cat;
          save(SK.lastGame, data.gameType);
          save(SK.lastLobby, currentLobbyId);
          window.location.href = `${route}?gameId=${docSnap.id}&username=${encodeURIComponent(username)}`;
        }
      });
    }

    async function startGame() {
      if (!currentLobbyId) return;
      const ref = doc(db, "lobbies", currentLobbyId);
      const snap = await getDoc(ref); if (!snap.exists()) return;
      const data = snap.data();

      if (data.gameType === "estate") {
        const q = query(collection(db, "lobbies"), where("gameType","==","estate"), where("status","==","active"), limit(1));
        const active = await getDocs(q);
        let gid = null;
        if (!active.empty) gid = active.docs[0].id;
        else {
          const newRef = doc(collection(db, "lobbies"));
          await runTransaction(db, async (tx)=>{ tx.set(newRef, {
            name:`Estate Defense ‚Äî ${new Date().toLocaleTimeString()}`, gameType:"estate",
            status:"active", players:(data.players||[]), host:username, createdAt:Date.now()
          }); });
          gid = newRef.id;
        }
        try { await deleteDoc(ref); } catch(e){}
        save(SK.lastGame, "estate"); save(SK.lastLobby, gid);
        window.location.href = `${ROUTES.estate}?gameId=${gid}&username=${encodeURIComponent(username)}`;
        return;
      }
      await updateDoc(ref, { status: "started" });
    }

    async function loadLeaderboard() {
      const qy = query(collection(db, "users"));
      const snapshot = await getDocs(qy);
      const rows = [];
      snapshot.forEach(docSnap => rows.push({ name: docSnap.id, wins: docSnap.data().wins || 0 }));
      rows.sort((a,b)=> b.wins - a.wins);
      const box = document.getElementById("leaderboardEntries"); box.innerHTML = "";
      rows.slice(0,8).forEach((r, i)=>{
        const row = document.createElement("div"); row.className="lb-row";
        const left = document.createElement("div"); left.style.display="flex"; left.style.alignItems="center"; left.style.gap="10px";
        const rank = document.createElement("div"); rank.className="rank"; rank.textContent = i+1;
        const name = document.createElement("div"); name.style.fontWeight="800"; name.textContent = r.name;
        left.appendChild(rank); left.appendChild(name);
        const right = document.createElement("div"); right.className="subtle"; right.textContent = `üèÜ ${r.wins}`;
        row.appendChild(left); row.appendChild(right);
        box.appendChild(row);
      });
    }

    function showError(msg){ document.getElementById("error").textContent = msg; }

    function maybeOfferResume(){
      const banner = document.getElementById("resumeBanner");
      const lastLobby = localStorage.getItem(SK.lastLobby);
      const lastGame = localStorage.getItem(SK.lastGame);
      const resumeLobbyBtn = document.getElementById("resumeLobbyBtn");
      const resumeGameBtn  = document.getElementById("resumeGameBtn");
      const clearBtn       = document.getElementById("clearSessionBtn");

      banner.style.display = "none";
      if (document.getElementById("lobbyInterface").style.display !== "none") return;

      if (lastLobby) {
        banner.style.display = "flex";
        resumeLobbyBtn.style.display = "inline-block";
        resumeLobbyBtn.onclick = ()=> joinLobby(lastLobby);
      }
      if (lastGame && ROUTES[lastGame]) {
        banner.style.display = "flex";
        resumeGameBtn.style.display = "inline-block";
        resumeGameBtn.onclick = ()=> {
          const route = ROUTES[lastGame];
          const gid = localStorage.getItem(SK.lastLobby) || "";
          const glue = gid ? `?gameId=${gid}&username=${encodeURIComponent(username)}` : `?username=${encodeURIComponent(username)}`;
          window.location.href = route + glue;
        };
      }
      clearBtn.onclick = ()=> { localStorage.removeItem(SK.user); localStorage.removeItem(SK.lastLobby); localStorage.removeItem(SK.lastGame); banner.style.display="none"; };
    }

    // Enter on password triggers login (handy on mobile keyboards)
    document.getElementById("password").addEventListener("keydown", (e)=>{
      if (e.key === "Enter") { e.preventDefault(); login(); }
    });
  </script>
</body>
</html>



