<!DOCTYPE html> 
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ•¹ï¸ Game Hub & Multiplayer Lobby</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <style>
    :root{
      --bg:#f9fafb; --ink:#111827; --muted:#6b7280; --card:#ffffff; --br:#e5e7eb;
      --accent:#b91c1c; --accent-2:#991b1b; --accent-soft:#fee2e2; --good:#16a34a; --bad:#ef4444;
      --shadow:0 14px 40px rgba(15,23,42,.12); --radius:16px; --radius-sm:12px;
      --tap:56px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--ink);
      background:
        radial-gradient(1200px 600px at 0% -200px, rgba(248,113,113,.18) 0%, transparent 55%),
        radial-gradient(1200px 600px at 100% -260px, rgba(248,113,113,.2) 0%, transparent 60%),
        var(--bg);
    }

    /* Header */
    .hero{
        background: radial-gradient(1200px 600px at 50% -260px, #ef4444 0%, #b91c1c 55%, #7f1d1d 100%);
        color:#fff;
        padding:24px 16px 18px;
        position:relative;
        overflow:visible;            /* â¬…ï¸ let the dropdown extend below the header */
        box-shadow:var(--shadow);
        padding-top: calc(24px + env(safe-area-inset-top));
        z-index:20;                  /* optional, keeps header stack above main content */
      }

    .hero::after{
      content:"";
      position:absolute;
      inset:auto -40px -160px;
      height:280px;
      background:radial-gradient(600px 280px at 50% 120%, rgba(0,0,0,.35) 0%, transparent 70%);
      opacity:.4;
      pointer-events:none;
    }
    .hero-inner{
      max-width:1200px;
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      flex-wrap:wrap;
      position:relative;
      z-index:1;
    }
    .brand{ display:flex; align-items:center; gap:14px; }
    .logo{
      width:46px; height:46px;
      display:grid; place-items:center;
      background:rgba(255,255,255,.14);
      border:1px solid rgba(255,255,255,.26);
      border-radius:18px;
      font-size:24px;
      box-shadow:0 12px 30px rgba(15,23,42,.45);
      backdrop-filter:blur(10px);
    }
    .title{ font-weight:800; letter-spacing:.3px; font-size:1.4rem }
    .subtitle{ color:#ffe2e2; font-size:.94rem }

    /* Tabs + HUD on right */
    .hud{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .tabs{
      display:flex; gap:8px;
      background:rgba(15,23,42,.18);
      padding:4px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.22);
      overflow:auto;
      -webkit-overflow-scrolling:touch;
    }
    .tab-btn{
      appearance:none; border:none; cursor:pointer;
      padding:9px 16px; border-radius:999px;
      color:#fffbfb; background:transparent;
      font-weight:700; letter-spacing:.2px; transition:.2s ease; white-space:nowrap;
      font-size:.9rem;
    }
    .tab-btn:hover{ background:rgba(255,255,255,.18) }
    .tab-btn[aria-selected="true"]{
      background:#fff; color:#111827;
      box-shadow:0 2px 16px rgba(15,23,42,.35);
    }

    /* Chips & buttons */
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      background:#fff; color:#111827;
      border:1px solid rgba(148,163,184,.5);
      border-radius:999px; padding:8px 12px;
      font-weight:700; box-shadow:0 4px 16px rgba(15,23,42,.22);
      font-size:.82rem;
    }
    .pill i{ font-style:normal; font-weight:900; }

    .btn{
      cursor:pointer;
      font-weight:700;
      border:1px solid var(--accent);
      background:var(--accent);
      color:#fff;
      transition:background .18s, transform .08s, box-shadow .18s;
      padding:10px 14px;
      border-radius:12px;
      box-shadow:0 8px 18px rgba(185,28,28,.35);
    }
    .btn:hover{ background:var(--accent-2); transform:translateY(-1px); }
    .btn:active{ transform:translateY(0); box-shadow:0 4px 12px rgba(0,0,0,.2); }

    .btn-ghost{
      border-color:rgba(255,255,255,.8);
      background:rgba(15,23,42,.15);
      color:#fff;
      font-weight:700;
      padding:8px 12px;
      border-radius:12px;
      box-shadow:0 4px 14px rgba(15,23,42,.25);
    }
    .btn-ghost:hover{ background:rgba(255,255,255,.12); }

    /* Member dropdown */
    .member-wrap{ position:relative; }
    .member-btn{
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.8);
      background:rgba(15,23,42,.12);
      color:#fff;
      font-size:.82rem;
      font-weight:700;
      box-shadow:0 4px 14px rgba(15,23,42,.3);
    }
    .member-btn span.chevron{
      font-size:.78rem;
      opacity:.8;
      transform-origin:center;
      transition:transform .16s;
    }
    .member-btn.open span.chevron{ transform:rotate(180deg); }

    .member-panel{
      position:absolute;
      right:0;
      top:calc(100% + 8px);
      width:min(320px, 90vw);
      max-height:380px;
      background:#fff;
      border-radius:var(--radius-sm);
      border:1px solid var(--br);
      box-shadow:0 18px 40px rgba(15,23,42,.25);
      padding:0;
      overflow:auto;
      z-index:40;
    }
    .member-head{
      padding:10px 14px;
      border-bottom:1px solid var(--br);
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-weight:700;
      font-size:.9rem;
      background:#f9fafb;
      position:sticky;
      top:0;
      z-index:1;
    }
    .member-head small{ color:var(--muted); font-weight:500; }
    .member-list{ padding:4px 0; }
    .member-row{
      padding:8px 14px;
      display:flex;
      flex-direction:column;
      gap:2px;
      font-size:.85rem;
    }
    .member-row:nth-child(odd){ background:#f9fafb; }
    .member-name{ font-weight:600; }
    .member-meta{ color:var(--muted); font-size:.78rem; }

    /* Layout */
    .shell{
      max-width:1200px;
      margin:18px auto 32px;
      padding:0 12px 28px;
    }
    .grid{ display:grid; grid-template-columns:2fr 1fr; gap:18px }
    @media (max-width:980px){ .grid{ grid-template-columns:1fr } }

    /* Cards */
    .card{
      background:var(--card);
      border:1px solid var(--br);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card-head{
      padding:12px 16px;
      border-bottom:1px solid var(--br);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      background:linear-gradient(135deg,#fef2f2,#fff);
    }
    .card-title{ font-weight:800; font-size:.98rem; }
    .card-body{ padding:14px 16px; }

    /* Forms */
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center }
    .input, .select{
      padding:12px 12px;
      border:1px solid var(--br);
      border-radius:12px;
      background:#fff;
      font-size:15px;
      outline:none;
      min-height:42px;
      transition:border-color .16s, box-shadow .16s, background .16s;
    }
    .input:focus, .select:focus{
      border-color:#fecaca;
      box-shadow:0 0 0 3px rgba(239,68,68,.18);
      background:#fef2f2;
    }
    .btn-lg{ min-height:var(--tap); font-size:16px }
    .btn-block{ width:100% }

    /* Resume banner */
    .resume{
      display:none;
      margin:12px 0 0;
      padding:10px 12px;
      border:1px solid #fecaca;
      background:#fff1f2;
      color:#7f1d1d;
      border-radius:12px;
      display:flex;
      align-items:center;
      gap:10px;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .resume .info{ font-weight:700; font-size:.9rem; }
    .resume .actions{ display:flex; gap:8px; flex-wrap:wrap }

    /* Lobby list as cards */
    .lobbies{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap:14px;
    }
    .lobby-card{
      position:relative;
      border:1px solid var(--br);
      border-radius:14px;
      padding:12px 12px 11px;
      background:#ffffff;
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow:hidden;
    }
    .lobby-card::before{
      content:"";
      position:absolute;
      inset:0;
      background:radial-gradient(400px 260px at 0% 0%, rgba(248,113,113,.20), transparent 65%);
      opacity:0;
      transition:opacity .18s;
      pointer-events:none;
    }
    .lobby-card:hover::before{ opacity:1; }
    .lobby-main{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:8px;
    }
    .lobby-name{ font-weight:800; font-size:.95rem; }
    .lobby-meta{ color:var(--muted); font-size:.78rem; }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      font-size:11px;
      background:var(--accent-soft);
      color:var(--accent);
      border:1px solid #fecaca;
      font-weight:700;
      white-space:nowrap;
    }
    .subtle{ color:var(--muted); font-size:.9rem }

    .cap{
      height:7px;
      background:#f9fafb;
      border:1px solid var(--br);
      border-radius:999px;
      overflow:hidden;
    }
    .cap > i{
      display:block;
      height:100%;
      width:0%;
      background:linear-gradient(90deg,#22c55e,#f59e0b,#ef4444);
      transition:width .18s;
    }

    .lobby-actions{
      display:flex;
      justify-content:flex-end;
      margin-top:4px;
    }

    /* Players box */
    .players{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      padding-top:2px;
      border-top:1px dashed #e5e7eb;
      margin-top:10px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:7px 11px;
      border:1px solid var(--br);
      border-radius:999px;
      background:#fff7f7;
      font-size:.82rem;
      box-shadow:0 4px 10px rgba(15,23,42,.06);
    }
    .dot{ width:9px; height:9px; border-radius:50% }

    /* Leaderboard */
    .ladder{ display:grid; gap:10px }
    .lb-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:9px 11px;
      border:1px solid var(--br);
      border-radius:12px;
      background:#fff;
    }
    .rank{
      font-weight:900;
      width:26px; height:26px;
      border-radius:999px;
      display:grid; place-items:center;
      background:#fee2e2;
      color:#7f1d1d;
      font-size:.78rem;
    }

    /* Singleplayer catalog */
    .catalog{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(260px,1fr));
      gap:14px;
    }
    .game-card{
      border:1px solid var(--br);
      border-radius:14px;
      padding:14px;
      background:#fff;
      display:flex;
      flex-direction:column;
      gap:10px;
      box-shadow:0 10px 28px rgba(15,23,42,.08);
    }
    .game-title{
      font-weight:800;
      display:flex;
      align-items:center;
      gap:8px;
      font-size:.98rem;
    }
    .game-desc{ color:var(--muted); line-height:1.45; font-size:.9rem; }
    .play-row{ display:flex; justify-content:flex-end }

    /* Start/Leave buttons row */
    .controls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
      justify-content:flex-start;
    }
    #startBtn{ display:none }
    #error{ margin-top:6px; color:var(--bad); font-weight:700; font-size:.9rem; }

    /* Mobile polish */
    @media (max-width:720px){
      .row{ flex-direction:column; align-items:stretch }
      .input, .select, .btn{ width:100% }
      .btn{ min-height:var(--tap) }
      .tab-btn{ padding:11px 15px }
      .hero-inner{ gap:10px }
      .lobby-card .btn{ width:100% }
      .subtitle{ font-size:.88rem }
      .card{ border-radius:18px }
      body{ padding-bottom: calc(env(safe-area-inset-bottom) + 8px) }
      .member-panel{ right:auto; left:0; }
    }
  </style>
</head>
<body>
  <!-- HERO -->
  <header class="hero">
    <div class="hero-inner">
      <div class="brand">
        <div class="logo" aria-hidden="true">ğŸ®</div>
        <div>
          <div class="title">Game Hub</div>
          <div class="subtitle">Create a lobby, invite friends, or jump into solo play.</div>
        </div>
      </div>

      <!-- RIGHT HUD: tabs + Daily Users pill + Members + Logout -->
      <div class="hud">
        <div class="tabs" role="tablist" aria-label="Game Modes">
          <button id="tabbtn-multi" class="tab-btn" role="tab" aria-controls="panel-multi" aria-selected="true" onclick="showTab('multi')">ğŸ‘¥ Multiplayer</button>
          <button id="tabbtn-single" class="tab-btn" role="tab" aria-controls="panel-single" aria-selected="false" onclick="showTab('single')">ğŸ® Singleplayer</button>
        </div>

        <div id="dailyUsersPill" class="pill" title="Unique logins today (America/New_York)">
          ğŸ‘¤ Today: <i id="dailyUsersCount">0</i>
        </div>

        <div class="member-wrap">
          <button id="memberToggle" class="member-btn" type="button" onclick="toggleMembers()">
            ğŸ‘¥ Members <span class="chevron">â–¾</span>
          </button>
          <div id="memberPanel" class="member-panel" hidden>
            <div class="member-head">
              <span>Members</span>
              <small>Sorted by last login</small>
            </div>
            <div id="memberList" class="member-list">
              <!-- members injected -->
            </div>
          </div>
        </div>

        <button id="logoutBtn" class="btn-ghost" style="display:none" onclick="logout()">ğŸšª Logout</button>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <div class="shell">
    <!-- MULTIPLAYER -->
    <section id="panel-multi" class="grid" role="tabpanel" aria-labelledby="tabbtn-multi">
      <div class="left">
        <div id="loginForm" class="card">
          <div class="card-head"><div class="card-title">Welcome</div></div>
          <div class="card-body">
            <div class="row" style="margin-bottom:8px">
              <input autocomplete="username" inputmode="text" type="text" id="username" class="input" placeholder="Username" />
              <input autocomplete="current-password" type="password" id="password" class="input" placeholder="Password" />
              <button class="btn btn-lg" onclick="login()">Login</button>
            </div>
            <div class="resume" id="resumeBanner" aria-live="polite" role="region">
              <div class="info">You have an unfinished session.</div>
              <div class="actions">
                <button class="btn btn-lg" id="resumeLobbyBtn" style="background:#fff;color:#111;border-color:#ddd;box-shadow:none">Rejoin Lobby</button>
                <button class="btn btn-lg" id="resumeGameBtn" style="background:#fff;color:#111;border-color:#ddd;box-shadow:none">Reopen Game</button>
                <button class="btn btn-lg" id="clearSessionBtn" style="background:#fff;color:#111;border-color:#ddd;box-shadow:none">Clear</button>
              </div>
            </div>
            <div id="error"></div>
          </div>
        </div>

        <div id="lobbyInterface" class="card" style="display:none">
          <div class="card-head">
            <div id="lobbyHeaderTitle" class="card-title">Start a Lobby</div>
          </div>
          <div class="card-body">
            <div class="row" style="align-items:flex-end">
              <div id="lobbyNameWrap" style="flex:1 1 220px">
                <label class="subtle">Lobby Name</label>
                <input type="text" id="lobbyName" class="input" placeholder="e.g., Friday Night Squad" />
              </div>
              <div style="flex:1 1 220px">
                <label class="subtle">Game</label>
                <select id="gameType" class="select">
                  <option value="cat">ğŸ­ Cat & Mouse</option>
                  <option value="catmobile">ğŸ­ğŸ“± Cat vs Mouse Mobile (8P)</option>
                  <option value="grass">ğŸŒ¿ Grass Realms</option>
                  <option value="estate">ğŸ¡ Estate Defense</option>
                  <option value="mountain">ğŸ—» Mountain Blade Skirmish (4P)</option>
                  <option value="mountonline">ğŸ—»ğŸŒ Mountain Blade Online</option>
                  <option value="rock">âœŠğŸ“„âœ‚ï¸ Rock Paper Scissors MMO</option>
                  <option value="stockkings">ğŸ“ˆ Stock Kings</option>
                  <option value="dutchblitz">ğŸƒ Dutch Blitz Arena (4P)</option>
                  <option value="splinters">ğŸª„ Splinters (4P)</option>
                  <option value="spelltower">ğŸ—¼ Spell Tower (8P)</option>
                  <option value="zombiezone">ğŸ§Ÿâ€â™‚ï¸ Zombie Zone (4P)</option>
                  <option value="biblegame">ğŸ“– Bible Game (12P)</option>
                  <option value="historyrush">ğŸ›ï¸ History Rush (4P)</option>
                  <option value="crowncouncil">ğŸ‘‘ Faction Forge (2P)</option>
                  <option value="rogueduel">ğŸ‚¡ Rogue Duel (2P)</option>
                  <option value="thegame">ğŸƒ The Game (5P)</option>
                  <option value="castledefense">ğŸ° Castle Defense (4P)</option>
                  <!-- NEW MULTIPLAYER -->
                  <option value="trumprev">ğŸ° Base Defense: Revenge (4P)</option>
                </select>
              </div>
              <button id="createBtn" class="btn btn-lg" onclick="startLobby()">Start Lobby</button>
            </div>

            <div id="availLobbiesCard" class="card" style="margin-top:14px">
              <div class="card-head"><div class="card-title">Available Lobbies</div></div>
              <div class="card-body" style="padding-top:10px">
                <div id="lobbyList" class="lobbies"><!-- Lobby cards injected here --></div>
              </div>
            </div>

            <div id="playersCard" class="card" style="margin-top:14px">
              <div class="card-head"><div class="card-title">Lobby Players</div></div>
              <div class="card-body">
                <div id="lobbyPlayers" class="players"><!-- chips injected --></div>
                <div class="controls">
                  <button id="startBtn" class="btn btn-lg">ğŸš€ Start Game</button>
                  <button class="btn btn-lg" style="background:#fff;color:#111;border-color:#ddd;box-shadow:none" onclick="leaveLobby()">âŒ Leave Lobby</button>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>

      <!-- RIGHT SIDEBAR -->
      <aside class="right">
        <div id="winsLeaderboard" class="card">
          <div class="card-head"><div class="card-title">ğŸ† Top Players</div></div>
          <div class="card-body">
            <div id="leaderboardEntries" class="ladder"><!-- rows --></div>
          </div>
        </div>
      </aside>
    </section>

    <!-- SINGLEPLAYER -->
    <section id="panel-single" class="card" role="tabpanel" aria-labelledby="tabbtn-single" style="display:none">
      <div class="card-head">
        <div class="card-title">Singleplayer</div>
      </div>
      <div class="card-body">
        <p class="subtle" style="margin-top:0">Pick a game to play solo.</p>
        <div id="catalog" class="catalog"><!-- game cards --></div>
      </div>
    </section>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore, collection, addDoc, doc, setDoc, updateDoc, onSnapshot,
      query, where, getDoc, getDocs, deleteDoc, limit, runTransaction,
      serverTimestamp, getCountFromServer, orderBy
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ---------- ROUTES ----------
    const ROUTES = {
      cat:        "/game/catandmouse.html",
      grass:      "/game/grassrealms.html",
      estate:     "/game/estatedefense.html",
      mountain:   "/game/mountainblade.html",
      mountonline:"/game/mountonline.html",
      rock:       "/game/rock.html",
      stockkings: "/game/stockkings.html",
      dutchblitz: "/game/dutchblitz.html",
      splinters:  "/game/Splinters.html",
      spelltower: "/game/spelltower.html",
      zombiezone: "/game/zombiezone.html",
      biblegame:  "/game/biblegame.html",
      historyrush:"/game/historyrush.html",
      crowncouncil:"/game/crowncouncil.html",
      thegame:    "/game/thegame.html",
      matchwars:  "/game/matchwars.html",
      catmobile:  "/game/catmousemobile.html",
      flag:       "/game/Flag.html",
      microwars:  "/game/microwars.html",
      microwars2: "/game/microwaves2.html",
      microwars4: "/game/microwaves4.html",   // legacy route reused
      border:     "/game/border.html",
      mobamania:  "/game/CatLanes.html",
      roguecards: "/game/roguecard.html",
      rogueduel:  "/game/rogueduel.html",
      versemem:   "/game/verse-memorizer.html",
      village:    "/game/villagelobby.html",
      castledefense: "/game/castlepanic.html",
      // NEW multiplayer alias for former Micro Wars Nexus
      trumprev:   "/game/donrevenge.html"
    };

    const AUTO_REDIRECT_GAMES = new Set([
      "cat","grass","mountain","stockkings","dutchblitz","catmobile","splinters",
      "spelltower","thegame","zombiezone","biblegame","historyrush","crowncouncil",
      "castledefense","rogueduel","trumprev"
    ]);

    const MAX_PLAYERS = {
      mountain: 4,
      dutchblitz: 4,
      splinters: 4,
      spelltower: 8,
      zombiezone: 4,
      stockkings: 8,
      biblegame: 20,
      catmobile: 8,
      historyrush: 4,
      thegame: 5,
      crowncouncil: 2,
      rogueduel: 2,
      castledefense: 4,
      trumprev: 4
    };
    const getMaxPlayers = (gameType, fallback = Infinity) =>
      typeof MAX_PLAYERS[gameType] === "number" ? MAX_PLAYERS[gameType] : fallback;

    const SINGLEPLAYER_GAMES = [
      { key: "village",    title: "Village",        emoji: "ğŸ˜ï¸",     desc: "Build and manage your village.", route: ROUTES.village, requiresUser:true, autoUsername:true },
      { key: "versemem",  title: "Verse Memorizer", emoji: "ğŸ“–ğŸ§ ",   desc: "Drill scripture, track streaks, and race the clock. Launches with your username.", route: ROUTES.versemem, requiresUser:true, autoUsername:true },
      { key: "microwars", title: "Micro Wars",      emoji: "ğŸ”¬âš”ï¸",   desc: "Blinkers & Soldiers RTS skirmishes.", route: ROUTES.microwars },
      { key: "microwars2",title: "Micro Wars Terran", emoji: "ğŸ›°ï¸ğŸª–", desc: "Terran-flavored variant.", route: ROUTES.microwars2 },
       { key: "microwars4",title: "Base Defense", emoji: "ğŸ›°ï¸ğŸª–", desc: "Terran-flavored variant.", route: ROUTES.microwars4 },
      { key: "mobamania", title: "MOBA Mania",      emoji: "ğŸ§™â€â™‚ï¸ğŸ›¡ï¸ğŸ’ ", desc: "Single-lane hero brawler.", route: ROUTES.mobamania },
      { key: "matchwars", title: "MatchWars",       emoji: "ğŸ§©âš”ï¸",   desc: "Match to recruit & steamroll.", route: ROUTES.matchwars },
      { key: "trials",    title: "Trials",          emoji: "âš”ï¸",     desc: "Survive.", route: ROUTES.border },
      { key: "roguecards",title: "Rogue Cards",     emoji: "ğŸ‚ ",     desc: "Solo deckbuilder run.", route: ROUTES.roguecards },
      { key: "flag",      title: "Flag Fight",      emoji: "ğŸâš”ï¸",   desc: "Capture flags and crush the core.", route: ROUTES.flag }
    ];

    // ---------- FIREBASE ----------
    const firebaseConfig = {
      apiKey: "AIzaSyB7twY7z31ucB6pGA8JC_HrVMZhA8lNaJA",
      authDomain: "bible-game-246c0.firebaseapp.com",
      projectId: "bible-game-246c0",
      storageBucket: "bible-game-246c0.appspot.com",
      messagingSenderId: "959619818996",
      appId: "1:959619818996:web:5a9fbf492e23c765e445a1"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ---------- DAILY USERS â€” per-user-per-day (NO HOT DOCS) ----------
    const TZ = "America/New_York";
    const fmtYMD = new Intl.DateTimeFormat("en-CA",{ timeZone:TZ, year:"numeric", month:"2-digit", day:"2-digit" });
    const todayNY = () => fmtYMD.format(new Date()); // "YYYY-MM-DD"
    const DU_KEY = () => "gh.du.marked." + todayNY();

    const fmtLastLogin = new Intl.DateTimeFormat("en-US", {
      timeZone: TZ,
      month: "short",
      day: "2-digit",
      hour: "2-digit",
      minute: "2-digit",
      hour12: true
    });

    async function markDailyUserOnce(uid){
      if (!uid) return;
      const key = DU_KEY();
      if (sessionStorage.getItem(key)) return;
      sessionStorage.setItem(key, "1");
      const dateKey = todayNY();
      await setDoc(doc(db, "metrics_dailyUsers", dateKey, "users", uid), { ts: serverTimestamp() }, { merge: true });
    }

    async function fetchDailyUserCount(){
      const dateKey = todayNY();
      const col = collection(db, "metrics_dailyUsers", dateKey, "users");
      const snap = await getCountFromServer(col);
      return snap.data().count || 0;
    }

    async function showDailyUsersPill(){
      const countEl = document.getElementById("dailyUsersCount");
      const pill = document.getElementById("dailyUsersPill");
      try{
        const c = await fetchDailyUserCount();
        countEl.textContent = String(c);
        pill.title = `Unique logins on ${todayNY()} (${TZ})`;
      }catch(e){ /* ignore visual errors */ }
    }
    showDailyUsersPill();

    // ---------- STORAGE KEYS & SESSION HELPERS ----------
    const SK = {
      user: "gh.username",
      lastLobby: "gh.lastLobbyId",
      lastGame: "gh.lastGameType",
      lastTab: "gh.lastTab",
      nextRoute: "gh.nextRoute"
    };
    const save = (k,v)=> localStorage.setItem(k, v);
    const read = (k)=> localStorage.getItem(k);
    const del  = (k)=> localStorage.removeItem(k);

    function persistSession() {
      if (username) save(SK.user, username);
      const activeTab = isMultiVisible() ? "multi" : "single";
      save(SK.lastTab, activeTab);
    }
    function clearSession() {
      del(SK.user); del(SK.lastLobby); del(SK.lastGame); del(SK.lastTab); del(SK.nextRoute);
    }

    // ---------- TABS ----------
    function isMultiVisible(){ return document.getElementById('panel-multi').style.display !== 'none'; }
    window.showTab = function(which){
      const isMulti = which === 'multi';
      document.getElementById('panel-multi').style.display = isMulti ? 'grid' : 'none';
      document.getElementById('panel-single').style.display = isMulti ? 'none' : 'block';
      document.getElementById('tabbtn-multi').setAttribute('aria-selected', String(isMulti));
      document.getElementById('tabbtn-single').setAttribute('aria-selected', String(!isMulti));
      save(SK.lastTab, which);
    };

    function playSingle(g){
      if (g.requiresUser && !username){
        save(SK.nextRoute, g.key);
        showTab('multi');
        showError("ğŸ”’ Please log in to play this game.");
        const u = document.getElementById('username'); if (u) u.focus();
        window.scrollTo({ top: 0, behavior: 'smooth' });
        return;
      }
      let url = g.route;
      if (g.autoUsername && username){
        url += (url.includes('?') ? '&' : '?') + `username=${encodeURIComponent(username)}`;
      }
      window.location.href = url;
    }

    function renderSingleplayer(){
      const el = document.getElementById('catalog');
      el.innerHTML = '';
      for(const g of SINGLEPLAYER_GAMES){
        const card = document.createElement('div'); card.className = 'game-card';
        const t = document.createElement('div'); t.className = 'game-title'; t.textContent = `${g.emoji} ${g.title}`;
        const d = document.createElement('div'); d.className = 'game-desc'; d.textContent = g.desc;
        const pr = document.createElement('div'); pr.className = 'play-row';
        const btn = document.createElement('button'); btn.className = 'btn btn-lg'; btn.textContent = 'Play';
        btn.addEventListener('click', ()=> playSingle(g));
        pr.appendChild(btn);
        card.appendChild(t); card.appendChild(d); card.appendChild(pr);
        el.appendChild(card);
      }
    }
    renderSingleplayer();

    // ---------- LOBBY LOGIC ----------
    const urlParams = new URLSearchParams(window.location.search);
    const urlUser = urlParams.get("username");
    let username = (urlUser ? urlUser.trim() : (read(SK.user) || "")).trim();
    let currentLobbyId = null;
    let isHost = false;
    let lobbyUnsub = null;

    if (urlUser) {
      history.replaceState({}, "", window.location.pathname);
    }

    const lastTab = read(SK.lastTab);
    if (lastTab === "single") showTab("single");

    if (username) { autoLogin(username); }

    function openPendingRouteIfAny(){
      const key = read(SK.nextRoute);
      if (!key) return;
      const g = SINGLEPLAYER_GAMES.find(x => x.key === key);
      del(SK.nextRoute);
      if (!g) return;
      let url = g.route;
      if (g.autoUsername && username){
        url += (url.includes('?') ? '&' : '?') + `username=${encodeURIComponent(username)}`;
      }
      window.location.href = url;
    }

    async function login() {
      username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value.trim();
      if (!username || !password) { return showError("âŒ Enter username & password."); }
      const userRef = doc(db, "users", username);
      const userSnap = await getDoc(userRef);
      if (!userSnap.exists() || userSnap.data().password !== password) {
        return showError("âŒ Invalid login.");
      }

      // update last login timestamp
      await setDoc(userRef, { lastLogin: serverTimestamp() }, { merge: true });

      // âœ… Count unique daily user safely
      await markDailyUserOnce(username);
      await showDailyUsersPill();

      enterLobbyUI();
      persistSession();
      maybeOfferResume();
      openPendingRouteIfAny();
    }

    async function autoLogin(name) {
      try{
        const userRef = doc(db, "users", name);
        const userSnap = await getDoc(userRef);
        if (!userSnap.exists()) { return showError("âŒ Username not found in system."); }
        username = name;

        // update last login timestamp for auto-login too
        await setDoc(userRef, { lastLogin: serverTimestamp() }, { merge: true });

        await markDailyUserOnce(username);
        await showDailyUsersPill();

        enterLobbyUI();
        persistSession();
        maybeOfferResume();
        openPendingRouteIfAny();
      }catch(e){ /* ignore */ }
    }

    function enterLobbyUI() {
      document.getElementById("loginForm").style.display = "none";
      document.getElementById("lobbyInterface").style.display = "block";
      const lo = document.getElementById('logoutBtn'); if (lo) lo.style.display = 'inline-flex';
      loadLobbies();
      loadLeaderboard();
      if (!window.__lobbyPoll){
        window.__lobbyPoll = setInterval(loadLobbies, 5000);
      }
      document.getElementById("startBtn").addEventListener("click", startGame);
      document.getElementById("gameType").addEventListener("change", updateStartUI);
      updateStartUI();
    }

    function showLoginUI() {
      document.getElementById("loginForm").style.display = "block";
      document.getElementById("lobbyInterface").style.display = "none";
      const lo = document.getElementById('logoutBtn'); if (lo) lo.style.display = 'none';
    }

    function gameLabel(type){
      return type==='grass' ? 'ğŸŒ¿ Grass Realms' :
             type==='estate'? 'ğŸ¡ Estate Defense' :
             type==='mountain'?'ğŸ—» Mountain Blade Skirmish (4P)' :
             type==='mountonline'?'ğŸ—»ğŸŒ Mountain Blade Online' :
             type==='rock'?'âœŠğŸ“„âœ‚ï¸ RPS MMO' :
             type==='stockkings'?'ğŸ“ˆ Stock Kings' :
             type==='dutchblitz'?'ğŸƒ Dutch Blitz Arena (4P)' :
             type==='splinters'?'ğŸª„ Splinters (4P)' :
             type==='spelltower'?'ğŸ—¼ Spell Tower (8P)' :
             type==='zombiezone'?'ğŸ§Ÿâ€â™‚ï¸ Zombie Zone (4P)' :
             type==='biblegame'?'ğŸ“– Bible Game (20P)' :
             type==='historyrush'?'ğŸ›ï¸ History Rush (4P)' :
             type==='catmobile'?'ğŸ­ğŸ“± Cat vs Mouse Mobile (8P)' :
             type==='thegame'?'ğŸƒ The Game (5P)' :
             type==='crowncouncil'?'ğŸ‘‘ Faction Forge (2P)' :
             type==='castledefense'?'ğŸ° Castle Defense (4P)' :
             type==='rogueduel'?'ğŸ‚¡ Rogue Duel (2P)' :
             type==='trumprev'?'ğŸ° Base Defense: Revenge (4P)' :
             'ğŸ­ Cat & Mouse';
    }

    function updateStartUI(){
      const gt = document.getElementById("gameType").value;
      const title = document.getElementById("lobbyHeaderTitle");
      const nameWrap = document.getElementById("lobbyNameWrap");
      const createBtn = document.getElementById("createBtn");
      const lobbiesCard = document.getElementById("availLobbiesCard");
      const playersCard = document.getElementById("playersCard");

      const isQuickPlay = (gt === "mountonline" || gt === "rock");

      title.textContent = isQuickPlay ? "Quick Play" : "Start a Lobby";
      nameWrap.style.display = isQuickPlay ? "none" : "block";
      createBtn.textContent = isQuickPlay ? "Play" : "Start Lobby";
      lobbiesCard.style.display = isQuickPlay ? "none" : "block";
      playersCard.style.display = isQuickPlay ? "none" : "block";
    }

    async function startLobby() {
      const gameType = document.getElementById("gameType").value;

      if (gameType === "mountonline" || gameType === "rock") {
        if (!username) return showError("âŒ You must be logged in.");
        const route = ROUTES[gameType];
        save(SK.lastGame, gameType);
        window.location.href = `${route}?username=${encodeURIComponent(username)}`;
        return;
      }

      const name = document.getElementById("lobbyName").value.trim();
      if (!name) return showError("Please enter a lobby name.");

      if (!['cat','catmobile','grass','estate','mountain','stockkings','thegame','dutchblitz','splinters','spelltower','zombiezone','biblegame','historyrush','crowncouncil','castledefense','rogueduel','trumprev'].includes(gameType)) {
        return showError("Invalid game type.");
      }
      const lobby = await addDoc(collection(db, "lobbies"), {
        name, gameType, status: "waiting", players: [username], host: username, createdAt: Date.now()
      });
      currentLobbyId = lobby.id; isHost = true;
      save(SK.lastLobby, currentLobbyId);
      save(SK.lastGame, gameType);
      listenToLobby();
    }

    async function loadLobbies() {
      const qy = query(collection(db, "lobbies"), where("status", "==", "waiting"));
      const snap = await getDocs(qy);
      const list = document.getElementById("lobbyList");
      list.innerHTML = "";

      if (snap.empty) {
        const none = document.createElement("div"); none.className = "subtle";
        none.textContent = "No open lobbies. Start one above!";
        list.appendChild(none); return;
      }

      snap.forEach(async (docSnap) => {
        const data = docSnap.data();
        if (!data.players || data.players.length === 0) {
          try { await deleteDoc(doc(db, "lobbies", docSnap.id)); } catch(e){}
          return;
        }

        const card = document.createElement("div"); card.className = "lobby-card";

        const head = document.createElement("div");
        head.className = "lobby-main";
        const titleWrap = document.createElement("div");
        const title = document.createElement("div"); title.className="lobby-name"; title.textContent = data.name || "Lobby";
        const meta = document.createElement("div"); meta.className="lobby-meta";

        const cap = getMaxPlayers(data.gameType);
        const playerCount = (data.players || []).length;

        meta.textContent =
          (isFinite(cap) ? `${playerCount}/${cap} players` : `${playerCount} players`) +
          ` â€¢ Host: ${data.host || "?"}`;

        titleWrap.appendChild(title);
        titleWrap.appendChild(meta);

        const badge = document.createElement("span"); badge.className="badge"; badge.textContent = gameLabel(data.gameType);
        head.appendChild(titleWrap); head.appendChild(badge);

        const progress = document.createElement("div"); progress.className="cap";
        const fill = document.createElement("i"); progress.appendChild(fill);
        if (isFinite(cap)) {
          const pct = Math.min(100, Math.round((playerCount / cap) * 100));
          fill.style.width = pct + "%";
        } else { fill.style.width = "100%"; }

        const actions = document.createElement("div"); actions.className="lobby-actions";
        const btn = document.createElement("button"); btn.className="btn btn-lg"; btn.textContent = "Join";
        if (isFinite(cap) && playerCount >= cap) {
          btn.disabled = true;
          btn.className="btn btn-lg";
          btn.style.background="#fff";
          btn.style.color="#111";
          btn.style.borderColor="#ddd";
          btn.style.boxShadow="none";
          btn.textContent="Full";
        } else {
          btn.addEventListener("click", ()=> joinLobby(docSnap.id));
        }
        actions.appendChild(btn);

        card.appendChild(head);
        card.appendChild(progress);
        card.appendChild(actions);
        list.appendChild(card);
      });
    }

    async function joinLobby(id) {
      if (lobbyUnsub) { lobbyUnsub(); lobbyUnsub = null; }
      const ref = doc(db, "lobbies", id);
      try {
        await runTransaction(db, async (tx) => {
          const snap = await tx.get(ref);
          if (!snap.exists()) throw new Error("gone");
          const d = snap.data(); const players = Array.isArray(d.players)? d.players : [];
          const cap = getMaxPlayers(d.gameType);
          if (players.includes(username)) return;
          if (isFinite(cap) && players.length >= cap) throw new Error("Lobby is full");
          tx.update(ref, { players: [...players, username] });
        });
      } catch (e) { return showError("âŒ Lobby is full."); }

      const snap = await getDoc(ref);
      if (!snap.exists()) return showError("Lobby no longer exists.");
      const data = snap.data();
      currentLobbyId = id; isHost = data.host === username;
      save(SK.lastLobby, currentLobbyId);
      save(SK.lastGame, data.gameType);
      listenToLobby();
    }

    function listenToLobby() {
      if (!currentLobbyId) return;
      if (lobbyUnsub) { lobbyUnsub(); lobbyUnsub = null; }

      const ref = doc(db, "lobbies", currentLobbyId);
      lobbyUnsub = onSnapshot(ref, async (docSnap) => {
        if (!docSnap.exists()) return;
        const data = docSnap.data();

        if (!data.players || data.players.length === 0) {
          try { await deleteDoc(ref); } catch(e){}
          currentLobbyId = null; isHost=false;
          save(SK.lastLobby, "");
          document.getElementById("lobbyPlayers").innerHTML = "";
          document.getElementById("startBtn").style.display = "none";
          if (lobbyUnsub) { lobbyUnsub(); lobbyUnsub = null; }
          loadLobbies(); return;
        }

        const container = document.getElementById("lobbyPlayers");
        container.innerHTML = "";
        const headerBadge = document.createElement("div");
        headerBadge.className = "badge";
        headerBadge.textContent = gameLabel(data.gameType);
        container.appendChild(headerBadge);

        for (const player of (data.players || [])) {
          const userRef = doc(db, "users", player);
          const userSnap = await getDoc(userRef);
          const wins = userSnap.exists() ? (userSnap.data().wins || 0) : 0;

          let color = "#cd7f32";
          if (wins >= 5 && wins < 10) color = "#c0c0c0";
          else if (wins >= 10 && wins < 15) color = "#ffd700";
          else if (wins >= 15 && wins < 25) color = "#f59e0b";
          else if (wins >= 25) color = "#ef4444";

          const chip = document.createElement("div"); chip.className="chip";
          const dot = document.createElement("span"); dot.className="dot"; dot.style.background=color;
          const name = document.createElement("span"); name.textContent = player;
          const w = document.createElement("span"); w.className="subtle"; w.textContent = `(${wins} wins)`;
          chip.appendChild(dot); chip.appendChild(name); chip.appendChild(w);
          container.appendChild(chip);
        }

        const startBtn = document.getElementById("startBtn");
        startBtn.style.display = (data.host === username) ? "inline-block" : "none";

        if (AUTO_REDIRECT_GAMES.has(data.gameType) && data.status === "started") {
          const route = ROUTES[data.gameType] || ROUTES.cat;
          save(SK.lastGame, data.gameType);
          save(SK.lastLobby, currentLobbyId);
          window.location.href = `${route}?gameId=${docSnap.id}&username=${encodeURIComponent(username)}`;
        }
      });
    }

    // Estate Defense special-case
    async function joinOrCreateActiveEstate(extraPlayers) {
      const unique = (arr) => Array.from(new Set(arr.filter(Boolean)));
      const qActive = query(collection(db, "lobbies"), where("gameType","==","estate"), where("status","==","active"), limit(1));
      const snap = await getDocs(qActive);

      if (!snap.empty) {
        const targetRef = doc(db, "lobbies", snap.docs[0].id);
        try {
          const activeId = await runTransaction(db, async (tx) => {
            const cur = await tx.get(targetRef);
            if (!cur.exists()) throw new Error("gone");
            const d = cur.data();
            if (d.status !== "active" || d.gameType !== "estate") throw new Error("not_active");
            const merged = unique([...(d.players || []), ...extraPlayers]);
            tx.update(targetRef, { players: merged });
            return targetRef.id;
          });
          return activeId;
        } catch(e){ /* fall through */ }
      }

      const newRef = doc(collection(db, "lobbies"));
      const payload = {
        name:`Estate Defense â€” ${new Date().toLocaleTimeString()}`,
        gameType:"estate", category:"estate-defense", status:"active",
        players:unique(extraPlayers), host:username, createdAt:Date.now()
      };
      await runTransaction(db, async (tx)=>{ tx.set(newRef, payload); });
      return newRef.id;
    }

    async function startGame() {
      if (!currentLobbyId) return;
      const ref = doc(db, "lobbies", currentLobbyId);
      const snap = await getDoc(ref); if (!snap.exists()) return;
      const data = snap.data();

      if (data.gameType === "estate") {
        const playersFromThisLobby = data.players || [username];
        const activeId = await joinOrCreateActiveEstate(playersFromThisLobby);
        try { await deleteDoc(ref); } catch(e){}
        const route = ROUTES.estate;
        save(SK.lastGame, "estate");
        save(SK.lastLobby, activeId);
        window.location.href = `${route}?gameId=${activeId}&username=${encodeURIComponent(username)}`;
        return;
      }
      await updateDoc(ref, { status: "started" });
    }

    async function leaveLobby() {
      if (!currentLobbyId) return;
      const ref = doc(db, "lobbies", currentLobbyId);
      const snap = await getDoc(ref);
      if (snap.exists()) {
        const data = snap.data();
        const players = (data.players || []).filter(p => p !== username);
        if (players.length > 0) { await updateDoc(ref, { players }); }
        else { try { await deleteDoc(ref); } catch(e){} }
      }
      currentLobbyId = null; isHost=false;
      if (lobbyUnsub) { lobbyUnsub(); lobbyUnsub=null; }
      document.getElementById("lobbyPlayers").innerHTML = "";
      document.getElementById("startBtn").style.display = "none";
      loadLobbies();
      save(SK.lastLobby, "");
    }

    async function loadLeaderboard() {
      const qy = query(collection(db, "users"));
      const snapshot = await getDocs(qy);
      const rows = [];
      snapshot.forEach(docSnap => rows.push({ name: docSnap.id, wins: docSnap.data().wins || 0 }));
      rows.sort((a,b)=> b.wins - a.wins);
      const box = document.getElementById("leaderboardEntries"); box.innerHTML = "";
      rows.slice(0,8).forEach((r, i)=>{
        const row = document.createElement("div"); row.className="lb-row";
        const left = document.createElement("div"); left.style.display="flex"; left.style.alignItems="center"; left.style.gap="10px";
        const rank = document.createElement("div"); rank.className="rank"; rank.textContent = i+1;
        const name = document.createElement("div"); name.style.fontWeight="800"; name.textContent = r.name;
        left.appendChild(rank); left.appendChild(name);
        const right = document.createElement("div"); right.className="subtle"; right.textContent = `ğŸ† ${r.wins}`;
        row.appendChild(left); row.appendChild(right);
        box.appendChild(row);
      });
    }

    function showError(msg){
      const e = document.getElementById("error"); e.textContent = msg;
    }

    // ---------- MEMBER LIST ----------
    async function loadMembers(){
      const box = document.getElementById("memberList");
      if (!box) return;
      box.innerHTML = '<div class="subtle" style="padding:8px 14px">Loadingâ€¦</div>';
      try{
        const qy = query(collection(db, "users"), orderBy("lastLogin", "desc"), limit(50));
        const snap = await getDocs(qy);
        if (snap.empty){
          box.innerHTML = '<div class="subtle" style="padding:8px 14px">No members found.</div>';
          return;
        }
        box.innerHTML = "";
        snap.forEach(docSnap => {
          const d = docSnap.data();
          const row = document.createElement("div"); row.className="member-row";
          const nameEl = document.createElement("div"); nameEl.className="member-name"; nameEl.textContent = docSnap.id;
          const metaEl = document.createElement("div"); metaEl.className="member-meta";

          const wins = d.wins || 0;
          let lastText = "No login recorded";
          if (d.lastLogin && typeof d.lastLogin.toDate === "function"){
            const dt = d.lastLogin.toDate();
            lastText = `Last login: ${fmtLastLogin.format(dt)}`;
          }
          metaEl.textContent = `${lastText} â€¢ ğŸ† ${wins} wins`;
          row.appendChild(nameEl); row.appendChild(metaEl);
          box.appendChild(row);
        });
      }catch(e){
        box.innerHTML = '<div class="subtle" style="padding:8px 14px">Error loading members.</div>';
      }
    }

    window.toggleMembers = function(){
      const panel = document.getElementById("memberPanel");
      const btn = document.getElementById("memberToggle");
      if (!panel || !btn) return;
      const nowHidden = !panel.hidden;
      panel.hidden = nowHidden;
      btn.classList.toggle("open", !panel.hidden);
      if (!panel.hidden){
        loadMembers();
      }
    };

    document.addEventListener("click", (ev)=>{
      const panel = document.getElementById("memberPanel");
      const btn = document.getElementById("memberToggle");
      if (!panel || !btn) return;
      if (panel.hidden) return;
      if (!panel.contains(ev.target) && !btn.contains(ev.target)){
        panel.hidden = true;
        btn.classList.remove("open");
      }
    });

    // ---------- RESUME BANNER ----------
    function maybeOfferResume(){
      const banner = document.getElementById("resumeBanner");
      const lastLobby = read(SK.lastLobby);
      const lastGame = read(SK.lastGame);

      const resumeLobbyBtn = document.getElementById("resumeLobbyBtn");
      const resumeGameBtn  = document.getElementById("resumeGameBtn");
      const clearBtn       = document.getElementById("clearSessionBtn");

      banner.style.display = "none";
      resumeLobbyBtn.style.display = "none";
      resumeGameBtn.style.display = "none";

      if (document.getElementById("lobbyInterface").style.display !== "none") return;

      if (lastLobby) {
        banner.style.display = "flex";
        resumeLobbyBtn.style.display = "inline-block";
        resumeLobbyBtn.onclick = ()=> joinLobby(lastLobby);
      }

      if (lastGame && ROUTES[lastGame]) {
        banner.style.display = "flex";
        resumeGameBtn.style.display = "inline-block";
        resumeGameBtn.onclick = ()=> {
          const route = ROUTES[lastGame];
          const gid = read(SK.lastLobby) || "";
          const glue = gid ? `?gameId=${gid}&username=${encodeURIComponent(username)}` : `?username=${encodeURIComponent(username)}`;
          window.location.href = route + glue;
        };
      }

      clearBtn.onclick = ()=> { clearSession(); banner.style.display="none"; };
    }

    // ---------- LOGOUT ----------
    window.logout = async function(){
      try {
        if (currentLobbyId) { await leaveLobby(); }
      } catch(e) { /* ignore */ }
      if (lobbyUnsub) { lobbyUnsub = null; }
      clearSession();
      username = "";
      showLoginUI();
      document.getElementById('resumeBanner').style.display = 'none';
      history.replaceState({}, "", window.location.pathname);
      document.getElementById('error').textContent = "";
    };

    // Initial UI
    if (!username) { showLoginUI(); maybeOfferResume(); }

    // Expose
    window.login = login;
    window.startLobby = startLobby;
    window.joinLobby = joinLobby;
    window.startGame = startGame;
    window.leaveLobby = leaveLobby;
  </script>
</body>
</html>























