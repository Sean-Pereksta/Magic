<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üõ∞Ô∏è Grid Overlord ‚Äî Co-op Node Defense</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover" />
  <style>
    :root{
      --bg:#020617;
      --panel:#0b1120;
      --ink:#e5e7eb;
      --muted:#9ca3af;
      --accent:#38bdf8;
      --accent-soft:#0ea5e9;
      --danger:#ef4444;
      --enemy:#b91c1c;
      --player:#16a34a;
      --contested:#facc15;
      --neutral:#4b5563;
      --radius:14px;
      --shadow:0 18px 40px rgba(0,0,0,.7);
    }
    *{box-sizing:border-box; -webkit-tap-highlight-color:transparent;}
    html,body{
      margin:0;
      padding:0;
      height:100%;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:radial-gradient(circle at top,#0f172a 0,#020617 55%);
      color:var(--ink);
      overflow:hidden;
    }
    body{
      display:flex;
      flex-direction:column;
      align-items:center;
    }
    .shell{
      flex:1;
      display:flex;
      flex-direction:column;
      width:100%;
      max-width:1200px;
      padding:8px 8px calc(8px + env(safe-area-inset-bottom));
      gap:8px;
    }
    .top-bar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      padding:8px 12px;
      border-radius:var(--radius);
      background:rgba(15,23,42,.95);
      border:1px solid #1f2937;
      box-shadow:var(--shadow);
      font-size:.9rem;
    }
    .top-left,.top-right{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .game-title{
      display:flex;
      align-items:center;
      gap:6px;
      font-weight:700;
    }
    .pill{
      border-radius:999px;
      border:1px solid #1f2937;
      padding:4px 10px;
      background:rgba(15,23,42,.95);
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:.78rem;
      color:var(--muted);
    }
    .pill strong{color:var(--ink); font-weight:600;}

    .hp-bar{
      position:relative;
      width:90px;
      height:8px;
      border-radius:999px;
      background:#020617;
      overflow:hidden;
      border:1px solid #1f2937;
    }
    .hp-fill{
      position:absolute;
      inset:0;
      background:linear-gradient(90deg,#16a34a,#facc15,#ef4444);
      width:100%;
      transition:width .18s linear;
    }

    .main{
      flex:1;
      display:flex;
      gap:8px;
      min-height:0;
    }

    .panel{
      border-radius:var(--radius);
      background:rgba(15,23,42,.96);
      border:1px solid #1f2937;
      box-shadow:var(--shadow);
      padding:10px;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .panel-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:.85rem;
      color:var(--muted);
    }

    .board-panel{
      flex:1.1;
      min-width:0;
    }
    .side-panel{
      flex:0.9;
      min-width:260px;
    }

    .board-grid{
      flex:1;
      display:grid;
      grid-template-columns:repeat(7, minmax(0,1fr));
      grid-auto-rows:minmax(34px,1fr);
      gap:4px;
      padding:4px;
    }
    .node-cell{
      border-radius:12px;
      border:1px solid #1f2937;
      background:#020617;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      font-size:.8rem;
      cursor:pointer;
      position:relative;
      overflow:hidden;
      transition:transform .08s ease, box-shadow .08s ease, border-color .1s ease;
    }
    .node-cell span{pointer-events:none;}
    .node-owner{
      font-size:.72rem;
      opacity:.85;
    }
    .node-cell:hover{
      transform:translateY(-1px);
      box-shadow:0 8px 18px rgba(0,0,0,.7);
      border-color:var(--accent-soft);
    }
    .node-base-tag,
    .node-eco-tag{
      position:absolute;
      top:4px;
      left:6px;
      font-size:.75rem;
      opacity:.9;
    }

    .node-player{
      background:radial-gradient(circle at top,#15803d,#022c22);
      border-color:#16a34a;
    }
    .node-enemy{
      background:radial-gradient(circle at top,#7f1d1d,#020617);
      border-color:#b91c1c;
    }
    .node-neutral{
      background:radial-gradient(circle at top,#374151,#020617);
      border-color:#4b5563;
    }
    .node-contested{
      background:radial-gradient(circle at top,#facc15,#451a03);
      border-color:#facc15;
      color:#111827;
    }
    .node-selected{
      box-shadow:0 0 0 2px var(--accent-soft);
    }

    .btn{
      border-radius:999px;
      border:1px solid #1f2937;
      background:#020617;
      padding:6px 10px;
      font-size:.8rem;
      color:var(--ink);
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .btn[disabled]{
      opacity:.4;
      cursor:default;
    }
    .btn-primary{
      border-color:var(--accent-soft);
      background:linear-gradient(135deg,#0ea5e9,#22c55e);
      color:#0f172a;
      font-weight:600;
    }

    .node-info-box{
      flex:1;
      min-height:70px;
      border-radius:10px;
      border:1px solid #1f2937;
      background:#020617;
      padding:6px 8px;
      font-size:.78rem;
      color:var(--muted);
      overflow:auto;
    }

    .log-box{
      height:90px;
      border-radius:10px;
      border:1px solid #1f2937;
      background:#020617;
      padding:6px 8px;
      font-size:.75rem;
      color:var(--muted);
      overflow:auto;
    }
    .log-line{margin-bottom:2px;}

    .mini-grid{
      margin-top:6px;
      display:grid;
      grid-template-columns:repeat(10, minmax(0,1fr));
      gap:1px;
      padding:4px;
      border-radius:8px;
      background:#020617;
      border:1px solid #1f2937;
      max-width:220px;
    }
    .mini-grid-cell{
      width:100%;
      aspect-ratio:1/1;
      border-radius:3px;
      background:#030712;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:.65rem;
      color:#e5e7eb;
      opacity:.9;
    }
    .mini-grid-cell.bg-player{ background:#052e16; }
    .mini-grid-cell.bg-enemy{ background:#43171f; }
    .mini-grid-cell.bg-front{ background:#020617; }

    .overlay{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.96);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:40;
    }
    .overlay-inner{
      width:min(1020px, 100vw - 12px);
      height:min(620px, 100vh - 16px);
      border-radius:var(--radius);
      border:1px solid #1f2937;
      background:radial-gradient(circle at top,#020617,#020617);
      box-shadow:var(--shadow);
      padding:8px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .battle-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:.85rem;
      color:var(--muted);
      gap:6px;
      flex-wrap:wrap;
    }
    .battle-main{
      flex:1;
      display:flex;
      gap:6px;
      min-height:0;
    }
    .battle-grid-wrap{
      flex:1;
      border-radius:12px;
      border:1px solid #1f2937;
      background:#020617;
      padding:4px;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      overflow:hidden;
    }
    .battle-grid{
      display:grid;
      grid-template-columns:repeat(10, minmax(0,1fr));
      grid-auto-rows:minmax(0,1fr);
      gap:2px;
      width:100%;
      max-width:520px;
      aspect-ratio:1/1;
      position:relative;
      z-index:1;
    }
    .battle-cell{
      border-radius:4px;
      background:#020617;
      border:1px solid #111827;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:1.1rem;
      position:relative;
      cursor:pointer;
      overflow:hidden;
    }
    .battle-cell-bg-player{
      background:#022c22;
    }
    .battle-cell-bg-enemy{
      background:#111827;
    }
    .battle-cell-bg-frontline{
      background:#1e293b;
    }
    .battle-cell .hp-bar-mini{
      position:absolute;
      bottom:1px;
      left:2px;
      right:2px;
      height:3px;
      border-radius:999px;
      background:#020617;
      overflow:hidden;
    }
    .battle-cell .hp-bar-mini-fill{
      height:100%;
      background:linear-gradient(90deg,#22c55e,#f97316,#ef4444);
      width:100%;
    }

    .hitline-layer{
      position:absolute;
      inset:0;
      pointer-events:none;
      z-index:2;
    }
    .hitline{
      position:absolute;
      height:2px;
      background:rgba(148,163,184,.85);
      transform-origin:0 50%;
      opacity:.9;
    }
    .hitline.player{
      background:rgba(56,189,248,.9);
    }
    .hitline.enemy{
      background:rgba(248,113,113,.9);
    }

    .battle-side{
      width:220px;
      border-radius:12px;
      border:1px solid #1f2937;
      background:#020617;
      padding:6px;
      font-size:.78rem;
      display:flex;
      flex-direction:column;
      gap:4px;
      color:var(--muted);
      min-width:0;
    }

    .build-bar{
      display:flex;
      flex-wrap:wrap;
      gap:4px;
      padding:4px;
      border-radius:999px;
      border:1px solid #1f2937;
      background:rgba(15,23,42,.95);
      font-size:.76rem;
      align-items:center;
    }
    .build-pill{
      border-radius:999px;
      border:1px solid #1f2937;
      padding:3px 7px;
      display:inline-flex;
      align-items:center;
      gap:4px;
      cursor:pointer;
      background:#020617;
      color:var(--muted);
      white-space:nowrap;
    }
    .build-pill.active{
      border-color:var(--accent-soft);
      color:var(--ink);
      background:radial-gradient(circle at top,#0ea5e9,#22c55e);
    }

    .tag{
      border-radius:999px;
      padding:2px 6px;
      border:1px solid #1f2937;
      font-size:.7rem;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .tag-base{border-color:var(--accent); color:var(--accent);}
    .tag-enemy{border-color:var(--danger); color:var(--danger);}
    .tag-green{border-color:var(--player); color:var(--player);}

    .small{
      font-size:.76rem;
      color:var(--muted);
    }

    @media (max-width:900px){
      .shell{
        padding:6px 6px calc(6px + env(safe-area-inset-bottom));
        gap:6px;
      }
      .top-bar{
        padding:6px 8px;
        font-size:.8rem;
        flex-wrap:wrap;
        row-gap:4px;
      }
      .game-title{font-size:.9rem;}
      .pill{
        font-size:.7rem;
        padding:3px 7px;
      }
      .main{
        gap:6px;
      }
      .panel{
        padding:8px;
        gap:6px;
      }
      .side-panel{
        min-width:0;
        flex:0.9;
      }
      .node-info-box{
        font-size:.72rem;
        max-height:110px;
      }
      .log-box{
        height:80px;
        font-size:.7rem;
      }
    }

    @media (max-width:700px){
      .board-grid{
        grid-auto-rows:minmax(30px,1fr);
        gap:3px;
      }
      .node-cell{
        font-size:.75rem;
      }
      .node-owner{
        font-size:.68rem;
      }
    }

    @media (max-width:600px){
      .overlay-inner{
        width:100vw;
        height:100vh;
        border-radius:0;
        padding:6px;
      }
      .battle-main{
        flex-direction:column;
      }
      .battle-side{
        width:100%;
        order:-1;
      }
      .battle-grid{
        max-width:100%;
      }
      .build-bar{
        overflow-x:auto;
        flex-wrap:nowrap;
      }
      .build-pill{
        font-size:.7rem;
      }
    }

    @media (max-height:640px){
      html,body{
        overflow:auto;
      }
    }
  </style>
</head>
<body>
  <div class="shell">
    <div class="top-bar">
      <div class="top-left">
        <div class="game-title">
          üõ∞Ô∏è <span>Grid Overlord</span>
        </div>
        <div class="pill">
          <span>üë§</span> <strong id="playerNameLabel">‚Ä¶</strong>
        </div>
        <div class="pill">
          ‚è± <strong id="timeLabel">0:00</strong>
        </div>
        <div class="pill">
          üí∞ <strong id="moneyLabel">0</strong>
        </div>
      </div>
      <div class="top-right">
        <div class="pill">
          <span>Base</span>
          <div class="hp-bar">
            <div id="baseHpFill" class="hp-fill"></div>
          </div>
        </div>
        <button class="btn" id="fullscreenBtn">‚õ∂ Fullscreen</button>
      </div>
    </div>

    <div class="main">
      <div class="panel board-panel">
        <div class="panel-header">
          <span>Galaxy Map ‚Äî Nodes</span>
          <span class="small">
            üü¢ you ¬∑ üî¥ aliens ¬∑ üü° both ¬∑ ‚ö™ empty ¬∑ üí∞ eco
          </span>
        </div>
        <div id="boardGrid" class="board-grid"></div>
      </div>

      <div class="panel side-panel">
        <div class="panel-header">
          <span>Node Details</span>
        </div>
        <div id="nodeInfo" class="node-info-box">
          <div>Select a node on the left to inspect or enter its battlefield.</div>
        </div>
        <div style="display:flex;gap:6px;margin-top:4px;flex-wrap:wrap;align-items:center;">
          <button id="openBattleBtn" class="btn btn-primary" disabled>Enter Area</button>
          <button id="upgradeBaseBtn" class="btn" disabled>Upgrade Generator</button>
          <button id="dropshipBtn" class="btn">üöÄ Dropship</button>
          <span id="dropshipStatus" class="small">Ready</span>
        </div>
        <div id="baseInfo" class="small" style="margin-top:4px;display:none;">
          üîã Lv <span id="baseLevelLabel">1</span> ¬∑ +<span id="incomeLabel">0</span> credits / 5s per player ¬∑ Next: <span id="baseUpgradeCostLabel">0</span>
        </div>

        <div style="margin-top:6px;font-size:.75rem;color:var(--muted);line-height:1.4;">
          <strong>Quick guide:</strong><br/>
          ‚Ä¢ Colors: üü¢ only your troops/towers, üî¥ only aliens, üü° both, ‚ö™ none.<br/>
          ‚Ä¢ üí∞ Eco nodes add bonus credits when they‚Äôre green.<br/>
          ‚Ä¢ Aliens spread from red nodes and stockpile nests over time.<br/>
          ‚Ä¢ The center base node has the üîã generator at the back. If aliens destroy it, everyone loses.
        </div>

        <div class="log-box" id="logBox"></div>
      </div>
    </div>
  </div>

  <!-- Battle Overlay -->
  <div id="battleOverlay" class="overlay" style="display:none;">
    <div class="overlay-inner">
      <div class="battle-header">
        <div>
          <span id="battleNodeLabel">Node</span>
          <span id="battleOwnerTag" class="tag tag-green" style="margin-left:6px;">Player</span>
        </div>
        <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;justify-content:flex-end;">
          <div class="pill" id="battleCreditsPill">
            <span>üí∞</span>
            <strong id="battleMoneyLabel">0</strong>
          </div>
          <span class="small">Build only in the first 3 columns.</span>
          <button id="leaveBattleBtn" class="btn">‚¨Ö Leave</button>
        </div>
      </div>
      <div class="battle-main">
        <div class="battle-grid-wrap">
          <div id="battleGrid" class="battle-grid"></div>
        </div>
        <div class="battle-side">
          <div><strong>Troops</strong></div>
          <div class="build-bar" id="troopBar"></div>
          <div style="margin-top:4px;"><strong>Towers</strong></div>
          <div class="build-bar" id="towerBar"></div>
          <div style="margin-top:4px;font-size:.74rem;line-height:1.4;">
            Tap a type, then tap a tile in columns 1‚Äì3 to place it.<br/>
            <strong>Key effects:</strong> üßë‚Äç‚öïÔ∏è heal, ‚≠ê buff damage, üõ°Ô∏è reduce damage taken, üì° boost allies, ‚ö° chain hits, üåµ piercer = high single target, üåµ shredder = chip all in range.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Socket.IO client (served by your Node.js server) -->
  <script src="/socket.io/socket.io.js"></script>

  <!-- Firebase + client logic -->
  <script type="module">
    // ---------------- FIREBASE AUTH (ONLY) ----------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getAuth, signInAnonymously, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB7twY7z31ucB6pGA8JC_HrVMZhA8lNaJA",
      authDomain: "bible-game-246c0.firebaseapp.com",
      projectId: "bible-game-246c0",
      storageBucket: "bible-game-246c0.appspot.com",
      messagingSenderId: "959619818996",
      appId: "1:959619818996:web:5a9fbf492e23c765e445a1"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // ---------------- GAME CONFIG (CLIENT-SIDE) ----------------
    const BOARD_SIZE = 7;
    const BATTLE_W = 10;
    const BATTLE_H = 10;

    const params = new URLSearchParams(window.location.search);
    const gameId = params.get("gameId") || "dev-overlord";
    const displayName = (params.get("username") || "Guest").trim() || "Guest";

    // Same troop/tower/enemy definitions as before, but server actually simulates them.
    const TROOPS = {
      rifle:   { key:"rifle",   name:"Rifleman",      emoji:"üî´", baseHp:12, dmg:3, range:3, cost:8 },
      phase:   { key:"phase",   name:"Phase Blade",   emoji:"üó°Ô∏è", baseHp:18, dmg:4, range:1, cost:10 },
      bomber:  { key:"bomber",  name:"Photon Bomber", emoji:"üí£", baseHp:10, dmg:3, range:3, splash:true, cost:12 },
      medic:   { key:"medic",   name:"Medic",         emoji:"üßë‚Äç‚öïÔ∏è", baseHp:10, heal:3, range:2, cost:10 },
      sergeant:{ key:"sergeant",name:"Space Sergeant",emoji:"‚≠ê", baseHp:14, dmg:2, range:2, buff:true, cost:14 },
      sniper:  { key:"sniper",  name:"Ion Sniper",    emoji:"üéØ", baseHp:8,  dmg:5, range:5, cost:14 }
    };

    const TOWERS = {
      laser:  { key:"laser",  name:"Laser Tower",  emoji:"üî∫", dmg:4, range:4, cost:14 },
      tesla:  { key:"tesla",  name:"Tesla Coil",   emoji:"‚ö°", dmg:3, range:3, chain:true, cost:16 },
      shield: { key:"shield", name:"Shield Tower", emoji:"üõ°Ô∏è", range:2, shield:true, cost:12 },
      signal: { key:"signal", name:"Signal Tower", emoji:"üì°", range:2, buff:true, cost:16 }
    };

    const ENEMIES = {
      bug:       { key:"bug",       emoji:"üêú", baseHp:10 },
      spitter:   { key:"spitter",   emoji:"ü™≤", baseHp:14 },
      brute:     { key:"brute",     emoji:"ü¶Ç", baseHp:26 },
      behemoth:  { key:"behemoth",  emoji:"üëæ", baseHp:40 },
      hiveQueen: { key:"hiveQueen", emoji:"üëë", baseHp:90,  isBoss:true },
      warper:    { key:"warper",    emoji:"üåÄ", baseHp:75,  isBoss:true }
    };

    // ---------------- STATE ----------------
    let currentUser = null;
    let socket = null;

    let latestGame = null;
    let nodesState = {};
    let myPlayer = null;

    let selectedNodeId = null;
    let selectedNode = null;
    let currentBuild = { type:null, category:null };

    let dropshipSourceNodeId = null;
    let selectingDropshipTarget = false;

    // ---------------- DOM ----------------
    const playerNameLabel = document.getElementById("playerNameLabel");
    const battleMoneyLabel = document.getElementById("battleMoneyLabel");
    const timeLabel = document.getElementById("timeLabel");
    const moneyLabel = document.getElementById("moneyLabel");
    const baseHpFill = document.getElementById("baseHpFill");
    const boardGridEl = document.getElementById("boardGrid");
    const nodeInfoEl = document.getElementById("nodeInfo");
    const logBoxEl = document.getElementById("logBox");
    const openBattleBtn = document.getElementById("openBattleBtn");
    const upgradeBaseBtn = document.getElementById("upgradeBaseBtn");
    const baseInfoEl = document.getElementById("baseInfo");
    const baseLevelLabel = document.getElementById("baseLevelLabel");
    const incomeLabel = document.getElementById("incomeLabel");
    const baseUpgradeCostLabel = document.getElementById("baseUpgradeCostLabel");

    const battleOverlay = document.getElementById("battleOverlay");
    const battleNodeLabel = document.getElementById("battleNodeLabel");
    const battleOwnerTag = document.getElementById("battleOwnerTag");
    const battleGridEl = document.getElementById("battleGrid");
    const troopBarEl = document.getElementById("troopBar");
    const towerBarEl = document.getElementById("towerBar");
    const dropshipBtn = document.getElementById("dropshipBtn");
    const dropshipStatusLabel = document.getElementById("dropshipStatus");
    const leaveBattleBtn = document.getElementById("leaveBattleBtn");

    // ---------------- UTILS ----------------
    function log(msg){
      if(!logBoxEl) return;
      const div = document.createElement("div");
      div.className = "log-line";
      div.textContent = msg;
      logBoxEl.appendChild(div);
      logBoxEl.scrollTop = logBoxEl.scrollHeight;
      console.log("[GRID]", msg);
    }
    function nodeKey(row,col){ return `${row}_${col}`; }
    function parseKey(key){
      const [r,c]=key.split("_").map(Number);
      return {row:r,col:c};
    }
    function formatTime(sec){
      sec = Math.max(0, Math.floor(sec||0));
      const m = Math.floor(sec/60);
      const s = sec % 60;
      return `${m}:${s.toString().padStart(2,"0")}`;
    }
    function neighborsOf(row,col){
      const dirs = [[1,0],[-1,0],[0,1],[0,-1]];
      const out=[];
      for(const [dr,dc] of dirs){
        const nr = row+dr, nc = col+dc;
        if(nr>=0 && nr<BOARD_SIZE && nc>=0 && nc<BOARD_SIZE){
          out.push(nodeKey(nr,nc));
        }
      }
      return out;
    }
    function canBuildInNode(nodeId){
      const node = nodesState[nodeId];
      if (!node) return false;
      if (node.owner === "player") return true;

      const { row, col } = node;
      const neigh = neighborsOf(row, col);
      for (const nk of neigh) {
        const n = nodesState[nk];
        if (n && n.owner === "player") return true;
      }
      return false;
    }

    // ---------------- DROPSHIP STATUS UI ----------------
    function updateDropshipStatus(){
      if (!dropshipStatusLabel || !dropshipBtn) return;

      if (!latestGame || !myPlayer){
        dropshipStatusLabel.textContent = "‚Ä¶";
        dropshipBtn.disabled = true;
        return;
      }

      const now = latestGame.timeSeconds || 0;
      const last = myPlayer.lastDropshipAt || 0;
      const CD = 60;
      const remaining = CD - (now - (last || 0));

      if (selectingDropshipTarget && dropshipSourceNodeId){
        dropshipStatusLabel.textContent = "Select destination‚Ä¶";
        dropshipBtn.disabled = false;
        return;
      }

      if (remaining <= 0){
        dropshipStatusLabel.textContent = "Ready";
        dropshipBtn.disabled = false;
      } else {
        dropshipStatusLabel.textContent = `Cooldown: ${remaining}s`;
        dropshipBtn.disabled = true;
      }
    }

    // ---------------- RENDER META ----------------
    function renderGameMeta(){
      if (!latestGame) return;

      const sec = latestGame.timeSeconds || 0;
      timeLabel.textContent = formatTime(sec);

      const base = latestGame.base || {
        hp: 0,
        maxHp: 1,
        level: 1,
        incomePerPlayer: 0,
        upgradeCost: 0
      };

      const hp  = Math.max(0, base.hp  || 0);
      const max = Math.max(1, base.maxHp || 1);
      const pct = Math.max(0, Math.min(100, (hp / max) * 100));
      baseHpFill.style.width = pct + "%";

      baseInfoEl.style.display = "block";
      baseLevelLabel.textContent       = base.level ?? 1;
      incomeLabel.textContent          = base.incomePerPlayer ?? 0;
      baseUpgradeCostLabel.textContent = base.upgradeCost ?? 0;

      if (latestGame.status === "lost"){
        log("‚ö† Base destroyed. Game over for all players.");
      } else if (latestGame.status === "won"){
        log("‚úÖ You survived the full duration! Victory.");
      }

      updateDropshipStatus();
    }

    function applyPlayerUi(){
      if(!myPlayer) return;
      const credits = Math.floor(myPlayer.money || 0);
      moneyLabel.textContent = credits;
      if(battleMoneyLabel){
        battleMoneyLabel.textContent = credits;
      }
      updateDropshipStatus();
    }

    // ---------------- RENDER BOARD ----------------
    function renderBoard(){
      if(!boardGridEl) return;
      boardGridEl.innerHTML = "";
      const center = Math.floor(BOARD_SIZE/2);

      for(let r=0;r<BOARD_SIZE;r++){
        for(let c=0;c<BOARD_SIZE;c++){
          const key = nodeKey(r,c);
          const node = nodesState[key];
          const div = document.createElement("div");
          div.className = "node-cell";
          if(node){
            if(node.owner==="player") div.classList.add("node-player");
            else if(node.owner==="enemy") div.classList.add("node-enemy");
            else if(node.owner==="neutral") div.classList.add("node-neutral");
            else if(node.owner==="contested") div.classList.add("node-contested");
            if(key===selectedNodeId) div.classList.add("node-selected");
          }

          const title = document.createElement("span");
          title.textContent =
            (r===center && c===center) ? "Base" :
            (node && node.type==="eco") ? "Eco" :
            `Node ${r+1}-${c+1}`;
          div.appendChild(title);

          const ownerSpan = document.createElement("span");
          ownerSpan.className = "node-owner";
          ownerSpan.textContent = node ? (
            node.owner==="player" ? "You" :
            node.owner==="enemy" ? "Aliens" :
            node.owner==="contested" ? "Contested" :
            "Neutral"
          ) : "‚Ä¶";
          div.appendChild(ownerSpan);

          if(node && node.type==="base"){
            const tag = document.createElement("div");
            tag.className = "node-base-tag";
            tag.textContent = "üîã";
            div.appendChild(tag);
          }else if(node && node.type==="eco"){
            const tag = document.createElement("div");
            tag.className = "node-eco-tag";
            tag.textContent = "üí∞";
            div.appendChild(tag);
          }

          div.addEventListener("click",()=>{
            selectedNodeId = key;
            selectedNode = node || null;
            renderBoard();
            renderNodeDetails();

            // If we're in dropship target selection, try to send troops
            if (selectingDropshipTarget && dropshipSourceNodeId && node){
              if (key === dropshipSourceNodeId){
                log("Dropship cancelled.");
              } else if (node.owner === "player" || node.owner === "contested"){
                requestDropship(dropshipSourceNodeId, key);
              } else {
                log("Dropship target must be a green or contested node.");
              }
              selectingDropshipTarget = false;
              dropshipSourceNodeId = null;
              updateDropshipStatus();
            }
          });

          boardGridEl.appendChild(div);
        }
      }
    }

    function appendMiniGrid(container, node){
      const bf = node.battlefield || {width:BATTLE_W,height:BATTLE_H,troops:[],towers:[],aliens:[],spines:[]};
      const troops = bf.troops || [];
      const towers = bf.towers || [];
      const aliens = bf.aliens || [];
      const spines = bf.spines || [];

      function getCell(x,y){
        const res = {troop:null,tower:null,alien:null,spine:null};
        res.troop = troops.find(t=>t.x===x && t.y===y) || null;
        res.tower = towers.find(t=>t.x===x && t.y===y) || null;
        res.alien = aliens.find(a=>a.x===x && a.y===y) || null;
        res.spine = spines.find(s=>s.x===x && s.y===y) || null;
        return res;
      }

      const grid = document.createElement("div");
      grid.className = "mini-grid";

      for(let y=0;y<BATTLE_H;y++){
        for(let x=0;x<BATTLE_W;x++){
          const cell = document.createElement("div");
          cell.className = "mini-grid-cell";

          if(x<=2) cell.classList.add("bg-player");
          else if(x>=BATTLE_W-3) cell.classList.add("bg-enemy");
          else cell.classList.add("bg-front");

          const {troop,tower,alien,spine} = getCell(x,y);
          let emoji = "";
          if(spine){
            emoji = "üåµ";
          }else if(tower){
            if(tower.kind === "generator"){
              emoji = "üîã";
            }else{
              const def = TOWERS[tower.kind] || TOWERS.laser;
              emoji = def.emoji;
            }
          }else if(troop){
            const def = TROOPS[troop.kind] || TROOPS.rifle;
            emoji = def.emoji;
          }
          if(alien){
            const def = ENEMIES[alien.type] || ENEMIES.bug;
            emoji = def.emoji;
          }
          cell.textContent = emoji;
          grid.appendChild(cell);
        }
      }

      container.appendChild(grid);
    }

    function renderNodeDetails(){
      if(!selectedNodeId || !selectedNode){
        nodeInfoEl.innerHTML = "<div>Select a node on the left.</div>";
        openBattleBtn.disabled = true;
        upgradeBaseBtn.disabled = true;
        return;
      }
      let html = "";
      html += `<div><strong>${selectedNode.type==="base" ? "Base Node" : selectedNode.type==="eco" ? "Eco Node" : "Node"} ${selectedNode.row+1}-${selectedNode.col+1}</strong></div>`;
      const ownerName =
        selectedNode.owner==="player" ? "You (green)" :
        selectedNode.owner==="enemy" ? "Aliens (red)" :
        selectedNode.owner==="contested" ? "Contested (yellow)" :
        "Neutral (empty)";
      html += `<div style="margin-top:4px;">Owner: <strong>${ownerName}</strong></div>`;

      if(selectedNode.type==="base"){
        const base = latestGame?.base || {};
        html += `<div style="margin-top:6px;">
          Central <strong>üîã generator</strong> is in this node. If it dies, the run ends.<br/>
          Next upgrade cost: <strong>${base.upgradeCost ?? 0}</strong> credits.
        </div>`;
      }else if(selectedNode.type==="eco"){
        html += `<div style="margin-top:6px;">This <strong>üí∞ eco node</strong> gives extra income while it‚Äôs green.</div>`;
      }else{
        html += `<div style="margin-top:6px;">Control is based only on who is standing here. Clear aliens to flip red/yellow to green.</div>`;
      }

      nodeInfoEl.innerHTML = html;
      appendMiniGrid(nodeInfoEl, selectedNode);

      openBattleBtn.disabled = false;
      upgradeBaseBtn.disabled = selectedNode.type!=="base";
    }

    // ---------------- BATTLE UI ----------------
    function buildBattleBars(){
      troopBarEl.innerHTML = "";
      for(const key in TROOPS){
        const def = TROOPS[key];
        const pill = document.createElement("button");
        pill.type="button";
        pill.className = "build-pill";
        pill.dataset.type = def.key;
        pill.dataset.category = "troop";
        pill.innerHTML = `${def.emoji} ${def.name} <span style="opacity:.7;">(${def.cost})</span>`;
        pill.onclick = ()=>selectBuild(def.key,"troop");
        troopBarEl.appendChild(pill);
      }
      towerBarEl.innerHTML = "";
      for(const key in TOWERS){
        const def = TOWERS[key];
        const pill = document.createElement("button");
        pill.type="button";
        pill.className = "build-pill";
        pill.dataset.type = def.key;
        pill.dataset.category = "tower";
        pill.innerHTML = `${def.emoji} ${def.name} <span style="opacity:.7;">(${def.cost})</span>`;
        pill.onclick = ()=>selectBuild(def.key,"tower");
        towerBarEl.appendChild(pill);
      }
    }

    function selectBuild(type,category){
      currentBuild = {type,category};
      document.querySelectorAll(".build-pill").forEach(el=>{
        const t = el.dataset.type;
        const cat = el.dataset.category;
        el.classList.toggle("active", t===type && cat===category);
      });
    }

    function openBattleForNode(nodeId){
      if(!nodeId || !nodesState[nodeId]) return;
      selectedNodeId = nodeId;
      selectedNode = nodesState[nodeId];
      renderBoard();
      renderNodeDetails();

      buildBattleBars();
      const {row,col} = parseKey(nodeId);
      battleNodeLabel.textContent =
        (selectedNode.type==="base" ? "Base Node" :
         selectedNode.type==="eco" ? "Eco Node" : "Node") +
        ` ${row+1}-${col+1}`;
      updateBattleOwnerTag(selectedNode);
      battleOverlay.style.display = "flex";

      if(socket && socket.connected){
        socket.emit("overlord:watchNode", { gameId, nodeId });
      }
    }

    function updateBattleOwnerTag(node){
      const owner = node.owner;
      battleOwnerTag.textContent =
        owner==="player" ? "Player-only (green)" :
        owner==="enemy" ? "Alien-only (red)" :
        owner==="contested" ? "Both present (yellow)" :
        "Empty (neutral)";
      battleOwnerTag.className = "tag";
      if(owner==="player") battleOwnerTag.classList.add("tag-green");
      else if(owner==="enemy") battleOwnerTag.classList.add("tag-enemy");
      else if(owner==="contested") battleOwnerTag.classList.add("tag-base");
    }

    function renderBattlefield(node){
      const bf = node.battlefield || {
        width:BATTLE_W,
        height:BATTLE_H,
        troops:[],
        towers:[],
        aliens:[],
        spines:[],
        hitLines:[]
      };
      battleGridEl.innerHTML = "";
      const troops = bf.troops || [];
      const towers = bf.towers || [];
      const aliens = bf.aliens || [];
      const spines = bf.spines || [];

      function getCellContents(x,y){
        const res = {troop:null,tower:null,alien:null,spine:null};
        res.troop = troops.find(t=>t.x===x && t.y===y) || null;
        res.tower = towers.find(tw=>tw.x===x && tw.y===y) || null;
        res.alien = aliens.find(a=>a.x===x && a.y===y) || null;
        res.spine = spines.find(s=>s.x===x && s.y===y) || null;
        return res;
      }

      for(let y=0;y<BATTLE_H;y++){
        for(let x=0;x<BATTLE_W;x++){
          const cell = document.createElement("div");
          cell.className = "battle-cell";
          cell.dataset.x = x;
          cell.dataset.y = y;

          if(x<=2) cell.classList.add("battle-cell-bg-player");
          else if(x>=BATTLE_W-3) cell.classList.add("battle-cell-bg-enemy");
          else cell.classList.add("battle-cell-bg-frontline");

          const {troop,tower,alien,spine} = getCellContents(x,y);
          let emoji = "";
          let hp = null, maxHp = null;

          if(spine){
            emoji = "üåµ";
            hp = spine.hp;
            maxHp = spine.maxHp;
          }else if(tower){
            if(tower.kind === "generator"){
              emoji = "üîã";
            }else{
              const def = TOWERS[tower.kind] || TOWERS.laser;
              emoji = def.emoji;
            }
            hp = tower.hp;
            maxHp = tower.maxHp;
          }else if(troop){
            const def = TROOPS[troop.kind] || TROOPS.rifle;
            emoji = def.emoji;
            hp = troop.hp;
            maxHp = troop.maxHp;
          }
          if(alien){
            const def = ENEMIES[alien.type] || ENEMIES.bug;
            emoji = def.emoji;
            hp = alien.hp;
            maxHp = alien.maxHp;
          }

          if(emoji){
            cell.textContent = emoji;
          }

          if(hp != null && maxHp != null){
            const bar = document.createElement("div");
            bar.className = "hp-bar-mini";
            const fill = document.createElement("div");
            fill.className = "hp-bar-mini-fill";
            const pct = Math.max(0, Math.min(100, (hp/maxHp)*100));
            fill.style.width = pct + "%";
            bar.appendChild(fill);
            cell.appendChild(bar);
          }

          cell.addEventListener("click",()=>{
            onBattleCellClick(x,y,node);
          });

          battleGridEl.appendChild(cell);
        }
      }

      const wrap = battleGridEl.parentElement;
      if(wrap){
        wrap.querySelectorAll(".hitline-layer").forEach(el=>el.remove());

        const layer = document.createElement("div");
        layer.className = "hitline-layer";

        const wrapRect = wrap.getBoundingClientRect();
        const centerCache = {};

        function getCellCenter(x,y){
          const key = x+"_"+y;
          if(centerCache[key]) return centerCache[key];

          const cell = battleGridEl.querySelector(`.battle-cell[data-x="${x}"][data-y="${y}"]`);
          if(!cell){
            centerCache[key] = null;
            return null;
          }
          const r = cell.getBoundingClientRect();
          const cx = r.left + r.width/2 - wrapRect.left;
          const cy = r.top + r.height/2 - wrapRect.top;
          const center = {x:cx, y:cy};
          centerCache[key] = center;
          return center;
        }

        const lines = bf.hitLines || [];
        for(const l of lines){
          const p1 = getCellCenter(l.x1,l.y1);
          const p2 = getCellCenter(l.x2,l.y2);
          if(!p1 || !p2) continue;

          const dx = p2.x - p1.x;
          const dy = p2.y - p1.y;
          const dist = Math.sqrt(dx*dx + dy*dy) || 1;
          const angle = Math.atan2(dy,dx) * 180 / Math.PI;

          const lineEl = document.createElement("div");
          lineEl.className = "hitline " + (l.kind==="enemy" ? "enemy" : "player");
          lineEl.style.left = p1.x + "px";
          lineEl.style.top = p1.y + "px";
          lineEl.style.width = dist + "px";
          lineEl.style.transform = `translate(0,-50%) rotate(${angle}deg)`;

          layer.appendChild(lineEl);
        }

        wrap.appendChild(layer);
      }

      updateBattleOwnerTag(node);
    }

    function onBattleCellClick(x, y, node) {
      if (!selectedNodeId || !canBuildInNode(selectedNodeId)) {
        log("You can only build in nodes you control or adjacent to your territory.");
        return;
      }

      if (!currentBuild.type || !currentBuild.category) {
        log("Select a troop or tower type first.");
        return;
      }

      if (x > 2) {
        log("You can only place in the first 3 columns.");
        return;
      }
      if (!currentUser) {
        log("Player auth not ready yet.");
        return;
      }
      if (!socket || !socket.connected){
        log("Not connected to server.");
        return;
      }

      const def =
        currentBuild.category === "troop"
          ? TROOPS[currentBuild.type]
          : TOWERS[currentBuild.type];

      if (!def) {
        log("Unknown unit type.");
        return;
      }

      const payload = {
        gameId,
        nodeId: selectedNodeId,
        x,
        y,
        category: currentBuild.category,
        kind: currentBuild.type
      };

      // Server will validate cost, occupancy, etc.
      socket.emit("overlord:build", payload, (resp)=>{
        if(!resp) return;
        if(resp.ok){
          const name =
            currentBuild.category === "troop"
              ? TROOPS[currentBuild.type].name
              : TOWERS[currentBuild.type].name;
          log(`Built ${name} at (${x + 1},${y + 1}).`);
        }else if(resp.error){
          log("Build failed: " + resp.error);
        }
      });
    }

    // ---------------- SOCKET.IO WIRING ----------------
    function setupSocket(user){
      socket = io(); // same origin

      socket.on("connect", ()=>{
        log("Connected to Grid Overlord server.");
        socket.emit("overlord:join", {
          gameId,
          uid: user.uid,
          name: displayName
        });
      });

      // Full snapshot
      socket.on("overlord:state", (payload)=>{
        if(!payload) return;
        latestGame = payload.game || latestGame;
        nodesState = payload.nodes || {};
        myPlayer   = payload.player || myPlayer;
        renderGameMeta();
        renderBoard();
        if(selectedNodeId){
          selectedNode = nodesState[selectedNodeId] || null;
          renderNodeDetails();
        }
        applyPlayerUi();
      });

      socket.on("overlord:gameUpdate", (game)=>{
        latestGame = game || latestGame;
        renderGameMeta();
      });

      socket.on("overlord:nodesUpdate", (nodes)=>{
        nodesState = nodes || {};
        renderBoard();
        if(selectedNodeId){
          selectedNode = nodesState[selectedNodeId] || null;
          renderNodeDetails();
        }
      });

      socket.on("overlord:nodeUpdate", (node)=>{
        if(!node || !node.id) return;
        nodesState[node.id] = node;
        if(selectedNodeId === node.id){
          selectedNode = node;
          renderNodeDetails();
          renderBattlefield(node);
        }
        renderBoard();
      });

      socket.on("overlord:playerUpdate", (player)=>{
        myPlayer = player || myPlayer;
        applyPlayerUi();
      });

      socket.on("overlord:log", (msg)=> log(msg));
      socket.on("overlord:error", (msg)=> log("‚ö† " + msg));

      socket.on("disconnect", ()=>{
        log("Disconnected from Grid Overlord server.");
      });
    }

    // ---------------- ACTION HELPERS (DROPSHIP / UPGRADE) ----------------
    function requestDropship(sourceId, destId){
      if(!socket || !socket.connected){
        log("Not connected to server.");
        return;
      }
      socket.emit("overlord:dropship", { gameId, sourceId, destId }, (resp)=>{
        if(!resp) return;
        if(resp.ok){
          const src = nodesState[sourceId];
          const dst = nodesState[destId];
          const sLabel = src ? `${src.row+1}-${src.col+1}` : sourceId;
          const dLabel = dst ? `${dst.row+1}-${dst.col+1}` : destId;
          log(`üöÄ Dropship: moved troops from ${sLabel} to ${dLabel}.`);
        }else if(resp.error){
          log("Dropship failed: " + resp.error);
        }
      });
    }

    function requestUpgradeBase(){
      if(!socket || !socket.connected){
        log("Not connected to server.");
        return;
      }
      socket.emit("overlord:upgradeBase", { gameId }, (resp)=>{
        if(!resp) return;
        if(resp.ok){
          log("‚ö° Generator upgraded. All players gain more credits per tick.");
        }else if(resp.error){
          log("Upgrade failed: " + resp.error);
        }
      });
    }

    // ---------------- UI BUTTONS ----------------
    openBattleBtn.addEventListener("click",()=>{
      if(!selectedNodeId) return;
      openBattleForNode(selectedNodeId);
    });

    dropshipBtn.addEventListener("click", ()=>{
      if (!selectedNodeId || !selectedNode){
        log("Select a green node you control first.");
        return;
      }
      if (selectedNode.owner !== "player"){
        log("Dropship source must be a green node you control.");
        return;
      }

      const bf = selectedNode.battlefield || {};
      const troops = bf.troops || [];
      if (!troops.length){
        log("No friendly troops in this node to dropship.");
        return;
      }

      if (!latestGame || !myPlayer){
        log("Dropship not ready yet.");
        return;
      }

      const now = latestGame.timeSeconds || 0;
      const last = myPlayer.lastDropshipAt || 0;
      const remaining = 60 - (now - (last || 0));

      if (remaining > 0){
        log(`Dropship is recharging (${remaining}s left).`);
        updateDropshipStatus();
        return;
      }

      dropshipSourceNodeId = selectedNodeId;
      selectingDropshipTarget = true;
      log("Dropship source locked. Click a green or contested node to send your troops (click the same node again to cancel).");
      updateDropshipStatus();
    });

    leaveBattleBtn.addEventListener("click",()=>{
      battleOverlay.style.display = "none";
      if(socket && socket.connected && selectedNodeId){
        socket.emit("overlord:unwatchNode", { gameId, nodeId: selectedNodeId });
      }
    });

    upgradeBaseBtn.addEventListener("click", ()=>{
      if(!latestGame || !myPlayer) return;
      if(!selectedNode || selectedNode.type!=="base") return;
      requestUpgradeBase();
    });

    document.getElementById("fullscreenBtn").addEventListener("click",()=>{
      const el = document.documentElement;
      if(!document.fullscreenElement){
        el.requestFullscreen?.();
      }else{
        document.exitFullscreen?.();
      }
    });

    // ---------------- AUTH FLOW ----------------
    log("Connecting to Firebase (auth only) and waiting for authentication‚Ä¶");

    signInAnonymously(auth).catch(err=>{
      console.error(err);
      alert("Failed to sign in anonymously to Firebase: "+err.message);
    });

    let socketStarted = false;
    onAuthStateChanged(auth, (user)=>{
      if(!user) return;
      currentUser = user;
      playerNameLabel.textContent = displayName;
      if(!socketStarted){
        socketStarted = true;
        setupSocket(user);
      }
    });
  </script>
</body>
</html>



















