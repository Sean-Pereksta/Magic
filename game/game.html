<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Card Battle Game</title>
  <style>
    body { font-family: sans-serif; background: #f2f2f2; padding: 20px; }
    #game { max-width: 1000px; margin: auto; background: white; padding: 20px; border-radius: 10px; }
    .hidden { display: none; }
    .card { display: inline-block; background: #e0e0e0; padding: 10px; border-radius: 5px; margin: 5px; width: 150px; cursor: pointer; }
    .zone { margin-top: 10px; padding: 10px; border: 1px solid #ccc; min-height: 60px; }
    button { padding: 10px; margin: 10px; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
<div id="game">
  <div id="setupPhase">
    <h2>Select Your Class (20 seconds)</h2>
    <button onclick="selectClass('Ranger')">Ranger</button>
    <button onclick="selectClass('Sorcerer')">Sorcerer</button>
    <button onclick="selectClass('Knight')">Knight</button>
    <p id="classCountdown"></p>
  </div>  <div id="mainGame" class="hidden">
    <h2 id="playerLabel"></h2>
    <p>Health: <span id="healthDisplay"></span></p>
    <p>Actions Remaining: <span id="actionDisplay">3</span></p><div>
  <h3>Hand</h3>
  <div id="handZone" class="zone"></div>
</div>

<div>
  <h3>Items in Play</h3>
  <div id="itemZone" class="zone"></div>
</div>

<div>
  <h3>Spells in Play</h3>
  <div id="spellZone" class="zone"></div>
</div>

<button onclick="drawCard()">Draw Card</button>
<button onclick="endTurn()">End Turn</button>

  </div>
</div><script>
const firebaseConfig = {
  apiKey: "AIzaSyCKy1KVoLdTH_nwpYVr8u_CT5e0hjBpFOc",
  authDomain: "truth-b65cd.firebaseapp.com",
  databaseURL: "https://truth-b65cd-default-rtdb.firebaseio.com",
  projectId: "truth-b65cd",
  storageBucket: "truth-b65cd.appspot.com",
  messagingSenderId: "11180463959",
  appId: "1:11180463959:web:e860d37bdbf8e245e25012"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const urlParams = new URLSearchParams(window.location.search);
const lobbyId = urlParams.get("lobbyId");
const playerName = urlParams.get("name");
const playerRole = urlParams.get("role");
const playerPath = `lobbies/${lobbyId}/players/${playerName}`;

let opponent = null;

let player = {
  name: playerName,
  class: null,
  stats: { dexterity: 0, magic: 0, defense: 0 },
  health: 50,
  hand: [],
  items: [],
  spells: [],
  actions: 3,
  isTurn: playerRole === "host"
};

const classStats = {
  Ranger: { dexterity: 5, magic: 2, defense: 3 },
  Sorcerer: { dexterity: 2, magic: 5, defense: 2 },
  Knight: { dexterity: 3, magic: 3, defense: 5 }
};

const cardPool = [
  { name: "Dex Strike", type: "item", effect: "deal", target: "opponent", value: "dexterity + d6" },
  { name: "Magic Drain", type: "spell", effect: "discard", target: "target", value: "roll d6 + magic < 5 ? 1 : 2" },
  { name: "Healing Potion", type: "potion", effect: "heal", target: "self", value: 5 },
  { name: "Steal Card", type: "item", effect: "steal", target: "target", value: 1 },
  { name: "Arrow Volley", type: "item", effect: "deal", target: "all", value: "dexterity + d6" },
  { name: "Mana Surge", type: "spell", effect: "heal", target: "self", value: "magic + d6" },
  { name: "Shield Bash", type: "item", effect: "deal", target: "opponent", value: "defense + d6" },
  { name: "Burning Words", type: "spell", effect: "deal", target: "opponent", value: "magic + d6" },
  { name: "Barrier Ward", type: "spell", effect: "heal", target: "self", value: "defense" },
  { name: "Reckless Swing", type: "item", effect: "deal", target: "opponent", value: "dexterity + d6 - 2" }
];

let turnTimer = 20;
const classTimer = setInterval(() => {
  document.getElementById("classCountdown").textContent = `Auto-assigning class in ${turnTimer--} seconds...`;
  if (turnTimer < 0) {
    selectClass("Knight");
    clearInterval(classTimer);
  }
}, 1000);

function selectClass(selected) {
  player.class = selected;
  player.stats = classStats[selected];
  document.getElementById("setupPhase").classList.add("hidden");
  document.getElementById("mainGame").classList.remove("hidden");
  document.getElementById("playerLabel").textContent = `Class: ${selected}`;
  document.getElementById("healthDisplay").textContent = player.health;
  drawCard(playerRole === "host" ? 1 : 2);
  syncPlayer();
  listenForChanges();
}

function syncPlayer() {
  db.ref(playerPath).set(player);
}

function listenForChanges() {
  db.ref(`lobbies/${lobbyId}/players`).on("value", snapshot => {
    const players = snapshot.val();
    const opponentName = Object.keys(players).find(n => n !== player.name);
    if (!opponentName) return;
    opponent = players[opponentName];
    if (!player.isTurn && opponent.isTurn) {
      alert("Your turn!");
      player.isTurn = true;
      player.actions = 3;
      updateUI();
    }
  });
}

function drawCard(n = 1) {
  if (!player.isTurn || player.actions <= 0) return;
  for (let i = 0; i < n; i++) {
    const card = JSON.parse(JSON.stringify(cardPool[Math.floor(Math.random() * cardPool.length)]));
    player.hand.push(card);
  }
  player.actions--;
  syncPlayer();
  updateUI();
}

function playCard(index) {
  if (!player.isTurn || player.actions <= 0) return;
  const card = player.hand.splice(index, 1)[0];
  const zone = card.type === "spell" ? player.spells : player.items;
  if (card.type !== "potion" && zone.length >= 3) {
    const removeIndex = prompt(`You have 3 ${card.type}s. Enter index (0-2) of a card to replace:`);
    if (removeIndex === null || isNaN(removeIndex) || removeIndex < 0 || removeIndex > 2) return;
    zone.splice(removeIndex, 1);
  }
  if (card.type === "potion") applyEffect(card);
  else zone.push(card);
  applyEffect(card);
  player.actions--;
  syncPlayer();
  updateUI();
}

function applyEffect(card) {
  let d6 = Math.ceil(Math.random() * 6);
  let raw = 0;
  switch(card.value) {
    case "dexterity + d6": raw = player.stats.dexterity + d6; break;
    case "magic + d6": raw = player.stats.magic + d6; break;
    case "defense + d6": raw = player.stats.defense + d6; break;
    case "dexterity + d6 - 2": raw = player.stats.dexterity + d6 - 2; break;
    case "roll d6 + magic < 5 ? 1 : 2":
      raw = player.stats.magic + d6;
      alert(`Rolled ${d6} + Magic (${player.stats.magic}) = ${raw}`);
      raw = raw < 5 ? 1 : 2;
      break;
    default:
      raw = typeof card.value === "number" ? card.value : 0;
  }

  let adjusted = raw;
  if (card.effect === "deal" && opponent) {
    const def = classStats[opponent.class]?.defense || 0;
    adjusted = Math.max(0, raw - def);
    alert(`${card.name} dealt ${adjusted} damage after reducing ${def} defense.`);
    opponent.health -= adjusted;
    db.ref(`lobbies/${lobbyId}/players/${opponent.name}`).update({ health: opponent.health });
  }
  else if (card.effect === "heal") {
    player.health += adjusted;
  }
  else if (card.effect === "discard") {
    alert(`Target discards ${adjusted} card(s).`);
  }
  else if (card.effect === "steal") {
    alert(`You steal ${adjusted} card(s).`);
  }
  syncPlayer();
}

function endTurn() {
  player.actions = 3;
  player.isTurn = false;
  syncPlayer();
  alert("Turn ended.");
}

function updateUI() {
  document.getElementById("handZone").innerHTML = player.hand.map((card, i) => `<div class='card' onclick='playCard(${i})'>${card.name}</div>`).join('');
  document.getElementById("itemZone").innerHTML = player.items.map(card => `<div class='card'>${card.name}</div>`).join('');
  document.getElementById("spellZone").innerHTML = player.spells.map(card => `<div class='card'>${card.name}</div>`).join('');
  document.getElementById("actionDisplay").textContent = player.actions;
  document.getElementById("healthDisplay").textContent = player.health;
}
</script></body>
</html>
