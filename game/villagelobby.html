<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üè∞ Tribes Lobby</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      /* Light theme */
      --bg:#f7fbff; --panel:#ffffff; --ink:#0b1220; --muted:#5b6b7d; --line:#e6edf5;
      --accent:#0ea5e9; --accent2:#7c3aed; --good:#16a34a; --warn:#f59e0b; --danger:#ef4444;
      --chip:#f1f5f9; --glow:0 8px 22px rgba(13,37,62,.08);
    }
    *{ box-sizing:border-box }
    body{
      margin:0; padding:24px;
      background: radial-gradient(1200px 600px at 20% -10%, #e6f4ff 0%, #f7fbff 45%, #f7fbff 100%);
      color:var(--ink); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
    }
    .shell{
      max-width:1200px; margin:0 auto; display:grid; grid-template-columns: 2fr 1fr; gap:18px;
    }
    .card{
      background: var(--panel);
      border:1px solid var(--line); border-radius:14px; padding:16px 16px 18px; box-shadow: var(--glow);
    }
    h1{ margin:0 0 10px 0; font-size:28px; letter-spacing:.3px }
    h2{ margin:6px 0 12px; font-size:18px; color:var(--accent) }
    h3{ margin:4px 0 10px; font-size:15px; color:var(--muted) }

    /* Left column */
    #villagesCard{ min-height:680px }
    #villageList{ display:flex; flex-direction:column; gap:10px }
    .sectionTitle{
      display:flex; align-items:center; gap:10px; margin:12px 0 6px; color:var(--accent2); font-weight:800;
    }
    .village-row{
      display:grid; grid-template-columns: 1.5fr .7fr auto; gap:10px;
      align-items:center; padding:10px; border:1px solid var(--line); border-radius:12px;
      background: #ffffff;
      transition: transform .06s ease, border-color .2s ease, box-shadow .2s ease;
    }
    .village-row:hover{ transform: translateY(-1px); border-color: #d6e3f3; box-shadow: 0 6px 14px rgba(18,46,83,.06); }
    .village-row.own{ outline:1px solid rgba(22,163,74,.35); box-shadow: 0 0 0 2px rgba(16,185,129,.08) inset; }
    .v-name{ font-weight:800; color:#0e1726 }
    .v-owner{ color:var(--muted); font-size:13px }
    .v-power{ font-variant-numeric: tabular-nums; font-weight:900; letter-spacing:.2px }
    .pill{
      background:var(--chip); border:1px solid var(--line); padding:6px 10px; border-radius:999px; font-weight:800;
      color:var(--accent);
    }
    .row-actions{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end }
    .btn{
      appearance:none; border:1px solid var(--line); background:#fff;
      color:var(--ink); border-radius:10px; padding:8px 12px; font-weight:800; cursor:pointer; letter-spacing:.2px;
      transition: transform .06s ease, filter .15s ease, border-color .2s ease;
    }
    .btn:hover{ filter: brightness(1.06); border-color: #cfe0f3 }
    .btn:active{ transform: translateY(1px) }
    .btn-primary{ color:white; background: linear-gradient(180deg, #38bdf8, #0ea5e9); border:none; }
    .btn-ghost{ background: transparent }

    .toolbar{ display:flex; gap:10px; align-items:center; margin:10px 0 16px; flex-wrap:wrap }
    .toolbar .tag{
      font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--line); color:var(--muted);
      background:#fff;
    }

    /* Right column panels stack */
    .stack{ display:flex; flex-direction:column; gap:18px }
    .scrollbox{
      max-height:300px; overflow:auto; padding-right:6px; border:1px dashed var(--line); border-radius:12px;
      background:#fff;
    }
    .leader-row{
      display:grid; grid-template-columns: auto 1fr auto; gap:10px; align-items:center; padding:8px 10px;
      border-bottom:1px solid #eef3f8;
    }
    .leader-row:last-child{ border-bottom:0 }
    .ranknum{
      width:28px; height:28px; display:grid; place-items:center; border-radius:8px; font-weight:900;
      color:#fff; background:linear-gradient(180deg, #7c3aed, #6d28d9);
    }
    .me .ranknum{ background:linear-gradient(180deg, #16a34a, #0ea568) }
    .mini{ font-size:12px; color:var(--muted) }

    /* Login & header */
    .auth{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin:0 0 10px }
    .input{
      background:#fff; border:1px solid var(--line); color:var(--ink);
      padding:8px 10px; border-radius:10px; outline:none; width:180px;
    }
    .idchip{ margin-left:auto; font-size:12px; color:var(--muted) }

    /* Preview popup */
    #previewPopup{
      display:none; position:fixed; inset:0; background: rgba(0,0,0,.35);
      align-items:center; justify-content:center; z-index:1000;
    }
    .modal{
      background:#fff; color:var(--ink);
      border:1px solid var(--line); border-radius:14px; padding:16px; width:min(90vw,520px); box-shadow: 0 16px 50px rgba(0,0,0,.12);
    }
    .modal-head{ display:flex; align-items:center; justify-content:space-between; margin-bottom:12px }
    #previewGrid{
      display:grid; grid-template-columns: repeat(16, 10px); gap:1px; margin-top:10px;
    }
    #previewGrid div{ width:10px; height:10px; border:1px solid #d7e2f0; background:#eff6ff }

    .dot{ display:inline-block; width:10px; height:10px; border-radius:2px; margin-right:6px; vertical-align:middle }
    .sep{ height:1px; background:var(--line); margin:10px 0 }

    /* Simple three-column grid for Suggested Battles list */
    .grid3{ display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:10px }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore, collection, doc, getDocs, getDoc, updateDoc
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB7twY7z31ucB6pGA8JC_HrVMZhA8lNaJA",
      authDomain: "bible-game-246c0.firebaseapp.com",
      projectId: "bible-game-246c0",
      storageBucket: "bible-game-246c0.appspot.com",
      messagingSenderId: "959619818996",
      appId: "1:959619818996:web:5a9fbf492e23c765e445a1"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    /* ----------------- State ----------------- */
    const params = new URLSearchParams(location.search);
    let currentUsername = params.get("username") || localStorage.getItem("username") || null;
    let villages = [];
    let campaign = 0;
    let targetGoblinId = null;

    const tribesList = ["Reuben","Simeon","Levi","Judah","Dan","Naphtali","Gad","Asher","Issachar","Zebulun","Joseph","Benjamin"];

    const buildingClassMap = {
      wall: '#111827', strongWall: 'orange', archerTower: '#ef4444',
      trap: '#10b981', lightningStriker: '#60a5fa', sniperTower: '#9ca3af', troopStructure: '#a78bfa',
      cannonTower:'#6b7280', necromancerTower:'#3b0764'
    };

    /* ----------------- Boot ----------------- */
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("loginBtn").onclick = doLogin;

      if (currentUsername) {
        document.getElementById("username").value = currentUsername;
        document.getElementById("password").value = ""; // no PW needed when returning via ?username
        loadVillagePage(true);
      }
    });

    async function doLogin(){
      const user  = document.getElementById("username").value.trim();
      const pass  = document.getElementById("password").value.trim();
      if (!user || !pass) return alert("Enter username & password.");
      const uRef  = doc(db, "users", user);
      const uSnap = await getDoc(uRef);
      if (uSnap.exists() && uSnap.data().password === pass) {
        currentUsername = user;
        localStorage.setItem("username", user);
        loadVillagePage();
      } else {
        alert("Invalid credentials.");
      }
    }

    /* ----------------- Load / Render ----------------- */
    async function loadVillagePage(){
      document.getElementById("loginSection").style.display = "none";
      document.getElementById("idChip").textContent = `Signed in as ${currentUsername}`;

      const userRef  = doc(db, "users", currentUsername);
      const userSnap = await getDoc(userRef);
      campaign       = userSnap.exists() ? (userSnap.data().campaign || 0) : 0;
      targetGoblinId = `Goblin${campaign + 1}`;

      const snap = await getDocs(collection(db, "villages"));
      villages   = snap.docs.map(d => ({ id: d.id, ...d.data() }));

      // Render order: Your Village (top) ‚Üí Suggested Battles (below) ‚Üí Active Villages
      renderLeftColumn(userSnap.exists() ? userSnap.data().tribe : null);
      renderPlayerRankings();
      await loadTribeUI();
    }

    function powerOf(v){ return (v?.power?.attack || 0) + (v?.power?.defense || 0); }

    function addSectionTitle(parent, text){
      const div = document.createElement("div");
      div.className = "sectionTitle";
      div.innerHTML = `<span>${text}</span><span class="sep" style="flex:1"></span>`;
      parent.appendChild(div);
    }

    function renderLeftColumn(myTribe){
      const list = document.getElementById("villageList");
      list.innerHTML = "";

      // --- Your Village (top)
      addSectionTitle(list, "üè∞ Your Village");
      const ownV = villages.find(v => v.owner === currentUsername);
      if (ownV) {
        const row = renderVillageRow(ownV, true, false, myTribe);
        list.appendChild(row);
      } else {
        const create = document.createElement("div");
        create.className = "village-row";
        create.innerHTML = `
          <div><div class="v-name">No village yet</div><div class="v-owner">Owner: ${currentUsername}</div></div>
          <div class="v-power">0</div>
          <div class="row-actions"></div>
        `;
        const actions = create.querySelector(".row-actions");
        const makeBtn = document.createElement("button");
        makeBtn.className = "btn btn-primary";
        makeBtn.textContent = "üõ†Ô∏è Create Village";
        makeBtn.onclick = () => location.href = `/game/createvillage.html?username=${encodeURIComponent(currentUsername)}`;
        actions.appendChild(makeBtn);
        list.appendChild(create);
      }

      // --- Suggested Battles (3) directly under your village
      addSectionTitle(list, "üéØ Suggested Battles (Top 3)");
      const meV    = villages.find(v => v.owner === currentUsername);
      const myPow  = powerOf(meV || {});
      const sugg   = villages
        .filter(v => v.owner !== currentUsername && !v.id.startsWith("Goblin"))
        .map(v => ({ v, diff: Math.abs(powerOf(v) - myPow) }))
        .sort((a,b)=> a.diff - b.diff)
        .slice(0,3);

      const grid3 = document.createElement("div");
      grid3.className = "grid3";
      sugg.forEach(({v,diff})=>{
        const card = document.createElement("div");
        card.className = "village-row";
        card.innerHTML = `
          <div>
            <div class="v-name">${v.id}</div>
            <div class="v-owner">Owner: ${v.owner}</div>
          </div>
          <div class="v-power">${powerOf(v)}</div>
          <div class="row-actions">
            <span class="pill">Œî ${diff}</span>
            <button class="btn" title="Preview">üß≠ Preview</button>
            <button class="btn btn-primary" title="Attack">‚öîÔ∏è Attack</button>
          </div>
        `;
        const acts = card.querySelector(".row-actions").children;
        acts[1].onclick = (e)=>{ e.stopPropagation(); showVillagePreview(v.grid || []); };
        acts[2].onclick = (e)=>{ e.stopPropagation(); location.href = `/game/battle.html?attacker=${encodeURIComponent(currentUsername)}&defender=${encodeURIComponent(v.owner)}`; };
        card.onclick = ()=> showVillagePreview(v.grid || []);
        grid3.appendChild(card);
      });
      list.appendChild(grid3);

      // --- Campaign Target
      addSectionTitle(list, "üéØ Campaign Target");
      const campV = villages.find(v => v.id === targetGoblinId);
      if (campV) list.appendChild(renderVillageRow(campV, false, true));
      else {
        const done = document.createElement("div");
        done.className = "village-row";
        done.innerHTML = `<div class="v-name">üéâ Campaign Complete!</div><div class="v-power"></div><div class="row-actions"></div>`;
        list.appendChild(done);
      }

      // --- Active Villages
      addSectionTitle(list, "üèòÔ∏è Active Villages");
      const others = villages
        .filter(v => v.owner !== currentUsername && !v.id.startsWith("Goblin"))
        .sort((a,b) => powerOf(b) - powerOf(a));
      others.forEach(v => list.appendChild(renderVillageRow(v, false, false)));

      // Work/Edit button row under list
      const workRow = document.createElement("div");
      workRow.style.display = 'flex';
      workRow.style.justifyContent = 'flex-start';
      workRow.style.gap = '10px';
      const workBtn = document.createElement("button");
      workBtn.className = "btn btn-primary";
      workBtn.textContent = ownV ? "üîß Work on Village" : "üõ†Ô∏è Create Village";
      workBtn.onclick = () => location.href = `/game/createvillage.html?username=${encodeURIComponent(currentUsername)}`;
      workRow.appendChild(workBtn);

      const legend = document.createElement("div");
      legend.className = "mini";
      legend.innerHTML = `
        <span class="dot" style="background:${buildingClassMap.archerTower}"></span>Archer
        <span class="dot" style="background:${buildingClassMap.sniperTower}"></span>Sniper
        <span class="dot" style="background:${buildingClassMap.lightningStriker}"></span>Lightning
        <span class="dot" style="background:${buildingClassMap.cannonTower}"></span>Cannon
        <span class="dot" style="background:${buildingClassMap.necromancerTower}"></span>Necro
        <span class="dot" style="background:${buildingClassMap.trap}"></span>Trap
        <span class="dot" style="background:${buildingClassMap.wall}"></span>Wall
        <span class="dot" style="background:${buildingClassMap.troopStructure}"></span>Troops
      `;
      workRow.appendChild(legend);
      list.appendChild(workRow);
    }

    function renderVillageRow(v, isOwn=false, isCampaign=false, myTribe=null){
      const row = document.createElement("div");
      row.className = "village-row" + (isOwn ? " own" : "");
      const total = powerOf(v);
      row.innerHTML = `
        <div>
          <div class="v-name">${isCampaign ? "üéØ " : ""}${v.id}</div>
          <div class="v-owner">Owner: ${v.owner}</div>
        </div>
        <div class="v-power">${total}</div>
        <div class="row-actions"></div>
      `;
      const actions = row.querySelector(".row-actions");

      if (isOwn){
        if (myTribe){
          const tribeBadge = document.createElement("span");
          tribeBadge.className = "pill";
          tribeBadge.textContent = `Tribe: ${myTribe}`;
          actions.appendChild(tribeBadge);
        }
        const edit = document.createElement("button");
        edit.className = "btn";
        edit.textContent = "üîß Edit";
        edit.onclick = (e)=>{ e.stopPropagation(); location.href = `/game/createvillage.html?username=${encodeURIComponent(currentUsername)}`; };
        actions.appendChild(edit);
        const preview = document.createElement("button");
        preview.className = "btn";
        preview.textContent = "üß≠ Preview";
        preview.onclick = (e)=>{ e.stopPropagation(); showVillagePreview(v.grid || []); };
        actions.appendChild(preview);
      } else {
        const pill = document.createElement("span");
        pill.className = "pill";
        pill.textContent = isCampaign ? "Campaign" : "PvP";
        actions.appendChild(pill);

        const preview = document.createElement("button");
        preview.className = "btn";
        preview.textContent = "üß≠ Preview";
        preview.onclick = (e)=>{ e.stopPropagation(); showVillagePreview(v.grid || []); };
        actions.appendChild(preview);

        const atk = document.createElement("button");
        atk.className = "btn btn-primary";
        atk.textContent = "‚öîÔ∏è Attack";
        atk.onclick = (e) => {
          e.stopPropagation();
          const url = `/game/battle.html?attacker=${encodeURIComponent(currentUsername)}&defender=${encodeURIComponent(v.owner)}`;
          location.href = url;
        };
        actions.appendChild(atk);
      }

      row.onclick = () => showVillagePreview(v.grid || []);
      return row;
    }

    /* ----------------- Player Rankings (scrollable) ----------------- */
    function renderPlayerRankings(){
      const card = document.getElementById("playerRanksCard");
      card.innerHTML = `
        <h2>üß≠ Player Rankings</h2>
        <div id="playerRanks" class="scrollbox"></div>
      `;
      const list = villages
        .filter(v => !v.id.startsWith("Goblin"))
        .map(v => ({ owner: v.owner, id: v.id, power: powerOf(v) }))
        .sort((a,b)=> b.power - a.power);

      const box = document.getElementById("playerRanks");
      box.innerHTML = "";
      list.forEach((p,i)=>{
        const row = document.createElement("div");
        row.className = "leader-row" + (p.owner===currentUsername ? " me" : "");
        row.innerHTML = `
          <div class="ranknum">${i+1}</div>
          <div><b>${p.owner}</b><div class="mini">${p.id}</div></div>
          <div class="mini"><b>${p.power}</b></div>
        `;
        box.appendChild(row);
      });
    }

    /* ----------------- Tribe UI (click to see members) ----------------- */
    async function loadTribeUI(){
      const tribeCard = document.getElementById("tribeCard");
      tribeCard.innerHTML = `
        <h2>üõ°Ô∏è Tribe</h2>
        <div id="myTribe"></div>
        <div class="sep"></div>
        <h3>üèÜ Tribe Power Rankings</h3>
        <div id="tribeRanks" class="scrollbox"></div>
      `;
      const uRef  = doc(db, "users", currentUsername);
      const uSnap = await getDoc(uRef);
      const userData = uSnap.exists() ? uSnap.data() : {};

      const my = document.getElementById("myTribe");
      if (userData.tribe){
        my.innerHTML = `<div class="pill" style="color:#0f766e;background:#e6fffb;border-color:#b6f3ee">You‚Äôre in <b>${userData.tribe}</b></div>`;
      } else {
        const sel = document.createElement("select");
        sel.className = "input";
        tribesList.forEach(t => {
          const o = document.createElement("option"); o.value=t; o.text=t; sel.appendChild(o);
        });
        const join = document.createElement("button");
        join.className = "btn btn-primary"; join.textContent = "Join Tribe";
        join.onclick = async () => { await updateDoc(uRef, { tribe: sel.value }); loadTribeUI(); };
        const row = document.createElement("div"); row.className="auth"; row.appendChild(sel); row.appendChild(join);
        my.appendChild(row);
      }

      // Build tribe map + powers
      const usersSnap = await getDocs(collection(db, "users"));
      const tribeMap = {};
      usersSnap.docs.forEach(d=>{
        const ud = d.data();
        if (ud.tribe){
          tribeMap[ud.tribe] = tribeMap[ud.tribe] || [];
          tribeMap[ud.tribe].push(d.id);
        }
      });
      const ranks = Object.entries(tribeMap).map(([tribe,members])=>{
        let sum = 0;
        members.forEach(m=>{
          const v = villages.find(x => x.owner === m);
          sum += powerOf(v || {});
        });
        return { tribe, members, power: sum };
      }).sort((a,b)=> b.power - a.power);

      // Render, with expandable member lists
      const box = document.getElementById("tribeRanks");
      box.innerHTML = "";
      ranks.forEach((r,i)=>{
        const row = document.createElement("div");
        row.className = "leader-row";
        row.style.cursor = "pointer";
        row.innerHTML = `
          <div class="ranknum">${i+1}</div>
          <div><b>${r.tribe}</b><div class="mini">${r.power} power ‚Äî click to view members</div></div>
          <div>üë•</div>
        `;
        const membersWrap = document.createElement("div");
        membersWrap.style.display = "none";
        membersWrap.style.padding = "6px 10px 10px 44px";
        membersWrap.style.background = "#fafcff";

        const list = document.createElement("div");
        list.className = "mini";
        list.innerHTML = r.members
          .map(m => {
            const v = villages.find(x => x.owner === m);
            return `<div style="padding:2px 0"><b>${m}</b> ‚Äî <span style="opacity:.8">${powerOf(v||{})} power</span></div>`;
          }).join("");
        membersWrap.appendChild(list);

        row.onclick = ()=>{
          membersWrap.style.display = (membersWrap.style.display === "none") ? "block" : "none";
        };

        box.appendChild(row);
        box.appendChild(membersWrap);
      });
    }

    /* ----------------- Preview ----------------- */
    window.showVillagePreview = function(grid){
      const modal = document.getElementById("previewPopup");
      const pg = document.getElementById("previewGrid");
      pg.innerHTML = "";
      for (let y=0; y<16; y++){
        for (let x=0; x<16; x++){
          const cell = document.createElement("div");
          const tile = grid?.find(t => t.x===x && t.y===y);
          if (tile){
            const color = buildingClassMap[tile.type] || '#cfe3ff';
            cell.style.background = color;
            cell.style.borderColor = '#dbe7f7';
          }
          pg.appendChild(cell);
        }
      }
      modal.style.display = "flex";
    };
    window.closePreview = ()=> document.getElementById("previewPopup").style.display = "none";
  </script>
</head>
<body>
  <div class="shell">
    <!-- LEFT: Your Village (top) + Suggested Battles under it + Active Villages -->
    <div id="villagesCard" class="card">
      <div class="auth">
        <h1>‚ö° Tribes Lobby</h1>
        <div class="idchip" id="idChip">Not signed in</div>
      </div>

      <div id="loginSection" class="card" style="background:#fff; border-color:var(--line); margin-bottom:12px;">
        <div class="auth">
          <input id="username" class="input" type="text" placeholder="Username" />
          <input id="password" class="input" type="password" placeholder="Password" />
          <button id="loginBtn" class="btn btn-primary">üîê Login</button>
          <span class="mini">Returning from battle? You‚Äôre auto-signed if the URL had ?username=‚Ä¶</span>
        </div>
      </div>

      <div class="toolbar">
        <span class="tag">Light UI</span>
        <span class="tag">Your Village on Top</span>
        <span class="tag">Suggested Battles (3)</span>
      </div>

      <div id="villageList"></div>
    </div>

    <!-- RIGHT: Player Rankings + Tribe Rankings (click to view members) -->
    <div class="stack">
      <div id="playerRanksCard" class="card"></div>
      <div id="tribeCard" class="card"></div>
    </div>
  </div>

  <!-- Preview Modal -->
  <div id="previewPopup">
    <div class="modal">
      <div class="modal-head">
        <h3>üèòÔ∏è Village Layout</h3>
        <button class="btn btn-ghost" onclick="closePreview()">‚ùå Close</button>
      </div>
      <div id="previewGrid"></div>
    </div>
  </div>
</body>
</html>




