<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üè∞ Tribes Lobby</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f4f7fb; --panel:#ffffff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --accent:#2563eb; --accent2:#0ea5e9; --good:#16a34a; --warn:#f59e0b; --danger:#ef4444;
      --chip:#f1f5f9; --shadow:0 8px 30px rgba(2,8,23,.06);
    }
    *{ box-sizing:border-box }
    body{
      margin:0; padding:24px; background:
        radial-gradient(1200px 600px at -200px -100px, #e0f2fe 0%, #f4f7fb 40%, #f4f7fb 100%);
      color:var(--ink); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
    }
    .shell{ max-width:1200px; margin:0 auto; display:grid; grid-template-columns: 2fr 1fr; gap:20px }

    .card{
      background: var(--panel); border:1px solid var(--line); border-radius:14px; padding:16px 16px 18px;
      box-shadow: var(--shadow);
    }
    h1{ margin:0 0 8px 0; font-size:28px; letter-spacing:.2px }
    h2{ margin:8px 0 12px; font-size:18px; color:var(--accent) }
    h3{ margin:4px 0 10px; font-size:16px; color:var(--muted) }

    /* Left column */
    #villagesCard{ min-height:680px }
    .sectionTitle{
      display:flex; align-items:center; gap:10px; margin:12px 0 8px; color:var(--accent2); font-weight:700;
    }
    .sep{ flex:1; height:1px; background:var(--line) }

    .village-row{
      display:grid; grid-template-columns: 1.5fr .7fr auto; gap:10px;
      align-items:center; padding:10px; border:1px solid var(--line); border-radius:12px;
      background: linear-gradient(180deg, #ffffff, #fafcff);
      transition: transform .06s ease, border-color .2s ease, box-shadow .2s ease;
    }
    .village-row:hover{ transform: translateY(-1px); border-color: #cfe7ff; box-shadow: 0 8px 18px rgba(2,8,23,.06) }
    .village-row.own{ outline:1px solid rgba(37,99,235,.15); box-shadow: inset 0 0 0 2px rgba(37,99,235,.08) }
    .v-name{ font-weight:700; color:#0b1220 }
    .v-owner{ color:var(--muted); font-size:13px }
    .v-power{ font-variant-numeric: tabular-nums; font-weight:800; letter-spacing:.2px }

    .pill{
      background:var(--chip); border:1px solid var(--line); padding:6px 10px; border-radius:999px; font-weight:700;
      color:var(--accent);
    }
    .tribe-pill{
      background:#eef2ff; color:#4338ca; border:1px solid #c7d2fe; padding:4px 8px; border-radius:999px; font-weight:700; font-size:12px;
      display:inline-flex; gap:6px; align-items:center;
    }
    .row-actions{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }

    .btn{
      appearance:none; border:1px solid var(--line); background:linear-gradient(180deg, #ffffff, #f8fafc);
      color:var(--ink); border-radius:10px; padding:8px 12px; font-weight:800; cursor:pointer; letter-spacing:.2px;
      transition: transform .06s ease, filter .15s ease, border-color .2s ease;
    }
    .btn:hover{ filter: brightness(1.02); border-color: #cfe7ff }
    .btn:active{ transform: translateY(1px) }
    .btn-primary{ color:#ffffff; background: linear-gradient(180deg, #3b82f6, #2563eb); border:none; }
    .btn-ghost{ background: transparent }

    /* Lists */
    #villageList{ display:flex; flex-direction:column; gap:10px }

    /* Suggested battles tiling (no overlap) */
    .grid3{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap:12px;
    }
    .village-row.suggest{ grid-template-columns: 1fr; align-items:flex-start }
    .village-row.suggest .v-power{ font-size:14px; color:var(--muted) }

    /* Right column panels stack */
    .stack{ display:flex; flex-direction:column; gap:18px }

    .scrollbox{
      max-height:300px; overflow:auto; padding-right:6px; border:1px dashed var(--line); border-radius:12px;
      background: linear-gradient(180deg, #ffffff, #fafcff);
    }
    .leader-row{
      display:grid; grid-template-columns: auto 1fr auto; gap:10px; align-items:center; padding:8px 10px;
      border-bottom:1px solid var(--line);
    }
    .leader-row:last-child{ border-bottom:0 }
    .ranknum{
      width:28px; height:28px; display:grid; place-items:center; border-radius:6px; font-weight:900;
      color:#fff; background:linear-gradient(180deg, #60a5fa, #2563eb);
    }
    .me .ranknum{ background:linear-gradient(180deg, #22c55e, #16a34a) }
    .mini{ font-size:12px; color:var(--muted) }

    /* Login & header */
    .auth{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin:0 0 10px }
    .input{
      background: #ffffff; border:1px solid var(--line); color:var(--ink);
      padding:8px 10px; border-radius:10px; outline:none; width:180px;
    }
    .idchip{ margin-left:auto; font-size:12px; color:var(--muted) }

    /* Modal */
    #previewPopup{
      display:none; position:fixed; inset:0; background: rgba(0,0,0,.2);
      align-items:center; justify-content:center; z-index:1000;
    }
    .modal{
      background: #ffffff; border:1px solid var(--line); border-radius:14px; padding:16px;
      width:min(90vw,520px); box-shadow: var(--shadow);
    }
    .modal-head{ display:flex; align-items:center; justify-content:space-between; margin-bottom:12px }
    #previewGrid{
      display:grid; grid-template-columns: repeat(16, 10px); gap:1px; margin-top:10px;
    }
    #previewGrid div{ width:10px; height:10px; border:1px solid #e5e7eb; background:#ffffff }

    /* tiny legend dots */
    .dot{ display:inline-block; width:10px; height:10px; border-radius:2px; margin-right:6px; vertical-align:middle }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore, collection, doc, getDocs, getDoc, setDoc, updateDoc
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB7twY7z31ucB6pGA8JC_HrVMZhA8lNaJA",
      authDomain: "bible-game-246c0.firebaseapp.com",
      projectId: "bible-game-246c0",
      storageBucket: "bible-game-246c0.appspot.com",
      messagingSenderId: "959619818996",
      appId: "1:959619818996:web:5a9fbf492e23c765e445a1"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    /* ----------------- State ----------------- */
    const params = new URLSearchParams(location.search);
    let currentUsername = params.get("username") || localStorage.getItem("username") || null;
    let villages = [];
    let tribeMap = {}; // tribe ‚Üí [members]

    const tribesList = ["Reuben","Simeon","Levi","Judah","Dan","Naphtali","Gad","Asher","Issachar","Zebulun","Joseph","Benjamin"];

    // Color map for preview pixels
    const buildingClassMap = {
      wall: '#111827', strongWall: 'orange', archerTower: '#ef4444',
      trap: '#10b981', lightningStriker: '#60a5fa', sniperTower: '#9ca3af', troopStructure: '#a78bfa',
      cannonTower:'#6b7280', necromancerTower:'#3b0764'
    };

    // Stats used to compute "power"
    const buildingStats = {
      wall:             { attack: 0,  defense: 2 },
      strongWall:       { attack: 0,  defense: 5 },
      archerTower:      { attack: 4,  defense: 1 },
      trap:             { attack: 3,  defense: 3 },
      lightningStriker: { attack: 6,  defense: 1 },
      troopStructure:   { attack: 5,  defense: 2 },
      sniperTower:      { attack: 15, defense: 1 },
      cannonTower:      { attack: 10, defense: 2 },
      necromancerTower: { attack: 7,  defense: 4 }
    };

    /* ----------------- Boot ----------------- */
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("loginBtn").onclick = doLogin;
      if (currentUsername) {
        document.getElementById("username").value = currentUsername;
        document.getElementById("password").value = "";
        loadVillagePage(true);
      }
    });

    /* ----------------- Login ----------------- */
    async function doLogin(){
      const user  = document.getElementById("username").value.trim();
      const pass  = document.getElementById("password").value.trim();
      if (!user || !pass) return alert("Enter username & password.");
      const uRef  = doc(db, "users", user);
      const uSnap = await getDoc(uRef);

      // Allow login if password missing (legacy) or matches; create user if missing
      if (uSnap.exists()){
        const data = uSnap.data() || {};
        if (!("password" in data) || data.password === pass){
          currentUsername = user;
          localStorage.setItem("username", user);
          await loadVillagePage();
        } else {
          alert("Invalid credentials.");
        }
      } else {
        await setDoc(uRef, { password: pass, bucks: 0, tribe: null, campaign: 0 });
        currentUsername = user;
        localStorage.setItem("username", user);
        await loadVillagePage();
      }
    }

    /* ----------------- Load / Render ----------------- */
    async function loadVillagePage(){
      document.getElementById("loginSection").style.display = "none";
      document.getElementById("idChip").textContent = `Signed in as ${currentUsername}`;

      // my user (for tribe pill)
      const userRef  = doc(db, "users", currentUsername);
      const userSnap = await getDoc(userRef);
      const myTribe  = userSnap.exists() ? (userSnap.data().tribe || null) : null;

      // villages
      const snap = await getDocs(collection(db, "villages"));
      villages   = snap.docs.map(d => ({ id: d.id, ...d.data() }));

      // build tribe map
      const usersSnap = await getDocs(collection(db, "users"));
      tribeMap = {};
      usersSnap.docs.forEach(d=>{
        const ud = d.data();
        if (ud.tribe){
          (tribeMap[ud.tribe] ||= []).push(d.id);
        }
      });

      renderLeftColumn(myTribe);
      renderPlayerRankings();
      renderTribePanel();
    }

    function powerOf(v){ 
      const grid = v?.grid || [];
      let atk=0, def=0;
      grid.forEach(t=>{
        const s = buildingStats[t.type];
        if (s){ atk += s.attack; def += s.defense; }
      });
      return (atk + def);
    }

    /* ---------- Left column: Your Village + Explore + Suggested Battles ---------- */
    function renderLeftColumn(myTribe){
      const list = document.getElementById("villageList");
      list.innerHTML = "";

      // Your Village (top)
      const ownV = villages.find(v => v.owner === currentUsername || v.id === currentUsername);
      const header = document.createElement("div");
      header.className = "sectionTitle";
      header.innerHTML = `<span>üè∞ Your Village</span><span class="sep"></span>`;
      list.appendChild(header);

      if (ownV){
        const row = buildVillageRow(ownV, true, myTribe);
        list.appendChild(row);

        // Explore Battle generator right under your village
        const exploreBar = document.createElement("div");
        exploreBar.style.display = "flex";
        exploreBar.style.gap = "10px";
        exploreBar.style.alignItems = "center";
        exploreBar.style.margin = "6px 0 4px";
        const tip = document.createElement("div");
        tip.className = "mini";
        tip.textContent = "Generate an NPC base ~100‚Äì200 power above yours and attack it.";
        const genBtn = document.createElement("button");
        genBtn.className = "btn btn-primary";
        genBtn.textContent = "üß≠ Generate Explore Battle";
        genBtn.onclick = () => generateExploreBattle(ownV);
        exploreBar.appendChild(genBtn);
        exploreBar.appendChild(tip);
        list.appendChild(exploreBar);
      } else {
        const createRow = document.createElement("div");
        createRow.className = "village-row own";
        createRow.innerHTML = `
          <div>
            <div class="v-name">No village yet</div>
            <div class="v-owner mini">Create your first village to start battling!</div>
          </div>
          <div class="v-power">0</div>
          <div class="row-actions"></div>
        `;
        const actions = createRow.querySelector(".row-actions");
        const createBtn = document.createElement("button");
        createBtn.className = "btn btn-primary";
        createBtn.textContent = "üõ†Ô∏è Create Village";
        createBtn.onclick = () => {
          location.href = `/game/createvillage.html?username=${encodeURIComponent(currentUsername)}`;
        };
        actions.appendChild(createBtn);
        list.appendChild(createRow);
      }

      // Suggested Battles (3 tiles below)
      const suggHeader = document.createElement("div");
      suggHeader.className = "sectionTitle";
      suggHeader.innerHTML = `<span>üéØ Suggested Battles</span><span class="sep"></span>`;
      list.appendChild(suggHeader);

      const suggWrap = document.createElement("div");
      suggWrap.className = "grid3";
      list.appendChild(suggWrap);

      const myPower = powerOf(ownV || {});
      const suggestions = villages
        .filter(v => (v.owner || v.id) !== currentUsername && !v.id.startsWith("Goblin") && !v.id.startsWith("NPC-"))
        .map(v => ({ v, diff: Math.abs(powerOf(v)-myPower) }))
        .sort((a,b)=> a.diff - b.diff)
        .slice(0,3);

      if (suggestions.length === 0){
        const empty = document.createElement("div");
        empty.className = "mini";
        empty.textContent = "No opponents available yet.";
        list.appendChild(empty);
      } else {
        suggestions.forEach(({v,diff})=>{
          suggWrap.appendChild(buildSuggestCard(v, diff));
        });
      }

      // Player villages (short list)
      const actHeader = document.createElement("div");
      actHeader.className = "sectionTitle";
      actHeader.innerHTML = `<span>üèòÔ∏è Active Villages</span><span class="sep"></span>`;
      list.appendChild(actHeader);

      const others = villages
        .filter(v => (v.owner || v.id) !== currentUsername && !v.id.startsWith("Goblin") && !v.id.startsWith("NPC-"))
        .sort((a,b)=> powerOf(b) - powerOf(a))
        .slice(0,12);
      others.forEach(v => list.appendChild(buildVillageRow(v, false, null)));

      // Work/Create + legend
      const actionsRow = document.createElement("div");
      actionsRow.style.display = 'flex';
      actionsRow.style.gap = '10px';
      actionsRow.style.alignItems = 'center';

      const workBtn = document.createElement("button");
      workBtn.className = "btn btn-primary";
      workBtn.textContent = ownV ? "üè∞ Work on Village" : "üõ†Ô∏è Create Village";
      workBtn.onclick = () => {
        location.href = `/game/createvillage.html?username=${encodeURIComponent(currentUsername)}`;
      };
      actionsRow.appendChild(workBtn);

      const legend = document.createElement("div");
      legend.className = "mini";
      legend.innerHTML = `
        <span class="dot" style="background:${buildingClassMap.archerTower}"></span>Archer
        <span class="dot" style="background:${buildingClassMap.sniperTower}"></span>Sniper
        <span class="dot" style="background:${buildingClassMap.lightningStriker}"></span>Lightning
        <span class="dot" style="background:${buildingClassMap.cannonTower}"></span>Cannon
        <span class="dot" style="background:${buildingClassMap.necromancerTower}"></span>Necro
        <span class="dot" style="background:${buildingClassMap.trap}"></span>Trap
        <span class="dot" style="background:${buildingClassMap.wall}"></span>Wall
        <span class="dot" style="background:${buildingClassMap.troopStructure}"></span>Troops
      `;
      actionsRow.appendChild(legend);

      list.appendChild(actionsRow);
    }

    function buildVillageRow(v, isOwn, myTribe){
      const row = document.createElement("div");
      row.className = "village-row" + (isOwn ? " own" : "");
      const total = powerOf(v);
      const ownerName = v.owner || v.id;
      row.innerHTML = `
        <div>
          <div class="v-name">${v.id}</div>
          <div class="v-owner">Owner: ${ownerName}</div>
        </div>
        <div class="v-power">${total}</div>
        <div class="row-actions"></div>
      `;
      row.onclick = () => showVillagePreview(v.grid || []);
      const actions = row.querySelector(".row-actions");

      const pill = document.createElement("span");
      pill.className = "pill";
      pill.textContent = isOwn ? "Your Village" : "PvP";
      actions.appendChild(pill);

      if (isOwn){
        if (myTribe){
          const tribe = document.createElement("span");
          tribe.className = "tribe-pill";
          tribe.innerHTML = `üõ°Ô∏è ${myTribe}`;
          actions.appendChild(tribe);
        }
        const edit = document.createElement("button");
        edit.className = "btn";
        edit.textContent = "üîß Edit";
        edit.onclick = (e)=>{ e.stopPropagation();
          location.href = `/game/createvillage.html?username=${encodeURIComponent(currentUsername)}`;
        };
        const preview = document.createElement("button");
        preview.className = "btn";
        preview.textContent = "üß≠ Preview";
        preview.onclick = (e)=>{ e.stopPropagation(); showVillagePreview(v.grid || []); };
        actions.appendChild(edit);
        actions.appendChild(preview);
      } else {
        const atk = document.createElement("button");
        atk.className = "btn";
        atk.textContent = "‚öîÔ∏è Attack";
        atk.onclick = (e) => {
          e.stopPropagation();
          const defenderName = v.owner || v.id;
          const url = `/game/battle.html?attacker=${encodeURIComponent(currentUsername)}&defender=${encodeURIComponent(defenderName)}`;
          location.href = url;
        };
        const preview = document.createElement("button");
        preview.className = "btn btn-ghost";
        preview.textContent = "üß≠ Preview";
        preview.onclick = (e)=>{ e.stopPropagation(); showVillagePreview(v.grid || []); };
        actions.appendChild(atk);
        actions.appendChild(preview);
      }
      return row;
    }

    function buildSuggestCard(v, diff){
      const card = document.createElement("div");
      card.className = "village-row suggest";
      const total = powerOf(v);
      const ownerName = v.owner || v.id;
      card.innerHTML = `
        <div>
          <div class="v-name">${v.id}</div>
          <div class="v-owner">Owner: ${ownerName}</div>
        </div>
        <div class="v-power">Their power: ${total} ‚Ä¢ Œî${diff}</div>
        <div class="row-actions">
          <span class="pill">PvP</span>
          <button class="btn">‚öîÔ∏è Attack</button>
          <button class="btn btn-ghost">üß≠ Preview</button>
        </div>
      `;
      const [ , , actions ] = card.children;
      const attackBtn = actions.querySelector("button.btn");
      attackBtn.onclick = (e)=>{
        e.stopPropagation();
        const defenderName = v.owner || v.id;
        const url = `/game/battle.html?attacker=${encodeURIComponent(currentUsername)}&defender=${encodeURIComponent(defenderName)}`;
        location.href = url;
      };
      const prevBtn = actions.querySelector(".btn.btn-ghost");
      prevBtn.onclick = (e)=>{ e.stopPropagation(); showVillagePreview(v.grid || []); };
      card.onclick = ()=> showVillagePreview(v.grid || []);
      return card;
    }

    /* ----------------- Explore Battle Generator (NPC) ----------------- */
    async function generateExploreBattle(myVillage){
      if (!myVillage){
        alert("You need a village first. Create one, then try again.");
        return;
      }
      const myPower = powerOf(myVillage);
      const minP = myPower + 100;
      const maxP = myPower + 200;

      // 1) build a grid with a wall preset + filled defenses
      const grid = generateNpcGridWithTarget(minP, maxP);

      // 2) persist NPC "village" and a matching "user" document
      const ts = Date.now();
      const npcOwner = `NPC-${currentUsername}-${ts}`;
      const villageDoc = doc(db, "villages", npcOwner);
      await setDoc(villageDoc, {
        id: npcOwner,
        owner: npcOwner,
        grid,
        power: { attack: 0, defense: 0 }
      });

      const userDoc = doc(db, "users", npcOwner);
      await setDoc(userDoc, {
        password: "npc",
        bucks: 0,
        tribe: null,
        campaign: 0
      }, { merge: true });

      // 3) go fight!
      location.href = `/game/battle.html?attacker=${encodeURIComponent(currentUsername)}&defender=${encodeURIComponent(npcOwner)}`;
    }

    function generateNpcGridWithTarget(minP, maxP){
      const size = 16;
      const occupied = new Set();
      const grid = [];

      // choose a wall preset
      const presets = [placeRingWalls, placeCornerBastions, placeStripes, placeBoxMaze];
      const preset = presets[Math.floor(Math.random()*presets.length)];
      preset(size, grid, occupied);

      // fill remaining with random mix; then tune to target power
      const pool = [
        "archerTower","sniperTower","lightningStriker","cannonTower","necromancerTower",
        "trap","troopStructure","strongWall","wall"
      ];

      // initial fill pass
      for (let y=0; y<size; y++){
        for (let x=0; x<size; x++){
          const key = `${x},${y}`;
          if (occupied.has(key)) continue;
          if (Math.random()<0.55){
            const type = pool[Math.floor(Math.random()*pool.length)];
            grid.push({x,y,type});
            occupied.add(key);
          }
        }
      }

      // compute and nudge toward range
      let p = computeGridPower(grid);
      let guard = 0;
      while ((p < minP || p > maxP) && guard < 400){
        guard++;
        if (p < minP){
          // add strong structures in empty spots
          const adds = ["sniperTower","cannonTower","necromancerTower","lightningStriker","archerTower","trap","strongWall"];
          let placed = false;
          for (let tries=0; tries<50 && !placed; tries++){
            const x = Math.floor(Math.random()*size), y = Math.floor(Math.random()*size);
            const key = `${x},${y}`;
            if (occupied.has(key)) continue;
            const type = adds[Math.floor(Math.random()*adds.length)];
            grid.push({x,y,type});
            occupied.add(key);
            placed = true;
          }
        } else {
          // too strong ‚Üí remove a higher value item
          const idx = grid.findIndex(t => ["sniperTower","cannonTower","necromancerTower","lightningStriker","trap","strongWall","archerTower"].includes(t.type));
          if (idx !== -1){
            const key = `${grid[idx].x},${grid[idx].y}`;
            occupied.delete(key);
            grid.splice(idx,1);
          } else {
            // fallback remove anything
            if (grid.length){
              const r = Math.floor(Math.random()*grid.length);
              const key2 = `${grid[r].x},${grid[r].y}`;
              occupied.delete(key2);
              grid.splice(r,1);
            }
          }
        }
        p = computeGridPower(grid);
      }
      return grid;
    }

    function computeGridPower(grid){
      let atk=0, def=0;
      grid.forEach(t=>{
        const s = buildingStats[t.type];
        if (s){ atk += s.attack; def += s.defense; }
      });
      return atk+def;
    }

    /* ---------- Wall presets ---------- */
    function placeRingWalls(size, grid, occ){
      const ring = (x,y)=> x===1||y===1||x===size-2||y===size-2;
      for (let y=0;y<size;y++){
        for (let x=0;x<size;x++){
          if (ring(x,y)){
            grid.push({x,y,type: (Math.random()<0.25?"strongWall":"wall")});
            occ.add(`${x},${y}`);
          }
        }
      }
    }
    function placeCornerBastions(size, grid, occ){
      const chunks = [
        [0,0],[0,1],[1,0],[1,1],
        [size-1,0],[size-2,0],[size-1,1],[size-2,1],
        [0,size-1],[0,size-2],[1,size-1],[1,size-2],
        [size-1,size-1],[size-2,size-1],[size-1,size-2],[size-2,size-2]
      ];
      chunks.forEach(([x,y])=>{
        grid.push({x,y,type: (Math.random()<0.5?"strongWall":"wall")});
        occ.add(`${x},${y}`);
      });
    }
    function placeStripes(size, grid, occ){
      for (let y=2; y<size; y+=3){
        for (let x=0;x<size;x++){
          grid.push({x,y,type: (Math.random()<0.3?"strongWall":"wall")});
          occ.add(`${x},${y}`);
        }
      }
    }
    function placeBoxMaze(size, grid, occ){
      for (let layer=1; layer<=3; layer++){
        const a=layer, b=size-1-layer;
        for (let x=a;x<=b;x++){
          grid.push({x, y:a, type:"wall"}); occ.add(`${x},${a}`);
          grid.push({x, y:b, type:"wall"}); occ.add(`${x},${b}`);
        }
        for (let y=a+1;y<=b-1;y++){
          grid.push({x:a, y, type:"wall"}); occ.add(`${a},${y}`);
          grid.push({x:b, y, type:"wall"}); occ.add(`${b},${y}`);
        }
      }
    }

    /* ----------------- Right: Tribe & Player panels ----------------- */
    async function renderTribePanel(){
      const tribeCard = document.getElementById("tribeCard");
      tribeCard.innerHTML = `
        <h2>üõ°Ô∏è Tribe</h2>
        <div id="myTribe"></div>
        <div class="sep" style="margin:10px 0"></div>
        <h3>üèÜ Tribe Power Rankings</h3>
        <div id="tribeRanks" class="scrollbox"></div>
      `;

      // my membership
      const uRef  = doc(db, "users", currentUsername);
      const uSnap = await getDoc(uRef);
      const userData = uSnap.exists() ? uSnap.data() : {};
      const my = document.getElementById("myTribe");

      if (userData.tribe){
        my.innerHTML = `<div class="mini">Member of <b>${userData.tribe}</b></div>`;
      } else {
        const sel = document.createElement("select");
        sel.className = "input";
        tribesList.forEach(t => {
          const o = document.createElement("option"); o.value=t; o.text=t; sel.appendChild(o);
        });
        const join = document.createElement("button");
        join.className = "btn btn-primary"; join.textContent = "Join Tribe";
        join.onclick = async () => { await updateDoc(uRef, { tribe: sel.value }); renderTribePanel(); };
        const row = document.createElement("div"); row.className="auth"; row.appendChild(sel); row.appendChild(join);
        my.appendChild(row);
      }

      // rankings
      const ranks = Object.entries(tribeMap).map(([tribe,members])=>{
        let sum = 0;
        members.forEach(m=>{
          const v = villages.find(x => (x.owner || x.id) === m);
          sum += powerOf(v || {});
        });
        return { tribe, power: sum, members };
      }).sort((a,b)=> b.power - a.power);

      const box = document.getElementById("tribeRanks");
      box.innerHTML = "";
      ranks.forEach((r,i)=>{
        const row = document.createElement("div");
        row.className = "leader-row";
        row.style.cursor = "pointer";
        row.innerHTML = `
          <div class="ranknum">${i+1}</div>
          <div><b>${r.tribe}</b><div class="mini">${r.power} power ‚Ä¢ ${r.members.length} member(s)</div></div>
          <div class="mini">üë• View</div>
        `;
        row.onclick = () => showTribeMembers(r.tribe, r.members);
        box.appendChild(row);
      });
    }

    function renderPlayerRankings(){
      const card = document.getElementById("playerRanksCard");
      card.innerHTML = `
        <h2>üß≠ Player Rankings</h2>
        <div id="playerRanks" class="scrollbox"></div>
      `;
      const list = villages
        .filter(v => !v.id.startsWith("Goblin"))
        .map(v => ({ owner: v.owner || v.id, id: v.id, power: powerOf(v) }))
        .sort((a,b)=> b.power - a.power);

      const box = document.getElementById("playerRanks");
      box.innerHTML = "";
      list.forEach((p,i)=>{
        const row = document.createElement("div");
        row.className = "leader-row" + (p.owner===currentUsername ? " me" : "");
        row.innerHTML = `
          <div class="ranknum">${i+1}</div>
          <div><b>${p.owner}</b><div class="mini">${p.id}</div></div>
          <div class="mini"><b>${p.power}</b></div>
        `;
        box.appendChild(row);
      });
    }

    /* ----------------- Preview & Tribe Members Modals ----------------- */
    window.showVillagePreview = function(grid){
      const modal = document.getElementById("previewPopup");
      const pg = document.getElementById("previewGrid");
      const head = document.querySelector("#previewPopup .modal-head h3");
      head.textContent = "üèòÔ∏è Village Layout";
      pg.innerHTML = "";
      for (let y=0; y<16; y++){
        for (let x=0; x<16; x++){
          const cell = document.createElement("div");
          const tile = grid?.find(t => t.x===x && t.y===y);
          if (tile){
            const color = buildingClassMap[tile.type] || '#94a3b8';
            cell.style.background = color;
            cell.style.borderColor = '#e5e7eb';
          }
          pg.appendChild(cell);
        }
      }
      modal.style.display = "flex";
    };
    window.closePreview = ()=> document.getElementById("previewPopup").style.display = "none";

    window.showTribeMembers = function(tribe, members){
      const modal = document.getElementById("previewPopup");
      const pg = document.getElementById("previewGrid");
      const head = document.querySelector("#previewPopup .modal-head h3");
      head.textContent = `üë• ${tribe} ‚Äî Members`;

      pg.innerHTML = "";
      const list = document.createElement("div");
      list.style.display = "grid";
      list.style.gridTemplateColumns = "1fr auto";
      list.style.gap = "8px";
      list.style.width = "100%";

      members.forEach(name=>{
        const v = villages.find(x => (x.owner || x.id) === name);
        const left = document.createElement("div");
        left.innerHTML = `<b>${name}</b><div class="mini">${v ? v.id : "No village"}</div>`;
        const right = document.createElement("div");
        right.className = "mini";
        right.textContent = `${v ? powerOf(v) : 0} power`;
        list.appendChild(left);
        list.appendChild(right);
      });

      pg.appendChild(list);
      modal.style.display = "flex";
    };
  </script>
</head>
<body>
  <div class="shell">
    <!-- LEFT: Your Village + Explore + Suggested + Some Active -->
    <div id="villagesCard" class="card">
      <div class="auth">
        <h1>‚ö° Tribes Lobby</h1>
        <div class="idchip" id="idChip">Not signed in</div>
      </div>

      <div id="loginSection" class="card" style="padding:12px; margin-bottom:12px;">
        <div class="auth">
          <input id="username" class="input" type="text" placeholder="Username" />
          <input id="password" class="input" type="password" placeholder="Password" />
          <button id="loginBtn" class="btn btn-primary">üîê Login</button>
          <span class="mini">Tip: If your user has no password saved, any password will log you in (legacy).</span>
        </div>
      </div>

      <div id="villageList"></div>
    </div>

    <!-- RIGHT: Tribes & Player Rankings -->
    <div class="stack">
      <div id="tribeCard" class="card"></div>
      <div id="playerRanksCard" class="card"></div>
    </div>
  </div>

  <!-- Modal -->
  <div id="previewPopup">
    <div class="modal">
      <div class="modal-head">
        <h3>üèòÔ∏è Village Layout</h3>
        <button class="btn btn-ghost" onclick="closePreview()">‚ùå Close</button>
      </div>
      <div id="previewGrid"></div>
    </div>
  </div>
</body>
</html>











