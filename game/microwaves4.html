<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Base Push â€” Hero & Turrets</title>
  <meta name="viewport"
        content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
  <style>
    :root{
      --bg:#020617;
      --panel:#020617;
      --ink:#e5e7eb;
      --muted:#9ca3af;
      --accent:#22c55e;
      --danger:#ef4444;
      --warn:#eab308;
      --line:#1f2933;
    }
    *{box-sizing:border-box; -webkit-tap-highlight-color:transparent;}
    html,body{margin:0;padding:0;height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
    body{display:flex;justify-content:center;align-items:stretch;}

    #gameRoot{
      display:flex;
      flex-direction:column;
      width:100%;
      max-width:1100px;
      height:100vh;
      background:radial-gradient(circle at top,#0f172a,#020617 60%);
      overflow:hidden;
      position:relative;
    }

    #topBar{
      flex:0 0 auto;
      padding:6px 8px;
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:4px;
      border-bottom:1px solid var(--line);
      background:rgba(0,0,0,0.65);
      backdrop-filter:blur(8px);
      font-size:12px;
    }

    #hudStats{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }

    .pill{
      padding:2px 8px;
      border-radius:999px;
      background:#020617;
      border:1px solid #1f2937;
      white-space:nowrap;
    }
    .pill strong{font-weight:600;}

    #btnFullscreen{
      margin-left:auto;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid #1f2937;
      background:#020617;
      color:var(--ink);
      font-size:12px;
    }
    #btnFullscreen:active{
      transform:scale(.97);
      background:#111827;
    }

    #upgradeBar{
      flex:0 0 auto;
      padding:4px 6px 6px;
      display:flex;
      gap:6px;
      min-height:40px;
      align-items:center;
      overflow-x:auto;
      border-bottom:1px solid var(--line);
      background:rgba(15,23,42,.9);
    }
    #upgradeBar::-webkit-scrollbar{height:4px;}
    #upgradeBar::-webkit-scrollbar-thumb{background:#1f2937;border-radius:999px;}

    .upgradeHint{
      font-size:11px;
      color:var(--muted);
      white-space:nowrap;
    }

    .upgradeCard{
      min-width:110px;
      max-width:140px;
      padding:6px 8px;
      border-radius:10px;
      border:1px solid #374151;
      background:#020617;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      gap:4px;
      font-size:11px;
      flex:0 0 auto;
    }
    .upgradeCard h4{
      margin:0;
      font-size:12px;
    }
    .upgradeCard small{
      color:var(--muted);
    }
    .upgradeCard:active{
      transform:scale(.97);
      border-color:var(--accent);
    }

    #canvasWrap{
      position:relative;
      flex:1 1 auto;
      background:#020617;
      overflow:hidden;
    }
    #gameCanvas{
      width:100%;
      height:100%;
      touch-action:none;
      display:block;
    }

    #overlay{
      position:absolute;
      inset:0;
      display:flex;
      justify-content:center;
      align-items:center;
      pointer-events:none;
      font-size:20px;
      font-weight:600;
      text-shadow:0 0 8px #000;
    }
    #overlay span{
      background:rgba(15,23,42,.8);
      padding:10px 16px;
      border-radius:12px;
      border:1px solid #1f2937;
    }

    #toast{
      position:absolute;
      left:50%;
      top:54px;
      transform:translateX(-50%);
      padding:6px 12px;
      border-radius:999px;
      background:rgba(8,47,73,.9);
      color:#e0f2fe;
      font-size:12px;
      border:1px solid #0ea5e9;
      opacity:0;
      pointer-events:none;
      transition:opacity .2s, transform .2s;
      z-index:10;
      white-space:nowrap;
    }
    #toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(-4px);
    }

    @media (max-width:600px){
      #topBar{font-size:11px;}
      .pill{padding:1px 6px;}
      #btnFullscreen{padding:3px 8px;font-size:11px;}
      .upgradeCard{min-width:100px;}
    }
  </style>
</head>
<body>
<div id="gameRoot">
  <div id="topBar">
    <div id="hudStats">
      <div class="pill" id="hudLevel">Lv 1</div>
      <div class="pill" id="hudHP">HP 100 / 100</div>
      <div class="pill" id="hudBase">Base 1000 / 1000</div>
      <div class="pill" id="hudXP">XP 0 / 20</div>
      <div class="pill" id="hudTip">Click / tap to move â€¢ Auto-fire</div>
    </div>
    <button id="btnFullscreen">â›¶ Fullscreen</button>
  </div>
  <div id="upgradeBar">
    <span class="upgradeHint" id="upgradeHint">Level up to choose upgrades.</span>
  </div>
  <div id="canvasWrap">
    <canvas id="gameCanvas"></canvas>
    <div id="overlay"><span></span></div>
    <div id="toast"></div>
  </div>
</div>

<script>
(function(){
  // ---------- Canvas & basic layout ----------
  var canvas = document.getElementById('gameCanvas');
  var ctx = canvas.getContext('2d');
  var overlayEl = document.getElementById('overlay');
  var overlaySpan = overlayEl.querySelector('span');
  var toastEl = document.getElementById('toast');

  var hudLevel = document.getElementById('hudLevel');
  var hudHP = document.getElementById('hudHP');
  var hudBase = document.getElementById('hudBase');
  var hudXP = document.getElementById('hudXP');

  var upgradeBar = document.getElementById('upgradeBar');
  var upgradeHint = document.getElementById('upgradeHint');

  var btnFullscreen = document.getElementById('btnFullscreen');
  var gameRoot = document.getElementById('gameRoot');

  function resizeCanvas(){
    var rect = canvas.parentElement.getBoundingClientRect();
    canvas.width = Math.floor(rect.width * window.devicePixelRatio);
    canvas.height = Math.floor(rect.height * window.devicePixelRatio);
    ctx.setTransform(window.devicePixelRatio,0,0,window.devicePixelRatio,0,0);
  }
  window.addEventListener('resize',resizeCanvas);
  resizeCanvas();

  // ---------- World & camera ----------
  var world = {
    width: 4200,
    height: 900
  };
  var cameraX = 0;
  var cameraY = 0;

  function clamp(v,min,max){ return v<min?min:(v>max?max:v); }

  // ---------- Entities ----------
  var player = {
    x: 260,
    y: world.height/2,
    size: 22,
    speed: 220,
    baseSpeed: 220,
    maxHP: 100,
    hp: 100,
    regen: 2, // per sec
    dmg: 16,
    range: 280,
    fireCooldown: 0.35,
    fireTimer: 0,
    alive: true,
    respawnTimer:0,
    level: 1,
    xp: 0,
    xpNext: 20,
    targetX: null,
    targetY: null,
    unlocked: {
      shotgun:false,
      sniper:false,
      missile:false,
      shockwave:false
    },
    atkTimers:{
      shotgun:0,
      sniper:0,
      missile:0,
      shockwave:0
    }
  };

  var base = {
    x: 80,
    y: world.height/2 - 80,
    w: 160,
    h: 160,
    maxHP: 1000,
    hp: 1000,
    alive:true
  };

  var friendlyTurrets = [];
  var enemyTurrets = [];
  var enemies = [];
  var bullets = [];
  var boss = null;
  var missiles = []; // boss missiles
  var explosions = [];

  var timeElapsed = 0;
  var enemySpawnTimer = 0;
  var gameOver = false;
  var gameWin = false;
  var upgradeOpen = false;
  var upgradeChoices = [];
  var pauseForUpgrade = false;

  function randRange(a,b){ return a + Math.random()*(b-a); }

  function distanceSq(ax,ay,bx,by){
    var dx=ax-bx, dy=ay-by;
    return dx*dx+dy*dy;
  }

  // ---------- Init map ----------
  function initTurrets(){
    friendlyTurrets.length = 0;
    // Around base
    var bx = base.x + base.w/2;
    var by = base.y + base.h/2;
    var r = 110;
    var spots = [
      {dx:0,dy:-r},
      {dx:0,dy:r},
      {dx:-r,dy:0},
      {dx:r,dy:0},
      {dx:-r*0.7,dy:-r*0.7},
      {dx:-r*0.7,dy:r*0.7}
    ];
    for(var i=0;i<spots.length;i++){
      friendlyTurrets.push(makeTurret(bx+spots[i].dx,by+spots[i].dy,false));
    }
    // Forward row
    var rowX = 800;
    friendlyTurrets.push(makeTurret(rowX, world.height*0.35, true));
    friendlyTurrets.push(makeTurret(rowX, world.height*0.65, true));
  }

  function makeTurret(x,y,isForward){
    return {
      x:x,
      y:y,
      size:20,
      maxHP:isForward?200:170,
      hp:isForward?200:170,
      fireCooldown:isForward?0.9:1.1,
      fireTimer:0,
      dmg:isForward?18:14,
      range:isForward?360:310,
      alive:true,
      side:'friendly'
    };
  }

  function makeEnemyTurrets(){
    enemyTurrets.length = 0;
    var xs = [2800, 3200, 3600];
    for(var i=0;i<xs.length;i++){
      var strength = i+1;
      enemyTurrets.push({
        x: xs[i],
        y: world.height*0.4,
        size: 22,
        maxHP: 220 + strength*60,
        hp: 220 + strength*60,
        fireCooldown:1.0 - strength*0.12,
        fireTimer:0,
        dmg: 20 + strength*10,
        range: 380 + strength*40,
        alive:true,
        side:'enemy'
      });
      enemyTurrets.push({
        x: xs[i],
        y: world.height*0.6,
        size: 22,
        maxHP: 220 + strength*60,
        hp: 220 + strength*60,
        fireCooldown:1.0 - strength*0.12,
        fireTimer:0,
        dmg: 20 + strength*10,
        range: 380 + strength*40,
        alive:true,
        side:'enemy'
      });
    }
  }

  function makeBoss(){
    boss = {
      x: world.width-220,
      y: world.height/2,
      size: 50,
      maxHP: 2000,
      hp: 2000,
      alive:true,
      missileCooldown:3.5,
      missileTimer:0,
      aggroRange: 750
    };
  }

  function resetGame(){
    player.x = base.x+base.w/2;
    player.y = base.y+base.h/2;
    player.size=22;
    player.speed=220;
    player.baseSpeed=220;
    player.maxHP=100;
    player.hp=100;
    player.regen=2;
    player.dmg=16;
    player.range=280;
    player.fireCooldown=0.35;
    player.fireTimer=0;
    player.alive=true;
    player.respawnTimer=0;
    player.level=1;
    player.xp=0;
    player.xpNext=20;
    player.targetX=null;
    player.targetY=null;
    player.unlocked.shotgun=false;
    player.unlocked.sniper=false;
    player.unlocked.missile=false;
    player.unlocked.shockwave=false;
    player.atkTimers.shotgun=0;
    player.atkTimers.sniper=0;
    player.atkTimers.missile=0;
    player.atkTimers.shockwave=0;

    base.maxHP=1000;
    base.hp=1000;
    base.alive=true;

    enemies.length=0;
    bullets.length=0;
    missiles.length=0;
    explosions.length=0;

    initTurrets();
    makeEnemyTurrets();
    makeBoss();

    timeElapsed=0;
    enemySpawnTimer=0;
    gameOver=false;
    gameWin=false;
    upgradeOpen=false;
    pauseForUpgrade=false;
    clearUpgradesUI();
    setOverlay('');
  }

  resetGame();

  // ---------- Upgrades ----------
  var ALL_UPGRADES = [
    {
      id:'range',
      title:'+15% Range',
      desc:'Hit enemies from further away.',
      apply:function(){ player.range = Math.round(player.range*1.15); }
    },
    {
      id:'speed',
      title:'+15% Move Speed',
      desc:'Move faster to kite or dodge.',
      apply:function(){ player.baseSpeed = Math.round(player.baseSpeed*1.15); }
    },
    {
      id:'hp',
      title:'+25% Max HP',
      desc:'Max HP +25% and fully heal.',
      apply:function(){
        player.maxHP = Math.round(player.maxHP*1.25);
        player.hp = player.maxHP;
      }
    },
    {
      id:'regen',
      title:'+40% Regen',
      desc:'Recover HP faster over time.',
      apply:function(){ player.regen = player.regen*1.4; }
    },
    {
      id:'damage',
      title:'+20% Damage',
      desc:'Your shots hit harder.',
      apply:function(){ player.dmg = Math.round(player.dmg*1.2); }
    },
    {
      id:'firerate',
      title:'+15% Fire Rate',
      desc:'Reduce auto-fire cooldown.',
      apply:function(){ player.fireCooldown = player.fireCooldown*0.85; }
    }
  ];

  function showToast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add('show');
    setTimeout(function(){
      toastEl.classList.remove('show');
    },1800);
  }

  function unlockSpecial(level){
    if(level===5 && !player.unlocked.shotgun){
      player.unlocked.shotgun=true;
      showToast('Unlocked: Shotgun blast!');
    } else if(level===10 && !player.unlocked.sniper){
      player.unlocked.sniper=true;
      showToast('Unlocked: Sniper beam!');
    } else if(level===15 && !player.unlocked.missile){
      player.unlocked.missile=true;
      showToast('Unlocked: Mini missiles!');
    } else if(level===20 && !player.unlocked.shockwave){
      player.unlocked.shockwave=true;
      showToast('Unlocked: Shockwave!');
    }
  }

  function openUpgradeChoices(){
    upgradeOpen = true;
    pauseForUpgrade = true;
    upgradeHint.textContent = 'Choose an upgrade:';
    // pick up to 3 random unique upgrades
    var pool = ALL_UPGRADES.slice();
    var choices = [];
    var count = Math.min(3, pool.length);
    for(var i=0;i<count;i++){
      var idx = Math.floor(Math.random()*pool.length);
      choices.push(pool[idx]);
      pool.splice(idx,1);
    }
    upgradeChoices = choices;
    renderUpgradeCards();
  }

  function clearUpgradesUI(){
    upgradeChoices = [];
    while(upgradeBar.firstChild){
      upgradeBar.removeChild(upgradeBar.firstChild);
    }
    upgradeBar.appendChild(upgradeHint);
    upgradeHint.textContent = 'Level up to choose upgrades.';
  }

  function renderUpgradeCards(){
    while(upgradeBar.firstChild){
      upgradeBar.removeChild(upgradeBar.firstChild);
    }
    upgradeBar.appendChild(upgradeHint);
    for(var i=0;i<upgradeChoices.length;i++){
      (function(up){
        var card = document.createElement('div');
        card.className='upgradeCard';
        var h4 = document.createElement('h4');
        h4.textContent=up.title;
        var p = document.createElement('small');
        p.textContent=up.desc;
        card.appendChild(h4);
        card.appendChild(p);
        card.addEventListener('click',function(){
          up.apply();
          upgradeOpen=false;
          pauseForUpgrade=false;
          clearUpgradesUI();
        });
        upgradeBar.appendChild(card);
      })(upgradeChoices[i]);
    }
  }

  function gainXP(amount){
    if(gameOver) return;
    player.xp += amount;
    while(player.xp >= player.xpNext){
      player.xp -= player.xpNext;
      levelUp();
    }
  }

  function levelUp(){
    player.level += 1;
    // Base HP growth on level
    player.maxHP = Math.round(player.maxHP + 18);
    player.hp = player.maxHP;
    player.xpNext = Math.round(player.xpNext * 1.35);
    unlockSpecial(player.level);
    openUpgradeChoices();
  }

  // ---------- Spawning enemies ----------
  function spawnEnemy(){
    var y = randRange(80, world.height-80);
    var x = randRange(world.width-400, world.width-120);
    // choose type based on timeElapsed
    var t;
    if(timeElapsed<60){
      t = Math.random()<0.7?'bug':'alien';
    }else if(timeElapsed<120){
      var r = Math.random();
      if(r<0.45) t='bug';
      else if(r<0.75) t='fast';
      else t='alien';
    }else{
      var r2 = Math.random();
      if(r2<0.32) t='bug';
      else if(r2<0.64) t='fast';
      else if(r2<0.85) t='tank';
      else t='alien';
    }

    var enemy;
    if(t==='bug'){
      enemy = {
        kind:'bug',
        emoji:'ðŸœ',
        x:x,y:y,
        size:18,
        maxHP:40,
        hp:40,
        speed:70,
        dmg:6,
        dps:10,
        xp:5,
        range:18,
        alive:true
      };
    }else if(t==='fast'){
      enemy = {
        kind:'fast',
        emoji:'ðŸ',
        x:x,y:y,
        size:16,
        maxHP:32,
        hp:32,
        speed:140,
        dmg:5,
        dps:9,
        xp:7,
        range:18,
        alive:true
      };
    }else if(t==='tank'){
      enemy = {
        kind:'tank',
        emoji:'ðŸª²',
        x:x,y:y,
        size:26,
        maxHP:120,
        hp:120,
        speed:45,
        dmg:14,
        dps:18,
        xp:12,
        range:24,
        alive:true
      };
    }else{
      // alien ranged
      enemy = {
        kind:'alien',
        emoji:'ðŸ‘¾',
        x:x,y:y,
        size:22,
        maxHP:70,
        hp:70,
        speed:60,
        dmg:10,
        dps:0, // uses bullets instead
        xp:10,
        range:230,
        fireCooldown:1.6,
        fireTimer:0,
        alive:true
      };
    }
    enemies.push(enemy);
  }

  // ---------- Bullets & damage ----------
  function addBullet(x,y,tx,ty,speed,dmg,side){
    var dx = tx-x;
    var dy = ty-y;
    var len = Math.sqrt(dx*dx+dy*dy) || 1;
    var vx = dx/len*speed;
    var vy = dy/len*speed;
    bullets.push({
      x:x,y:y,
      vx:vx,vy:vy,
      dmg:dmg,
      side:side,
      life:3,
      radius:6
    });
  }

  function hitEntity(ent, dmg){
    if(!ent.alive) return;
    ent.hp -= dmg;
    if(ent.hp <= 0){
      ent.hp = 0;
      ent.alive=false;
      if(ent===base){
        base.alive=false;
      }
    }
  }

  // ---------- Boss missiles ----------
  function fireBossMissile(targetX,targetY){
    missiles.push({
      x:boss.x,
      y:boss.y,
      tx:targetX,
      ty:targetY,
      speed:120,
      radius:10,
      arrived:false,
      explodeRadius:90,
      dmg:120
    });
  }

  // ---------- Specials ----------
  function getClosestEnemy(){
    var best=null;
    var bestD=Infinity;
    for(var i=0;i<enemies.length;i++){
      var e=enemies[i];
      if(!e.alive) continue;
      var d=distanceSq(player.x,player.y,e.x,e.y);
      if(d<bestD){
        bestD=d;
        best=e;
      }
    }
    return best;
  }

  function spawnShotgun(){
    var target = getClosestEnemy();
    if(!target) return;
    var dx = target.x-player.x;
    var dy = target.y-player.y;
    var baseAng = Math.atan2(dy,dx);
    var spread = Math.PI/6;
    var count = 5;
    for(var i=0;i<count;i++){
      var a = baseAng + spread*(i-(count-1)/2);
      var tx = player.x + Math.cos(a)*player.range;
      var ty = player.y + Math.sin(a)*player.range;
      addBullet(player.x,player.y,tx,ty,260,Math.round(player.dmg*0.7),'friendly');
    }
  }

  function spawnSniper(){
    var far=null;
    var farD=0;
    for(var i=0;i<enemies.length;i++){
      var e=enemies[i];
      if(!e.alive) continue;
      var d=distanceSq(player.x,player.y,e.x,e.y);
      if(d>farD){
        farD=d;
        far=e;
      }
    }
    if(!far) return;
    addBullet(player.x,player.y,far.x,far.y,420,Math.round(player.dmg*3),'friendly');
  }

  function spawnMiniMissiles(){
    var list=[];
    for(var i=0;i<enemies.length;i++){
      if(enemies[i].alive){
        list.push(enemies[i]);
      }
    }
    if(list.length===0) return;
    var shots = Math.min(4,list.length);
    for(var s=0;s<shots;s++){
      var idx = Math.floor(Math.random()*list.length);
      var e=list[idx];
      addBullet(player.x,player.y,e.x,e.y,180,Math.round(player.dmg*1.6),'friendly');
    }
  }

  function spawnShockwave(){
    var radius = 160;
    var dmg = Math.round(player.dmg*1.4);
    explosions.push({
      x:player.x,
      y:player.y,
      radius:radius,
      maxRadius:radius,
      life:0.35
    });
    for(var i=0;i<enemies.length;i++){
      var e=enemies[i];
      if(!e.alive) continue;
      var d = Math.sqrt(distanceSq(player.x,player.y,e.x,e.y));
      if(d<=radius){
        hitEntity(e,dmg);
        if(!e.alive){
          gainXP(e.xp);
        }
      }
    }
  }

  // ---------- Input ----------
  function handlePointer(evt){
    if(!player.alive || gameOver) return;
    var rect = canvas.getBoundingClientRect();
    var scaleX = canvas.width / window.devicePixelRatio / rect.width;
    var scaleY = canvas.height / window.devicePixelRatio / rect.height;
    var cx = (evt.clientX - rect.left) * scaleX;
    var cy = (evt.clientY - rect.top) * scaleY;
    var worldX = cameraX - canvas.width/window.devicePixelRatio/2 + cx;
    var worldY = cameraY - canvas.height/window.devicePixelRatio/2 + cy;
    player.targetX = clamp(worldX,0,world.width);
    player.targetY = clamp(worldY,0,world.height);
  }

  canvas.addEventListener('pointerdown',function(e){
    e.preventDefault();
    handlePointer(e);
  });
  canvas.addEventListener('pointermove',function(e){
    if(e.buttons&1){
      e.preventDefault();
      handlePointer(e);
    }
  });
  canvas.addEventListener('contextmenu',function(e){e.preventDefault();});

  // ---------- Fullscreen ----------
  btnFullscreen.addEventListener('click',function(){
    if(!document.fullscreenElement){
      if(gameRoot.requestFullscreen){
        gameRoot.requestFullscreen();
      }
    }else{
      if(document.exitFullscreen){
        document.exitFullscreen();
      }
    }
  });

  // ---------- Overlay ----------
  function setOverlay(text){
    if(text){
      overlayEl.style.display='flex';
      overlaySpan.textContent=text;
    }else{
      overlayEl.style.display='none';
      overlaySpan.textContent='';
    }
  }

  // ---------- Main update ----------
  var lastTime = performance.now();

  function update(dt){
    if(gameOver) return;
    if(pauseForUpgrade) return;

    timeElapsed += dt;
    enemySpawnTimer += dt;

    // spawn enemies; faster over time
    var spawnInterval = Math.max(0.5, 2.0 - timeElapsed*0.015);
    while(enemySpawnTimer >= spawnInterval){
      enemySpawnTimer -= spawnInterval;
      spawnEnemy();
    }

    // update player (move, regen, shooting)
    if(player.alive){
      if(player.targetX!==null){
        var dx = player.targetX-player.x;
        var dy = player.targetY-player.y;
        var dist = Math.sqrt(dx*dx+dy*dy);
        if(dist>2){
          var vx = dx/dist * player.baseSpeed;
          var vy = dy/dist * player.baseSpeed;
          player.x += vx*dt;
          player.y += vy*dt;
          player.x = clamp(player.x,0,world.width);
          player.y = clamp(player.y,0,world.height);
        }
      }
      // regen
      if(player.hp<player.maxHP){
        player.hp = Math.min(player.maxHP, player.hp + player.regen*dt);
      }
      // auto-fire
      player.fireTimer -= dt;
      if(player.fireTimer<=0){
        var target = null;
        var bestD = player.range*player.range;
        for(var i=0;i<enemies.length;i++){
          var e=enemies[i];
          if(!e.alive) continue;
          var d = distanceSq(player.x,player.y,e.x,e.y);
          if(d<bestD){
            bestD=d;
            target=e;
          }
        }
        if(target){
          addBullet(player.x,player.y,target.x,target.y,340,player.dmg,'friendly');
          player.fireTimer = player.fireCooldown;
        }else{
          player.fireTimer = 0.1;
        }
      }

      // specials
      if(player.unlocked.shotgun){
        player.atkTimers.shotgun += dt;
        if(player.atkTimers.shotgun>=3){
          spawnShotgun();
          player.atkTimers.shotgun=0;
        }
      }
      if(player.unlocked.sniper){
        player.atkTimers.sniper += dt;
        if(player.atkTimers.sniper>=4.5){
          spawnSniper();
          player.atkTimers.sniper=0;
        }
      }
      if(player.unlocked.missile){
        player.atkTimers.missile += dt;
        if(player.atkTimers.missile>=5.0){
          spawnMiniMissiles();
          player.atkTimers.missile=0;
        }
      }
      if(player.unlocked.shockwave){
        player.atkTimers.shockwave += dt;
        if(player.atkTimers.shockwave>=7.5){
          spawnShockwave();
          player.atkTimers.shockwave=0;
        }
      }
    }else{
      player.respawnTimer -= dt;
      if(player.respawnTimer<=0){
        // respawn
        player.alive=true;
        player.hp = player.maxHP;
        player.x = base.x+base.w/2;
        player.y = base.y+base.h/2;
        player.targetX = player.x;
        player.targetY = player.y;
      }
    }

    // Turrets (friendly)
    for(var i=0;i<friendlyTurrets.length;i++){
      var t = friendlyTurrets[i];
      if(!t.alive) continue;
      if(t.hp < t.maxHP){
        t.hp = Math.min(t.maxHP, t.hp + 3*dt); // tiny regen
      }
      t.fireTimer -= dt;
      if(t.fireTimer<=0){
        var target2=null;
        var bestD2 = t.range*t.range;
        for(var j=0;j<enemies.length;j++){
          var e2=enemies[j];
          if(!e2.alive) continue;
          var d2 = distanceSq(t.x,t.y,e2.x,e2.y);
          if(d2<bestD2){
            bestD2=d2;
            target2=e2;
          }
        }
        if(target2){
          addBullet(t.x,t.y,target2.x,target2.y,320,t.dmg,'friendly');
          t.fireTimer = t.fireCooldown;
        }else{
          t.fireTimer=0.15;
        }
      }
    }

    // Enemy turrets
    for(var i2=0;i2<enemyTurrets.length;i2++){
      var et = enemyTurrets[i2];
      if(!et.alive) continue;
      et.fireTimer -= dt;
      if(et.fireTimer<=0){
        // choose nearest target on friendly side
        var best=null;
        var bestD3 = et.range*et.range;
        // base
        if(base.alive){
          var d3 = distanceSq(et.x,et.y, base.x+base.w/2, base.y+base.h/2);
          if(d3<bestD3){bestD3=d3;best={type:'base',ref:base,x:base.x+base.w/2,y:base.y+base.h/2};}
        }
        // player
        if(player.alive){
          var d4 = distanceSq(et.x,et.y,player.x,player.y);
          if(d4<bestD3){bestD3=d4;best={type:'player',ref:player,x:player.x,y:player.y};}
        }
        // turrets
        for(var j2=0;j2<friendlyTurrets.length;j2++){
          var ft=friendlyTurrets[j2];
          if(!ft.alive) continue;
          var d5=distanceSq(et.x,et.y,ft.x,ft.y);
          if(d5<bestD3){
            bestD3=d5;
            best={type:'turret',ref:ft,x:ft.x,y:ft.y};
          }
        }
        if(best){
          addBullet(et.x,et.y,best.x,best.y,280,et.dmg,'enemy');
          et.fireTimer = et.fireCooldown;
        }else{
          et.fireTimer=0.3;
        }
      }
    }

    // Enemies movement & attacking
    for(var eIdx=0;eIdx<enemies.length;eIdx++){
      var en = enemies[eIdx];
      if(!en.alive) continue;

      // choose nearest target from base, player, turrets
      var target=null;
      var bestD=Infinity;

      if(player.alive){
        var dpl = distanceSq(en.x,en.y,player.x,player.y);
        if(dpl<bestD){
          bestD=dpl;
          target={type:'player',ref:player,x:player.x,y:player.y};
        }
      }
      if(base.alive){
        var bcx = base.x+base.w/2;
        var bcy = base.y+base.h/2;
        var db = distanceSq(en.x,en.y,bcx,bcy);
        if(db<bestD){
          bestD=db;
          target={type:'base',ref:base,x:bcx,y:bcy};
        }
      }
      for(var ftIdx=0;ftIdx<friendlyTurrets.length;ftIdx++){
        var ft2=friendlyTurrets[ftIdx];
        if(!ft2.alive) continue;
        var dt2 = distanceSq(en.x,en.y,ft2.x,ft2.y);
        if(dt2<bestD){
          bestD=dt2;
          target={type:'turret',ref:ft2,x:ft2.x,y:ft2.y};
        }
      }

      if(target){
        var dx2 = target.x-en.x;
        var dy2 = target.y-en.y;
        var dist2 = Math.sqrt(dx2*dx2+dy2*dy2);
        if(dist2>1){
          if(en.kind!=='alien' || dist2>en.range*0.6){
            // move
            en.x += dx2/dist2 * en.speed*dt;
            en.y += dy2/dist2 * en.speed*dt;
          }
        }
        // melee hit
        if(en.dps>0 && dist2 < en.size + (target.ref.size||24) + 4){
          var dmgSec = en.dps*dt;
          hitEntity(target.ref,dmgSec);
          if(target.ref===base && !base.alive){
            gameOver=true;
            gameWin=false;
            setOverlay('Defeat â€” your base fell.');
          }
          if(target.ref===player && !player.alive){
            // handled below.
          }
        }
        // alien ranged
        if(en.kind==='alien'){
          en.fireTimer -= dt;
          if(en.fireTimer<=0 && dist2<en.range*en.range){
            addBullet(en.x,en.y,target.x,target.y,260,en.dmg,'enemy');
            en.fireTimer = en.fireCooldown || 1.6;
          }
        }
      }
    }

    // Boss
    if(boss && boss.alive){
      boss.missileTimer -= dt;
      var inAggro = false;
      if(player.alive){
        var dBoss = Math.sqrt(distanceSq(player.x,player.y,boss.x,boss.y));
        inAggro = (dBoss <= boss.aggroRange);
      }
      // only fires if in aggro
      if(inAggro && boss.missileTimer<=0){
        var tx = player.x;
        var ty = player.y;
        fireBossMissile(tx,ty);
        boss.missileTimer = boss.missileCooldown;
      }
    }

    // Boss missiles
    for(var m=0;m<missiles.length;m++){
      var ms = missiles[m];
      if(ms.arrived) continue;
      var dxm = ms.tx-ms.x;
      var dym = ms.ty-ms.y;
      var distm = Math.sqrt(dxm*dxm+dym*dym);
      if(distm<10){
        ms.arrived=true;
        // explode
        explosions.push({
          x:ms.tx,
          y:ms.ty,
          radius:ms.explodeRadius,
          maxRadius:ms.explodeRadius,
          life:0.45
        });
        // damage friendly
        var re = ms.explodeRadius;
        var reSq = re*re;
        // player
        if(player.alive){
          var dp = distanceSq(player.x,player.y,ms.tx,ms.ty);
          if(dp<=reSq){
            player.hp -= ms.dmg;
            if(player.hp<=0){
              player.hp=0;
              player.alive=false;
              player.respawnTimer=10;
              player.targetX=null;
              player.targetY=null;
            }
          }
        }
        // base (center)
        if(base.alive){
          var dbc = distanceSq(base.x+base.w/2,base.y+base.h/2,ms.tx,ms.ty);
          if(dbc<=reSq){
            hitEntity(base,ms.dmg*1.2);
            if(!base.alive){
              gameOver=true;
              gameWin=false;
              setOverlay('Defeat â€” your base fell.');
            }
          }
        }
        // friendly turrets
        for(var fIdx=0;fIdx<friendlyTurrets.length;fIdx++){
          var ft3=friendlyTurrets[fIdx];
          if(!ft3.alive) continue;
          var dft = distanceSq(ft3.x,ft3.y,ms.tx,ms.ty);
          if(dft<=reSq){
            hitEntity(ft3,ms.dmg);
          }
        }
      }else{
        ms.x += dxm/distm*ms.speed*dt;
        ms.y += dym/distm*ms.speed*dt;
      }
    }

    // Bullets
    for(var bIdx=0;bIdx<bullets.length;bIdx++){
      var bl = bullets[bIdx];
      if(!bl) continue;
      bl.life -= dt;
      if(bl.life<=0){
        bullets[bIdx]=null;
        continue;
      }
      bl.x += bl.vx*dt;
      bl.y += bl.vy*dt;
      if(bl.x< -50 || bl.x>world.width+50 || bl.y< -50 || bl.y>world.height+50){
        bullets[bIdx]=null;
        continue;
      }

      if(bl.side==='friendly'){
        // check enemies & boss & enemy turrets
        var hit = false;
        for(var e2Idx=0;e2Idx<enemies.length;e2Idx++){
          var e2=enemies[e2Idx];
          if(!e2.alive) continue;
          var de = distanceSq(bl.x,bl.y,e2.x,e2.y);
          var rad = bl.radius + e2.size*0.7;
          if(de<=rad*rad){
            hitEntity(e2,bl.dmg);
            if(!e2.alive){
              gainXP(e2.xp);
            }
            hit=true;
            break;
          }
        }
        if(!hit && boss && boss.alive){
          var dboss = distanceSq(bl.x,bl.y,boss.x,boss.y);
          var radB = bl.radius + boss.size;
          if(dboss<=radB*radB){
            hitEntity(boss,bl.dmg);
            hit=true;
          }
        }
        if(!hit){
          for(var et3Idx=0;et3Idx<enemyTurrets.length;et3Idx++){
            var et3=enemyTurrets[et3Idx];
            if(!et3.alive) continue;
            var det=distanceSq(bl.x,bl.y,et3.x,et3.y);
            var radet = bl.radius + et3.size;
            if(det<=radet*radet){
              hitEntity(et3,bl.dmg);
              hit=true;
              break;
            }
          }
        }
        if(hit){
          bullets[bIdx]=null;
        }
      }else{
        // enemy bullet -> hit player, base, friendly turrets
        var hit2=false;
        if(player.alive){
          var dp2 = distanceSq(bl.x,bl.y,player.x,player.y);
          var rp = bl.radius + player.size;
          if(dp2<=rp*rp){
            player.hp -= bl.dmg;
            if(player.hp<=0){
              player.hp=0;
              player.alive=false;
              player.respawnTimer=10;
              player.targetX=null;
              player.targetY=null;
            }
            hit2=true;
          }
        }
        if(!hit2 && base.alive){
          var db2 = distanceSq(bl.x,bl.y,base.x+base.w/2,base.y+base.h/2);
          var rb = bl.radius + Math.max(base.w,base.h)/2;
          if(db2<=rb*rb){
            hitEntity(base,bl.dmg);
            if(!base.alive){
              gameOver=true;
              gameWin=false;
              setOverlay('Defeat â€” your base fell.');
            }
            hit2=true;
          }
        }
        if(!hit2){
          for(var ft4Idx=0;ft4Idx<friendlyTurrets.length;ft4Idx++){
            var ft4=friendlyTurrets[ft4Idx];
            if(!ft4.alive) continue;
            var dft2=distanceSq(bl.x,bl.y,ft4.x,ft4.y);
            var rft = bl.radius + ft4.size;
            if(dft2<=rft*rft){
              hitEntity(ft4,bl.dmg);
              hit2=true;
              break;
            }
          }
        }
        if(hit2){
          bullets[bIdx]=null;
        }
      }
    }

    // explosions fade
    for(var ex=0;ex<explosions.length;ex++){
      var exo=explosions[ex];
      exo.life -= dt;
      if(exo.life<0){
        explosions.splice(ex,1);
        ex--;
      }
    }

    // Clean dead bullets
    var newBullets=[];
    for(var nb=0;nb<bullets.length;nb++){
      if(bullets[nb]) newBullets.push(bullets[nb]);
    }
    bullets=newBullets;

    // Player death check vs melee (maybe took enough)
    if(player.alive && player.hp<=0){
      player.alive=false;
      player.respawnTimer=10;
      player.targetX=null;
      player.targetY=null;
    }

    // Base defeat
    if(base.alive===false && !gameOver){
      gameOver=true;
      gameWin=false;
      setOverlay('Defeat â€” your base fell.');
    }

    // Win condition: boss dead, no enemy turrets alive, no enemies alive
    if(boss && !boss.alive && !gameOver){
      var anyTurret=false;
      for(var qt=0;qt<enemyTurrets.length;qt++){
        if(enemyTurrets[qt].alive) {anyTurret=true; break;}
      }
      var anyEnemy=false;
      for(var qe=0;qe<enemies.length;qe++){
        if(enemies[qe].alive) {anyEnemy=true; break;}
      }
      if(!anyTurret && !anyEnemy){
        gameOver=true;
        gameWin=true;
        setOverlay('Victory â€” boss defeated!');
      }
    }

    // camera follows player
    var camTargetX = player.x;
    var camTargetY = player.y;
    cameraX = clamp(camTargetX, canvas.width/window.devicePixelRatio/2, world.width - canvas.width/window.devicePixelRatio/2);
    cameraY = clamp(camTargetY, canvas.height/window.devicePixelRatio/2, world.height - canvas.height/window.devicePixelRatio/2);
  }

  // ---------- Drawing ----------
  function worldToScreen(wx,wy){
    var sx = wx - cameraX + canvas.width/window.devicePixelRatio/2;
    var sy = wy - cameraY + canvas.height/window.devicePixelRatio/2;
    return {x:sx,y:sy};
  }

  function drawBar(x,y,w,h,ratio,colorBg,colorFg){
    ctx.fillStyle=colorBg;
    ctx.fillRect(x,y,w,h);
    ctx.fillStyle=colorFg;
    ctx.fillRect(x,y,w*ratio,h);
  }

  function render(){
    ctx.clearRect(0,0,canvas.width/window.devicePixelRatio,canvas.height/window.devicePixelRatio);

    // Background grid
    ctx.save();
    ctx.fillStyle='#020617';
    ctx.fillRect(0,0,canvas.width/window.devicePixelRatio,canvas.height/window.devicePixelRatio);
    ctx.strokeStyle='#0b1220';
    ctx.lineWidth=1;
    var gridSize=60;
    var camOffsetX = cameraX%gridSize;
    var camOffsetY = cameraY%gridSize;
    var w = canvas.width/window.devicePixelRatio;
    var h = canvas.height/window.devicePixelRatio;
    for(var gx=-camOffsetX;gx<w;gx+=gridSize){
      ctx.beginPath();ctx.moveTo(gx,0);ctx.lineTo(gx,h);ctx.stroke();
    }
    for(var gy=-camOffsetY;gy<h;gy+=gridSize){
      ctx.beginPath();ctx.moveTo(0,gy);ctx.lineTo(w,gy);ctx.stroke();
    }
    ctx.restore();

    // base
    if(base.alive){
      var bc = worldToScreen(base.x+base.w/2,base.y+base.h/2);
      ctx.fillStyle='#111827';
      ctx.fillRect(bc.x-base.w/2,bc.y-base.h/2,base.w,base.h);
      ctx.strokeStyle='#22c55e';
      ctx.lineWidth=3;
      ctx.strokeRect(bc.x-base.w/2,bc.y-base.h/2,base.w,base.h);
      // highlight
      drawBar(bc.x-50,bc.y-base.h/2-10,100,5, base.hp/base.maxHP,'#1f2937','#22c55e');
    }else{
      var bc2 = worldToScreen(base.x+base.w/2,base.y+base.h/2);
      ctx.fillStyle='#111827';
      ctx.fillRect(bc2.x-base.w/2,bc2.y-base.h/2,base.w,base.h);
      ctx.strokeStyle='#991b1b';
      ctx.lineWidth=3;
      ctx.strokeRect(bc2.x-base.w/2,bc2.y-base.h/2,base.w,base.h);
    }

    // friendly turrets (triangles)
    for(var i=0;i<friendlyTurrets.length;i++){
      var t=friendlyTurrets[i];
      var ts=worldToScreen(t.x,t.y);
      if(!t.alive){
        ctx.globalAlpha=0.3;
      }
      ctx.beginPath();
      ctx.moveTo(ts.x,ts.y-t.size);
      ctx.lineTo(ts.x-t.size*0.9,ts.y+t.size*0.8);
      ctx.lineTo(ts.x+t.size*0.9,ts.y+t.size*0.8);
      ctx.closePath();
      ctx.fillStyle='#0f766e';
      ctx.fill();
      ctx.strokeStyle='#99f6e4';
      ctx.lineWidth=2;
      ctx.stroke();
      // hp bar
      var ratio = t.hp/t.maxHP;
      drawBar(ts.x-18,ts.y+t.size+2,36,4,'#1f2937', ratio>0.4?'#22c55e':'#f97316');
      ctx.globalAlpha=1;
    }

    // enemy turrets
    for(var j=0;j<enemyTurrets.length;j++){
      var et=enemyTurrets[j];
      var es=worldToScreen(et.x,et.y);
      if(!et.alive){
        ctx.globalAlpha=0.35;
      }
      ctx.beginPath();
      ctx.moveTo(es.x,es.y-et.size);
      ctx.lineTo(es.x-et.size*0.9,es.y+et.size*0.8);
      ctx.lineTo(es.x+et.size*0.9,es.y+et.size*0.8);
      ctx.closePath();
      ctx.fillStyle='#7f1d1d';
      ctx.fill();
      ctx.strokeStyle='#fecaca';
      ctx.lineWidth=2;
      ctx.stroke();
      var ratio2=et.hp/et.maxHP;
      drawBar(es.x-20,es.y+et.size+3,40,4,'#1f2937', ratio2>0.4?'#f97316':'#ef4444');
      ctx.globalAlpha=1;
    }

    // boss
    if(boss){
      var bs = worldToScreen(boss.x,boss.y);
      ctx.beginPath();
      ctx.arc(bs.x,bs.y,boss.size,0,Math.PI*2);
      ctx.fillStyle=boss.alive?'#7c2d12':'#1f2937';
      ctx.fill();
      ctx.strokeStyle='#f97316';
      ctx.lineWidth=3;
      ctx.stroke();
      var ratio3 = boss.hp/boss.maxHP;
      drawBar(bs.x-60,bs.y-boss.size-10,120,6,'#1f2937', ratio3>0.4?'#f97316':'#ef4444');
      ctx.fillStyle='#fed7aa';
      ctx.font='16px system-ui';
      ctx.textAlign='center';
      ctx.fillText('ðŸ‘¹',bs.x,bs.y+6);
    }

    // hero
    var ps = worldToScreen(player.x,player.y);
    if(player.alive){
      ctx.fillStyle='#38bdf8';
    }else{
      ctx.fillStyle='#64748b';
    }
    ctx.fillRect(ps.x-player.size/2,ps.y-player.size/2,player.size,player.size);
    ctx.strokeStyle='#f9fafb';
    ctx.lineWidth=2;
    ctx.strokeRect(ps.x-player.size/2,ps.y-player.size/2,player.size,player.size);
    // hero HP
    drawBar(ps.x-24,ps.y-player.size/2-8,48,4,'#1f2937', player.hp>player.maxHP*0.4?'#22c55e':'#ef4444');

    // enemies
    ctx.font='20px system-ui';
    ctx.textAlign='center';
    ctx.textBaseline='middle';
    for(var eIdx=0;eIdx<enemies.length;eIdx++){
      var en=enemies[eIdx];
      if(!en.alive) continue;
      var es2=worldToScreen(en.x,en.y);
      ctx.fillStyle='#0f172a';
      ctx.beginPath();
      ctx.arc(es2.x,es2.y,en.size,0,Math.PI*2);
      ctx.fill();
      ctx.fillStyle='#fef9c3';
      ctx.fillText(en.emoji,es2.x,es2.y+1);
      var ratioE = en.hp/en.maxHP;
      drawBar(es2.x-en.size,es2.y-en.size-7,en.size*2,4,'#1f2937', ratioE>0.4?'#22c55e':'#f97316');
    }

    // bullets
    for(var bIdx=0;bIdx<bullets.length;bIdx++){
      var bl=bullets[bIdx];
      if(!bl) continue;
      var bs2=worldToScreen(bl.x,bl.y);
      ctx.beginPath();
      ctx.arc(bs2.x,bs2.y,4,0,Math.PI*2);
      ctx.fillStyle = bl.side==='friendly' ? '#e5e7eb' : '#fb7185';
      ctx.fill();
    }

    // boss missiles
    for(var m=0;m<missiles.length;m++){
      var ms=missiles[m];
      var msS=worldToScreen(ms.x,ms.y);
      ctx.beginPath();
      ctx.arc(msS.x,msS.y,ms.radius,0,Math.PI*2);
      ctx.fillStyle='#f97316';
      ctx.fill();
      ctx.strokeStyle='#fed7aa';
      ctx.lineWidth=2;
      ctx.stroke();
    }

    // explosions
    for(var ex=0;ex<explosions.length;ex++){
      var exo=explosions[ex];
      var t = exo.life/0.45;
      var rNow = exo.maxRadius * (1-t);
      var exs=worldToScreen(exo.x,exo.y);
      ctx.beginPath();
      ctx.arc(exs.x,exs.y,rNow,0,Math.PI*2);
      ctx.strokeStyle='rgba(248,250,252,'+t+')';
      ctx.lineWidth=4;
      ctx.stroke();
    }

    // HUD updates
    hudLevel.textContent = 'Lv '+player.level;
    hudHP.textContent = 'HP '+Math.round(player.hp)+' / '+player.maxHP;
    hudBase.textContent = 'Base '+Math.round(base.hp)+' / '+base.maxHP;
    hudXP.textContent = 'XP '+Math.round(player.xp)+' / '+player.xpNext;

    if(!player.alive && !gameOver){
      setOverlay('You died â€“ respawn in '+Math.ceil(player.respawnTimer)+'s');
    }else if(!gameOver){
      setOverlay('');
    }
  }

  // ---------- Game loop ----------
  function loop(now){
    var dt = (now-lastTime)/1000;
    if(dt>0.05) dt=0.05;
    lastTime=now;
    update(dt);
    render();
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

  // Allow restart on click of overlay after game over
  overlayEl.addEventListener('click',function(){
    if(gameOver){
      resetGame();
    }
  });

})();
</script>
</body>
</html>


