<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Monster Quest ‚Äî Firebase RPG</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#020617;
      --panel:#0b1120;
      --ink:#e5e7eb;
      --muted:#9ca3af;
      --accent:#22c55e;
      --danger:#ef4444;
      --zone1:#14532d;
      --zone2:#1d4ed8;
      --zone3:#7c2d12;
      --zone4:#4b5563;
      --zone5:#065f46;
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
    body{
      background:radial-gradient(circle at top,#0f172a,#020617);
      color:var(--ink);
      display:flex;
      justify-content:center;
      align-items:center;
      min-height:100vh;
    }
    #app{
      width:100%;
      max-width:1100px;
      height:95vh;
      max-height:800px;
      background:rgba(15,23,42,.95);
      border-radius:18px;
      box-shadow:0 30px 80px rgba(0,0,0,.7);
      display:flex;
      overflow:hidden;
      border:1px solid #1f2937;
    }
    #leftPane{
      flex:2.1;
      border-right:1px solid #1f2937;
      position:relative;
      overflow:hidden;
      background:#020617;
    }
    #rightPane{
      flex:1.2;
      display:flex;
      flex-direction:column;
      background:linear-gradient(180deg,#020617,#020617,#020617);
    }
    #mapView{
      width:100%;
      height:100%;
      display:grid;
      grid-template-columns:repeat(15,1fr);
      grid-template-rows:repeat(15,1fr);
      gap:1px;
      padding:6px;
      background:#000;
    }
    .tile{
      position:relative;
      border-radius:4px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:12px;
      color:#e5e7eb;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
    }
    .tile.zone1{background:var(--zone1);}
    .tile.zone2{background:var(--zone2);}
    .tile.zone3{background:var(--zone3);}
    .tile.zone4{background:var(--zone4);}
    .tile.zone5{background:var(--zone5);}
    .tile.bush::after{
      content:"üåø";
      position:absolute;
      font-size:14px;
    }
    .tile.rock::after{
      content:"ü™®";
      position:absolute;
      font-size:14px;
    }
    .tile.shop::after{
      content:"üè™";
      position:absolute;
      font-size:16px;
    }
    .tile.arena::after{
      content:"‚öîÔ∏è";
      position:absolute;
      font-size:15px;
    }
    .playerMarker{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:16px;
    }
    .playerMarker span{
      filter:drop-shadow(0 0 4px rgba(0,0,0,.7));
    }

    /* Right pane */
    #header{
      padding:10px 12px;
      border-bottom:1px solid #1f2937;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    #header h1{
      font-size:18px;
      font-weight:600;
      letter-spacing:.03em;
    }
    #header small{
      color:var(--muted);
      font-size:11px;
    }
    .pill{
      padding:4px 8px;
      border-radius:999px;
      border:1px solid #1f2937;
      font-size:11px;
      color:var(--muted);
    }
    #metaRow{
      padding:6px 10px 8px;
      border-bottom:1px solid #1f2937;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      font-size:12px;
      color:var(--muted);
    }
    #inventory{
      padding:6px 10px;
      border-bottom:1px solid #1f2937;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      font-size:12px;
    }
    .chip{
      padding:4px 8px;
      border-radius:999px;
      background:#0f172a;
      border:1px solid #1f2937;
      display:flex;
      align-items:center;
      gap:4px;
      font-size:11px;
    }
    .chip span{
      font-size:13px;
    }
    #controls{
      padding:8px 10px;
      border-bottom:1px solid #1f2937;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      font-size:12px;
    }
    button{
      background:var(--accent);
      border:none;
      color:#ecfdf5;
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:4px;
    }
    button.secondary{
      background:#0f172a;
      color:var(--muted);
      border:1px solid #1f2937;
    }
    button.danger{
      background:var(--danger);
    }
    button:disabled{
      opacity:.5;
      cursor:not-allowed;
    }
    input[type="text"]{
      background:#020617;
      color:var(--ink);
      border-radius:999px;
      border:1px solid #1f2937;
      padding:4px 9px;
      font-size:12px;
      min-width:0;
    }
    #log{
      flex:1;
      padding:8px 10px;
      font-size:12px;
      overflow-y:auto;
    }
    .logLine{
      margin-bottom:4px;
      color:#e5e7eb;
    }
    .logLine span.tag{
      font-size:10px;
      padding:1px 4px;
      border-radius:999px;
      margin-right:4px;
      background:#0f172a;
      color:var(--muted);
    }
    #footer{
      padding:6px 10px;
      border-top:1px solid #1f2937;
      font-size:10px;
      color:var(--muted);
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    /* Overlays (start, battle, shop, arena, game over) */
    .overlay{
      position:absolute;
      inset:0;
      background:rgba(15,23,42,.96);
      display:none;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:10;
    }
    .overlay.visible{display:flex;}
    .panel{
      background:#020617;
      border-radius:16px;
      border:1px solid #1f2937;
      padding:14px 16px;
      width:100%;
      max-width:420px;
      max-height:90%;
      display:flex;
      flex-direction:column;
      gap:8px;
      overflow:hidden;
    }
    .panelHeader{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      border-bottom:1px solid #1f2937;
      padding-bottom:6px;
    }
    .panelHeader h2{
      font-size:16px;
    }
    .panelBody{
      flex:1;
      overflow-y:auto;
      padding-top:4px;
      font-size:12px;
    }
    .panelFooter{
      padding-top:6px;
      border-top:1px solid #1f2937;
      display:flex;
      justify-content:flex-end;
      gap:8px;
      flex-wrap:wrap;
    }
    .row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
      margin-bottom:4px;
    }
    .row strong{font-size:12px;}
    .battleStats{
      display:flex;
      gap:6px;
      margin-bottom:6px;
      flex-wrap:wrap;
    }
    .badge{
      border-radius:999px;
      padding:1px 6px;
      font-size:10px;
      border:1px solid #1f2937;
      background:#020617;
      color:var(--muted);
    }
    .hpBar{
      width:100%;
      height:6px;
      background:#111827;
      border-radius:999px;
      overflow:hidden;
      margin-top:2px;
    }
    .hpFill{
      height:100%;
      background:linear-gradient(90deg,#22c55e,#f97316);
    }
    .sectionTitle{
      font-weight:600;
      margin:4px 0 2px;
      color:#e5e7eb;
    }
    .listItem{
      padding:4px 4px;
      border-radius:6px;
      border:1px solid #1f2937;
      margin-bottom:4px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:4px;
    }
    @media (max-width:900px){
      #app{flex-direction:column;height:100vh;max-height:none;border-radius:0;}
      #leftPane{flex:1.6;border-right:none;border-bottom:1px solid #1f2937;}
      #rightPane{flex:1.4;}
    }
  </style>
</head>
<body>
<div id="app">
  <div id="leftPane">
    <div id="mapView"></div>

    <!-- Start / Save selection overlay -->
    <div id="startOverlay" class="overlay visible">
      <div class="panel">
        <div class="panelHeader">
          <h2>Monster Quest</h2>
          <button class="secondary" id="btnStartClose" style="padding-inline:8px;font-size:11px;">X</button>
        </div>
        <div class="panelBody">
          <p style="margin-bottom:8px;color:var(--muted);">
            Choose a <strong>save name</strong>. You can start a new adventure or load an existing one
            (saved under your anonymous Firebase ID).
          </p>
          <label style="font-size:12px;display:block;margin-bottom:4px;">Save Name</label>
          <input type="text" id="saveNameInput" placeholder="e.g. my-first-run" style="width:100%;margin-bottom:8px;">
          <p id="startStatus" style="font-size:11px;color:var(--muted);min-height:14px;"></p>
        </div>
        <div class="panelFooter">
          <button class="secondary" id="btnLoadGame">Load Game</button>
          <button id="btnNewGame">Start New Game</button>
        </div>
      </div>
    </div>

    <!-- Battle overlay -->
    <div id="battleOverlay" class="overlay">
      <div class="panel">
        <div class="panelHeader">
          <h2 id="battleTitle">Wild Battle</h2>
          <button class="secondary" id="btnBattleClose">X</button>
        </div>
        <div class="panelBody" id="battleBody">
          <!-- Filled by JS -->
        </div>
        <div class="panelFooter" id="battleFooter">
          <!-- Actions: abilities, capture, potion, switch, run (if wild) -->
        </div>
      </div>
    </div>

    <!-- Shop overlay -->
    <div id="shopOverlay" class="overlay">
      <div class="panel">
        <div class="panelHeader">
          <h2>Item Shop</h2>
          <button class="secondary" id="btnShopClose">X</button>
        </div>
        <div class="panelBody" id="shopBody"></div>
        <div class="panelFooter">
          <button class="secondary" id="btnShopBack">Back to Map</button>
        </div>
      </div>
    </div>

    <!-- Arena overlay -->
    <div id="arenaOverlay" class="overlay">
      <div class="panel">
        <div class="panelHeader">
          <h2>Arena Challenge</h2>
          <button class="secondary" id="btnArenaClose">X</button>
        </div>
        <div class="panelBody" id="arenaBody"></div>
        <div class="panelFooter">
          <button class="secondary" id="btnArenaCancel">Leave Arena</button>
          <button id="btnArenaStart">Begin Battle</button>
        </div>
      </div>
    </div>

    <!-- Game Over overlay -->
    <div id="gameOverOverlay" class="overlay">
      <div class="panel">
        <div class="panelHeader">
          <h2>Game Over</h2>
        </div>
        <div class="panelBody">
          <p style="margin-bottom:8px;">All of your critters have fallen. This save is done.</p>
          <p style="font-size:11px;color:var(--muted);">
            You can start a new game with the same or a different save name from the main menu.
          </p>
        </div>
        <div class="panelFooter">
          <button id="btnGameOverToMenu">Return to Menu</button>
        </div>
      </div>
    </div>
  </div>

  <div id="rightPane">
    <div id="header">
      <div>
        <h1>Monster Quest</h1>
        <small id="userTag">Connecting to Firebase‚Ä¶</small>
      </div>
      <div class="pill" id="saveTag">No save loaded</div>
    </div>
    <div id="metaRow">
      <div>Zone: <span id="zoneName">-</span></div>
      <div>Pos: <span id="posLabel">-</span></div>
      <div>Mode: <span id="modeLabel">Exploration</span></div>
    </div>
    <div id="inventory"></div>
    <div id="controls">
      <input type="text" id="quickSaveName" placeholder="Save name" style="flex:1;min-width:80px;">
      <button class="secondary" id="btnQuickLoad" style="font-size:11px;">Load</button>
      <button id="btnQuickSave" style="font-size:11px;">Save</button>
      <button class="secondary" id="btnCenter" style="font-size:11px;">Center on Player</button>
    </div>
    <div id="log"></div>
    <div id="footer">
      <span>Click / tap a tile to move. Bushes / rocks increase encounter odds.</span>
      <span style="opacity:.7;">v0.1 proto</span>
    </div>
  </div>
</div>

<script type="module">
  // ----------------------------------------
  // Firebase init (anonymous auth, Firestore)
  // ----------------------------------------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB7twY7z31ucB6pGA8JC_HrVMZhA8lNaJA",
    authDomain: "bible-game-246c0.firebaseapp.com",
    databaseURL: "https://bible-game-246c0-default-rtdb.firebaseio.com",
    projectId: "bible-game-246c0",
    storageBucket: "bible-game-246c0.firebasestorage.app",
    messagingSenderId: "959619818996",
    appId: "1:959619818996:web:5a9fbf492e23c765e445a1",
    measurementId: "G-8PR6LVKSH3"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUser = null;
  let savesCache = {}; // map of saveName -> gameState
  const userTagEl = document.getElementById("userTag");
  const saveTagEl = document.getElementById("saveTag");
  const logEl = document.getElementById("log");
  const invEl = document.getElementById("inventory");
  const zoneNameEl = document.getElementById("zoneName");
  const posLabelEl = document.getElementById("posLabel");
  const modeLabelEl = document.getElementById("modeLabel");

  // ----------------------------------------
  // Game data definitions
  // ----------------------------------------

  const ELEMENTS = ["Fire","Water","Nature","Storm","Stone"];

  const TYPE_CHART = {
    Fire:   { Nature:2, Water:0.5, Stone:0.5 },
    Water:  { Fire:2, Stone:2, Nature:0.5, Storm:0.5 },
    Nature: { Water:2, Stone:2, Fire:0.5 },
    Storm:  { Water:2, Stone:0.5 },
    Stone:  { Storm:2, Fire:2, Water:0.5, Nature:0.5 }
  };

  function typeMultiplier(att, def){
    const row = TYPE_CHART[att];
    if(row && row[def] != null) return row[def];
    return 1;
  }

 const SPECIES = [
  // =========================
  // WEAK TIER (10)
  // =========================

  // Fire (2)
  {
    id:"emberkit",
    name:"Emberkit",
    element:"Fire",
    baseHP:70,
    baseAtk:14,
    baseDef:12,
    baseSpd:18,
    abilities:[
      {name:"Warm Nip", kind:"damage", power:16, maxCharges:7},
      {name:"Tiny Ember", kind:"damage", power:18, maxCharges:5}
    ]
  },
  {
    id:"cinderchip",
    name:"Cinderchip",
    element:"Fire",
    baseHP:68,
    baseAtk:15,
    baseDef:11,
    baseSpd:20,
    abilities:[
      {name:"Cinder Peck", kind:"damage", power:17, maxCharges:7},
      {name:"Glow Up", kind:"buffAtk", amount:4, maxCharges:3}
    ]
  },

  // Water (2)
  {
    id:"splashling",
    name:"Splashling",
    element:"Water",
    baseHP:72,
    baseAtk:13,
    baseDef:13,
    baseSpd:17,
    abilities:[
      {name:"Tiny Wave", kind:"damage", power:16, maxCharges:7},
      {name:"Soothing Drip", kind:"heal", amount:18, maxCharges:3}
    ]
  },
  {
    id:"drizzlefin",
    name:"Drizzlefin",
    element:"Water",
    baseHP:74,
    baseAtk:15,
    baseDef:12,
    baseSpd:19,
    abilities:[
      {name:"Drizzle Shot", kind:"damage", power:18, maxCharges:6},
      {name:"Rain Veil", kind:"buffDef", amount:4, maxCharges:3}
    ]
  },

  // Nature (2)
  {
    id:"sproutbug",
    name:"Sproutbug",
    element:"Nature",
    baseHP:68,
    baseAtk:13,
    baseDef:12,
    baseSpd:18,
    abilities:[
      {name:"Nibble Leaf", kind:"damage", power:16, maxCharges:7},
      {name:"Green Pulse", kind:"heal", amount:16, maxCharges:3}
    ]
  },
  {
    id:"thornsprout",
    name:"Thornsprout",
    element:"Nature",
    baseHP:70,
    baseAtk:16,
    baseDef:11,
    baseSpd:17,
    abilities:[
      {name:"Thorn Prick", kind:"damage", power:18, maxCharges:6},
      {name:"Root Slow", kind:"debuffSpd", amount:4, maxCharges:3} // treated as no-op but flavor text
    ]
  },

  // Storm (2)
  {
    id:"gustling",
    name:"Gustling",
    element:"Storm",
    baseHP:66,
    baseAtk:14,
    baseDef:11,
    baseSpd:22,
    abilities:[
      {name:"Breeze Peck", kind:"damage", power:17, maxCharges:7},
      {name:"Tailwind", kind:"buffSpd", amount:5, maxCharges:3}
    ]
  },
  {
    id:"sparkmite",
    name:"Sparkmite",
    element:"Storm",
    baseHP:64,
    baseAtk:15,
    baseDef:10,
    baseSpd:23,
    abilities:[
      {name:"Static Nibble", kind:"damage", power:18, maxCharges:6},
      {name:"Charge Up", kind:"buffAtk", amount:4, maxCharges:3}
    ]
  },

  // Stone (2)
  {
    id:"pebblepup",
    name:"Pebblepup",
    element:"Stone",
    baseHP:76,
    baseAtk:13,
    baseDef:15,
    baseSpd:14,
    abilities:[
      {name:"Pebble Bop", kind:"damage", power:17, maxCharges:7},
      {name:"Hard Shell", kind:"buffDef", amount:4, maxCharges:3}
    ]
  },
  {
    id:"dustpebble",
    name:"Dustpebble",
    element:"Stone",
    baseHP:72,
    baseAtk:15,
    baseDef:14,
    baseSpd:15,
    abilities:[
      {name:"Dust Toss", kind:"damage", power:18, maxCharges:6},
      {name:"Dust Screen", kind:"debuffAtk", amount:4, maxCharges:3}
    ]
  },

  // =========================
  // MODERATE TIER (10)
  // =========================

  // Fire (2)
  {
    id:"flarethorn",
    name:"Flarethorn",
    element:"Fire",
    baseHP:80,
    baseAtk:19,
    baseDef:15,
    baseSpd:19,
    abilities:[
      {name:"Flare Bite", kind:"damage", power:22, maxCharges:6},
      {name:"Heat Bloom", kind:"buffAtk", amount:5, maxCharges:3}
    ]
  },
  {
    id:"charcub",
    name:"Charcub",
    element:"Fire",
    baseHP:82,
    baseAtk:20,
    baseDef:14,
    baseSpd:20,
    abilities:[
      {name:"Char Swipe", kind:"damage", power:22, maxCharges:6},
      {name:"Warm Fur", kind:"buffDef", amount:5, maxCharges:3}
    ]
  },

  // Water (2)
  {
    id:"brookfin",
    name:"Brookfin",
    element:"Water",
    baseHP:84,
    baseAtk:18,
    baseDef:17,
    baseSpd:18,
    abilities:[
      {name:"Brook Jet", kind:"damage", power:22, maxCharges:6},
      {name:"Fresh Current", kind:"heal", amount:22, maxCharges:3}
    ]
  },
  {
    id:"tideotter",
    name:"Tideotter",
    element:"Water",
    baseHP:86,
    baseAtk:20,
    baseDef:16,
    baseSpd:19,
    abilities:[
      {name:"Tide Tackle", kind:"damage", power:23, maxCharges:6},
      {name:"Shell Rub", kind:"buffDef", amount:5, maxCharges:3}
    ]
  },

  // Nature (2)
  {
    id:"mossling",
    name:"Mossling",
    element:"Nature",
    baseHP:82,
    baseAtk:18,
    baseDef:17,
    baseSpd:18,
    abilities:[
      {name:"Moss Bite", kind:"damage", power:22, maxCharges:6},
      {name:"Soft Growth", kind:"heal", amount:22, maxCharges:3}
    ]
  },
  {
    id:"vinepup",
    name:"Vinepup",
    element:"Nature",
    baseHP:80,
    baseAtk:20,
    baseDef:16,
    baseSpd:20,
    abilities:[
      {name:"Vine Lash", kind:"damage", power:23, maxCharges:6},
      {name:"Entangle", kind:"debuffDef", amount:5, maxCharges:3}
    ]
  },

  // Storm (2)
  {
    id:"breezerat",
    name:"Breezerat",
    element:"Storm",
    baseHP:78,
    baseAtk:19,
    baseDef:14,
    baseSpd:24,
    abilities:[
      {name:"Gale Scratch", kind:"damage", power:23, maxCharges:6},
      {name:"Tail Current", kind:"buffSpd", amount:6, maxCharges:3}
    ]
  },
  {
    id:"stormkit",
    name:"Stormkit",
    element:"Storm",
    baseHP:80,
    baseAtk:20,
    baseDef:15,
    baseSpd:23,
    abilities:[
      {name:"Spark Swipe", kind:"damage", power:23, maxCharges:6},
      {name:"Static Coat", kind:"buffDef", amount:5, maxCharges:3}
    ]
  },

  // Stone (2)
  {
    id:"rubblepup",
    name:"Rubblepup",
    element:"Stone",
    baseHP:88,
    baseAtk:19,
    baseDef:19,
    baseSpd:16,
    abilities:[
      {name:"Rubble Bash", kind:"damage", power:23, maxCharges:6},
      {name:"Stone Guard", kind:"buffDef", amount:6, maxCharges:3}
    ]
  },
  {
    id:"stonehopper",
    name:"Stonehopper",
    element:"Stone",
    baseHP:86,
    baseAtk:20,
    baseDef:18,
    baseSpd:17,
    abilities:[
      {name:"Pebble Kick", kind:"damage", power:22, maxCharges:6},
      {name:"Dust Leap", kind:"buffSpd", amount:5, maxCharges:3}
    ]
  },

  // =========================
  // GOOD TIER (10)
  // (Starters live here)
  // =========================

  // Fire (2) ‚Äî includes Blazefox
  {
    id:"blazefox",
    name:"Blazefox",
    element:"Fire",
    baseHP:90,
    baseAtk:25,
    baseDef:15,
    baseSpd:20,
    abilities:[
      {name:"Flame Bite", kind:"damage", power:24, maxCharges:6},
      {name:"Fire Claws", kind:"damage", power:30, maxCharges:4},
      {name:"Inferno Howl", kind:"buffAtk", amount:7, maxCharges:2}
    ]
  },
  {
    id:"emberclaw",
    name:"Emberclaw",
    element:"Fire",
    baseHP:94,
    baseAtk:26,
    baseDef:16,
    baseSpd:21,
    abilities:[
      {name:"Claw Blaze", kind:"damage", power:26, maxCharges:5},
      {name:"Smolder Guard", kind:"buffDef", amount:6, maxCharges:3}
    ]
  },

  // Water (2) ‚Äî includes Tidalfin
  {
    id:"tidalfin",
    name:"Tidalfin",
    element:"Water",
    baseHP:95,
    baseAtk:22,
    baseDef:18,
    baseSpd:18,
    abilities:[
      {name:"Water Jet", kind:"damage", power:24, maxCharges:6},
      {name:"Bubble Burst", kind:"damage", power:28, maxCharges:4},
      {name:"Splash Shield", kind:"buffDef", amount:7, maxCharges:3}
    ]
  },
  {
    id:"surfstrider",
    name:"Surfstrider",
    element:"Water",
    baseHP:98,
    baseAtk:24,
    baseDef:18,
    baseSpd:20,
    abilities:[
      {name:"Surf Crash", kind:"damage", power:26, maxCharges:5},
      {name:"Foam Veil", kind:"heal", amount:26, maxCharges:3}
    ]
  },

  // Nature (2) ‚Äî includes Leafling
  {
    id:"leafling",
    name:"Leafling",
    element:"Nature",
    baseHP:88,
    baseAtk:20,
    baseDef:16,
    baseSpd:20,
    abilities:[
      {name:"Vine Whip", kind:"damage", power:24, maxCharges:6},
      {name:"Photosynthesis", kind:"heal", amount:26, maxCharges:4},
      {name:"Root Bind", kind:"debuffDef", amount:6, maxCharges:3}
    ]
  },
  {
    id:"briarhorn",
    name:"Briarhorn",
    element:"Nature",
    baseHP:96,
    baseAtk:24,
    baseDef:18,
    baseSpd:18,
    abilities:[
      {name:"Briar Charge", kind:"damage", power:26, maxCharges:5},
      {name:"Thorn Screen", kind:"debuffAtk", amount:6, maxCharges:3}
    ]
  },

  // Storm (2) ‚Äî Stormpup & Voltwing
  {
    id:"stormpup",
    name:"Stormpup",
    element:"Storm",
    baseHP:82,
    baseAtk:23,
    baseDef:14,
    baseSpd:30,
    abilities:[
      {name:"Spark Pounce", kind:"damage", power:24, maxCharges:7},
      {name:"Thunder Bark", kind:"damage", power:28, maxCharges:4},
      {name:"Agility", kind:"buffSpd", amount:7, maxCharges:3}
    ]
  },
  {
    id:"voltwing",
    name:"Voltwing",
    element:"Storm",
    baseHP:84,
    baseAtk:24,
    baseDef:15,
    baseSpd:26,
    abilities:[
      {name:"Lightning Peck", kind:"damage", power:26, maxCharges:6},
      {name:"Static Field", kind:"debuffAtk", amount:7, maxCharges:3}
    ]
  },

  // Stone (2) ‚Äî Boulderback plus a buddy
  {
    id:"boulderback",
    name:"Boulderback",
    element:"Stone",
    baseHP:120,
    baseAtk:20,
    baseDef:26,
    baseSpd:12,
    abilities:[
      {name:"Rock Slam", kind:"damage", power:26, maxCharges:6},
      {name:"Earthen Wall", kind:"buffDef", amount:9, maxCharges:3},
      {name:"Quake Stomp", kind:"damage", power:30, maxCharges:3}
    ]
  },
  {
    id:"pebblord",
    name:"Pebblord",
    element:"Stone",
    baseHP:110,
    baseAtk:23,
    baseDef:24,
    baseSpd:14,
    abilities:[
      {name:"Pebble Storm", kind:"damage", power:26, maxCharges:5},
      {name:"Stone Crown", kind:"buffAtk", amount:6, maxCharges:3}
    ]
  },

  // =========================
  // GREAT TIER (10)
  // =========================

  // Fire (2)
  {
    id:"magmafang",
    name:"Magmafang",
    element:"Fire",
    baseHP:110,
    baseAtk:30,
    baseDef:20,
    baseSpd:22,
    abilities:[
      {name:"Magma Maul", kind:"damage", power:32, maxCharges:4},
      {name:"Lava Armor", kind:"buffDef", amount:8, maxCharges:3}
    ]
  },
  {
    id:"solaraptor",
    name:"Solaraptor",
    element:"Fire",
    baseHP:105,
    baseAtk:31,
    baseDef:19,
    baseSpd:26,
    abilities:[
      {name:"Solar Claw", kind:"damage", power:33, maxCharges:4},
      {name:"Flare Halo", kind:"buffAtk", amount:8, maxCharges:3}
    ]
  },

  // Water (2)
  {
    id:"abysslurker",
    name:"Abysslurker",
    element:"Water",
    baseHP:112,
    baseAtk:28,
    baseDef:22,
    baseSpd:20,
    abilities:[
      {name:"Abyss Bite", kind:"damage", power:32, maxCharges:4},
      {name:"Dark Tide", kind:"damage", power:28, maxCharges:4}
    ]
  },
  {
    id:"glacialon",
    name:"Glacialon",
    element:"Water",
    baseHP:108,
    baseAtk:27,
    baseDef:23,
    baseSpd:21,
    abilities:[
      {name:"Glacier Crash", kind:"damage", power:32, maxCharges:4},
      {name:"Frost Heal", kind:"heal", amount:34, maxCharges:3}
    ]
  },

  // Nature (2)
  {
    id:"barkback",
    name:"Barkback",
    element:"Nature",
    baseHP:112,
    baseAtk:27,
    baseDef:24,
    baseSpd:18,
    abilities:[
      {name:"Trunk Smash", kind:"damage", power:30, maxCharges:4},
      {name:"Ancient Bark", kind:"buffDef", amount:9, maxCharges:3}
    ]
  },
  {
    id:"wildbloom",
    name:"Wildbloom",
    element:"Nature",
    baseHP:104,
    baseAtk:28,
    baseDef:22,
    baseSpd:22,
    abilities:[
      {name:"Bloom Burst", kind:"damage", power:30, maxCharges:4},
      {name:"Verdant Pulse", kind:"heal", amount:32, maxCharges:3}
    ]
  },

  // Storm (2)
  {
    id:"thundraptor",
    name:"Thundraptor",
    element:"Storm",
    baseHP:104,
    baseAtk:30,
    baseDef:20,
    baseSpd:28,
    abilities:[
      {name:"Thunder Claw", kind:"damage", power:33, maxCharges:4},
      {name:"Sky Roar", kind:"buffAtk", amount:8, maxCharges:3}
    ]
  },
  {
    id:"cloudcoil",
    name:"Cloudcoil",
    element:"Storm",
    baseHP:108,
    baseAtk:27,
    baseDef:23,
    baseSpd:24,
    abilities:[
      {name:"Cloud Lash", kind:"damage", power:30, maxCharges:4},
      {name:"Storm Veil", kind:"debuffAtk", amount:8, maxCharges:3}
    ]
  },

  // Stone (2)
  {
    id:"slabtoise",
    name:"Slabtoise",
    element:"Stone",
    baseHP:125,
    baseAtk:27,
    baseDef:28,
    baseSpd:14,
    abilities:[
      {name:"Slab Crush", kind:"damage", power:32, maxCharges:4},
      {name:"Granite Shell", kind:"buffDef", amount:10, maxCharges:3}
    ]
  },
  {
    id:"gritclaw",
    name:"Gritclaw",
    element:"Stone",
    baseHP:116,
    baseAtk:29,
    baseDef:24,
    baseSpd:18,
    abilities:[
      {name:"Rubble Rend", kind:"damage", power:31, maxCharges:4},
      {name:"Stone Howl", kind:"buffAtk", amount:8, maxCharges:3}
    ]
  },

  // =========================
  // LEGENDARY TIER (10)
  // =========================

  // Fire (2)
  {
    id:"infernotitan",
    name:"Infernotitan",
    element:"Fire",
    baseHP:138,
    baseAtk:38,
    baseDef:28,
    baseSpd:26,
    abilities:[
      {name:"Titan Blaze", kind:"damage", power:40, maxCharges:3},
      {name:"Worldfire Aura", kind:"buffAtk", amount:10, maxCharges:2}
    ]
  },
  {
    id:"phoenixflare",
    name:"Phoenixflare",
    element:"Fire",
    baseHP:130,
    baseAtk:36,
    baseDef:26,
    baseSpd:30,
    abilities:[
      {name:"Phoenix Dive", kind:"damage", power:38, maxCharges:3},
      {name:"Rebirth Flame", kind:"heal", amount:40, maxCharges:2}
    ]
  },

  // Water (2)
  {
    id:"leviadrake",
    name:"Leviadrake",
    element:"Water",
    baseHP:140,
    baseAtk:37,
    baseDef:30,
    baseSpd:24,
    abilities:[
      {name:"Leviathan Crush", kind:"damage", power:40, maxCharges:3},
      {name:"Abyssal Shield", kind:"buffDef", amount:11, maxCharges:2}
    ]
  },
  {
    id:"maelstromwyrm",
    name:"Maelstromwyrm",
    element:"Water",
    baseHP:132,
    baseAtk:36,
    baseDef:28,
    baseSpd:28,
    abilities:[
      {name:"Maelstrom Coil", kind:"damage", power:38, maxCharges:3},
      {name:"Ocean's Grace", kind:"heal", amount:40, maxCharges:2}
    ]
  },

  // Nature (2)
  {
    id:"worldroot",
    name:"Worldroot",
    element:"Nature",
    baseHP:142,
    baseAtk:35,
    baseDef:32,
    baseSpd:22,
    abilities:[
      {name:"Root of Ages", kind:"damage", power:38, maxCharges:3},
      {name:"Gaia's Embrace", kind:"heal", amount:42, maxCharges:2}
    ]
  },
  {
    id:"sylphqueen",
    name:"Sylphqueen",
    element:"Nature",
    baseHP:130,
    baseAtk:34,
    baseDef:28,
    baseSpd:30,
    abilities:[
      {name:"Sylph Ray", kind:"damage", power:36, maxCharges:3},
      {name:"Royal Bloom", kind:"buffAtk", amount:9, maxCharges:2}
    ]
  },

  // Storm (2)
  {
    id:"skytyrant",
    name:"Skytyrant",
    element:"Storm",
    baseHP:134,
    baseAtk:37,
    baseDef:27,
    baseSpd:32,
    abilities:[
      {name:"Tyrant Bolt", kind:"damage", power:40, maxCharges:3},
      {name:"Storm Dominion", kind:"buffSpd", amount:10, maxCharges:2}
    ]
  },
  {
    id:"tempestlion",
    name:"Tempestlion",
    element:"Storm",
    baseHP:136,
    baseAtk:38,
    baseDef:29,
    baseSpd:30,
    abilities:[
      {name:"Tempest Fang", kind:"damage", power:39, maxCharges:3},
      {name:"Thunder Roar", kind:"debuffDef", amount:10, maxCharges:2}
    ]
  },

  // Stone (2)
  {
    id:"colossogolem",
    name:"Colossogolem",
    element:"Stone",
    baseHP:150,
    baseAtk:36,
    baseDef:34,
    baseSpd:22,
    abilities:[
      {name:"Colossal Slam", kind:"damage", power:40, maxCharges:3},
      {name:"Mountain Core", kind:"buffDef", amount:12, maxCharges:2}
    ]
  },
  {
    id:"aurorite",
    name:"Aurorite",
    element:"Stone",
    baseHP:140,
    baseAtk:35,
    baseDef:32,
    baseSpd:24,
    abilities:[
      {name:"Aurora Shatter", kind:"damage", power:38, maxCharges:3},
      {name:"Crystal Radiance", kind:"buffAtk", amount:10, maxCharges:2}
    ]
  }
];


  function cloneAbilities(abilities){
    return abilities.map(a => ({
      name:a.name,
      kind:a.kind,
      power:a.power ?? 0,
      amount:a.amount ?? 0,
      maxCharges:a.maxCharges ?? 3,
      charges:a.maxCharges ?? 3
    }));
  }

  function createCritterFromSpecies(specId, level){
    const s = SPECIES.find(sp=>sp.id===specId);
    if(!s) throw new Error("Unknown species "+specId);
    const lvlFactor = 1 + (level-1)*0.08;
    return {
      speciesId:s.id,
      name:s.name,
      element:s.element,
      level,
      maxHP:Math.round(s.baseHP*lvlFactor),
      currentHP:Math.round(s.baseHP*lvlFactor),
      atk:Math.round(s.baseAtk*lvlFactor),
      def:Math.round(s.baseDef*lvlFactor),
      spd:Math.round(s.baseSpd*lvlFactor),
      xp:0,
      xpToNext:25 + level*15,
      abilities:cloneAbilities(s.abilities)
    };
  }

  // ----------------------------------------
  // Map generation
  // ----------------------------------------

  const MAP_W = 40;
  const MAP_H = 40;

  function generateMap(){
    const tiles = [];
    for(let y=0;y<MAP_H;y++){
      const row = [];
      for(let x=0;x<MAP_W;x++){
        let zoneType;
        if(y<10) zoneType = "Forest";
        else if(y<20) zoneType="Riverlands";
        else if(y<30) zoneType="Highlands";
        else zoneType="Ruins";

        let zoneColorIndex;
        if(zoneType==="Forest") zoneColorIndex=1;
        else if(zoneType==="Riverlands") zoneColorIndex=2;
        else if(zoneType==="Highlands") zoneColorIndex=3;
        else zoneColorIndex=4;

        let feature = null;
        const r = Math.random();
        if(r<0.06) feature="bush";
        else if(r<0.11) feature="rock";

        // thin line of shops + arenas
        if((x===5 || x===34) && y%9===0) feature="shop";
        if((x===MAP_W-6 || x===8) && (y+4)%11===0) feature="arena";

        row.push({zoneType, zoneColorIndex, feature});
      }
      tiles.push(row);
    }
    // ensure starting area is safe
    tiles[MAP_H-2][2].feature=null;
    return tiles;
  }

  // ----------------------------------------
  // Global game state
  // ----------------------------------------

  let gameState = null;      // structure described below
  let currentSaveName = null;
  let inBattle = false;
  let battleState = null;    // {mode, enemyTeam, playerTeamIdxs, activePlayerIdx, activeEnemyIdx, arenaReward, log:[]}
  let lastShopPos = null;
  let lastArenaPos = null;

  // ----------------------------------------
  // Logging helper
  // ----------------------------------------
  function addLog(tag, text){
    const line = document.createElement("div");
    line.className = "logLine";
    const badge = document.createElement("span");
    badge.className = "tag";
    badge.textContent = tag;
    line.appendChild(badge);
    line.append(text);
    logEl.prepend(line);
  }

  // ----------------------------------------
  // Rendering: map & HUD
  // ----------------------------------------
  const mapViewEl = document.getElementById("mapView");

  function renderHUD(){
    if(!gameState){
      invEl.innerHTML = "";
      zoneNameEl.textContent="-";
      posLabelEl.textContent="-";
      modeLabelEl.textContent=inBattle?"Battle":"Exploration";
      return;
    }
    const p = gameState.player;
    invEl.innerHTML = "";
    const chips = [
      {icon:"üí∞", label:`$${p.money}`},
      {icon:"üß™", label:`Potion x${p.potions}`},
      {icon:"üî¥", label:`Ball x${p.balls.basic}`},
      {icon:"üîµ", label:`Great x${p.balls.great}`},
      {icon:"üü°", label:`Ultra x${p.balls.ultra}`}
    ];
    for(const c of chips){
      const el = document.createElement("div");
      el.className="chip";
      const s = document.createElement("span");
      s.textContent=c.icon;
      el.appendChild(s);
      el.append(c.label);
      invEl.appendChild(el);
    }
    const tile = gameState.map.tiles[gameState.map.playerY][gameState.map.playerX];
    zoneNameEl.textContent=tile.zoneType;
    posLabelEl.textContent=`(${gameState.map.playerX}, ${gameState.map.playerY})`;
    modeLabelEl.textContent=inBattle?"Battle":"Exploration";
  }

  function getVisibleWindow(){
    if(!gameState) return {x0:0,y0:0};
    const {playerX, playerY} = gameState.map;
    let x0 = playerX - 7;
    let y0 = playerY - 7;
    if(x0<0) x0=0;
    if(y0<0) y0=0;
    if(x0>MAP_W-15) x0=MAP_W-15;
    if(y0>MAP_H-15) y0=MAP_H-15;
    return {x0,y0};
  }

  function renderMap(){
    mapViewEl.innerHTML = "";
    if(!gameState){
      for(let i=0;i<225;i++){
        const d=document.createElement("div");
        d.className="tile zone4";
        mapViewEl.appendChild(d);
      }
      return;
    }
    const {x0,y0} = getVisibleWindow();
    const {playerX, playerY} = gameState.map;
    for(let yy=0; yy<15; yy++){
      for(let xx=0; xx<15; xx++){
        const gx = x0+xx;
        const gy = y0+yy;
        const tile = gameState.map.tiles[gy][gx];
        const d = document.createElement("div");
        d.className = `tile zone${tile.zoneColorIndex}`;
        if(tile.feature) d.classList.add(tile.feature);
        d.dataset.gx = gx;
        d.dataset.gy = gy;
        d.addEventListener("click", ()=>onTileClick(gx,gy));
        // player marker
        if(gx===playerX && gy===playerY){
          const pm = document.createElement("div");
          pm.className="playerMarker";
          pm.innerHTML="<span>üßç</span>";
          d.appendChild(pm);
        }
        mapViewEl.appendChild(d);
      }
    }
    renderHUD();
  }

  function centerOnPlayer(){
    renderMap(); // already centers based on player
  }

  // ----------------------------------------
  // Movement & encounters
  // ----------------------------------------

  function onTileClick(gx,gy){
    if(!gameState || inBattle) return;
    const {playerX, playerY} = gameState.map;
    const dx = Math.abs(gx-playerX);
    const dy = Math.abs(gy-playerY);
    if(dx+dy !==1){
      addLog("Move","You can only move one tile at a time.");
      return;
    }
    movePlayerTo(gx,gy);
  }

  function movePlayerTo(gx,gy){
    const map = gameState.map;
    map.playerX = gx;
    map.playerY = gy;
    const tile = map.tiles[gy][gx];
    addLog("Move",`You moved into the ${tile.zoneType}.`);
    renderMap();
    // feature triggers
    if(tile.feature==="shop"){
      lastShopPos = {x:gx,y:gy};
      openShop();
      return;
    }
    if(tile.feature==="arena"){
      lastArenaPos = {x:gx,y:gy};
      openArena();
      return;
    }
    // random encounter
    const base = tile.zoneType==="Forest" ? 0.18 :
                 tile.zoneType==="Riverlands" ? 0.15 :
                 tile.zoneType==="Highlands" ? 0.16 :
                 0.20;
    let bonus = 0;
    if(tile.feature==="bush") bonus += 0.12;
    if(tile.feature==="rock") bonus += 0.08;
    const chance = base+bonus;
    if(Math.random() < chance){
      startWildEncounter(tile);
    } else {
      autoSaveDebounced();
    }
  }

  function randomSpeciesForZone(zoneType){
    const pool = SPECIES.filter(s=>{
      if(zoneType==="Forest") return s.element==="Nature" || s.element==="Fire";
      if(zoneType==="Riverlands") return s.element==="Water" || s.element==="Storm";
      if(zoneType==="Highlands") return s.element==="Stone" || s.element==="Fire";
      if(zoneType==="Ruins") return s.element==="Stone" || s.element==="Storm";
      return true;
    });
    return pool[Math.floor(Math.random()*pool.length)];
  }

  function startWildEncounter(tile){
    const playerAvgLvl = Math.max(1,Math.round(
      gameState.player.roster.reduce((a,c)=>a+c.level,0)/gameState.player.roster.length
    ));
    const lvl = Math.max(1, Math.round(playerAvgLvl + (Math.random()*4-2)));
    const species = randomSpeciesForZone(tile.zoneType);
    const wild = createCritterFromSpecies(species.id,lvl);
    addLog("Encounter",`A wild ${wild.name} (Lv ${wild.level}) appears!`);
    const enemyTeam = [wild];
    const playerTeamIdxs = gameState.player.roster.map((_,i)=>i);
    startBattle({
      mode:"wild",
      enemyTeam,
      playerTeamIdxs,
      activePlayerIdx:playerTeamIdxs[0],
      activeEnemyIdx:0,
      arenaReward:0
    });
  }

  // ----------------------------------------
  // Battle system
  // ----------------------------------------
  const battleOverlay = document.getElementById("battleOverlay");
  const battleTitleEl = document.getElementById("battleTitle");
  const battleBodyEl = document.getElementById("battleBody");
  const battleFooterEl = document.getElementById("battleFooter");
  document.getElementById("btnBattleClose").onclick = ()=>{/* no close during battle */};

  function startBattle(initialState){
    inBattle = true;
    modeLabelEl.textContent="Battle";
    battleState = {
      ...initialState,
      log:[]
    };
    for(const c of gameState.player.roster){
      for(const ab of c.abilities){
        ab.charges = ab.maxCharges;
      }
    }
    for(const e of battleState.enemyTeam){
      for(const ab of e.abilities){
        ab.charges = ab.maxCharges;
      }
    }
    battleOverlay.classList.add("visible");
    renderBattle();
  }

  function activePlayerCritter(){
    return gameState.player.roster[battleState.activePlayerIdx];
  }
  function activeEnemyCritter(){
    return battleState.enemyTeam[battleState.activeEnemyIdx];
  }

  function renderBattle(){
    const pc = activePlayerCritter();
    const ec = activeEnemyCritter();
    if(!pc || !ec){
      endBattle();
      return;
    }
    battleTitleEl.textContent = battleState.mode==="arena" ? "Arena Battle" : "Wild Encounter";
    battleBodyEl.innerHTML="";
    const hero = document.createElement("div");
    hero.innerHTML = `
      <div class="sectionTitle">Your Critter</div>
      <div class="battleStats">
        <div style="flex:1;">
          <strong>${pc.name}</strong> <span class="badge">Lv ${pc.level}</span>
          <span class="badge">${pc.element}</span>
          <div class="hpBar"><div class="hpFill" style="width:${Math.max(0,pc.currentHP)/pc.maxHP*100}%"></div></div>
          <div style="font-size:11px;margin-top:2px;">HP ${pc.currentHP}/${pc.maxHP}</div>
        </div>
      </div>
      <div class="sectionTitle">Enemy</div>
      <div class="battleStats">
        <div style="flex:1;">
          <strong>${ec.name}</strong> <span class="badge">Lv ${ec.level}</span>
          <span class="badge">${ec.element}</span>
          <div class="hpBar"><div class="hpFill" style="width:${Math.max(0,ec.currentHP)/ec.maxHP*100}%"></div></div>
          <div style="font-size:11px;margin-top:2px;">HP ${ec.currentHP}/${ec.maxHP}</div>
        </div>
      </div>
    `;
    battleBodyEl.appendChild(hero);

    const histTitle = document.createElement("div");
    histTitle.className="sectionTitle";
    histTitle.textContent="Battle Log";
    battleBodyEl.appendChild(histTitle);

    const histBox = document.createElement("div");
    histBox.style.maxHeight="200px";
    histBox.style.overflowY="auto";
    histBox.style.border="1px solid #1f2937";
    histBox.style.borderRadius="8px";
    histBox.style.padding="4px 6px";
    const lines = battleState.log.slice(-8);
    if(lines.length===0){
      histBox.innerHTML = `<div style="font-size:11px;color:var(--muted);">Actions will appear here.</div>`;
    }else{
      for(const L of lines){
        const div=document.createElement("div");
        div.style.fontSize="11px";
        div.textContent=L;
        histBox.appendChild(div);
      }
    }
    battleBodyEl.appendChild(histBox);

    // Footer buttons
    battleFooterEl.innerHTML="";
    // abilities
    pc.abilities.forEach((ab,idx)=>{
      const btn=document.createElement("button");
      btn.textContent = `${ab.name} (${ab.charges}/${ab.maxCharges})`;
      btn.disabled = ab.charges<=0;
      btn.onclick=()=>queuePlayerAction({type:"ability", index:idx});
      battleFooterEl.appendChild(btn);
    });
    const invRow=document.createElement("div");
    invRow.style.display="flex";
    invRow.style.flexWrap="wrap";
    invRow.style.gap="4px";
    invRow.style.marginTop="4px";
    const btnPotion=document.createElement("button");
    btnPotion.className="secondary";
    btnPotion.textContent=`Use Potion (${gameState.player.potions})`;
    btnPotion.disabled = gameState.player.potions<=0 || pc.currentHP>=pc.maxHP;
    btnPotion.onclick=()=>queuePlayerAction({type:"potion"});
    invRow.appendChild(btnPotion);

    const btnCapture=document.createElement("button");
    btnCapture.className="secondary";
    btnCapture.textContent="Capture";
    btnCapture.onclick=()=>openCaptureMenu();
    invRow.appendChild(btnCapture);

    const btnSwitch=document.createElement("button");
    btnSwitch.className="secondary";
    btnSwitch.textContent="Switch";
    btnSwitch.onclick=()=>openSwitchMenu();
    invRow.appendChild(btnSwitch);

    if(battleState.mode==="wild"){
      const btnRun=document.createElement("button");
      btnRun.className="danger";
      btnRun.textContent="Run";
      btnRun.onclick=()=>{
        battleState.log.push("You fled from the battle.");
        endBattle();
      };
      invRow.appendChild(btnRun);
    }
    battleFooterEl.appendChild(invRow);
  }

  function queuePlayerAction(action){
    // Simple: resolve immediately with speed-based order vs enemy default attack
    const pc = activePlayerCritter();
    const ec = activeEnemyCritter();
    if(!pc || !ec) { endBattle(); return; }
    const enemyAction = chooseEnemyAction(ec, pc);
    const firstPlayer = pc.spd >= ec.spd;

    if(firstPlayer){
      resolveAction("player", action, pc, ec);
      if(ec.currentHP>0 && pc.currentHP>0){
        resolveAction("enemy", enemyAction, ec, pc);
      }
    }else{
      resolveAction("enemy", enemyAction, ec, pc);
      if(pc.currentHP>0 && ec.currentHP>0){
        resolveAction("player", action, pc, ec);
      }
    }
    checkBattleState();
    renderBattle();
  }

  function basicDamage(attacker, defender, ability){
    const base = (ability.power ?? 20) + Math.floor(attacker.atk*0.6) - Math.floor(defender.def*0.4);
    return Math.max(5, base);
  }

  function resolveAction(side, action, actor, target){
    if(actor.currentHP<=0) return;
    const sideLabel = side==="player" ? "Your" : "Enemy";
    if(action.type==="ability"){
      const idx = action.index;
      const ab = actor.abilities[idx];
      if(!ab || ab.charges<=0){
        battleState.log.push(`${sideLabel} ${actor.name} fumbles and does nothing.`);
        return;
      }
      ab.charges--;
      if(ab.kind==="damage"){
        const mult = typeMultiplier(actor.element, target.element);
        let dmg = basicDamage(actor, target, ab);
        dmg = Math.round(dmg*mult);
        if(dmg<1)dmg=1;
        target.currentHP -= dmg;
        if(target.currentHP<0) target.currentHP=0;
        let eff = "";
        if(mult>1.1) eff=" It's super effective!";
        else if(mult<0.9) eff=" It's not very effective.";
        battleState.log.push(`${sideLabel} ${actor.name} used ${ab.name}! It dealt ${dmg} damage.${eff}`);
        if(target.currentHP<=0){
          const victimSide = side==="player" ? "Enemy" : "Your";
          battleState.log.push(`${victimSide} ${target.name} fainted!`);
        }
      }else if(ab.kind==="heal"){
        const before = actor.currentHP;
        actor.currentHP = Math.min(actor.maxHP, actor.currentHP + (ab.amount ?? 20));
        const healed = actor.currentHP-before;
        battleState.log.push(`${sideLabel} ${actor.name} used ${ab.name} and healed ${healed} HP.`);
      }else if(ab.kind==="buffAtk"){
        actor.atk += ab.amount ?? 4;
        battleState.log.push(`${sideLabel} ${actor.name} used ${ab.name}. Attack rose!`);
      }else if(ab.kind==="buffDef"){
        actor.def += ab.amount ?? 4;
        battleState.log.push(`${sideLabel} ${actor.name} used ${ab.name}. Defense rose!`);
      }else if(ab.kind==="buffSpd"){
        actor.spd += ab.amount ?? 4;
        battleState.log.push(`${sideLabel} ${actor.name} used ${ab.name}. Speed rose!`);
      }else if(ab.kind==="debuffAtk"){
        target.atk = Math.max(1, target.atk - (ab.amount ?? 4));
        battleState.log.push(`${sideLabel} ${actor.name} used ${ab.name}. Foe's Attack fell!`);
      }else if(ab.kind==="debuffDef"){
        target.def = Math.max(1, target.def - (ab.amount ?? 4));
        battleState.log.push(`${sideLabel} ${actor.name} used ${ab.name}. Foe's Defense fell!`);
      }else{
        battleState.log.push(`${sideLabel} ${actor.name} used ${ab.name}... but nothing happened.`);
      }
    }else if(action.type==="potion"){
      const before = actor.currentHP;
      if(gameState.player.potions<=0 || before>=actor.maxHP){
        battleState.log.push("But it failed.");
        return;
      }
      gameState.player.potions--;
      actor.currentHP = Math.min(actor.maxHP, actor.currentHP + 40);
      const healed = actor.currentHP-before;
      battleState.log.push(`${sideLabel} ${actor.name} drank a potion and healed ${healed} HP.`);
    }else if(action.type==="switch"){
      const newIdx = action.toIndex;
      if(side==="player"){
        battleState.activePlayerIdx = newIdx;
        const newC = gameState.player.roster[newIdx];
        battleState.log.push(`You switched to ${newC.name}.`);
      }else{
        battleState.activeEnemyIdx = newIdx;
        const newC = battleState.enemyTeam[newIdx];
        battleState.log.push(`Enemy switched to ${newC.name}.`);
      }
    }else if(action.type==="struggle"){
      const dmg = 15;
      target.currentHP = Math.max(0, target.currentHP-dmg);
      battleState.log.push(`${sideLabel} ${actor.name} struggled for ${dmg} damage.`);
      if(target.currentHP<=0) battleState.log.push(`${target.name} fainted.`);
    }else if(action.type==="capture"){
      // handled separately
    }
  }

  function chooseEnemyAction(enemy, player){
    // if low HP and any teammate alive, small chance to switch
    const aliveIdxs = battleState.enemyTeam
      .map((c,i)=>({c,i}))
      .filter(x=>x.c.currentHP>0 && x.i!==battleState.activeEnemyIdx)
      .map(x=>x.i);
    if(enemy.currentHP < enemy.maxHP*0.3 && aliveIdxs.length>0 && Math.random()<0.25){
      return {type:"switch", toIndex:aliveIdxs[Math.floor(Math.random()*aliveIdxs.length)]};
    }
    const dam = enemy.abilities.filter(a=>a.kind==="damage" && a.charges>0);
    if(dam.length>0){
      // prefer ones with higher power * typeMult
      dam.sort((a,b)=>{
        const sa = (a.power ?? 20)*typeMultiplier(enemy.element, player.element);
        const sb = (b.power ?? 20)*typeMultiplier(enemy.element, player.element);
        return sb-sa;
      });
      const ab = dam[0];
      const idx = enemy.abilities.indexOf(ab);
      return {type:"ability", index:idx};
    }
    const any = enemy.abilities.find(a=>a.charges>0);
    if(any){
      return {type:"ability", index:enemy.abilities.indexOf(any)};
    }
    return {type:"struggle"};
  }

  function openSwitchMenu(){
    const pcIdx = battleState.activePlayerIdx;
    const alive = gameState.player.roster
      .map((c,i)=>({c,i}))
      .filter(x=>x.c.currentHP>0 && x.i!==pcIdx);
    if(alive.length===0){
      battleState.log.push("No other healthy critters to switch to.");
      renderBattle();
      return;
    }
    battleFooterEl.innerHTML="";
    const info=document.createElement("div");
    info.style.fontSize="11px";
    info.style.marginBottom="4px";
    info.textContent="Choose a critter to switch to:";
    battleFooterEl.appendChild(info);
    for(const {c,i} of alive){
      const btn=document.createElement("button");
      btn.className="secondary";
      btn.textContent=`${c.name} (Lv ${c.level}) HP ${c.currentHP}/${c.maxHP}`;
      btn.onclick=()=>{
        queuePlayerAction({type:"switch", toIndex:i});
      };
      battleFooterEl.appendChild(btn);
    }
    const cancel=document.createElement("button");
    cancel.className="secondary";
    cancel.textContent="Cancel";
    cancel.onclick=()=>renderBattle();
    battleFooterEl.appendChild(cancel);
  }

  function openCaptureMenu(){
    const inv = gameState.player.balls;
    battleFooterEl.innerHTML="";
    const info=document.createElement("div");
    info.style.fontSize="11px";
    info.style.marginBottom="4px";
    info.textContent="Choose which capture ball to throw:";
    battleFooterEl.appendChild(info);

    function addBallButton(label, key){
      const count = inv[key];
      const btn=document.createElement("button");
      btn.className="secondary";
      btn.textContent=`${label} (${count})`;
      btn.disabled = count<=0;
      btn.onclick=()=>attemptCapture(key);
      battleFooterEl.appendChild(btn);
    }
    addBallButton("Capture Ball","basic");
    addBallButton("Great Ball","great");
    addBallButton("Ultra Ball","ultra");
    const cancel=document.createElement("button");
    cancel.className="secondary";
    cancel.textContent="Cancel";
    cancel.onclick=()=>renderBattle();
    battleFooterEl.appendChild(cancel);
  }

  function attemptCapture(ballKey){
    const pc = activePlayerCritter();
    const ec = activeEnemyCritter();
    if(gameState.player.balls[ballKey]<=0){
      battleState.log.push("You don't have that ball.");
      renderBattle();
      return;
    }
    gameState.player.balls[ballKey]--;
    // base from HP
    const hpFactor = (ec.maxHP - ec.currentHP)/ec.maxHP;
    let baseChance = 0.25 + hpFactor*0.5; // 25-75%
    let ballMult = ballKey==="basic" ? 1 : ballKey==="great" ? 1.6 : 2.2;
    let typeBonus = typeMultiplier(pc.element, ec.element);
    if(typeBonus>1.1) typeBonus = 1.2;
    else if(typeBonus<0.9) typeBonus = 0.9;
    const catchChance = Math.min(0.95, baseChance*ballMult*typeBonus);
    const roll = Math.random();
    if(roll < catchChance){
      battleState.log.push(`You threw the ball... Gotcha! ${ec.name} was captured!`);
      // add to roster (healed a bit on capture)
      const captured = createCritterFromSpecies(ec.speciesId, ec.level);
      captured.currentHP = captured.maxHP;
      gameState.player.roster.push(captured);
      grantXP(pc, ec, true);
      endBattle();
    }else{
      battleState.log.push("The critter broke free!");
      renderBattle();
    }
  }

  function grantXP(pc, ec, captured){
    const base = 15 + ec.level*4;
    const xpGain = captured ? Math.round(base*0.8) : base;
    pc.xp += xpGain;
    battleState.log.push(`${pc.name} gained ${xpGain} XP.`);
    while(pc.xp >= pc.xpToNext){
      pc.xp -= pc.xpToNext;
      pc.level++;
      pc.xpToNext = Math.round(pc.xpToNext*1.4);
      // stat bumps
      pc.maxHP = Math.round(pc.maxHP*1.08);
      pc.currentHP = pc.maxHP;
      pc.atk = Math.round(pc.atk*1.06);
      pc.def = Math.round(pc.def*1.06);
      pc.spd = Math.round(pc.spd*1.03);
      battleState.log.push(`${pc.name} grew to level ${pc.level}!`);
    }
  }

  function checkBattleState(){
    const pcAlive = gameState.player.roster.some(c=>c.currentHP>0);
    const ecAlive = battleState.enemyTeam.some(c=>c.currentHP>0);
    if(!pcAlive){
      battleState.log.push("All of your critters have been defeated...");
      // perma-death already true (we don't revive). Remove dead ones now.
      gameState.player.roster = gameState.player.roster.filter(c=>c.currentHP>0);
      endBattle(true);
      return;
    }
    if(!ecAlive){
      const pc = activePlayerCritter();
      const ec = battleState.enemyTeam[0]; // coarse
      grantXP(pc, ec, false);
      if(battleState.mode==="arena" && battleState.arenaReward>0){
        gameState.player.money += battleState.arenaReward;
        battleState.log.push(`You won the arena battle and earned $${battleState.arenaReward}!`);
      }
      endBattle();
      return;
    }
    // ensure active indices refer to living
    if(activeEnemyCritter().currentHP<=0){
      let idx = battleState.enemyTeam.findIndex(c=>c.currentHP>0);
      if(idx===-1){ checkBattleState(); return; }
      battleState.activeEnemyIdx = idx;
    }
    if(activePlayerCritter().currentHP<=0){
      let idx = gameState.player.roster.findIndex(c=>c.currentHP>0);
      if(idx===-1){ checkBattleState(); return; }
      battleState.activePlayerIdx = idx;
      battleState.log.push(`You send out ${gameState.player.roster[idx].name}!`);
    }
  }

  function endBattle(isDeath){
    inBattle = false;
    battleOverlay.classList.remove("visible");
    if(isDeath){
      if(!gameState.player.roster.length){
        // full game over
        showGameOver();
      }
    }
    renderMap();
    autoSaveDebounced();
  }

  function showGameOver(){
    document.getElementById("gameOverOverlay").classList.add("visible");
  }
  document.getElementById("btnGameOverToMenu").onclick = ()=>{
    document.getElementById("gameOverOverlay").classList.remove("visible");
    openStartMenu();
  };

  // ----------------------------------------
  // Shop
  // ----------------------------------------
  const shopOverlay = document.getElementById("shopOverlay");
  const shopBody = document.getElementById("shopBody");
  document.getElementById("btnShopClose").onclick = closeShop;
  document.getElementById("btnShopBack").onclick = closeShop;

  const SHOP_PRICES = {
    potion:50,
    basicBall:100,
    greatBall:250,
    ultraBall:500
  };

  function openShop(){
    if(!gameState) return;
    shopOverlay.classList.add("visible");
    renderShop();
  }

  function closeShop(){
    shopOverlay.classList.remove("visible");
    // push you one tile away from the shop so you don't retrigger
    if(lastShopPos && gameState){
      const {x,y} = lastShopPos;
      const neighbors = [
        {x:x+1,y},
        {x:x-1,y},
        {x,y+1},
        {x,y-1},
      ].filter(p=>p.x>=0 && p.y>=0 && p.x<MAP_W && p.y<MAP_H);
      if(neighbors.length){
        const p = neighbors[0];
        gameState.map.playerX = p.x;
        gameState.map.playerY = p.y;
      }
      renderMap();
      autoSaveDebounced();
    }
  }

  function renderShop(){
    const p = gameState.player;
    shopBody.innerHTML="";
    const moneyRow=document.createElement("div");
    moneyRow.className="row";
    moneyRow.innerHTML=`<strong>Money:</strong><span>$${p.money}</span>`;
    shopBody.appendChild(moneyRow);

    const itemsTitle=document.createElement("div");
    itemsTitle.className="sectionTitle";
    itemsTitle.textContent="Buy Items";
    shopBody.appendChild(itemsTitle);

    function addBuyRow(label, price, key){
      const row=document.createElement("div");
      row.className="listItem";
      row.innerHTML=`<div>${label} <span style="color:var(--muted);font-size:11px;">$${price}</span></div>`;
      const btn=document.createElement("button");
      btn.className="secondary";
      btn.textContent="Buy";
      btn.disabled = p.money<price;
      btn.onclick=()=>{
        if(p.money<price) return;
        p.money-=price;
        if(key==="potion") p.potions++;
        else if(key==="basicBall") p.balls.basic++;
        else if(key==="greatBall") p.balls.great++;
        else if(key==="ultraBall") p.balls.ultra++;
        addLog("Shop",`Bought 1 ${label}.`);
        renderShop();
        renderHUD();
        autoSaveDebounced();
      };
      row.appendChild(btn);
      shopBody.appendChild(row);
    }
    addBuyRow("Healing Potion",SHOP_PRICES.potion,"potion");
    addBuyRow("Capture Ball",SHOP_PRICES.basicBall,"basicBall");
    addBuyRow("Great Capture Ball",SHOP_PRICES.greatBall,"greatBall");
    addBuyRow("Ultra Capture Ball",SHOP_PRICES.ultraBall,"ultraBall");

    const sellTitle=document.createElement("div");
    sellTitle.className="sectionTitle";
    sellTitle.textContent="Sell Critters";
    sellTitle.style.marginTop="8px";
    shopBody.appendChild(sellTitle);

    if(!p.roster.length){
      const msg=document.createElement("div");
      msg.style.fontSize="11px";
      msg.style.color="var(--muted)";
      msg.textContent="You have no critters to sell.";
      shopBody.appendChild(msg);
    }else{
      p.roster.forEach((c,idx)=>{
        const base = 60 + c.level*25;
        const elemBonus = c.element==="Fire"||c.element==="Storm" ? 20 :
                          c.element==="Stone" ? 30 : 10;
        const price = base+elemBonus;
        const row=document.createElement("div");
        row.className="listItem";
        const left=document.createElement("div");
        left.innerHTML=`<strong>${c.name}</strong> <span style="font-size:11px;color:var(--muted);">Lv ${c.level} ‚Ä¢ ${c.element}</span>`;
        const right=document.createElement("div");
        right.style.display="flex";
        right.style.alignItems="center";
        right.style.gap="6px";
        const val=document.createElement("span");
        val.style.fontSize="11px";
        val.textContent=`$${price}`;
        const btn=document.createElement("button");
        btn.className="danger";
        btn.textContent="Sell";
        btn.onclick=()=>{
          p.money += price;
          p.roster.splice(idx,1);
          addLog("Shop",`Sold ${c.name} for $${price}.`);
          renderShop();
          renderHUD();
          autoSaveDebounced();
        };
        right.appendChild(val);
        right.appendChild(btn);
        row.appendChild(left);
        row.appendChild(right);
        shopBody.appendChild(row);
      });
    }
  }

  // ----------------------------------------
  // Arena
  // ----------------------------------------
  const arenaOverlay=document.getElementById("arenaOverlay");
  const arenaBody=document.getElementById("arenaBody");
  const btnArenaStart=document.getElementById("btnArenaStart");
  document.getElementById("btnArenaClose").onclick = closeArena;
  document.getElementById("btnArenaCancel").onclick = closeArena;

  function openArena(){
    if(!gameState) return;
    arenaOverlay.classList.add("visible");
    renderArenaSelection();
  }

  function closeArena(){
    arenaOverlay.classList.remove("visible");
    // push you away from arena tile
    if(lastArenaPos && gameState){
      const {x,y} = lastArenaPos;
      const neighbors=[
        {x:x+1,y},
        {x:x-1,y},
        {x,y+1},
        {x,y-1}
      ].filter(p=>p.x>=0 && p.y>=0 && p.x<MAP_W && p.y<MAP_H);
      if(neighbors.length){
        const p=neighbors[0];
        gameState.map.playerX=p.x;
        gameState.map.playerY=p.y;
      }
      renderMap();
      autoSaveDebounced();
    }
  }

  function renderArenaSelection(){
    const p = gameState.player;
    arenaBody.innerHTML="";
    if(p.roster.length<3){
      arenaBody.innerHTML="<p>You need at least 3 critters to challenge the arena.</p>";
      btnArenaStart.disabled = true;
      return;
    }
    arenaBody.innerHTML=`
      <p style="font-size:12px;margin-bottom:6px;">
        Choose 3 of your critters to enter the arena. You will face 3 random opponents.
        Win to earn a cash prize.
      </p>
      <p style="font-size:11px;color:var(--muted);margin-bottom:6px;">
        (For now, all 3 of your first critters will enter automatically.)
      </p>
    `;
    const list=document.createElement("div");
    p.roster.slice(0,3).forEach(c=>{
      const row=document.createElement("div");
      row.className="listItem";
      row.innerHTML=`<div><strong>${c.name}</strong> <span style="font-size:11px;color:var(--muted);">Lv ${c.level} ‚Ä¢ ${c.element}</span></div>`;
      list.appendChild(row);
    });
    arenaBody.appendChild(list);
    btnArenaStart.disabled=false;
  }

  btnArenaStart.onclick = ()=>{
    arenaOverlay.classList.remove("visible");
    // enemy team: 3 random scaled critters
    const avgLvl = Math.max(3,Math.round(
      gameState.player.roster.slice(0,3).reduce((a,c)=>a+c.level,0)/Math.min(3,gameState.player.roster.length)
    ));
    const enemyTeam=[];
    for(let i=0;i<3;i++){
      const s = SPECIES[Math.floor(Math.random()*SPECIES.length)];
      const lvl = Math.max(2, avgLvl + (Math.random()*4-2|0));
      enemyTeam.push(createCritterFromSpecies(s.id,lvl));
    }
    const playerTeamIdxs = gameState.player.roster.slice(0,3).map((_,i)=>i);
    const reward = 200 + avgLvl*25;
    addLog("Arena",`You enter an arena battle for $${reward}!`);
    startBattle({
      mode:"arena",
      enemyTeam,
      playerTeamIdxs,
      activePlayerIdx:playerTeamIdxs[0],
      activeEnemyIdx:0,
      arenaReward:reward
    });
  };

  // ----------------------------------------
  // Saving & loading (Firestore /users/{uid})
  // ----------------------------------------
  const saveNameInput = document.getElementById("saveNameInput");
  const startOverlay = document.getElementById("startOverlay");
  const startStatus = document.getElementById("startStatus");
  const btnNewGame = document.getElementById("btnNewGame");
  const btnLoadGame = document.getElementById("btnLoadGame");
  const btnStartClose = document.getElementById("btnStartClose");

  function openStartMenu(){
    startOverlay.classList.add("visible");
    startStatus.textContent="";
  }
  btnStartClose.onclick = ()=>{ /* keep menu for now */ };

  btnNewGame.onclick = async ()=>{
    if(!currentUser){ startStatus.textContent="Still connecting to Firebase..."; return; }
    const name = saveNameInput.value.trim();
    if(!name){ startStatus.textContent="Please enter a save name."; return; }
    currentSaveName = name;
    gameState = createNewGameState(name);
    await saveGame();
    startOverlay.classList.remove("visible");
    addLog("System",`New game started with save "${name}".`);
    renderMap();
  };

  btnLoadGame.onclick = async ()=>{
    if(!currentUser){ startStatus.textContent="Still connecting to Firebase..."; return; }
    const name = saveNameInput.value.trim();
    if(!name){ startStatus.textContent="Please enter a save name."; return; }
    const loaded = await loadGameByName(name);
    if(!loaded){
      startStatus.textContent=`No save named "${name}" found for this user.`;
    }else{
      startOverlay.classList.remove("visible");
    }
  };

  async function ensureUserDoc(){
    if(!currentUser) return null;
    const ref = doc(db,"users",currentUser.uid);
    let snap = await getDoc(ref);
    if(!snap.exists()){
      await setDoc(ref,{ monsterQuestSaves:{} },{merge:true});
      snap = await getDoc(ref);
    }
    return {ref, snap};
  }

  async function loadSavesCache(){
    const info = await ensureUserDoc();
    if(!info) return;
    const data = info.snap.data() || {};
    savesCache = data.monsterQuestSaves || {};
  }

  async function saveGame(){
    if(!currentUser || !gameState || !currentSaveName) return;
    const ref = doc(db,"users",currentUser.uid);
    // update cache
    savesCache[currentSaveName] = gameState;
    await setDoc(ref,{
      monsterQuestSaves: savesCache
    },{merge:true});
    saveTagEl.textContent = `Saved: "${currentSaveName}"`;
  }

  let saveTimeout = null;
  function autoSaveDebounced(){
    if(!currentUser || !gameState) return;
    if(saveTimeout) clearTimeout(saveTimeout);
    saveTimeout = setTimeout(()=>{ saveGame().catch(console.error); }, 800);
  }

  async function loadGameByName(name){
    await loadSavesCache();
    const gs = savesCache[name];
    if(!gs){
      return false;
    }
    currentSaveName = name;
    gameState = gs;
    saveTagEl.textContent = `Loaded: "${name}"`;
    addLog("System",`Loaded game "${name}".`);
    renderMap();
    return true;
  }

  function createNewGameState(name){
    const tiles = generateMap();
    // random starter from three base critters
    const starters = ["blazefox","tidalfin","leafling"];
    const starterId = starters[Math.floor(Math.random()*starters.length)];
    const starter = createCritterFromSpecies(starterId,3);
    return {
      saveName:name,
      createdAt:Date.now(),
      lastPlayed:Date.now(),
      player:{
        money:300,
        potions:3,
        balls:{basic:10,great:3,ultra:1},
        roster:[starter]
      },
      map:{
        tiles,
        playerX:2,
        playerY:MAP_H-2
      }
    };
  }

  // Quick save/load controls on right pane
  const quickSaveNameInput=document.getElementById("quickSaveName");
  document.getElementById("btnQuickSave").onclick = ()=>saveGame().catch(console.error);
  document.getElementById("btnQuickLoad").onclick = async ()=>{
    const name = quickSaveNameInput.value.trim();
    if(!name) return;
    await loadGameByName(name);
  };
  document.getElementById("btnCenter").onclick = centerOnPlayer;

  // ----------------------------------------
  // Auth bootstrap
  // ----------------------------------------
  onAuthStateChanged(auth, async user=>{
    if(user){
      currentUser = user;
      userTagEl.textContent = `Anon UID: ${user.uid.slice(0,8)}‚Ä¶`;
      await loadSavesCache();
      openStartMenu();
    }else{
      userTagEl.textContent = "Signing in anonymously‚Ä¶";
      signInAnonymously(auth).catch(err=>{
        console.error(err);
        userTagEl.textContent = "Auth error. See console.";
      });
    }
  });

</script>
</body>
</html>


