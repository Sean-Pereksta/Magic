<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Monster Quest ‚Äî Firebase RPG</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
  :root{
    --bg:#020617;
    --panel:#0b1120;
    --ink:#e5e7eb;
    --muted:#9ca3af;
    --accent:#22c55e;
    --danger:#ef4444;
    --zone1:#14532d;
    --zone2:#1d4ed8;
    --zone3:#7c2d12;
    --zone4:#4b5563;
    --zone5:#065f46;
  }

  *{
    box-sizing:border-box;
    margin:0;
    padding:0;
    font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;
  }

  body{
    background:radial-gradient(circle at top,#0f172a,#020617);
    color:var(--ink);
    display:flex;
    justify-content:center;
    align-items:center;
    min-height:100vh;
  }

  #app{
    width:100%;
    max-width:1100px;
    height:95vh;
    max-height:800px;
    background:rgba(15,23,42,.95);
    border-radius:18px;
    box-shadow:0 30px 80px rgba(0,0,0,.7);
    display:flex;
    overflow:hidden;
    border:1px solid #1f2937;
  }

  /* Left pane with centered camera window */
  #leftPane{
    flex:2.1;
    border-right:1px solid #1f2937;
    position:relative;
    overflow:hidden;
    background:#020617;
    display:flex;
    align-items:center;
    justify-content:center;
  }

  /* Right pane */
  #rightPane{
    flex:1.2;
    display:flex;
    flex-direction:column;
    background:linear-gradient(180deg,#020617,#020617,#020617);
  }

  /* Camera window (9x9 tiles) */
  #mapView{
    display:grid;
    grid-template-columns:repeat(9,32px);
    grid-template-rows:repeat(9,32px);
    gap:2px;
    padding:6px;
    background:#000;
    border-radius:8px;
  }

  .tile{
    position:relative;
    width:32px;
    height:32px;
    border-radius:4px;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:12px;
    color:#e5e7eb;
    user-select:none;
    -webkit-tap-highlight-color:transparent;
  }

  .tile.zone1{background:var(--zone1);}
  .tile.zone2{background:var(--zone2);}
  .tile.zone3{background:var(--zone3);}
  .tile.zone4{background:var(--zone4);}
  .tile.zone5{background:var(--zone5);}

  .tile.bush::after{
    content:"üåø";
    position:absolute;
    font-size:14px;
  }
  .tile.rock::after{
    content:"ü™®";
    position:absolute;
    font-size:14px;
  }
  .tile.shop::after{
    content:"üè™";
    position:absolute;
    font-size:16px;
  }
   /* Old generic arena (for older saves) */
  .tile.arena::after{
    content:"‚öîÔ∏è";
    position:absolute;
    font-size:15px;
  }

  /* New tiered arenas */
  .tile.arena3::after{
    content:"‚öîÔ∏è";      /* base arena */
    position:absolute;
    font-size:15px;
  }
  .tile.arena4::after{
    content:"üèÜ";      /* elite arena */
    position:absolute;
    font-size:15px;
  }
  .tile.arena5::after{
    content:"üíÄ";      /* mythic arena */
    position:absolute;
    font-size:15px;
  }


  .playerMarker{
    position:absolute;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:16px;
  }
  .playerMarker span{
    filter:drop-shadow(0 0 4px rgba(0,0,0,.7));
  }

  /* Right pane: header & HUD */
  #header{
    padding:10px 12px;
    border-bottom:1px solid #1f2937;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
  }
  #header h1{
    font-size:18px;
    font-weight:600;
    letter-spacing:.03em;
  }
  #header small{
    color:var(--muted);
    font-size:11px;
  }

  .pill{
    padding:4px 8px;
    border-radius:999px;
    border:1px solid #1f2937;
    font-size:11px;
    color:var(--muted);
  }

  #metaRow{
    padding:6px 10px 8px;
    border-bottom:1px solid #1f2937;
    display:flex;
    flex-wrap:wrap;
    gap:6px;
    font-size:12px;
    color:var(--muted);
  }

  #inventory{
    padding:6px 10px;
    border-bottom:1px solid #1f2937;
    display:flex;
    flex-wrap:wrap;
    gap:6px;
    font-size:12px;
  }

  .chip{
    padding:4px 8px;
    border-radius:999px;
    background:#0f172a;
    border:1px solid #1f2937;
    display:flex;
    align-items:center;
    gap:4px;
    font-size:11px;
  }
  .chip span{
    font-size:13px;
  }

  #controls{
    padding:8px 10px;
    border-bottom:1px solid #1f2937;
    display:flex;
    flex-wrap:wrap;
    gap:6px;
    font-size:12px;
  }

  button{
    background:var(--accent);
    border:none;
    color:#ecfdf5;
    padding:4px 10px;
    border-radius:999px;
    font-size:12px;
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:4px;
  }
  button.secondary{
    background:#0f172a;
    color:var(--muted);
    border:1px solid #1f2937;
  }
  button.danger{
    background:var(--danger);
  }
  button:disabled{
    opacity:.5;
    cursor:not-allowed;
  }

  input[type="text"]{
    background:#020617;
    color:var(--ink);
    border-radius:999px;
    border:1px solid #1f2937;
    padding:4px 9px;
    font-size:12px;
    min-width:0;
  }

  #log{
    flex:1;
    padding:8px 10px;
    font-size:12px;
    overflow-y:auto;
  }

  .logLine{
    margin-bottom:4px;
    color:#e5e7eb;
  }
  .logLine span.tag{
    font-size:10px;
    padding:1px 4px;
    border-radius:999px;
    margin-right:4px;
    background:#0f172a;
    color:var(--muted);
  }

  #footer{
    padding:6px 10px;
    border-top:1px solid #1f2937;
    font-size:10px;
    color:var(--muted);
    display:flex;
    justify-content:space-between;
    align-items:center;
  }

  /* Overlays (battle, shop, arena, start, game over) */
  .overlay{
    position:absolute;
    inset:0;
    background:rgba(15,23,42,.96);
    display:none;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    padding:16px;
    z-index:10;
    /* allow scrolling if panel is taller than viewport */
    overflow-y:auto;
  }
  .overlay.visible{
    display:flex;
  }

  .panel{
    background:#020617;
    border-radius:16px;
    border:1px solid #1f2937;
    padding:14px 16px;
    width:100%;
    max-width:420px;
    max-height:90vh; /* use viewport height */
    display:flex;
    flex-direction:column;
    gap:8px;
    overflow:hidden;
  }

  .panelHeader{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:8px;
    border-bottom:1px solid #1f2937;
    padding-bottom:6px;
  }
  .panelHeader h2{
    font-size:16px;
  }

  .panelBody{
    flex:1;
    overflow-y:auto;
    padding-top:4px;
    font-size:12px;
  }

  .panelFooter{
    padding-top:6px;
    border-top:1px solid #1f2937;
    display:flex;
    justify-content:flex-end;
    gap:8px;
    flex-wrap:wrap;
  }

  .row{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:6px;
    margin-bottom:4px;
  }
  .row strong{
    font-size:12px;
  }

  .battleStats{
    display:flex;
    gap:6px;
    margin-bottom:6px;
    flex-wrap:wrap;
  }

  .badge{
    border-radius:999px;
    padding:1px 6px;
    font-size:10px;
    border:1px solid #1f2937;
    background:#020617;
    color:var(--muted);
  }

  .hpBar{
    width:100%;
    height:6px;
    background:#111827;
    border-radius:999px;
    overflow:hidden;
    margin-top:2px;
  }
  .hpFill{
    height:100%;
    background:linear-gradient(90deg,#22c55e,#f97316);
  }

  .sectionTitle{
    font-weight:600;
    margin:4px 0 2px;
    color:#e5e7eb;
  }

  .listItem{
    padding:4px 4px;
    border-radius:6px;
    border:1px solid #1f2937;
    margin-bottom:4px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:4px;
  }

  /* Battle footer buttons responsive behavior */
  #battleFooter button{
    flex:1 1 auto;
    min-width:140px;
    margin-bottom:4px;
  }

  @media (max-width:900px){
    #app{
      flex-direction:column;
      height:100vh;
      max-height:none;
      border-radius:0;
    }
    #leftPane{
      flex:1.6;
      border-right:none;
      border-bottom:1px solid #1f2937;
    }
    #rightPane{
      flex:1.4;
    }
  }

  /* Phone-specific tweaks */
  @media (max-width:600px){
    .overlay{
      align-items:flex-start;
      justify-content:flex-start;
      padding:8px 4px;
    }
    .panel{
      width:100%;
      max-width:none;
      max-height:100vh;
      border-radius:0;
      border-left:none;
      border-right:none;
    }
    .panelBody{
      flex:1;
      overflow-y:auto;
    }
    .panelFooter{
      flex-wrap:wrap;
      gap:6px;
      justify-content:flex-start;
    }
    #battleFooter button{
      flex:1 1 100%;
    }
    #shopBody{
  max-height:60vh;        /* keeps header/footer visible on most screens */
  overflow-y:auto;
  padding-right:4px;      /* little space for scrollbar */
}
  }
</style>
</head>
<body>
<div id="app">
  <div id="leftPane">
    <div id="mapView"></div>

    <!-- Start / Save selection overlay -->
<div id="startOverlay" class="overlay visible">
  <div class="panel">
    <div class="panelHeader">
      <h2>Monster Quest</h2>
      <button class="secondary" id="btnStartClose" style="padding-inline:8px;font-size:11px;">X</button>
    </div>
    <div class="panelBody">
      <p style="margin-bottom:8px;color:var(--muted);">
        Enter a <strong>Username</strong> and a <strong>Save name</strong>.  
        New Game will create / overwrite that save for that user.  
        Load Game will look for that username + save.
      </p>

      <label style="font-size:12px;display:block;margin-bottom:4px;">Username</label>
      <input type="text" id="startUsernameInput" placeholder="e.g. Sean" style="width:100%;margin-bottom:8px;">

      <label style="font-size:12px;display:block;margin-bottom:4px;">Save Name</label>
      <input type="text" id="saveNameInput" placeholder="e.g. my-first-run" style="width:100%;margin-bottom:8px;">

      <p id="startStatus" style="font-size:11px;color:var(--muted);min-height:14px;"></p>
    </div>
    <div class="panelFooter">
      <button class="secondary" id="btnLoadGame">Load Game</button>
      <button id="btnNewGame">Start New Game</button>
    </div>
  </div>
</div>


    <!-- Battle overlay -->
    <div id="battleOverlay" class="overlay">
      <div class="panel">
        <div class="panelHeader">
          <h2 id="battleTitle">Wild Battle</h2>
          <button class="secondary" id="btnBattleClose">X</button>
        </div>
        <div class="panelBody" id="battleBody">
          <!-- Filled by JS -->
        </div>
        <div class="panelFooter" id="battleFooter">
          <!-- Actions: abilities, capture, potion, switch, run (if wild) -->
        </div>
      </div>
    </div>

    <!-- Shop overlay -->
    <div id="shopOverlay" class="overlay">
      <div class="panel">
        <div class="panelHeader">
          <h2>Item Shop</h2>
          <button class="secondary" id="btnShopClose">X</button>
        </div>
        <div class="panelBody" id="shopBody"></div>
        <div class="panelFooter">
          <button class="secondary" id="btnShopBack">Back to Map</button>
        </div>
      </div>
    </div>

    <!-- Arena overlay -->
    <div id="arenaOverlay" class="overlay">
      <div class="panel">
        <div class="panelHeader">
          <h2>Arena Challenge</h2>
          <button class="secondary" id="btnArenaClose">X</button>
        </div>
        <div class="panelBody" id="arenaBody"></div>
        <div class="panelFooter">
          <button class="secondary" id="btnArenaCancel">Leave Arena</button>
          <button id="btnArenaStart">Begin Battle</button>
        </div>
      </div>
    </div>
    <!-- Roster / Critters overlay -->
<div id="rosterOverlay" class="overlay">
  <div class="panel">
    <div class="panelHeader">
      <h2>Your Critters</h2>
      <button class="secondary" id="btnRosterClose">X</button>
    </div>
    <div class="panelBody" id="rosterBody">
      <!-- Filled by JS -->
    </div>
    <div class="panelFooter">
      <button class="secondary" id="btnRosterBack">Back</button>
    </div>
  </div>
</div>


    <!-- Game Over overlay -->
    <div id="gameOverOverlay" class="overlay">
      <div class="panel">
        <div class="panelHeader">
          <h2>Game Over</h2>
        </div>
        <div class="panelBody">
          <p style="margin-bottom:8px;">All of your critters have fallen. This save is done.</p>
          <p style="font-size:11px;color:var(--muted);">
            You can start a new game with the same or a different save name from the main menu.
          </p>
        </div>
        <div class="panelFooter">
          <button id="btnGameOverToMenu">Return to Menu</button>
        </div>
      </div>
    </div>
  </div>

  <div id="rightPane">
    <div id="header">
      <div>
        <h1>Monster Quest</h1>
        <small id="userTag">Connecting to Firebase‚Ä¶</small>
      </div>
      <div class="pill" id="saveTag">No save loaded</div>
    </div>
    <div id="metaRow">
      <div>Zone: <span id="zoneName">-</span></div>
      <div>Pos: <span id="posLabel">-</span></div>
      <div>Mode: <span id="modeLabel">Exploration</span></div>
    </div>
    <div id="inventory"></div>
    <div id="controls">
      <input type="text" id="quickSaveName" placeholder="Save name" style="flex:1;min-width:80px;">
      <button class="secondary" id="btnQuickLoad" style="font-size:11px;">Load</button>
      <button id="btnQuickSave" style="font-size:11px;">Save</button>
      <button class="secondary" id="btnCenter" style="font-size:11px;">Center on Player</button>
      <button class="secondary" id="btnRoster" style="font-size:11px;">Critters</button>
    </div>
    <div id="log"></div>
    <div id="footer">
      <span>Click / tap a tile to move. Bushes / rocks increase encounter odds.</span>
      <span style="opacity:.7;">v0.1 proto</span>
    </div>
  </div>
</div>

<script type="module">
  // ----------------------------------------
  // Firebase init (anonymous auth, Firestore)
  // ----------------------------------------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB7twY7z31ucB6pGA8JC_HrVMZhA8lNaJA",
    authDomain: "bible-game-246c0.firebaseapp.com",
    databaseURL: "https://bible-game-246c0-default-rtdb.firebaseio.com",
    projectId: "bible-game-246c0",
    storageBucket: "bible-game-246c0.firebasestorage.app",
    messagingSenderId: "959619818996",
    appId: "1:959619818996:web:5a9fbf492e23c765e445a1",
    measurementId: "G-8PR6LVKSH3"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

 let currentUser = null;
  let currentUsername = null;  // logical username typed on menu
  let savesCache = {};         // saveName -> serialized state for this username
  const userTagEl = document.getElementById("userTag");
  const saveTagEl = document.getElementById("saveTag");
  const logEl = document.getElementById("log");
  const invEl = document.getElementById("inventory");
  const zoneNameEl = document.getElementById("zoneName");
  const posLabelEl = document.getElementById("posLabel");
  const modeLabelEl = document.getElementById("modeLabel");

  // ----------------------------------------
  // Game data definitions
  // ----------------------------------------

  const ELEMENTS = ["Fire","Water","Nature","Storm","Stone"];

  const TYPE_CHART = {
    Fire:   { Nature:2, Water:0.5, Stone:0.5 },
    Water:  { Fire:2, Stone:2, Nature:0.5, Storm:0.5 },
    Nature: { Water:2, Stone:2, Fire:0.5 },
    Storm:  { Water:2, Stone:0.5 },
    Stone:  { Storm:2, Fire:2, Water:0.5, Nature:0.5 }
  };

  function typeMultiplier(att, def){
    const row = TYPE_CHART[att];
    if(row && row[def] != null) return row[def];
    return 1;
  }

  // 50 critters across 5 elements, 5 power tiers
 const SPECIES = [
  // =========================
  // WEAK TIER (10)
  // =========================

  // Fire (2)
  {
    id:"emberkit",
    name:"Emberkit",
    emoji:"üî•",
    element:"Fire",
    baseHP:70,
    baseAtk:14,
    baseDef:12,
    baseSpd:18,
    abilities:[
      {name:"Warm Nip", kind:"damage", power:16, maxCharges:7},
      {name:"Tiny Ember", kind:"damage", power:18, maxCharges:5}
    ]
  },
  {
    id:"cinderchip",
    name:"Cinderchip",
    emoji:"üêøÔ∏è",
    element:"Fire",
    baseHP:68,
    baseAtk:15,
    baseDef:11,
    baseSpd:20,
    abilities:[
      {name:"Cinder Peck", kind:"damage", power:17, maxCharges:7},
      {name:"Glow Up", kind:"buffAtk", amount:4, maxCharges:3}
    ]
  },

  // Water (2)
  {
    id:"splashling",
    name:"Splashling",
    emoji:"üíß",
    element:"Water",
    baseHP:72,
    baseAtk:13,
    baseDef:13,
    baseSpd:17,
    abilities:[
      {name:"Tiny Wave", kind:"damage", power:16, maxCharges:7},
      {name:"Soothing Drip", kind:"heal", amount:18, maxCharges:3}
    ]
  },
  {
    id:"drizzlefin",
    name:"Drizzlefin",
    emoji:"üêü",
    element:"Water",
    baseHP:74,
    baseAtk:15,
    baseDef:12,
    baseSpd:19,
    abilities:[
      {name:"Drizzle Shot", kind:"damage", power:18, maxCharges:6},
      {name:"Rain Veil", kind:"buffDef", amount:4, maxCharges:3}
    ]
  },

  // Nature (2)
  {
    id:"sproutbug",
    name:"Sproutbug",
    emoji:"üêõ",
    element:"Nature",
    baseHP:68,
    baseAtk:13,
    baseDef:12,
    baseSpd:18,
    abilities:[
      {name:"Nibble Leaf", kind:"damage", power:16, maxCharges:7},
      {name:"Green Pulse", kind:"heal", amount:16, maxCharges:3}
    ]
  },
  {
    id:"thornsprout",
    name:"Thornsprout",
    emoji:"üåµ",
    element:"Nature",
    baseHP:70,
    baseAtk:16,
    baseDef:11,
    baseSpd:17,
    abilities:[
      {name:"Thorn Prick", kind:"damage", power:18, maxCharges:6},
      {name:"Root Slow", kind:"debuffSpd", amount:4, maxCharges:3}
    ]
  },

  // Storm (2)
  {
    id:"gustling",
    name:"Gustling",
    emoji:"üïäÔ∏è",
    element:"Storm",
    baseHP:66,
    baseAtk:14,
    baseDef:11,
    baseSpd:22,
    abilities:[
      {name:"Breeze Peck", kind:"damage", power:17, maxCharges:7},
      {name:"Tailwind", kind:"buffSpd", amount:5, maxCharges:3}
    ]
  },
  {
    id:"sparkmite",
    name:"Sparkmite",
    emoji:"üêù",
    element:"Storm",
    baseHP:64,
    baseAtk:15,
    baseDef:10,
    baseSpd:23,
    abilities:[
      {name:"Static Nibble", kind:"damage", power:18, maxCharges:6},
      {name:"Charge Up", kind:"buffAtk", amount:4, maxCharges:3}
    ]
  },

  // Stone (2)
  {
    id:"pebblepup",
    name:"Pebblepup",
    emoji:"üê∂",
    element:"Stone",
    baseHP:76,
    baseAtk:13,
    baseDef:15,
    baseSpd:14,
    abilities:[
      {name:"Pebble Bop", kind:"damage", power:17, maxCharges:7},
      {name:"Hard Shell", kind:"buffDef", amount:4, maxCharges:3}
    ]
  },
  {
    id:"dustpebble",
    name:"Dustpebble",
    emoji:"ü™®",
    element:"Stone",
    baseHP:72,
    baseAtk:15,
    baseDef:14,
    baseSpd:15,
    abilities:[
      {name:"Dust Toss", kind:"damage", power:18, maxCharges:6},
      {name:"Dust Screen", kind:"debuffAtk", amount:4, maxCharges:3}
    ]
  },

  // =========================
  // MODERATE TIER (10)
  // =========================

  // Fire (2)
  {
    id:"flarethorn",
    name:"Flarethorn",
    emoji:"üåã",
    element:"Fire",
    baseHP:80,
    baseAtk:19,
    baseDef:15,
    baseSpd:19,
    abilities:[
      {name:"Flare Bite", kind:"damage", power:22, maxCharges:6},
      {name:"Heat Bloom", kind:"buffAtk", amount:5, maxCharges:3}
    ]
  },
  {
    id:"charcub",
    name:"Charcub",
    emoji:"üêª",
    element:"Fire",
    baseHP:82,
    baseAtk:20,
    baseDef:14,
    baseSpd:20,
    abilities:[
      {name:"Char Swipe", kind:"damage", power:22, maxCharges:6},
      {name:"Warm Fur", kind:"buffDef", amount:5, maxCharges:3}
    ]
  },

  // Water (2)
  {
    id:"brookfin",
    name:"Brookfin",
    emoji:"üê†",
    element:"Water",
    baseHP:84,
    baseAtk:18,
    baseDef:17,
    baseSpd:18,
    abilities:[
      {name:"Brook Jet", kind:"damage", power:22, maxCharges:6},
      {name:"Fresh Current", kind:"heal", amount:22, maxCharges:3}
    ]
  },
  {
    id:"tideotter",
    name:"Tideotter",
    emoji:"ü¶¶",
    element:"Water",
    baseHP:86,
    baseAtk:20,
    baseDef:16,
    baseSpd:19,
    abilities:[
      {name:"Tide Tackle", kind:"damage", power:23, maxCharges:6},
      {name:"Shell Rub", kind:"buffDef", amount:5, maxCharges:3}
    ]
  },

  // Nature (2)
  {
    id:"mossling",
    name:"Mossling",
    emoji:"üåø",
    element:"Nature",
    baseHP:82,
    baseAtk:18,
    baseDef:17,
    baseSpd:18,
    abilities:[
      {name:"Moss Bite", kind:"damage", power:22, maxCharges:6},
      {name:"Soft Growth", kind:"heal", amount:22, maxCharges:3}
    ]
  },
  {
    id:"vinepup",
    name:"Vinepup",
    emoji:"üêï",
    element:"Nature",
    baseHP:80,
    baseAtk:20,
    baseDef:16,
    baseSpd:20,
    abilities:[
      {name:"Vine Lash", kind:"damage", power:23, maxCharges:6},
      {name:"Entangle", kind:"debuffDef", amount:5, maxCharges:3}
    ]
  },

  // Storm (2)
  {
    id:"breezerat",
    name:"Breezerat",
    emoji:"üê≠",
    element:"Storm",
    baseHP:78,
    baseAtk:19,
    baseDef:14,
    baseSpd:24,
    abilities:[
      {name:"Gale Scratch", kind:"damage", power:23, maxCharges:6},
      {name:"Tail Current", kind:"buffSpd", amount:6, maxCharges:3}
    ]
  },
  {
    id:"stormkit",
    name:"Stormkit",
    emoji:"üå©Ô∏è",
    element:"Storm",
    baseHP:80,
    baseAtk:20,
    baseDef:15,
    baseSpd:23,
    abilities:[
      {name:"Spark Swipe", kind:"damage", power:23, maxCharges:6},
      {name:"Static Coat", kind:"buffDef", amount:5, maxCharges:3}
    ]
  },

  // Stone (2)
  {
    id:"rubblepup",
    name:"Rubblepup",
    emoji:"üß±",
    element:"Stone",
    baseHP:88,
    baseAtk:19,
    baseDef:19,
    baseSpd:16,
    abilities:[
      {name:"Rubble Bash", kind:"damage", power:23, maxCharges:6},
      {name:"Stone Guard", kind:"buffDef", amount:6, maxCharges:3}
    ]
  },
  {
    id:"stonehopper",
    name:"Stonehopper",
    emoji:"üê∏",
    element:"Stone",
    baseHP:86,
    baseAtk:20,
    baseDef:18,
    baseSpd:17,
    abilities:[
      {name:"Pebble Kick", kind:"damage", power:22, maxCharges:6},
      {name:"Dust Leap", kind:"buffSpd", amount:5, maxCharges:3}
    ]
  },

  // =========================
  // GOOD TIER (10)
  // (Starters live here)
  // =========================

  // Fire (2) ‚Äî includes Blazefox
  {
    id:"blazefox",
    name:"Blazefox",
    emoji:"ü¶ä",
    element:"Fire",
    baseHP:90,
    baseAtk:25,
    baseDef:15,
    baseSpd:20,
    abilities:[
      {name:"Flame Bite", kind:"damage", power:24, maxCharges:6},
      // Off-type coverage: stone-forged claws
      {name:"Fire Claws", kind:"damage", power:30, maxCharges:4, element:"Stone"},
      {name:"Inferno Howl", kind:"buffAtk", amount:7, maxCharges:2}
    ]
  },
  {
    id:"emberclaw",
    name:"Emberclaw",
    emoji:"üêà‚Äç‚¨õ",
    element:"Fire",
    baseHP:94,
    baseAtk:26,
    baseDef:16,
    baseSpd:21,
    abilities:[
      {name:"Claw Blaze", kind:"damage", power:26, maxCharges:5},
      {name:"Smolder Guard", kind:"buffDef", amount:6, maxCharges:3},
      // New off-type strike
      {name:"Ashen Bolt", kind:"damage", power:28, maxCharges:4, element:"Storm"}
    ]
  },

  // Water (2) ‚Äî includes Tidalfin
  {
    id:"tidalfin",
    name:"Tidalfin",
    emoji:"üê¨",
    element:"Water",
    baseHP:95,
    baseAtk:22,
    baseDef:18,
    baseSpd:18,
    abilities:[
      {name:"Water Jet", kind:"damage", power:24, maxCharges:6},
      // Charged bubbles for Storm coverage
      {name:"Bubble Burst", kind:"damage", power:28, maxCharges:4, element:"Storm"},
      {name:"Splash Shield", kind:"buffDef", amount:7, maxCharges:3}
    ]
  },
  {
    id:"surfstrider",
    name:"Surfstrider",
    emoji:"üêã",
    element:"Water",
    baseHP:98,
    baseAtk:24,
    baseDef:18,
    baseSpd:20,
    abilities:[
      {name:"Surf Crash", kind:"damage", power:26, maxCharges:5},
      {name:"Foam Veil", kind:"heal", amount:26, maxCharges:3},
      // New icy/stone coverage
      {name:"Tidal Spike", kind:"damage", power:30, maxCharges:4, element:"Stone"}
    ]
  },

  // Nature (2) ‚Äî includes Leafling
  {
    id:"leafling",
    name:"Leafling",
    emoji:"üçÉ",
    element:"Nature",
    baseHP:88,
    baseAtk:20,
    baseDef:16,
    baseSpd:20,
    abilities:[
      {name:"Vine Whip", kind:"damage", power:24, maxCharges:6},
      {name:"Photosynthesis", kind:"heal", amount:26, maxCharges:4},
      {name:"Root Bind", kind:"debuffDef", amount:6, maxCharges:3}
    ]
  },
  {
    id:"briarhorn",
    name:"Briarhorn",
    emoji:"ü¶å",
    element:"Nature",
    baseHP:96,
    baseAtk:24,
    baseDef:18,
    baseSpd:18,
    abilities:[
      {name:"Briar Charge", kind:"damage", power:26, maxCharges:5},
      {name:"Thorn Screen", kind:"debuffAtk", amount:6, maxCharges:3},
      // New Water-flavored sap shot
      {name:"Sap Shot", kind:"damage", power:28, maxCharges:4, element:"Water"}
    ]
  },

  // Storm (2)
  {
    id:"stormpup",
    name:"Stormpup",
    emoji:"üê∫",
    element:"Storm",
    baseHP:82,
    baseAtk:23,
    baseDef:14,
    baseSpd:30,
    abilities:[
      {name:"Spark Pounce", kind:"damage", power:24, maxCharges:7},
      // Hot thunder giving Fire coverage
      {name:"Thunder Bark", kind:"damage", power:28, maxCharges:4, element:"Fire"},
      {name:"Agility", kind:"buffSpd", amount:7, maxCharges:3}
    ]
  },
  {
    id:"voltwing",
    name:"Voltwing",
    emoji:"ü¶Ö",
    element:"Storm",
    baseHP:84,
    baseAtk:24,
    baseDef:15,
    baseSpd:26,
    abilities:[
      {name:"Lightning Peck", kind:"damage", power:26, maxCharges:6},
      {name:"Static Field", kind:"debuffAtk", amount:7, maxCharges:3},
      // New Nature-charged slash
      {name:"Gale Slash", kind:"damage", power:28, maxCharges:4, element:"Nature"}
    ]
  },

  // Stone (2)
  {
    id:"boulderback",
    name:"Boulderback",
    emoji:"ü¶î",
    element:"Stone",
    baseHP:120,
    baseAtk:20,
    baseDef:26,
    baseSpd:12,
    abilities:[
      {name:"Rock Slam", kind:"damage", power:26, maxCharges:6},
      {name:"Earthen Wall", kind:"buffDef", amount:9, maxCharges:3},
      // Magma-cracking stomp for Fire coverage
      {name:"Quake Stomp", kind:"damage", power:30, maxCharges:3, element:"Fire"}
    ]
  },
  {
    id:"pebblord",
    name:"Pebblord",
    emoji:"ü™®",
    element:"Stone",
    baseHP:110,
    baseAtk:23,
    baseDef:24,
    baseSpd:14,
    abilities:[
      {name:"Pebble Storm", kind:"damage", power:26, maxCharges:5},
      {name:"Stone Crown", kind:"buffAtk", amount:6, maxCharges:3},
      // New crystal ice-shot for Water/Stone coverage
      {name:"Crystal Lance", kind:"damage", power:28, maxCharges:4, element:"Water"}
    ]
  },

  // =========================
  // GREAT TIER (10)
  // =========================

  // Fire (2)
  {
    id:"magmafang",
    name:"Magmafang",
    emoji:"üê≤",
    element:"Fire",
    baseHP:110,
    baseAtk:30,
    baseDef:20,
    baseSpd:22,
    abilities:[
      {name:"Magma Maul", kind:"damage", power:32, maxCharges:4},
      {name:"Lava Armor", kind:"buffDef", amount:8, maxCharges:3},
      {name:"Cinder Storm", kind:"damage", power:30, maxCharges:4, element:"Storm"}
    ]
  },
  {
    id:"solaraptor",
    name:"Solaraptor",
    emoji:"ü¶ñ",
    element:"Fire",
    baseHP:105,
    baseAtk:31,
    baseDef:19,
    baseSpd:26,
    abilities:[
      {name:"Solar Claw", kind:"damage", power:33, maxCharges:4},
      {name:"Flare Halo", kind:"buffAtk", amount:8, maxCharges:3},
      {name:"Radiant Dive", kind:"damage", power:31, maxCharges:4, element:"Nature"}
    ]
  },

  // Water (2)
  {
    id:"abysslurker",
    name:"Abysslurker",
    emoji:"üêô",
    element:"Water",
    baseHP:112,
    baseAtk:28,
    baseDef:22,
    baseSpd:20,
    abilities:[
      {name:"Abyss Bite", kind:"damage", power:32, maxCharges:4},
      {name:"Dark Tide", kind:"damage", power:28, maxCharges:4, element:"Storm"},
      {name:"Abyssal Mending", kind:"heal", amount:30, maxCharges:3}
    ]
  },
  {
    id:"glacialon",
    name:"Glacialon",
    emoji:"‚ùÑÔ∏è",
    element:"Water",
    baseHP:108,
    baseAtk:27,
    baseDef:23,
    baseSpd:21,
    abilities:[
      {name:"Glacier Crash", kind:"damage", power:32, maxCharges:4},
      {name:"Frost Heal", kind:"heal", amount:34, maxCharges:3},
      {name:"Ice Shard Burst", kind:"damage", power:30, maxCharges:4, element:"Stone"}
    ]
  },

  // Nature (2)
  {
    id:"barkback",
    name:"Barkback",
    emoji:"üå≥",
    element:"Nature",
    baseHP:112,
    baseAtk:27,
    baseDef:24,
    baseSpd:18,
    abilities:[
      {name:"Trunk Smash", kind:"damage", power:30, maxCharges:4},
      {name:"Ancient Bark", kind:"buffDef", amount:9, maxCharges:3},
      {name:"Sap Flood", kind:"damage", power:28, maxCharges:4, element:"Water"}
    ]
  },
  {
    id:"wildbloom",
    name:"Wildbloom",
    emoji:"üå∏",
    element:"Nature",
    baseHP:104,
    baseAtk:28,
    baseDef:22,
    baseSpd:22,
    abilities:[
      {name:"Bloom Burst", kind:"damage", power:30, maxCharges:4},
      {name:"Verdant Pulse", kind:"heal", amount:32, maxCharges:3},
      {name:"Spore Storm", kind:"damage", power:28, maxCharges:4, element:"Storm"}
    ]
  },

  // Storm (2)
  {
    id:"thundraptor",
    name:"Thundraptor",
    emoji:"‚ö°",
    element:"Storm",
    baseHP:104,
    baseAtk:30,
    baseDef:20,
    baseSpd:28,
    abilities:[
      {name:"Thunder Claw", kind:"damage", power:33, maxCharges:4},
      {name:"Sky Roar", kind:"buffAtk", amount:8, maxCharges:3},
      {name:"Stormflame Wing", kind:"damage", power:31, maxCharges:4, element:"Fire"}
    ]
  },
  {
    id:"cloudcoil",
    name:"Cloudcoil",
    emoji:"‚òÅÔ∏è",
    element:"Storm",
    baseHP:108,
    baseAtk:27,
    baseDef:23,
    baseSpd:24,
    abilities:[
      {name:"Cloud Lash", kind:"damage", power:30, maxCharges:4},
      {name:"Storm Veil", kind:"debuffAtk", amount:8, maxCharges:3},
      {name:"Rain Shot", kind:"damage", power:28, maxCharges:4, element:"Water"}
    ]
  },

  // Stone (2)
  {
    id:"slabtoise",
    name:"Slabtoise",
    emoji:"üê¢",
    element:"Stone",
    baseHP:125,
    baseAtk:27,
    baseDef:28,
    baseSpd:14,
    abilities:[
      {name:"Slab Crush", kind:"damage", power:32, maxCharges:4},
      {name:"Granite Shell", kind:"buffDef", amount:10, maxCharges:3},
      {name:"Tremor Pulse", kind:"damage", power:30, maxCharges:4, element:"Storm"}
    ]
  },
  {
    id:"gritclaw",
    name:"Gritclaw",
    emoji:"ü¶¥",
    element:"Stone",
    baseHP:116,
    baseAtk:29,
    baseDef:24,
    baseSpd:18,
    abilities:[
      {name:"Rubble Rend", kind:"damage", power:31, maxCharges:4},
      {name:"Stone Howl", kind:"buffAtk", amount:8, maxCharges:3},
      {name:"Earthen Spike", kind:"damage", power:29, maxCharges:4, element:"Nature"}
    ]
  },

  // =========================
  // LEGENDARY TIER (10)
  // =========================

  // Fire (2)
  {
    id:"infernotitan",
    name:"Infernotitan",
    emoji:"üåã",
    element:"Fire",
    baseHP:138,
    baseAtk:38,
    baseDef:28,
    baseSpd:26,
    abilities:[
      {name:"Titan Blaze", kind:"damage", power:40, maxCharges:3},
      {name:"Worldfire Aura", kind:"buffAtk", amount:10, maxCharges:2},
      {name:"Molten Meteor", kind:"damage", power:38, maxCharges:3, element:"Stone"}
    ]
  },
  {
    id:"phoenixflare",
    name:"Phoenixflare",
    emoji:"üî•",
    element:"Fire",
    baseHP:130,
    baseAtk:36,
    baseDef:26,
    baseSpd:30,
    abilities:[
      {name:"Phoenix Dive", kind:"damage", power:38, maxCharges:3},
      {name:"Rebirth Flame", kind:"heal", amount:40, maxCharges:2},
      {name:"Solar Feathers", kind:"damage", power:36, maxCharges:3, element:"Storm"}
    ]
  },

  // Water (2)
  {
    id:"leviadrake",
    name:"Leviadrake",
    emoji:"üêâ",
    element:"Water",
    baseHP:140,
    baseAtk:37,
    baseDef:30,
    baseSpd:24,
    abilities:[
      {name:"Leviathan Crush", kind:"damage", power:40, maxCharges:3},
      {name:"Abyssal Shield", kind:"buffDef", amount:11, maxCharges:2},
      {name:"Tidal Roar", kind:"damage", power:38, maxCharges:3, element:"Nature"}
    ]
  },
  {
    id:"maelstromwyrm",
    name:"Maelstromwyrm",
    emoji:"üåä",
    element:"Water",
    baseHP:132,
    baseAtk:36,
    baseDef:28,
    baseSpd:28,
    abilities:[
      {name:"Maelstrom Coil", kind:"damage", power:38, maxCharges:3},
      {name:"Ocean's Grace", kind:"heal", amount:40, maxCharges:2},
      {name:"Storm Spiral", kind:"damage", power:36, maxCharges:3, element:"Storm"}
    ]
  },

  // Nature (2)
  {
    id:"worldroot",
    name:"Worldroot",
    emoji:"ü™¥",
    element:"Nature",
    baseHP:142,
    baseAtk:35,
    baseDef:32,
    baseSpd:22,
    abilities:[
      {name:"Root of Ages", kind:"damage", power:38, maxCharges:3},
      {name:"Gaia's Embrace", kind:"heal", amount:42, maxCharges:2},
      {name:"Stone Bloom", kind:"damage", power:36, maxCharges:3, element:"Stone"}
    ]
  },
  {
    id:"sylphqueen",
    name:"Sylphqueen",
    emoji:"üëë",
    element:"Nature",
    baseHP:130,
    baseAtk:34,
    baseDef:28,
    baseSpd:30,
    abilities:[
      {name:"Sylph Ray", kind:"damage", power:36, maxCharges:3},
      {name:"Royal Bloom", kind:"buffAtk", amount:9, maxCharges:2},
      {name:"Petal Gale", kind:"damage", power:38, maxCharges:3, element:"Storm"}
    ]
  },

  // Storm (2)
  {
    id:"skytyrant",
    name:"Skytyrant",
    emoji:"üå™Ô∏è",
    element:"Storm",
    baseHP:134,
    baseAtk:37,
    baseDef:27,
    baseSpd:32,
    abilities:[
      {name:"Tyrant Bolt", kind:"damage", power:40, maxCharges:3},
      {name:"Storm Dominion", kind:"buffSpd", amount:10, maxCharges:2},
      {name:"Roaring Flame", kind:"damage", power:38, maxCharges:3, element:"Fire"}
    ]
  },
  {
    id:"tempestlion",
    name:"Tempestlion",
    emoji:"ü¶Å",
    element:"Storm",
    baseHP:136,
    baseAtk:38,
    baseDef:29,
    baseSpd:30,
    abilities:[
      {name:"Tempest Fang", kind:"damage", power:39, maxCharges:3},
      {name:"Thunder Roar", kind:"debuffDef", amount:10, maxCharges:2},
      {name:"Rainclaw Rake", kind:"damage", power:37, maxCharges:3, element:"Water"}
    ]
  },

  // Stone (2)
  {
    id:"colossogolem",
    name:"Colossogolem",
    emoji:"üèîÔ∏è",
    element:"Stone",
    baseHP:150,
    baseAtk:36,
    baseDef:34,
    baseSpd:22,
    abilities:[
      {name:"Colossal Slam", kind:"damage", power:40, maxCharges:3},
      {name:"Mountain Core", kind:"buffDef", amount:12, maxCharges:2},
      {name:"Falling Star", kind:"damage", power:38, maxCharges:3, element:"Fire"}
    ]
  },
  {
    id:"aurorite",
    name:"Aurorite",
    emoji:"üíé",
    element:"Stone",
    baseHP:140,
    baseAtk:35,
    baseDef:32,
    baseSpd:24,
    abilities:[
      {name:"Aurora Shatter", kind:"damage", power:38, maxCharges:3},
      {name:"Crystal Radiance", kind:"buffAtk", amount:10, maxCharges:2},
      {name:"Prism Pulse", kind:"damage", power:36, maxCharges:3, element:"Storm"}
    ]
  },

  // =========================
  // MYTHIC TIER (10)
  // =========================

  // Fire (2)
  {
    id:"starflare",
    name:"Starflare",
    emoji:"üå†",
    element:"Fire",
    baseHP:142,
    baseAtk:40,
    baseDef:30,
    baseSpd:32,
    abilities:[
      {name:"Meteor Rush", kind:"damage", power:42, maxCharges:3},
      {name:"Solar Mantle", kind:"buffDef", amount:11, maxCharges:2},
      {name:"Corona Spear", kind:"damage", power:40, maxCharges:3, element:"Storm"}
    ]
  },
  {
    id:"pyrorex",
    name:"Pyrorex",
    emoji:"üêâ",
    element:"Fire",
    baseHP:148,
    baseAtk:42,
    baseDef:29,
    baseSpd:30,
    abilities:[
      {name:"Royal Flame", kind:"damage", power:44, maxCharges:3},
      {name:"Crown of Cinders", kind:"buffAtk", amount:11, maxCharges:2},
      {name:"Magma Roar", kind:"damage", power:41, maxCharges:3, element:"Stone"}
    ]
  },

  // Water (2)
  {
    id:"tidalseraph",
    name:"Tidalseraph",
    emoji:"üî±",
    element:"Water",
    baseHP:146,
    baseAtk:38,
    baseDef:32,
    baseSpd:30,
    abilities:[
      {name:"Seraph Wave", kind:"damage", power:42, maxCharges:3},
      {name:"Ocean Blessing", kind:"heal", amount:44, maxCharges:2},
      {name:"Halo Torrent", kind:"damage", power:40, maxCharges:3, element:"Storm"}
    ]
  },
  {
    id:"rimeserpent",
    name:"Rimeserpent",
    emoji:"üêç",
    element:"Water",
    baseHP:140,
    baseAtk:39,
    baseDef:31,
    baseSpd:32,
    abilities:[
      {name:"Rime Coil", kind:"damage", power:41, maxCharges:3},
      {name:"Glacial Scales", kind:"buffDef", amount:11, maxCharges:2},
      {name:"Crystal Fang", kind:"damage", power:39, maxCharges:3, element:"Stone"}
    ]
  },

  // Nature (2)
  {
    id:"heartgrove",
    name:"Heartgrove",
    emoji:"üå≤",
    element:"Nature",
    baseHP:150,
    baseAtk:37,
    baseDef:34,
    baseSpd:26,
    abilities:[
      {name:"Heartwood Crush", kind:"damage", power:41, maxCharges:3},
      {name:"Forest‚Äôs Oath", kind:"heal", amount:44, maxCharges:2},
      {name:"Blooming Tide", kind:"damage", power:39, maxCharges:3, element:"Water"}
    ]
  },
  {
    id:"thornempress",
    name:"Thornempress",
    emoji:"üåπ",
    element:"Nature",
    baseHP:144,
    baseAtk:40,
    baseDef:32,
    baseSpd:30,
    abilities:[
      {name:"Regal Thorn", kind:"damage", power:42, maxCharges:3},
      {name:"Briar Court", kind:"buffAtk", amount:10, maxCharges:2},
      {name:"Seed Storm", kind:"damage", power:40, maxCharges:3, element:"Storm"}
    ]
  },

  // Storm (2)
  {
    id:"voltseraph",
    name:"Voltseraph",
    emoji:"‚ö°",
    element:"Storm",
    baseHP:140,
    baseAtk:41,
    baseDef:30,
    baseSpd:34,
    abilities:[
      {name:"Judgment Bolt", kind:"damage", power:43, maxCharges:3},
      {name:"Halo of Speed", kind:"buffSpd", amount:11, maxCharges:2},
      {name:"Radiant Flame", kind:"damage", power:41, maxCharges:3, element:"Fire"}
    ]
  },
  {
    id:"stormchimera",
    name:"Stormchimera",
    emoji:"üåÄ",
    element:"Storm",
    baseHP:138,
    baseAtk:42,
    baseDef:29,
    baseSpd:33,
    abilities:[
      {name:"Cyclone Maw", kind:"damage", power:43, maxCharges:3},
      {name:"Tempest Shroud", kind:"debuffDef", amount:11, maxCharges:2},
      {name:"Tidal Rake", kind:"damage", power:41, maxCharges:3, element:"Water"}
    ]
  },

  // Stone (2)
  {
    id:"obsidigon",
    name:"Obsidigon",
    emoji:"üóø",
    element:"Stone",
    baseHP:156,
    baseAtk:38,
    baseDef:36,
    baseSpd:24,
    abilities:[
      {name:"Obsidian Crash", kind:"damage", power:42, maxCharges:3},
      {name:"Blackglass Bulwark", kind:"buffDef", amount:12, maxCharges:2},
      {name:"Seismic Roar", kind:"damage", power:40, maxCharges:3, element:"Fire"}
    ]
  },
  {
    id:"runebastion",
    name:"Runebastion",
    emoji:"üß±",
    element:"Stone",
    baseHP:152,
    baseAtk:39,
    baseDef:35,
    baseSpd:26,
    abilities:[
      {name:"Runequake", kind:"damage", power:41, maxCharges:3},
      {name:"Sigil Fortress", kind:"buffAtk", amount:11, maxCharges:2},
      {name:"Verdant Hammer", kind:"damage", power:39, maxCharges:3, element:"Nature"}
    ]
  },

  // =========================
  // COSMIC LEGENDARY TIER (5)
  // (Ultra-top, most powerful)
  // =========================

  // Fire-aligned cosmic
  {
    id:"solsticeon",
    name:"Solsticeon",
    emoji:"üåû",
    element:"Fire",
    baseHP:162,
    baseAtk:45,
    baseDef:36,
    baseSpd:34,
    abilities:[
      {name:"Solar Flareburst", kind:"damage", power:46, maxCharges:3, element:"Fire"},
      {name:"Zenith Thunder", kind:"damage", power:44, maxCharges:3, element:"Storm"},
      {name:"Blazing Tides", kind:"damage", power:42, maxCharges:3, element:"Water"}
    ]
  },

  // Water-aligned cosmic
  {
    id:"abyssoracle",
    name:"Abyssoracle",
    emoji:"üîÆ",
    element:"Water",
    baseHP:164,
    baseAtk:44,
    baseDef:38,
    baseSpd:32,
    abilities:[
      {name:"Oracle Wave", kind:"damage", power:45, maxCharges:3, element:"Water"},
      {name:"Riptide Fangs", kind:"damage", power:43, maxCharges:3, element:"Nature"},
      {name:"Tempest Gaze", kind:"damage", power:41, maxCharges:3, element:"Storm"}
    ]
  },

  // Nature-aligned cosmic
  {
    id:"verdantwyrm",
    name:"Verdantwyrm",
    emoji:"üê≤",
    element:"Nature",
    baseHP:168,
    baseAtk:44,
    baseDef:37,
    baseSpd:33,
    abilities:[
      {name:"Primeval Crush", kind:"damage", power:45, maxCharges:3, element:"Nature"},
      {name:"Emerald Quake", kind:"damage", power:43, maxCharges:3, element:"Stone"},
      {name:"Solar Bloom", kind:"damage", power:41, maxCharges:3, element:"Fire"}
    ]
  },

  // Storm-aligned cosmic
  {
    id:"tempestarchon",
    name:"Tempestarchon",
    emoji:"‚õàÔ∏è",
    element:"Storm",
    baseHP:158,
    baseAtk:46,
    baseDef:36,
    baseSpd:36,
    abilities:[
      {name:"Archon Bolt", kind:"damage", power:46, maxCharges:3, element:"Storm"},
      {name:"Starfire Wing", kind:"damage", power:44, maxCharges:3, element:"Fire"},
      {name:"Cyclone Deluge", kind:"damage", power:42, maxCharges:3, element:"Water"}
    ]
  },

  // Stone-aligned cosmic
  {
    id:"monolithrex",
    name:"Monolithrex",
    emoji:"üóª",
    element:"Stone",
    baseHP:172,
    baseAtk:45,
    baseDef:40,
    baseSpd:32,
    abilities:[
      {name:"Monolith Crash", kind:"damage", power:46, maxCharges:3, element:"Stone"},
      {name:"Verdant Rupture", kind:"damage", power:44, maxCharges:3, element:"Nature"},
      {name:"Ocean Impact", kind:"damage", power:42, maxCharges:3, element:"Water"}
    ]
  },
    {
    id:"flarearchon",
    name:"Flarearchon",
    emoji:"üî•",
    element:"Fire",
    baseHP:176,
    baseAtk:47,
    baseDef:41,
    baseSpd:35,
    abilities:[
      {name:"Archon Blaze", kind:"damage", power:47, maxCharges:3},
      {name:"Solar Aegis", kind:"buffDef", amount:12, maxCharges:2},
      {name:"Stormbrand Slash", kind:"damage", power:45, maxCharges:3, element:"Storm"}
    ]
  },
  {
    id:"emberempyr",
    name:"Emberempyr",
    emoji:"üêâ",
    element:"Fire",
    baseHP:178,
    baseAtk:48,
    baseDef:41,
    baseSpd:34,
    abilities:[
      {name:"Empyr Flame", kind:"damage", power:47, maxCharges:3},
      {name:"Cinder Coronation", kind:"buffAtk", amount:12, maxCharges:2},
      {name:"Magma Javelin", kind:"damage", power:45, maxCharges:3, element:"Stone"}
    ]
  },

  // Water (2)
  {
    id:"abyssregent",
    name:"Abyssregent",
    emoji:"üåä",
    element:"Water",
    baseHP:180,
    baseAtk:46,
    baseDef:43,
    baseSpd:33,
    abilities:[
      {name:"Regent Tide", kind:"damage", power:47, maxCharges:3},
      {name:"Crown of Depths", kind:"heal", amount:46, maxCharges:2},
      {name:"Trench Lightning", kind:"damage", power:45, maxCharges:3, element:"Storm"}
    ]
  },
  {
    id:"tideascendant",
    name:"Tideascendant",
    emoji:"üê¨",
    element:"Water",
    baseHP:178,
    baseAtk:47,
    baseDef:42,
    baseSpd:34,
    abilities:[
      {name:"Ascendant Wave", kind:"damage", power:47, maxCharges:3},
      {name:"Tidal Bulwark", kind:"buffDef", amount:12, maxCharges:2},
      {name:"Riptide Bloom", kind:"damage", power:45, maxCharges:3, element:"Nature"}
    ]
  },

  // Nature (2)
  {
    id:"groveeternal",
    name:"Groveeternal",
    emoji:"üå≤",
    element:"Nature",
    baseHP:179,
    baseAtk:46,
    baseDef:42,
    baseSpd:33,
    abilities:[
      {name:"Eternal Branch", kind:"damage", power:47, maxCharges:3},
      {name:"Grove's Embrace", kind:"heal", amount:46, maxCharges:2},
      {name:"Rooted Quake", kind:"damage", power:45, maxCharges:3, element:"Stone"}
    ]
  },
  {
    id:"thornoracle2",
    name:"Thornoracle",
    emoji:"üå∫",
    element:"Nature",
    baseHP:176,
    baseAtk:47,
    baseDef:41,
    baseSpd:35,
    abilities:[
      {name:"Oracle Thorn", kind:"damage", power:47, maxCharges:3},
      {name:"Fate of Petals", kind:"buffAtk", amount:12, maxCharges:2},
      {name:"Stormseed Volley", kind:"damage", power:45, maxCharges:3, element:"Storm"}
    ]
  },

  // Storm (2)
  {
    id:"skyimperion",
    name:"Skyimperion",
    emoji:"üå™Ô∏è",
    element:"Storm",
    baseHP:174,
    baseAtk:47,
    baseDef:41,
    baseSpd:35,
    abilities:[
      {name:"Imperion Bolt", kind:"damage", power:47, maxCharges:3},
      {name:"Sky Dominion", kind:"buffSpd", amount:12, maxCharges:2},
      {name:"Sunfire Talon", kind:"damage", power:45, maxCharges:3, element:"Fire"}
    ]
  },
  {
    id:"voltparagon",
    name:"Voltparagon",
    emoji:"‚ö°",
    element:"Storm",
    baseHP:176,
    baseAtk:48,
    baseDef:41,
    baseSpd:34,
    abilities:[
      {name:"Paragon Surge", kind:"damage", power:47, maxCharges:3},
      {name:"Static Halo", kind:"debuffAtk", amount:12, maxCharges:2},
      {name:"Raincutter Wing", kind:"damage", power:45, maxCharges:3, element:"Water"}
    ]
  },

  // Stone (2)
  {
    id:"runecitadel",
    name:"Runecitadel",
    emoji:"üß±",
    element:"Stone",
    baseHP:182,
    baseAtk:46,
    baseDef:43,
    baseSpd:33,
    abilities:[
      {name:"Citadel Crush", kind:"damage", power:47, maxCharges:3},
      {name:"Rune Bastion", kind:"buffDef", amount:12, maxCharges:2},
      {name:"Crystal Storm", kind:"damage", power:45, maxCharges:3, element:"Storm"}
    ]
  },
  {
    id:"tectonlord",
    name:"Tectonlord",
    emoji:"üóª",
    element:"Stone",
    baseHP:180,
    baseAtk:47,
    baseDef:43,
    baseSpd:33,
    abilities:[
      {name:"Tectonic Break", kind:"damage", power:47, maxCharges:3},
      {name:"Fault Shield", kind:"buffDef", amount:12, maxCharges:2},
      {name:"Lava Spire", kind:"damage", power:45, maxCharges:3, element:"Fire"}
    ]
  },

  // =========================
  // ASTRAL TIER (10)
  // =========================

  // Fire (2)
  {
    id:"starsovereign",
    name:"Starsovereign",
    emoji:"üå†",
    element:"Fire",
    baseHP:182,
    baseAtk:49,
    baseDef:42,
    baseSpd:35,
    abilities:[
      {name:"Sovereign Flare", kind:"damage", power:49, maxCharges:3},
      {name:"Astral Guard", kind:"buffDef", amount:12, maxCharges:2},
      {name:"Comet Talon", kind:"damage", power:47, maxCharges:3, element:"Storm"}
    ]
  },
  {
    id:"cinderarchduke",
    name:"Cinderarchduke",
    emoji:"üî•",
    element:"Fire",
    baseHP:184,
    baseAtk:49,
    baseDef:43,
    baseSpd:34,
    abilities:[
      {name:"Archduke Brand", kind:"damage", power:49, maxCharges:3},
      {name:"Ember Edict", kind:"buffAtk", amount:12, maxCharges:2},
      {name:"Solar Lance", kind:"damage", power:47, maxCharges:3, element:"Nature"}
    ]
  },

  // Water (2)
  {
    id:"maelstromcrown",
    name:"Maelstromcrown",
    emoji:"üåä",
    element:"Water",
    baseHP:186,
    baseAtk:48,
    baseDef:44,
    baseSpd:34,
    abilities:[
      {name:"Crown Surge", kind:"damage", power:49, maxCharges:3},
      {name:"Deep Renewal", kind:"heal", amount:48, maxCharges:2},
      {name:"Starfall Spray", kind:"damage", power:47, maxCharges:3, element:"Storm"}
    ]
  },
  {
    id:"abyssseraphim",
    name:"Abyssseraphim",
    emoji:"üî±",
    element:"Water",
    baseHP:184,
    baseAtk:49,
    baseDef:43,
    baseSpd:35,
    abilities:[
      {name:"Seraphic Tide", kind:"damage", power:49, maxCharges:3},
      {name:"Tidal Benediction", kind:"heal", amount:48, maxCharges:2},
      {name:"Halo Current", kind:"damage", power:47, maxCharges:3, element:"Nature"}
    ]
  },

  // Nature (2)
  {
    id:"lifeblossom",
    name:"Lifeblossom",
    emoji:"üå∏",
    element:"Nature",
    baseHP:185,
    baseAtk:48,
    baseDef:44,
    baseSpd:34,
    abilities:[
      {name:"Astral Bloom", kind:"damage", power:49, maxCharges:3},
      {name:"Pulse of Spring", kind:"heal", amount:48, maxCharges:2},
      {name:"Starroot Lance", kind:"damage", power:47, maxCharges:3, element:"Stone"}
    ]
  },
  {
    id:"verdantcrown2",
    name:"Verdantcrown",
    emoji:"ü™¥",
    element:"Nature",
    baseHP:182,
    baseAtk:49,
    baseDef:43,
    baseSpd:35,
    abilities:[
      {name:"Verdant Decree", kind:"damage", power:49, maxCharges:3},
      {name:"Crown of Vines", kind:"buffAtk", amount:12, maxCharges:2},
      {name:"Meteor Seed", kind:"damage", power:47, maxCharges:3, element:"Fire"}
    ]
  },

  // Storm (2)
  {
    id:"thunderregent",
    name:"Thunderregent",
    emoji:"‚ö°",
    element:"Storm",
    baseHP:180,
    baseAtk:49,
    baseDef:42,
    baseSpd:36,
    abilities:[
      {name:"Regent Thunder", kind:"damage", power:49, maxCharges:3},
      {name:"Sky Mandate", kind:"buffSpd", amount:12, maxCharges:2},
      {name:"Ion Gale", kind:"damage", power:47, maxCharges:3, element:"Water"}
    ]
  },
  {
    id:"cycloneemperor",
    name:"Cycloneemperor",
    emoji:"üåÄ",
    element:"Storm",
    baseHP:182,
    baseAtk:50,
    baseDef:42,
    baseSpd:35,
    abilities:[
      {name:"Emperor Cyclone", kind:"damage", power:49, maxCharges:3},
      {name:"Tempest Decree", kind:"debuffDef", amount:12, maxCharges:2},
      {name:"Sunstorm Wing", kind:"damage", power:47, maxCharges:3, element:"Fire"}
    ]
  },

  // Stone (2)
  {
    id:"graniteoracle",
    name:"Graniteoracle",
    emoji:"ü™®",
    element:"Stone",
    baseHP:188,
    baseAtk:48,
    baseDef:44,
    baseSpd:34,
    abilities:[
      {name:"Oracle Slam", kind:"damage", power:49, maxCharges:3},
      {name:"Stone Augury", kind:"buffDef", amount:13, maxCharges:2},
      {name:"Celestial Pebble", kind:"damage", power:47, maxCharges:3, element:"Storm"}
    ]
  },
  {
    id:"monolithprime",
    name:"Monolithprime",
    emoji:"üóø",
    element:"Stone",
    baseHP:186,
    baseAtk:49,
    baseDef:44,
    baseSpd:34,
    abilities:[
      {name:"Prime Monolith", kind:"damage", power:49, maxCharges:3},
      {name:"Astral Core", kind:"buffDef", amount:13, maxCharges:2},
      {name:"Nebula Impact", kind:"damage", power:47, maxCharges:3, element:"Fire"}
    ]
  },

  // =========================
  // ETERNAL TIER (10)
  // =========================

  // Fire (2)
  {
    id:"sunimmortal",
    name:"Sunimmortal",
    emoji:"üåû",
    element:"Fire",
    baseHP:188,
    baseAtk:51,
    baseDef:43,
    baseSpd:36,
    abilities:[
      {name:"Immortal Flare", kind:"damage", power:51, maxCharges:3},
      {name:"Crown of Dawn", kind:"buffAtk", amount:13, maxCharges:2},
      {name:"Solar Cataclysm", kind:"damage", power:49, maxCharges:3, element:"Storm"}
    ]
  },
  {
    id:"infernoeternal",
    name:"Infernoeternal",
    emoji:"üî•",
    element:"Fire",
    baseHP:190,
    baseAtk:51,
    baseDef:44,
    baseSpd:35,
    abilities:[
      {name:"Eternal Inferno", kind:"damage", power:51, maxCharges:3},
      {name:"Blazing Pact", kind:"buffDef", amount:13, maxCharges:2},
      {name:"Obsidian Flame", kind:"damage", power:49, maxCharges:3, element:"Stone"}
    ]
  },

  // Water (2)
  {
    id:"tidesovereign",
    name:"Tidesovereign",
    emoji:"üåä",
    element:"Water",
    baseHP:192,
    baseAtk:50,
    baseDef:45,
    baseSpd:35,
    abilities:[
      {name:"Sovereign Wave", kind:"damage", power:51, maxCharges:3},
      {name:"Eternal Current", kind:"heal", amount:50, maxCharges:2},
      {name:"Thundercrest Tide", kind:"damage", power:49, maxCharges:3, element:"Storm"}
    ]
  },
  {
    id:"abyssimmortal",
    name:"Abyssimmortal",
    emoji:"üîÆ",
    element:"Water",
    baseHP:190,
    baseAtk:51,
    baseDef:44,
    baseSpd:36,
    abilities:[
      {name:"Immortal Deep", kind:"damage", power:51, maxCharges:3},
      {name:"Eternal Flood", kind:"heal", amount:50, maxCharges:2},
      {name:"Seafire Spiral", kind:"damage", power:49, maxCharges:3, element:"Fire"}
    ]
  },

  // Nature (2)
  {
    id:"worldwarden2",
    name:"Worldwarden",
    emoji:"üå≥",
    element:"Nature",
    baseHP:191,
    baseAtk:50,
    baseDef:45,
    baseSpd:35,
    abilities:[
      {name:"Worldguard Crush", kind:"damage", power:51, maxCharges:3},
      {name:"Oath of Roots", kind:"heal", amount:50, maxCharges:2},
      {name:"Eternal Spore", kind:"damage", power:49, maxCharges:3, element:"Storm"}
    ]
  },
  {
    id:"seedeternal",
    name:"Seedeternal",
    emoji:"üå±",
    element:"Nature",
    baseHP:188,
    baseAtk:51,
    baseDef:44,
    baseSpd:36,
    abilities:[
      {name:"Eternal Seed", kind:"damage", power:51, maxCharges:3},
      {name:"Timeless Growth", kind:"buffAtk", amount:13, maxCharges:2},
      {name:"Stonebloom Crush", kind:"damage", power:49, maxCharges:3, element:"Stone"}
    ]
  },

  // Storm (2)
  {
    id:"stormeternal",
    name:"Stormeternal",
    emoji:"‚õàÔ∏è",
    element:"Storm",
    baseHP:186,
    baseAtk:51,
    baseDef:43,
    baseSpd:37,
    abilities:[
      {name:"Eternal Storm", kind:"damage", power:51, maxCharges:3},
      {name:"Skyline Halo", kind:"buffSpd", amount:13, maxCharges:2},
      {name:"Radiant Tempest", kind:"damage", power:49, maxCharges:3, element:"Fire"}
    ]
  },
  {
    id:"skyseraph",
    name:"Skyseraph",
    emoji:"‚òÅÔ∏è",
    element:"Storm",
    baseHP:188,
    baseAtk:52,
    baseDef:43,
    baseSpd:36,
    abilities:[
      {name:"Seraphic Gale", kind:"damage", power:51, maxCharges:3},
      {name:"Halo Draft", kind:"debuffAtk", amount:13, maxCharges:2},
      {name:"Aerial Deluge", kind:"damage", power:49, maxCharges:3, element:"Water"}
    ]
  },

  // Stone (2)
  {
    id:"eartheternal",
    name:"Eartheternal",
    emoji:"ü™®",
    element:"Stone",
    baseHP:194,
    baseAtk:50,
    baseDef:45,
    baseSpd:35,
    abilities:[
      {name:"Eternal Slam", kind:"damage", power:51, maxCharges:3},
      {name:"Enduring Crust", kind:"buffDef", amount:13, maxCharges:2},
      {name:"Stormrift Boulder", kind:"damage", power:49, maxCharges:3, element:"Storm"}
    ]
  },
  {
    id:"runemountain",
    name:"Runemountain",
    emoji:"‚õ∞Ô∏è",
    element:"Stone",
    baseHP:192,
    baseAtk:51,
    baseDef:45,
    baseSpd:35,
    abilities:[
      {name:"Runequake Peak", kind:"damage", power:51, maxCharges:3},
      {name:"Sigil Summit", kind:"buffDef", amount:13, maxCharges:2},
      {name:"Sunshard Crash", kind:"damage", power:49, maxCharges:3, element:"Fire"}
    ]
  },

  // =========================
  // APOCALYPTIC TIER (10)
  // =========================

  // Fire (2)
  {
    id:"doombringerflare",
    name:"Doombringerflare",
    emoji:"üî•",
    element:"Fire",
    baseHP:194,
    baseAtk:53,
    baseDef:44,
    baseSpd:37,
    abilities:[
      {name:"Doomflame Rush", kind:"damage", power:53, maxCharges:3},
      {name:"Last Ember", kind:"buffAtk", amount:14, maxCharges:2},
      {name:"Skyfall Inferno", kind:"damage", power:51, maxCharges:3, element:"Storm"}
    ]
  },
  {
    id:"cinderapocalypse",
    name:"Cinderapocalypse",
    emoji:"üî•",
    element:"Fire",
    baseHP:196,
    baseAtk:53,
    baseDef:45,
    baseSpd:36,
    abilities:[
      {name:"Apocalypse Brand", kind:"damage", power:53, maxCharges:3},
      {name:"Cinder Aftermath", kind:"buffDef", amount:14, maxCharges:2},
      {name:"Magma Eclipse", kind:"damage", power:51, maxCharges:3, element:"Stone"}
    ]
  },

  // Water (2)
  {
    id:"delugereckoner",
    name:"Delugereckoner",
    emoji:"üåä",
    element:"Water",
    baseHP:198,
    baseAtk:52,
    baseDef:46,
    baseSpd:36,
    abilities:[
      {name:"Reckoning Wave", kind:"damage", power:53, maxCharges:3},
      {name:"Tidal Reckoning", kind:"heal", amount:52, maxCharges:2},
      {name:"Stormbreak Surge", kind:"damage", power:51, maxCharges:3, element:"Storm"}
    ]
  },
  {
    id:"tsunamiimperator",
    name:"Tsunamiimperator",
    emoji:"üêã",
    element:"Water",
    baseHP:196,
    baseAtk:53,
    baseDef:45,
    baseSpd:37,
    abilities:[
      {name:"Imperator Tsunami", kind:"damage", power:53, maxCharges:3},
      {name:"Abyss Verdict", kind:"heal", amount:52, maxCharges:2},
      {name:"Sunken Meteor", kind:"damage", power:51, maxCharges:3, element:"Fire"}
    ]
  },

  // Nature (2)
  {
    id:"briarcataclysm",
    name:"Briarcataclysm",
    emoji:"üåø",
    element:"Nature",
    baseHP:197,
    baseAtk:52,
    baseDef:46,
    baseSpd:36,
    abilities:[
      {name:"Cataclysm Thorns", kind:"damage", power:53, maxCharges:3},
      {name:"Last Bloom", kind:"heal", amount:52, maxCharges:2},
      {name:"Stonevine Rupture", kind:"damage", power:51, maxCharges:3, element:"Stone"}
    ]
  },
  {
    id:"thornapocalypse2",
    name:"Thornapocalypse",
    emoji:"üåπ",
    element:"Nature",
    baseHP:194,
    baseAtk:53,
    baseDef:45,
    baseSpd:37,
    abilities:[
      {name:"Apocalypse Briar", kind:"damage", power:53, maxCharges:3},
      {name:"Crown of Thorns", kind:"buffAtk", amount:14, maxCharges:2},
      {name:"Seedfall Storm", kind:"damage", power:51, maxCharges:3, element:"Storm"}
    ]
  },

  // Storm (2)
  {
    id:"thunderarmageddon",
    name:"Thunderarmageddon",
    emoji:"‚ö°",
    element:"Storm",
    baseHP:192,
    baseAtk:53,
    baseDef:44,
    baseSpd:38,
    abilities:[
      {name:"Armageddon Bolt", kind:"damage", power:53, maxCharges:3},
      {name:"Sky Ruin", kind:"buffSpd", amount:14, maxCharges:2},
      {name:"Inferno Tempest", kind:"damage", power:51, maxCharges:3, element:"Fire"}
    ]
  },
  {
    id:"typhooncataclysm",
    name:"Typhooncataclysm",
    emoji:"üå™Ô∏è",
    element:"Storm",
    baseHP:194,
    baseAtk:54,
    baseDef:44,
    baseSpd:37,
    abilities:[
      {name:"Cataclysm Gale", kind:"damage", power:53, maxCharges:3},
      {name:"Eye of Ending", kind:"debuffDef", amount:14, maxCharges:2},
      {name:"Deluge Spiral", kind:"damage", power:51, maxCharges:3, element:"Water"}
    ]
  },

  // Stone (2)
  {
    id:"faultapex",
    name:"Faultapex",
    emoji:"üóª",
    element:"Stone",
    baseHP:200,
    baseAtk:52,
    baseDef:46,
    baseSpd:36,
    abilities:[
      {name:"Apex Fracture", kind:"damage", power:53, maxCharges:3},
      {name:"Worldfissure Guard", kind:"buffDef", amount:14, maxCharges:2},
      {name:"Stormboulder Crash", kind:"damage", power:51, maxCharges:3, element:"Storm"}
    ]
  },
  {
    id:"quakecataclysm",
    name:"Quakecataclysm",
    emoji:"üß±",
    element:"Stone",
    baseHP:198,
    baseAtk:53,
    baseDef:46,
    baseSpd:36,
    abilities:[
      {name:"Cataclysm Quake", kind:"damage", power:53, maxCharges:3},
      {name:"Ruinous Rampart", kind:"buffDef", amount:14, maxCharges:2},
      {name:"Solar Rubble", kind:"damage", power:51, maxCharges:3, element:"Fire"}
    ]
  },

  // =========================
  // OMEGA TIER (10)
  // =========================

  // Fire (2)
  {
    id:"omegaember",
    name:"Omegaember",
    emoji:"üî•",
    element:"Fire",
    baseHP:200,
    baseAtk:55,
    baseDef:46,
    baseSpd:38,
    abilities:[
      {name:"Omega Flame", kind:"damage", power:55, maxCharges:3},
      {name:"Final Spark", kind:"buffAtk", amount:14, maxCharges:2},
      {name:"Endstorm Brand", kind:"damage", power:53, maxCharges:3, element:"Storm"}
    ]
  },
  {
    id:"supernovarex",
    name:"Supernovarex",
    emoji:"üåå",
    element:"Fire",
    baseHP:202,
    baseAtk:55,
    baseDef:47,
    baseSpd:37,
    abilities:[
      {name:"Supernova Roar", kind:"damage", power:55, maxCharges:3},
      {name:"Cinder Cosmos", kind:"buffDef", amount:14, maxCharges:2},
      {name:"Meteorburst Claw", kind:"damage", power:53, maxCharges:3, element:"Nature"}
    ]
  },

  // Water (2)
  {
    id:"omegaabyss",
    name:"Omegaabyss",
    emoji:"üåä",
    element:"Water",
    baseHP:204,
    baseAtk:54,
    baseDef:48,
    baseSpd:37,
    abilities:[
      {name:"Omega Depth", kind:"damage", power:55, maxCharges:3},
      {name:"Last Tide", kind:"heal", amount:54, maxCharges:2},
      {name:"Tempest Maelstrom", kind:"damage", power:53, maxCharges:3, element:"Storm"}
    ]
  },
  {
    id:"finaltide",
    name:"Finaltide",
    emoji:"üî±",
    element:"Water",
    baseHP:202,
    baseAtk:55,
    baseDef:47,
    baseSpd:38,
    abilities:[
      {name:"Terminus Wave", kind:"damage", power:55, maxCharges:3},
      {name:"Abyssal Atonement", kind:"heal", amount:54, maxCharges:2},
      {name:"Starshatter Surge", kind:"damage", power:53, maxCharges:3, element:"Fire"}
    ]
  },

  // Nature (2)
  {
    id:"omegagrove",
    name:"Omegagrove",
    emoji:"üå≤",
    element:"Nature",
    baseHP:215,
    baseAtk:54,
    baseDef:48,
    baseSpd:37,
    abilities:[
      {name:"Omega Canopy", kind:"damage", power:45, maxCharges:5},
      {name:"Last Oath", kind:"heal", amount:150, maxCharges:1},
      {name:"Stonefinal Bloom", kind:"damage", power:53, maxCharges:3, element:"Stone"}
    ]
  },
  {
    id:"finalbloom",
    name:"Finalbloom",
    emoji:"üå∏",
    element:"Nature",
    baseHP:200,
    baseAtk:55,
    baseDef:47,
    baseSpd:38,
    abilities:[
      {name:"Terminus Blossom", kind:"damage", power:55, maxCharges:4},
      {name:"Closing Petals", kind:"buffAtk", amount:35, maxCharges:2},
      {name:"Thunderseeds", kind:"damage", power:45, maxCharges:6, element:"Storm"}
    ]
  },

  // Storm (2)
  {
    id:"omegatempest",
    name:"Omegatempest",
    emoji:"‚õàÔ∏è",
    element:"Storm",
    baseHP:198,
    baseAtk:55,
    baseDef:46,
    baseSpd:39,
    abilities:[
      {name:"Omega Tempest", kind:"damage", power:55, maxCharges:3},
      {name:"Endless Gust", kind:"buffSpd", amount:14, maxCharges:2},
      {name:"Flare Squall", kind:"damage", power:53, maxCharges:3, element:"Fire"}
    ]
  },
  {
    id:"finalthunder",
    name:"Finalthunder",
    emoji:"‚ö°",
    element:"Storm",
    baseHP:200,
    baseAtk:56,
    baseDef:46,
    baseSpd:38,
    abilities:[
      {name:"Terminal Thunder", kind:"damage", power:85, maxCharges:1},
      {name:"Last Resound", kind:"debuffDef", amount:14, maxCharges:2},
      {name:"Rain of Judgement", kind:"damage", power:53, maxCharges:3, element:"Water"}
    ]
  },

  // Stone (2)
  {
    id:"omegamonolith",
    name:"Omegamonolith",
    emoji:"üóª",
    element:"Stone",
    baseHP:206,
    baseAtk:54,
    baseDef:48,
    baseSpd:37,
    abilities:[
      {name:"Omega Impact", kind:"damage", power:55, maxCharges:3},
      {name:"Final Bulwark", kind:"buffDef", amount:15, maxCharges:2},
      {name:"Stormcore Shatter", kind:"damage", power:53, maxCharges:3, element:"Storm"}
    ]
  },
  {
    id:"finalbastion",
    name:"Finalbastion",
    emoji:"üß±",
    element:"Stone",
    baseHP:240,
    baseAtk:45,
    baseDef:65,
    baseSpd:37,
    abilities:[
      {name:"Bastion Collapse", kind:"damage", power:45, maxCharges:5},
      {name:"Last Fortress", kind:"buffDef", amount:15, maxCharges:2},
      {name:"Starfall Rubble", kind:"damage", power:38, maxCharges:10, element:"Fire"}
    ]
  },
     // =========================
  // INFINITY TIER (10)
  // =========================

  // Fire (2)
  {
    id:"infinityflare",
    name:"Infinityflare",
    emoji:"üî•",
    element:"Fire",
    baseHP:210,
    baseAtk:57,
    baseDef:49,
    baseSpd:39,
    abilities:[
      {name:"Infinite Blaze", kind:"damage", power:56, maxCharges:3},
      {name:"Stellar Mantle", kind:"buffDef", amount:16, maxCharges:2},
      {name:"Thunder Nova", kind:"damage", power:56, maxCharges:3, element:"Storm"}
    ]
  },
  {
    id:"cosmicinferno",
    name:"Cosmicinferno",
    emoji:"üåã",
    element:"Fire",
    baseHP:208,
    baseAtk:57,
    baseDef:49,
    baseSpd:40,
    abilities:[
      {name:"Cosmic Inferno", kind:"damage", power:57, maxCharges:3},
      {name:"Event Horizon Flame", kind:"buffAtk", amount:16, maxCharges:2},
      {name:"Singularity Smash", kind:"damage", power:57, maxCharges:3, element:"Stone"}
    ]
  },

  // Water (2)
  {
    id:"abyssinfinity",
    name:"Abyssinfinity",
    emoji:"üåä",
    element:"Water",
    baseHP:210,
    baseAtk:57,
    baseDef:49,
    baseSpd:39,
    abilities:[
      {name:"Abyssal Infinity", kind:"damage", power:56, maxCharges:3},
      {name:"Endless Current", kind:"heal", amount:56, maxCharges:2},
      {name:"Storm Trench", kind:"damage", power:56, maxCharges:3, element:"Storm"}
    ]
  },
  {
    id:"tidalinfinity",
    name:"Tidalinfinity",
    emoji:"üî±",
    element:"Water",
    baseHP:212,
    baseAtk:57,
    baseDef:49,
    baseSpd:39,
    abilities:[
      {name:"Tidal Infinity", kind:"damage", power:57, maxCharges:3},
      {name:"Depth Guard", kind:"buffDef", amount:16, maxCharges:2},
      {name:"Verdant Surge", kind:"damage", power:57, maxCharges:3, element:"Nature"}
    ]
  },

  // Nature (2)
  {
    id:"infinitygrove",
    name:"Infinitygrove",
    emoji:"üå≤",
    element:"Nature",
    baseHP:209,
    baseAtk:57,
    baseDef:49,
    baseSpd:39,
    abilities:[
      {name:"Infinite Canopy", kind:"damage", power:56, maxCharges:3},
      {name:"Endless Renewal", kind:"heal", amount:56, maxCharges:2},
      {name:"Stonebound Roots", kind:"damage", power:56, maxCharges:3, element:"Stone"}
    ]
  },
  {
    id:"cosmicthorn",
    name:"Cosmicthorn",
    emoji:"üåø",
    element:"Nature",
    baseHP:208,
    baseAtk:57,
    baseDef:49,
    baseSpd:40,
    abilities:[
      {name:"Cosmic Thornlash", kind:"damage", power:57, maxCharges:3},
      {name:"Starseed Growth", kind:"buffAtk", amount:16, maxCharges:2},
      {name:"Stormpetal Burst", kind:"damage", power:57, maxCharges:3, element:"Storm"}
    ]
  },

  // Storm (2)
  {
    id:"infinitystorm",
    name:"Infinitystorm",
    emoji:"‚ö°",
    element:"Storm",
    baseHP:208,
    baseAtk:57,
    baseDef:49,
    baseSpd:40,
    abilities:[
      {name:"Infinite Tempest", kind:"damage", power:56, maxCharges:3},
      {name:"Skyloop Dash", kind:"buffSpd", amount:16, maxCharges:2},
      {name:"Flareburst Squall", kind:"damage", power:56, maxCharges:3, element:"Fire"}
    ]
  },
  {
    id:"cosmicthunder",
    name:"Cosmicthunder",
    emoji:"üå©Ô∏è",
    element:"Storm",
    baseHP:210,
    baseAtk:57,
    baseDef:49,
    baseSpd:39,
    abilities:[
      {name:"Cosmic Thunder", kind:"damage", power:57, maxCharges:3},
      {name:"Void Static", kind:"debuffDef", amount:16, maxCharges:2},
      {name:"Rainsing Bolt", kind:"damage", power:57, maxCharges:3, element:"Water"}
    ]
  },

  // Stone (2)
  {
    id:"infinitymonolith",
    name:"Infinitymonolith",
    emoji:"üóª",
    element:"Stone",
    baseHP:212,
    baseAtk:57,
    baseDef:49,
    baseSpd:39,
    abilities:[
      {name:"Infinite Impact", kind:"damage", power:56, maxCharges:3},
      {name:"Stellar Rampart", kind:"buffDef", amount:16, maxCharges:2},
      {name:"Stormcore Slam", kind:"damage", power:56, maxCharges:3, element:"Storm"}
    ]
  },
  {
    id:"cosmicbastion",
    name:"Cosmicbastion",
    emoji:"üß±",
    element:"Stone",
    baseHP:210,
    baseAtk:57,
    baseDef:49,
    baseSpd:39,
    abilities:[
      {name:"Cosmic Wallcrash", kind:"damage", power:57, maxCharges:3},
      {name:"Event Rampart", kind:"buffAtk", amount:16, maxCharges:2},
      {name:"Solar Rubblefall", kind:"damage", power:57, maxCharges:3, element:"Fire"}
    ]
  },

  // =========================
  // PARADOX TIER (10)
  // =========================

  // Fire (2)
  {
    id:"paradoxflame",
    name:"Paradoxflame",
    emoji:"üî•",
    element:"Fire",
    baseHP:214,
    baseAtk:58,
    baseDef:50,
    baseSpd:40,
    abilities:[
      {name:"Paradox Flame", kind:"damage", power:58, maxCharges:3},
      {name:"Looped Embers", kind:"buffAtk", amount:17, maxCharges:2},
      {name:"Storm of Echoes", kind:"damage", power:58, maxCharges:3, element:"Storm"}
    ]
  },
  {
    id:"timecollapse",
    name:"Timecollapse",
    emoji:"üåã",
    element:"Fire",
    baseHP:216,
    baseAtk:58,
    baseDef:50,
    baseSpd:40,
    abilities:[
      {name:"Time Collapse", kind:"damage", power:59, maxCharges:3},
      {name:"Temporal Guard", kind:"buffDef", amount:17, maxCharges:2},
      {name:"Ruinfall Cinder", kind:"damage", power:59, maxCharges:3, element:"Stone"}
    ]
  },

  // Water (2)
  {
    id:"paradoxtide",
    name:"Paradoxtide",
    emoji:"üåä",
    element:"Water",
    baseHP:214,
    baseAtk:58,
    baseDef:50,
    baseSpd:40,
    abilities:[
      {name:"Paradox Tide", kind:"damage", power:58, maxCharges:3},
      {name:"Recursion Wave", kind:"heal", amount:58, maxCharges:2},
      {name:"Lightning Undertow", kind:"damage", power:58, maxCharges:3, element:"Storm"}
    ]
  },
  {
    id:"riftcurrent",
    name:"Riftcurrent",
    emoji:"üî±",
    element:"Water",
    baseHP:216,
    baseAtk:58,
    baseDef:50,
    baseSpd:40,
    abilities:[
      {name:"Rift Current", kind:"damage", power:59, maxCharges:3},
      {name:"Tidal Riftguard", kind:"buffDef", amount:17, maxCharges:2},
      {name:"Verdant Undertow", kind:"damage", power:59, maxCharges:3, element:"Nature"}
    ]
  },

  // Nature (2)
  {
    id:"paradoxbloom",
    name:"Paradoxbloom",
    emoji:"üå∏",
    element:"Nature",
    baseHP:215,
    baseAtk:58,
    baseDef:50,
    baseSpd:40,
    abilities:[
      {name:"Paradox Bloom", kind:"damage", power:58, maxCharges:3},
      {name:"Endless Petals", kind:"heal", amount:58, maxCharges:2},
      {name:"Stone Spiral Vines", kind:"damage", power:58, maxCharges:3, element:"Stone"}
    ]
  },
  {
    id:"riftgrove",
    name:"Riftgrove",
    emoji:"üå≤",
    element:"Nature",
    baseHP:214,
    baseAtk:58,
    baseDef:50,
    baseSpd:41,
    abilities:[
      {name:"Riftroot Crush", kind:"damage", power:59, maxCharges:3},
      {name:"Tangled Timeline", kind:"buffAtk", amount:17, maxCharges:2},
      {name:"Stormseed Cascade", kind:"damage", power:59, maxCharges:3, element:"Storm"}
    ]
  },

  // Storm (2)
  {
    id:"paradoxgale",
    name:"Paradoxgale",
    emoji:"‚ö°",
    element:"Storm",
    baseHP:214,
    baseAtk:58,
    baseDef:50,
    baseSpd:41,
    abilities:[
      {name:"Paradox Gale", kind:"damage", power:58, maxCharges:3},
      {name:"Infinite Gust", kind:"buffSpd", amount:17, maxCharges:2},
      {name:"Flashfire Cyclone", kind:"damage", power:58, maxCharges:3, element:"Fire"}
    ]
  },
  {
    id:"rifttempest",
    name:"Rifttempest",
    emoji:"üåÄ",
    element:"Storm",
    baseHP:216,
    baseAtk:58,
    baseDef:50,
    baseSpd:40,
    abilities:[
      {name:"Rift Tempest", kind:"damage", power:59, maxCharges:3},
      {name:"Temporal Thunder", kind:"debuffDef", amount:17, maxCharges:2},
      {name:"Rainsplit Bolt", kind:"damage", power:59, maxCharges:3, element:"Water"}
    ]
  },

  // Stone (2)
  {
    id:"paradoxcore",
    name:"Paradoxcore",
    emoji:"ü™®",
    element:"Stone",
    baseHP:216,
    baseAtk:58,
    baseDef:50,
    baseSpd:40,
    abilities:[
      {name:"Paradox Core", kind:"damage", power:58, maxCharges:3},
      {name:"Fractured Aegis", kind:"buffDef", amount:17, maxCharges:2},
      {name:"Stormshard Echo", kind:"damage", power:58, maxCharges:3, element:"Storm"}
    ]
  },
  {
    id:"riftcolossus",
    name:"Riftcolossus",
    emoji:"üóª",
    element:"Stone",
    baseHP:214,
    baseAtk:58,
    baseDef:50,
    baseSpd:40,
    abilities:[
      {name:"Rift Colossus", kind:"damage", power:59, maxCharges:3},
      {name:"Time-locked Wall", kind:"buffDef", amount:17, maxCharges:2},
      {name:"Sunquake Impact", kind:"damage", power:59, maxCharges:3, element:"Fire"}
    ]
  },

  // =========================
  // ORIGIN TIER (10)
  // =========================

  // Fire (2)
  {
    id:"originpyre",
    name:"Originpyre",
    emoji:"üî•",
    element:"Fire",
    baseHP:218,
    baseAtk:60,
    baseDef:51,
    baseSpd:41,
    abilities:[
      {name:"Origin Pyre", kind:"damage", power:60, maxCharges:3},
      {name:"First Flame Ward", kind:"buffDef", amount:18, maxCharges:2},
      {name:"Stormbirth Spark", kind:"damage", power:60, maxCharges:3, element:"Storm"}
    ]
  },
  {
    id:"firstsun",
    name:"Firstsun",
    emoji:"üåû",
    element:"Fire",
    baseHP:220,
    baseAtk:60,
    baseDef:51,
    baseSpd:41,
    abilities:[
      {name:"First Sunfire", kind:"damage", power:60, maxCharges:3},
      {name:"Dawn of Worlds", kind:"buffAtk", amount:18, maxCharges:2},
      {name:"Stoneflare Corona", kind:"damage", power:60, maxCharges:3, element:"Stone"}
    ]
  },

  // Water (2)
  {
    id:"originsea",
    name:"Originsea",
    emoji:"üåä",
    element:"Water",
    baseHP:218,
    baseAtk:59,
    baseDef:51,
    baseSpd:41,
    abilities:[
      {name:"Origin Tide", kind:"damage", power:60, maxCharges:3},
      {name:"Primordial Flood", kind:"heal", amount:60, maxCharges:2},
      {name:"Thunderfall Surf", kind:"damage", power:60, maxCharges:3, element:"Storm"}
    ]
  },
  {
    id:"firsttide",
    name:"Firsttide",
    emoji:"üî±",
    element:"Water",
    baseHP:220,
    baseAtk:59,
    baseDef:51,
    baseSpd:41,
    abilities:[
      {name:"First Wave", kind:"damage", power:60, maxCharges:3},
      {name:"Sea Genesis", kind:"heal", amount:80, maxCharges:2},
      {name:"Flarecurrent", kind:"damage", power:60, maxCharges:3, element:"Fire"}
    ]
  },

  // Nature (2)
  {
    id:"originforest",
    name:"Originforest",
    emoji:"üå≥",
    element:"Nature",
    baseHP:219,
    baseAtk:59,
    baseDef:51,
    baseSpd:41,
    abilities:[
      {name:"Origin Canopy", kind:"damage", power:30, maxCharges:15},
      {name:"First Growth", kind:"heal", amount:225, maxCharges:2},
      {name:"Stoneheart Vines", kind:"damage", power:60, maxCharges:3, element:"Stone"}
    ]
  },
  {
    id:"firstseed",
    name:"Firstseed",
    emoji:"üå±",
    element:"Nature",
    baseHP:218,
    baseAtk:59,
    baseDef:51,
    baseSpd:42,
    abilities:[
      {name:"First Seedburst", kind:"damage", power:60, maxCharges:3},
      {name:"Worldsprout", kind:"buffAtk", amount:90, maxCharges:1},
      {name:"Stormroot Bloom", kind:"damage", power:60, maxCharges:3, element:"Storm"}
    ]
  },

  // Storm (2)
  {
    id:"originstorm",
    name:"Originstorm",
    emoji:"‚õàÔ∏è",
    element:"Storm",
    baseHP:218,
    baseAtk:60,
    baseDef:51,
    baseSpd:41,
    abilities:[
      {name:"Origin Tempest", kind:"damage", power:50, maxCharges:13},
      {name:"Skybirth Rush", kind:"buffSpd", amount:18, maxCharges:2},
      {name:"Starfire Squall", kind:"damage", power:60, maxCharges:3, element:"Fire"}
    ]
  },
  {
    id:"firstbolt",
    name:"Firstbolt",
    emoji:"‚ö°",
    element:"Storm",
    baseHP:245,
    baseAtk:80,
    baseDef:51,
    baseSpd:42,
    abilities:[
      {name:"First Thunder", kind:"damage", power:70, maxCharges:3},
      {name:"Echo of Lightning", kind:"debuffDef", amount:55, maxCharges:1},
      {name:"Tidal Spark", kind:"damage", power:60, maxCharges:3, element:"Water"}
    ]
  },

  // Stone (2)
  {
    id:"originstone",
    name:"Originstone",
    emoji:"ü™®",
    element:"Stone",
    baseHP:220,
    baseAtk:59,
    baseDef:51,
    baseSpd:41,
    abilities:[
      {name:"Origin Stonecrash", kind:"damage", power:60, maxCharges:3},
      {name:"Worldplate", kind:"buffDef", amount:18, maxCharges:2},
      {name:"Stormcore Pillar", kind:"damage", power:60, maxCharges:3, element:"Storm"}
    ]
  },
  {
    id:"firstmountain",
    name:"Firstmountain",
    emoji:"‚õ∞Ô∏è",
    element:"Stone",
    baseHP:275,
    baseAtk:59,
    baseDef:51,
    baseSpd:41,
    abilities:[
      {name:"First Mountainfall", kind:"damage", power:100, maxCharges:2},
      {name:"Bedrock Genesis", kind:"buffDef", amount:18, maxCharges:2},
      {name:"Solar Ridge", kind:"damage", power:60, maxCharges:3, element:"Fire"}
    ]
  }

];
// ----------------------------------------
// Difficulty helpers
// ----------------------------------------

// ----------------------------------------
// Difficulty helpers
// ----------------------------------------

// Compute a 1‚Äì5 difficulty score based on base stats
function computeSpeciesDifficulty(s){
  const avg = (s.baseHP + s.baseAtk + s.baseDef + s.baseSpd) / 4;

  if (avg < 40)  return 1;  // weak tier
  if (avg < 60)  return 2;  // moderate
  if (avg < 90) return 3;  // good
  if (avg < 120) return 4;  // great / legendary
  return 5;                 // mythic / cosmic
}

function getSpeciesById(id){
  return SPECIES.find(sp => sp.id === id);
}

function getSpeciesDifficulty(s){
  if(!s) return 1;
  if(s.difficulty == null){
    s.difficulty = computeSpeciesDifficulty(s);
  }
  return s.difficulty;
}

// Used anywhere we have a critter instance
function getDifficultyForCritter(c){
  if(!c) return 1;

  const s = getSpeciesById(c.speciesId);
  if (s) {
    return getSpeciesDifficulty(s);
  }

  // Fallback: approximate from critter stats if species missing
  if (typeof c.maxHP === "number" &&
      typeof c.atk   === "number" &&
      typeof c.def   === "number" &&
      typeof c.spd   === "number") {

    const avg = (c.maxHP + c.atk + c.def + c.spd) / 4;
    if (avg < 80)  return 1;
    if (avg < 95)  return 2;
    if (avg < 110) return 3;
    if (avg < 130) return 4;
    return 5;
  }

  return c.difficulty || 1;
}

// Species pool per arena tier
function getArenaSpeciesPool(tier){
  let minDiff, maxDiff;
  if(tier <= 3){
    minDiff = 1; maxDiff = 3;   // base arenas
  } else if(tier === 4){
    minDiff = 2; maxDiff = 4;   // elite
  } else {
    minDiff = 3; maxDiff = 5;   // mythic / cosmic
  }

  const pool = SPECIES.filter(s=>{
    const d = getSpeciesDifficulty(s);
    return d >= minDiff && d <= maxDiff;
  });

  return pool.length ? pool : SPECIES;
}




  function cloneAbilities(abilities, fallbackElement){
  return abilities.map(a => ({
    name: a.name,
    kind: a.kind,
    power: a.power ?? 0,
    amount: a.amount ?? 0,
    maxCharges: a.maxCharges ?? 3,
    charges: a.maxCharges ?? 3,
    // üëá NEW: element per move; falls back to species element if provided
    element: a.element ?? fallbackElement ?? null
  }));
}
function getSpeciesEmoji(critter){
  if(!critter) return "‚ùì";
  const spec = SPECIES.find(s => s.id === critter.speciesId);
  return spec && spec.emoji ? spec.emoji : "‚ùì";
}

function createCritterFromSpecies(specId, level){
  const s = SPECIES.find(sp => sp.id === specId);
  if (!s) throw new Error("Unknown species " + specId);

  const lvlFactor = 1 + (level - 1) * 0.08;
  const maxHP = Math.round(s.baseHP * lvlFactor);

  return {
    speciesId: s.id,
    name: s.name,
    emoji: s.emoji || "‚ùì",
    element: s.element,
    level,
    difficulty: getDifficultyForCritter({ speciesId: specId }), // store difficulty
    maxHP,
    currentHP: maxHP,
    atk: Math.round(s.baseAtk * lvlFactor),
    def: Math.round(s.baseDef * lvlFactor),
    spd: Math.round(s.baseSpd * lvlFactor),
    xp: 0,
    xpToNext: 25 + level * 15,
    // üëá pass the species element so abilities inherit it if they don't have their own
    abilities: cloneAbilities(s.abilities, s.element)
  };
}


  

  // ----------------------------------------
  // Map generation
  // ----------------------------------------

 const MAP_W = 40;
const MAP_H = 40;

// Size of the camera window in tiles
const VIEW_W = 9;
const VIEW_H = 9;


function generateMap(){
  const tiles = [];
  for(let y=0;y<MAP_H;y++){
    const row = [];
    for(let x=0;x<MAP_W;x++){
      let zoneType;
      if(y<10) zoneType = "Forest";
      else if(y<20) zoneType="Riverlands";
      else if(y<30) zoneType="Highlands";
      else zoneType="Ruins";

      let zoneColorIndex;
      if(zoneType==="Forest") zoneColorIndex=1;
      else if(zoneType==="Riverlands") zoneColorIndex=2;
      else if(zoneType==="Highlands") zoneColorIndex=3;
      else zoneColorIndex=4;

      let feature = null;
      const r = Math.random();
      if(r<0.06) feature="bush";
      else if(r<0.11) feature="rock";

      // thin line of shops
      if((x===5 || x===34) && y%9===0) feature="shop";

      // Arenas: tier by zone
      // y = 6,16,26,36,... -> one band per zone
      if((x===MAP_W-6 || x===8) && y % 10 === 6){
        if(zoneType === "Forest")        feature = "arena5"; // hardest
        else if(zoneType === "Riverlands") feature = "arena4";
        else                              feature = "arena3"; // Highlands + Ruins
      }

      row.push({zoneType, zoneColorIndex, feature});
    }
    tiles.push(row);
  }
  // ensure starting area is safe
  tiles[MAP_H-2][2].feature = null;
  return tiles;
}


  // ----------------------------------------
  // Global game state
  // ----------------------------------------

  let gameState = null;      // structure described below
  let currentSaveName = null;
  let inBattle = false;
  let battleState = null;    // {mode, enemyTeam, playerTeamIdxs, activePlayerIdx, activeEnemyIdx, arenaReward, log:[]}
  let lastShopPos = null;
  let lastArenaPos = null;
  let arenaSelectedIndices = []; // roster indices chosen for arena
    let currentArenaTier = 3;  // 3 = base, 4 = elite, 5 = mythic



  // ----------------------------------------
  // Logging helper
  // ----------------------------------------
  function addLog(tag, text){
    const line = document.createElement("div");
    line.className = "logLine";
    const badge = document.createElement("span");
    badge.className = "tag";
    badge.textContent = tag;
    line.appendChild(badge);
    line.append(text);
    logEl.prepend(line);
  }

  // ----------------------------------------
  // Rendering: map & HUD
  // ----------------------------------------

  // ----------------------------------------
// Roster / Critters overlay
// ----------------------------------------
const rosterOverlay = document.getElementById("rosterOverlay");
const rosterBody    = document.getElementById("rosterBody");
const btnRoster     = document.getElementById("btnRoster");
const btnRosterClose= document.getElementById("btnRosterClose");
const btnRosterBack = document.getElementById("btnRosterBack");

if(btnRoster){
  btnRoster.onclick = () => {
    if(!gameState || !gameState.player){
      addLog("System","No save loaded yet.");
      return;
    }
    openRoster();
  };
}
if(btnRosterClose) btnRosterClose.onclick = closeRoster;
if(btnRosterBack)  btnRosterBack.onclick  = closeRoster;

function openRoster(){
  renderRoster();
  rosterOverlay.classList.add("visible");
}

function closeRoster(){
  rosterOverlay.classList.remove("visible");
}

function renderRoster(){
  if(!gameState || !gameState.player){
    rosterBody.innerHTML = `<p style="font-size:12px;color:var(--muted);">No game loaded.</p>`;
    return;
  }
  const p = gameState.player;
  const roster = p.roster || [];

  if(!roster.length){
    rosterBody.innerHTML = `<p style="font-size:12px;color:var(--muted);">You don't have any critters yet.</p>`;
    return;
  }

  rosterBody.innerHTML = "";

  // Summary row: critter count + potions
  const summaryRow = document.createElement("div");
  summaryRow.style.display = "flex";
  summaryRow.style.justifyContent = "space-between";
  summaryRow.style.alignItems = "center";
  summaryRow.style.fontSize = "12px";
  summaryRow.style.marginBottom = "6px";
  summaryRow.innerHTML = `
    <span style="color:var(--muted);">Total critters: ${roster.length}</span>
    <span style="color:var(--muted);">üß™ Potions: ${p.potions}</span>
  `;
  rosterBody.appendChild(summaryRow);

  // Sort: highest level first, then by name
  const sorted = [...roster].sort((a,b)=>{
    if(b.level !== a.level) return b.level - a.level;
    return (a.name || "").localeCompare(b.name || "");
  });

  sorted.forEach(c => {
    const row = document.createElement("div");
    row.className = "listItem";
    
    const left = document.createElement("div");
    const emoji = c.emoji || "‚ùì";

    left.innerHTML = `
      <div>
        <strong>${emoji} ${c.name}</strong>
      </div>
      <div style="font-size:11px;color:var(--muted);margin-top:2px;">
        Lv ${c.level} ‚Ä¢ ${c.element} ‚Ä¢ Diff ${getDifficultyForCritter(c)} ‚Ä¢ HP ${c.currentHP}/${c.maxHP}
      </div>
      <div style="font-size:11px;color:var(--muted);margin-top:2px;">
        ATK ${c.atk} ‚Ä¢ DEF ${c.def} ‚Ä¢ SPD ${c.spd}
      </div>
    `;

    // Right: Heal button + tiny list of abilities
    const right = document.createElement("div");
    right.style.display = "flex";
    right.style.flexDirection = "column";
    right.style.alignItems = "flex-end";
    right.style.gap = "4px";

    // üîπ Heal with potion (full heal)
    const healBtn = document.createElement("button");
    healBtn.className = "secondary";
    healBtn.style.fontSize = "10px";
    healBtn.textContent = "Heal (potion)";
    healBtn.disabled = p.potions <= 0 || c.currentHP >= c.maxHP;
    healBtn.onclick = () => {
      if(p.potions <= 0 || c.currentHP >= c.maxHP) return;
      p.potions--;
      c.currentHP = c.maxHP;
      addLog("Roster", `You used a potion on ${c.name}. Fully healed!`);
      renderHUD();          // update inventory chips
      renderRoster();       // refresh this overlay
      autoSaveDebounced();  // save to Firestore
    };

    right.appendChild(healBtn);

    const abilitiesLabel = document.createElement("div");
    abilitiesLabel.style.fontSize = "10px";
    abilitiesLabel.style.color = "var(--muted)";
    abilitiesLabel.textContent = "Abilities:";
    right.appendChild(abilitiesLabel);

    (c.abilities || []).slice(0,3).forEach(ab => {
      const aRow = document.createElement("div");
      aRow.style.fontSize = "10px";
      aRow.textContent = ab.name;
      right.appendChild(aRow);
    });

    row.appendChild(left);
    row.appendChild(right);
    rosterBody.appendChild(row);
  });
}


  const mapViewEl = document.getElementById("mapView");

  function renderHUD(){
    if(!gameState){
      invEl.innerHTML = "";
      zoneNameEl.textContent="-";
      posLabelEl.textContent="-";
      modeLabelEl.textContent=inBattle?"Battle":"Exploration";
      return;
    }
    const p = gameState.player;
    invEl.innerHTML = "";
    const chips = [
      {icon:"üí∞", label:`$${p.money}`},
      {icon:"üß™", label:`Potion x${p.potions}`},
      {icon:"üî¥", label:`Ball x${p.balls.basic}`},
      {icon:"üîµ", label:`Great x${p.balls.great}`},
      {icon:"üü°", label:`Ultra x${p.balls.ultra}`}
    ];
    for(const c of chips){
      const el = document.createElement("div");
      el.className="chip";
      const s = document.createElement("span");
      s.textContent=c.icon;
      el.appendChild(s);
      el.append(c.label);
      invEl.appendChild(el);
    }
    const tile = gameState.map.tiles[gameState.map.playerY][gameState.map.playerX];
    zoneNameEl.textContent=tile.zoneType;
    posLabelEl.textContent=`(${gameState.map.playerX}, ${gameState.map.playerY})`;
    modeLabelEl.textContent=inBattle?"Battle":"Exploration";
  }

  function getVisibleWindow(){
  if(!gameState) return {x0:0,y0:0};
  const {playerX, playerY} = gameState.map;

  const halfW = Math.floor(VIEW_W/2);
  const halfH = Math.floor(VIEW_H/2);

  let x0 = playerX - halfW;
  let y0 = playerY - halfH;

  if(x0 < 0) x0 = 0;
  if(y0 < 0) y0 = 0;
  if(x0 > MAP_W - VIEW_W) x0 = MAP_W - VIEW_W;
  if(y0 > MAP_H - VIEW_H) y0 = MAP_H - VIEW_H;

  return {x0,y0};
}


 function renderMap(){
  mapViewEl.innerHTML = "";
  if(!gameState){
    // placeholder when no game is loaded
    for(let i=0;i<VIEW_W*VIEW_H;i++){
      const d=document.createElement("div");
      d.className="tile zone4";
      mapViewEl.appendChild(d);
    }
    return;
  }

  const {x0,y0} = getVisibleWindow();
  const {playerX, playerY} = gameState.map;

  for(let yy=0; yy<VIEW_H; yy++){
    for(let xx=0; xx<VIEW_W; xx++){
      const gx = x0 + xx;
      const gy = y0 + yy;
      const tile = gameState.map.tiles[gy][gx];

      const d = document.createElement("div");
      d.className = `tile zone${tile.zoneColorIndex}`;
      if(tile.feature) d.classList.add(tile.feature);
      d.dataset.gx = gx;
      d.dataset.gy = gy;
      d.addEventListener("click", ()=>onTileClick(gx,gy));

      // player marker
      if(gx===playerX && gy===playerY){
        const pm = document.createElement("div");
        pm.className="playerMarker";
        pm.innerHTML="<span>üßç</span>";
        d.appendChild(pm);
      }

      mapViewEl.appendChild(d);
    }
  }
  renderHUD();
}


  function centerOnPlayer(){
    renderMap(); // already centers based on player
  }

  // ----------------------------------------
  // Movement & encounters
  // ----------------------------------------

  function onTileClick(gx,gy){
    if(!gameState || inBattle) return;
    const {playerX, playerY} = gameState.map;
    const dx = Math.abs(gx-playerX);
    const dy = Math.abs(gy-playerY);
    if(dx+dy !==1){
      addLog("Move","You can only move one tile at a time.");
      return;
    }
    movePlayerTo(gx,gy);
  }

  function movePlayerTo(gx,gy){
    const map = gameState.map;
    map.playerX = gx;
    map.playerY = gy;
    const tile = map.tiles[gy][gx];
    addLog("Move",`You moved into the ${tile.zoneType}.`);
    renderMap();
    // feature triggers
        if(tile.feature==="shop"){
      lastShopPos = {x:gx,y:gy};
      openShop();
      return;
    }
    if(tile.feature && tile.feature.startsWith("arena")){
      lastArenaPos = {x:gx,y:gy};
      openArena(tile.feature);
      return;
    }

    // random encounter
    const base = tile.zoneType==="Forest" ? 0.04 :
                 tile.zoneType==="Riverlands" ? 0.03 :
                 tile.zoneType==="Highlands" ? 0.02 :
                 0.20;
    let bonus = 0;
    if(tile.feature==="bush") bonus += 0.02;
    if(tile.feature==="rock") bonus += 0.03;
    const chance = base+bonus;
    if(Math.random() < chance){
      startWildEncounter(tile);
    } else {
      autoSaveDebounced();
    }
  }

 function randomSpeciesForZone(zoneType){
  // 1) Filter by zone like before
  const pool = SPECIES.filter(s=>{
    if(zoneType==="Forest")     return s.element==="Nature" || s.element==="Fire";
    if(zoneType==="Riverlands") return s.element==="Water"  || s.element==="Storm";
    if(zoneType==="Highlands")  return s.element==="Stone"  || s.element==="Fire";
    if(zoneType==="Ruins")      return s.element==="Stone"  || s.element==="Storm";
    return true;
  });

  // Fallback: if somehow empty, just pick any
  if(!pool.length){
    return SPECIES[Math.floor(Math.random()*SPECIES.length)];
  }

  // 2) Compute average base stats for each species in the pool
  let minAvg = Infinity;
  let maxAvg = -Infinity;
  const meta = pool.map(s=>{
    const avg = (s.baseHP + s.baseAtk + s.baseDef + s.baseSpd) / 4;
    if(avg < minAvg) minAvg = avg;
    if(avg > maxAvg) maxAvg = avg;
    return { species: s, avg };
  });

  // 3) Convert stat average into a "weakness" score:
  //    weaker = bigger weakness = HIGHER chance
  //    stronger = smaller weakness = LOWER chance
  const EPS = 1; // prevents zero weight for the strongest
  const weights = meta.map(m=>{
    const weakness = (maxAvg - m.avg) + EPS;
    // square it so weak mons get a big boost
    return weakness * weakness;
  });

  // 4) Weighted random pick
  const totalWeight = weights.reduce((a,b)=>a+b,0);
  let r = Math.random() * totalWeight;
  for(let i=0; i<meta.length; i++){
    r -= weights[i];
    if(r <= 0){
      return meta[i].species;
    }
  }
  // Safety fallback
  return meta[meta.length-1].species;
}

  function startWildEncounter(tile){
    const roster = gameState.player.roster || [];
    const playerAvgLvl = roster.length
      ? Math.max(1,Math.round(roster.reduce((a,c)=>a+c.level,0)/roster.length))
      : 3;
    const lvl = Math.max(1, Math.round(playerAvgLvl + (Math.random()*4-2)));
    const species = randomSpeciesForZone(tile.zoneType);
    const wild = createCritterFromSpecies(species.id,lvl);
    addLog("Encounter",`A wild ${wild.name} (Lv ${wild.level}) appears!`);
    const enemyTeam = [wild];
    const playerTeamIdxs = roster.map((_,i)=>i);
    startBattle({
      mode:"wild",
      enemyTeam,
      playerTeamIdxs,
      activePlayerIdx:playerTeamIdxs[0],
      activeEnemyIdx:0,
      arenaReward:0
    });
  }

  // ----------------------------------------
  // Battle system
  // ----------------------------------------
  const battleOverlay = document.getElementById("battleOverlay");
  const battleTitleEl = document.getElementById("battleTitle");
  const battleBodyEl = document.getElementById("battleBody");
  const battleFooterEl = document.getElementById("battleFooter");
  document.getElementById("btnBattleClose").onclick = ()=>{/* no close during battle */};

  function startBattle(initialState){
    inBattle = true;
    modeLabelEl.textContent="Battle";
    battleState = {
      ...initialState,
      log:[]
    };
    // reset charges
    for(const c of gameState.player.roster){
      for(const ab of c.abilities){
        ab.charges = ab.maxCharges;
      }
    }
    for(const e of battleState.enemyTeam){
      for(const ab of e.abilities){
        ab.charges = ab.maxCharges;
      }
    }
    battleOverlay.classList.add("visible");
    renderBattle();
  }

  function activePlayerCritter(){
    return gameState.player.roster[battleState.activePlayerIdx];
  }
  function activeEnemyCritter(){
    return battleState.enemyTeam[battleState.activeEnemyIdx];
  }

 function renderBattle(){
  const pc = activePlayerCritter();
  const ec = activeEnemyCritter();
  if(!pc || !ec){
    endBattle();
    return;
  }

  const pcEmoji = pc.emoji || getSpeciesEmoji(pc);
  const ecEmoji = ec.emoji || getSpeciesEmoji(ec);

 if(battleState.mode === "arena"){
    battleTitleEl.textContent = `Arena Battle (Tier ${currentArenaTier})`;
  } else {
    battleTitleEl.textContent = "Wild Encounter";
  }
  battleBodyEl.innerHTML="";
  const hero = document.createElement("div");
  hero.innerHTML = `
    <div class="sectionTitle">Your Critter</div>
    <div class="battleStats">
      <div style="flex:1;display:flex;gap:8px;align-items:flex-start;">
        <div style="font-size:26px;line-height:1;">${pcEmoji}</div>
        <div style="flex:1;">
          <strong>${pc.name}</strong>
            <span class="badge">Lv ${pc.level}</span>
            <span class="badge">${pc.element}</span>
            <span class="badge">Diff ${getDifficultyForCritter(pc)}</span>
          <div class="hpBar">
            <div class="hpFill" style="width:${Math.max(0,pc.currentHP)/pc.maxHP*100}%"></div>
          </div>
          <div style="font-size:11px;margin-top:2px;">HP ${pc.currentHP}/${pc.maxHP}</div>
        </div>
      </div>
    </div>

    <div class="sectionTitle">Enemy</div>
    <div class="battleStats">
      <div style="flex:1;display:flex;gap:8px;align-items:flex-start;">
        <div style="font-size:26px;line-height:1;">${ecEmoji}</div>
        <div style="flex:1;">
         <strong>${ec.name}</strong>
            <span class="badge">Lv ${ec.level}</span>
            <span class="badge">${ec.element}</span>
            <span class="badge">Diff ${getDifficultyForCritter(ec)}</span>
          <div class="hpBar">
            <div class="hpFill" style="width:${Math.max(0,ec.currentHP)/ec.maxHP*100}%"></div>
          </div>
          <div style="font-size:11px;margin-top:2px;">HP ${ec.currentHP}/${ec.maxHP}</div>
        </div>
      </div>
    </div>
  `;
  battleBodyEl.appendChild(hero);

    const histTitle = document.createElement("div");
    histTitle.className="sectionTitle";
    histTitle.textContent="Battle Log";
    battleBodyEl.appendChild(histTitle);

    const histBox = document.createElement("div");
    histBox.style.maxHeight="200px";
    histBox.style.overflowY="auto";
    histBox.style.border="1px solid #1f2937";
    histBox.style.borderRadius="8px";
    histBox.style.padding="4px 6px";
    const lines = battleState.log.slice(-8);
    if(lines.length===0){
      histBox.innerHTML = `<div style="font-size:11px;color:var(--muted);">Actions will appear here.</div>`;
    }else{
      for(const L of lines){
        const div=document.createElement("div");
        div.style.fontSize="11px";
        div.textContent=L;
        histBox.appendChild(div);
      }
    }
    battleBodyEl.appendChild(histBox);

    // Footer buttons
    battleFooterEl.innerHTML="";
    // abilities
    pc.abilities.forEach((ab,idx)=>{
      const btn=document.createElement("button");
      btn.textContent = `${ab.name} (${ab.charges}/${ab.maxCharges})`;
      btn.disabled = ab.charges<=0;
      btn.onclick=()=>queuePlayerAction({type:"ability", index:idx});
      battleFooterEl.appendChild(btn);
    });
    const invRow=document.createElement("div");
    invRow.style.display="flex";
    invRow.style.flexWrap="wrap";
    invRow.style.gap="4px";
    invRow.style.marginTop="4px";
    const btnPotion=document.createElement("button");
    btnPotion.className="secondary";
    btnPotion.textContent=`Use Potion (${gameState.player.potions})`;
    btnPotion.disabled = gameState.player.potions<=0 || pc.currentHP>=pc.maxHP;
    btnPotion.onclick=()=>queuePlayerAction({type:"potion"});
    invRow.appendChild(btnPotion);

    const btnCapture=document.createElement("button");
    btnCapture.className="secondary";
    btnCapture.textContent="Capture";
    btnCapture.onclick=()=>openCaptureMenu();
    invRow.appendChild(btnCapture);

    const btnSwitch=document.createElement("button");
    btnSwitch.className="secondary";
    btnSwitch.textContent="Switch";
    btnSwitch.onclick=()=>openSwitchMenu();
    invRow.appendChild(btnSwitch);

    if(battleState.mode==="wild"){
      const btnRun=document.createElement("button");
      btnRun.className="danger";
      btnRun.textContent="Run";
      btnRun.onclick=()=>{
        battleState.log.push("You fled from the battle.");
        endBattle();
      };
      invRow.appendChild(btnRun);
    }
    battleFooterEl.appendChild(invRow);
  }

  function queuePlayerAction(action){
    const pc = activePlayerCritter();
    const ec = activeEnemyCritter();
    if(!pc || !ec) { endBattle(); return; }
    const enemyAction = chooseEnemyAction(ec, pc);
    const firstPlayer = pc.spd >= ec.spd;

    if(firstPlayer){
      resolveAction("player", action, pc, ec);
      if(ec.currentHP>0 && pc.currentHP>0){
        resolveAction("enemy", enemyAction, ec, pc);
      }
    }else{
      resolveAction("enemy", enemyAction, ec, pc);
      if(pc.currentHP>0 && ec.currentHP>0){
        resolveAction("player", action, pc, ec);
      }
    }
    checkBattleState();
    renderBattle();
  }

  function basicDamage(attacker, defender, ability){
    const base = (ability.power ?? 20) + Math.floor(attacker.atk*0.6) - Math.floor(defender.def*0.4);
    return Math.max(5, base);
  }

function resolveAction(side, action, actor, target){
  if (actor.currentHP <= 0) return;

  const sideLabel = side === "player" ? "Your" : "Enemy";

  if (action.type === "ability") {
    const idx = action.index;
    const ab  = actor.abilities[idx];

    if (!ab || ab.charges <= 0) {
      battleState.log.push(`${sideLabel} ${actor.name} fumbles and does nothing.`);
      return;
    }

    ab.charges--;

    if (ab.kind === "damage") {
      // üî∏ Use the ability's element if it has one; otherwise the user's element
      const atkElement = ab.element || actor.element;
      const mult = typeMultiplier(atkElement, target.element);

      let dmg = basicDamage(actor, target, ab);
      dmg = Math.round(dmg * mult);
      if (dmg < 1) dmg = 1;

      target.currentHP -= dmg;
      if (target.currentHP < 0) target.currentHP = 0;

      let eff = "";
      if (mult > 1.1)      eff = " It's super effective!";
      else if (mult < 0.9) eff = " It's not very effective.";

      battleState.log.push(
        `${sideLabel} ${actor.name} used ${ab.name}! It dealt ${dmg} damage.${eff}`
      );

      if (target.currentHP <= 0) {
        const victimSide = side === "player" ? "Enemy" : "Your";
        battleState.log.push(`${victimSide} ${target.name} fainted!`);
      }

    } else if (ab.kind === "heal") {
      const before = actor.currentHP;
      actor.currentHP = Math.min(actor.maxHP, actor.currentHP + (ab.amount ?? 20));
      const healed = actor.currentHP - before;
      battleState.log.push(`${sideLabel} ${actor.name} used ${ab.name} and healed ${healed} HP.`);

    } else if (ab.kind === "buffAtk") {
      actor.atk += ab.amount ?? 4;
      battleState.log.push(`${sideLabel} ${actor.name} used ${ab.name}. Attack rose!`);

    } else if (ab.kind === "buffDef") {
      actor.def += ab.amount ?? 4;
      battleState.log.push(`${sideLabel} ${actor.name} used ${ab.name}. Defense rose!`);

    } else if (ab.kind === "buffSpd") {
      actor.spd += ab.amount ?? 4;
      battleState.log.push(`${sideLabel} ${actor.name} used ${ab.name}. Speed rose!`);

    } else if (ab.kind === "debuffAtk") {
      target.atk = Math.max(1, target.atk - (ab.amount ?? 4));
      battleState.log.push(`${sideLabel} ${actor.name} used ${ab.name}. Foe's Attack fell!`);

    } else if (ab.kind === "debuffDef") {
      target.def = Math.max(1, target.def - (ab.amount ?? 4));
      battleState.log.push(`${sideLabel} ${actor.name} used ${ab.name}. Foe's Defense fell!`);

    } else {
      battleState.log.push(`${sideLabel} ${actor.name} used ${ab.name}... but nothing happened.`);
    }

  } else if (action.type === "potion") {
    const before = actor.currentHP;
    if (gameState.player.potions <= 0 || before >= actor.maxHP) {
      battleState.log.push("But it failed.");
      return;
    }
    gameState.player.potions--;
    actor.currentHP = Math.min(actor.maxHP, actor.currentHP + 120);
    const healed = actor.currentHP - before;
    battleState.log.push(`${sideLabel} ${actor.name} drank a potion and healed ${healed} HP.`);

  } else if (action.type === "switch") {
    const newIdx = action.toIndex;
    if (side === "player") {
      battleState.activePlayerIdx = newIdx;
      const newC = gameState.player.roster[newIdx];
      battleState.log.push(`You switched to ${newC.name}.`);
    } else {
      battleState.activeEnemyIdx = newIdx;
      const newC = battleState.enemyTeam[newIdx];
      battleState.log.push(`Enemy switched to ${newC.name}.`);
    }

  } else if (action.type === "struggle") {
    const dmg = 15;
    target.currentHP = Math.max(0, target.currentHP - dmg);
    battleState.log.push(`${sideLabel} ${actor.name} struggled for ${dmg} damage.`);
    if (target.currentHP <= 0) battleState.log.push(`${target.name} fainted.`);

  } else if (action.type === "capture") {
    // handled separately
  }
}

  function chooseEnemyAction(enemy, player){
    const aliveIdxs = battleState.enemyTeam
      .map((c,i)=>({c,i}))
      .filter(x=>x.c.currentHP>0 && x.i!==battleState.activeEnemyIdx)
      .map(x=>x.i);
    if(enemy.currentHP < enemy.maxHP*0.3 && aliveIdxs.length>0 && Math.random()<0.25){
      return {type:"switch", toIndex:aliveIdxs[Math.floor(Math.random()*aliveIdxs.length)]};
    }
    const dam = enemy.abilities.filter(a => a.kind === "damage" && a.charges > 0);
if (dam.length > 0) {
  dam.sort((a, b) => {
    const aElem = a.element || enemy.element;
    const bElem = b.element || enemy.element;

    const sa = (a.power ?? 20) * typeMultiplier(aElem, player.element);
    const sb = (b.power ?? 20) * typeMultiplier(bElem, player.element);

    return sb - sa; // highest ‚Äúeffective power‚Äù first
  });
  const ab = dam[0];
  const idx = enemy.abilities.indexOf(ab);
  return { type: "ability", index: idx };
}

    const any = enemy.abilities.find(a=>a.charges>0);
    if(any){
      return {type:"ability", index:enemy.abilities.indexOf(any)};
    }
    return {type:"struggle"};
  }

  function openSwitchMenu(){
  const pcIdx = battleState.activePlayerIdx;

  const teamIdxs = (battleState.playerTeamIdxs && battleState.playerTeamIdxs.length)
    ? battleState.playerTeamIdxs
    : gameState.player.roster.map((_,i)=>i);

  const alive = teamIdxs
    .map(i => ({ c: gameState.player.roster[i], i }))
    .filter(x => x.c && x.c.currentHP > 0 && x.i !== pcIdx);

  if(alive.length === 0){
    battleState.log.push("No other healthy critters to switch to.");
    renderBattle();
    return;
  }

  battleFooterEl.innerHTML = "";
  const info = document.createElement("div");
  info.style.fontSize = "11px";
  info.style.marginBottom = "4px";
  info.textContent = "Choose a critter to switch to:";
  battleFooterEl.appendChild(info);

  for(const {c,i} of alive){
    const btn = document.createElement("button");
    btn.className = "secondary";
    btn.textContent = `${c.name} (Lv ${c.level}) HP ${c.currentHP}/${c.maxHP}`;
    btn.onclick = () => {
      queuePlayerAction({ type:"switch", toIndex:i });
    };
    battleFooterEl.appendChild(btn);
  }

  const cancel = document.createElement("button");
  cancel.className = "secondary";
  cancel.textContent = "Cancel";
  cancel.onclick = () => renderBattle();
  battleFooterEl.appendChild(cancel);
}


  function openCaptureMenu(){
    const inv = gameState.player.balls;
    battleFooterEl.innerHTML="";
    const info=document.createElement("div");
    info.style.fontSize="11px";
    info.style.marginBottom="4px";
    info.textContent="Choose which capture ball to throw:";
    battleFooterEl.appendChild(info);

    function addBallButton(label, key){
      const count = inv[key];
      const btn=document.createElement("button");
      btn.className="secondary";
      btn.textContent=`${label} (${count})`;
      btn.disabled = count<=0;
      btn.onclick=()=>attemptCapture(key);
      battleFooterEl.appendChild(btn);
    }
    addBallButton("Capture Ball","basic");
    addBallButton("Great Ball","great");
    addBallButton("Ultra Ball","ultra");
    const cancel=document.createElement("button");
    cancel.className="secondary";
    cancel.textContent="Cancel";
    cancel.onclick=()=>renderBattle();
    battleFooterEl.appendChild(cancel);
  }

  function attemptCapture(ballKey){
    const pc = activePlayerCritter();
    const ec = activeEnemyCritter();
    if(gameState.player.balls[ballKey]<=0){
      battleState.log.push("You don't have that ball.");
      renderBattle();
      return;
    }
    gameState.player.balls[ballKey]--;
    const hpFactor = (ec.maxHP - ec.currentHP)/ec.maxHP;
    let baseChance = 0.25 + hpFactor*0.5; // 25‚Äì75%
    let ballMult = ballKey==="basic" ? 1 : ballKey==="great" ? 1.6 : 2.2;
    let typeBonus = typeMultiplier(pc.element, ec.element);
    if(typeBonus>1.1) typeBonus = 1.2;
    else if(typeBonus<0.9) typeBonus = 0.9;
    const catchChance = Math.min(0.95, baseChance*ballMult*typeBonus);
    const roll = Math.random();
    if(roll < catchChance){
      battleState.log.push(`You threw the ball... Gotcha! ${ec.name} was captured!`);
      const captured = createCritterFromSpecies(ec.speciesId, ec.level);
      captured.currentHP = captured.maxHP;
      gameState.player.roster.push(captured);
      grantXP(pc, ec, true);
      endBattle();
    }else{
      battleState.log.push("The critter broke free!");
      renderBattle();
    }
  }

  function grantXP(pc, ec, captured){
    if(!pc || !ec) return;
    const base = 15 + ec.level*4;
    const xpGain = captured ? Math.round(base*0.8) : base;
    pc.xp += xpGain;
    battleState.log.push(`${pc.name} gained ${xpGain} XP.`);
    while(pc.xp >= pc.xpToNext){
      pc.xp -= pc.xpToNext;
      pc.level++;
      pc.xpToNext = Math.round(pc.xpToNext*1.4);
      pc.maxHP = Math.round(pc.maxHP*1.08);
      pc.currentHP = pc.maxHP;
      pc.atk = Math.round(pc.atk*1.06);
      pc.def = Math.round(pc.def*1.06);
      pc.spd = Math.round(pc.spd*1.03);
      battleState.log.push(`${pc.name} grew to level ${pc.level}!`);
    }
  }

  function checkBattleState(){
  const teamIdxs = (battleState.playerTeamIdxs && battleState.playerTeamIdxs.length)
    ? battleState.playerTeamIdxs
    : gameState.player.roster.map((_,i)=>i);

  const pcAlive = teamIdxs.some(i => {
    const c = gameState.player.roster[i];
    return c && c.currentHP > 0;
  });

  const ecAlive = battleState.enemyTeam.some(c => c.currentHP > 0);

  if(!pcAlive){
    battleState.log.push("All of your selected critters have been defeated...");
    // Keep the existing hardcore behavior: remove fainted from the roster
    gameState.player.roster = gameState.player.roster.filter(c => c.currentHP > 0);
    endBattle(true);
    return;
  }

  if(!ecAlive){
    // Award XP to the first living critter on the selected team
    const firstAliveRosterIndex = teamIdxs.find(i => {
      const c = gameState.player.roster[i];
      return c && c.currentHP > 0;
    });

    let pc = null;
    if(firstAliveRosterIndex != null){
      pc = gameState.player.roster[firstAliveRosterIndex];
    } else if(teamIdxs.length){
      pc = gameState.player.roster[teamIdxs[0]];
    } else {
      pc = gameState.player.roster[0];
    }

    const ecRef = battleState.enemyTeam[0];
    if(pc && ecRef){
      grantXP(pc, ecRef, false);
    }

    if(battleState.mode === "arena" && battleState.arenaReward > 0){
      gameState.player.money += battleState.arenaReward;
      battleState.log.push(`You won the arena battle and earned $${battleState.arenaReward}!`);
    }

    endBattle();
    return;
  }

  // ensure active indices refer to living
  const curEnemy = activeEnemyCritter();
  if(!curEnemy || curEnemy.currentHP <= 0){
    let idx = battleState.enemyTeam.findIndex(c => c.currentHP > 0);
    if(idx === -1){ return; }
    battleState.activeEnemyIdx = idx;
  }

  const curPlayer = activePlayerCritter();
  if(!curPlayer || curPlayer.currentHP <= 0){
    const nextRosterIndex = teamIdxs.find(i => {
      const c = gameState.player.roster[i];
      return c && c.currentHP > 0;
    });
    if(nextRosterIndex == null) return;
    battleState.activePlayerIdx = nextRosterIndex;
    battleState.log.push(`You send out ${gameState.player.roster[nextRosterIndex].name}!`);
  }
}


  function endBattle(isDeath){
    inBattle = false;
    battleOverlay.classList.remove("visible");
    if(isDeath){
      if(!gameState.player.roster.length){
        showGameOver();
      }
    }
    renderMap();
    autoSaveDebounced();
  }

  function showGameOver(){
    document.getElementById("gameOverOverlay").classList.add("visible");
  }
  document.getElementById("btnGameOverToMenu").onclick = ()=>{
    document.getElementById("gameOverOverlay").classList.remove("visible");
    openStartMenu();
  };

  // ----------------------------------------
  // Shop
  // ----------------------------------------
  const shopOverlay = document.getElementById("shopOverlay");
  const shopBody = document.getElementById("shopBody");
  document.getElementById("btnShopClose").onclick = closeShop;
  document.getElementById("btnShopBack").onclick = closeShop;

  const SHOP_PRICES = {
    potion:50,
    basicBall:100,
    greatBall:250,
    ultraBall:500
  };

  function openShop(){
    if(!gameState) return;
    shopOverlay.classList.add("visible");
    renderShop();
  }

  function closeShop(){
    shopOverlay.classList.remove("visible");
    // push you one tile away from the shop so you don't retrigger
    if(lastShopPos && gameState){
      const {x,y} = lastShopPos;
      const neighbors = [];
      if (x + 1 < MAP_W) neighbors.push({ x: x + 1, y: y });
      if (x - 1 >= 0)    neighbors.push({ x: x - 1, y: y });
      if (y + 1 < MAP_H) neighbors.push({ x: x, y: y + 1 });
      if (y - 1 >= 0)    neighbors.push({ x: x, y: y - 1 });

      if(neighbors.length){
        const p = neighbors[0];
        gameState.map.playerX = p.x;
        gameState.map.playerY = p.y;
      }
      renderMap();
      autoSaveDebounced();
    }
  }

 function renderShop(){
  if(!gameState) return;
  const p = gameState.player;

  shopBody.innerHTML = "";

  // Money row
  const moneyRow = document.createElement("div");
  moneyRow.className = "row";
  moneyRow.innerHTML = `<strong>Money:</strong><span>$${p.money}</span>`;
  shopBody.appendChild(moneyRow);

  // Buy items section (unchanged)
  const itemsTitle = document.createElement("div");
  itemsTitle.className = "sectionTitle";
  itemsTitle.textContent = "Buy Items";
  shopBody.appendChild(itemsTitle);

  function addBuyRow(label, price, key){
    const row = document.createElement("div");
    row.className = "listItem";
    row.innerHTML = `<div>${label} <span style="color:var(--muted);font-size:11px;">$${price}</span></div>`;
    const btn = document.createElement("button");
    btn.className = "secondary";
    btn.textContent = "Buy";
    btn.disabled = p.money < price;
    btn.onclick = () => {
      if(p.money < price) return;
      p.money -= price;
      if(key==="potion") p.potions++;
      else if(key==="basicBall") p.balls.basic++;
      else if(key==="greatBall") p.balls.great++;
      else if(key==="ultraBall") p.balls.ultra++;
      addLog("Shop", `Bought 1 ${label}.`);
      renderShop();
      renderHUD();
      autoSaveDebounced();
    };
    row.appendChild(btn);
    shopBody.appendChild(row);
  }

  addBuyRow("Healing Potion",      SHOP_PRICES.potion,     "potion");
  addBuyRow("Capture Ball",        SHOP_PRICES.basicBall,  "basicBall");
  addBuyRow("Great Capture Ball",  SHOP_PRICES.greatBall,  "greatBall");
  addBuyRow("Ultra Capture Ball",  SHOP_PRICES.ultraBall,  "ultraBall");

  // Sell / heal section
  const sellTitle = document.createElement("div");
  sellTitle.className = "sectionTitle";
  sellTitle.textContent = "Manage Critters";
  sellTitle.style.marginTop = "8px";
  shopBody.appendChild(sellTitle);

  if(!p.roster.length){
    const msg = document.createElement("div");
    msg.style.fontSize = "11px";
    msg.style.color = "var(--muted)";
    msg.textContent = "You have no critters yet.";
    shopBody.appendChild(msg);
    return;
  }

  // Sort critters from highest level to lowest
  const sorted = [...p.roster].sort((a,b)=> b.level - a.level);

  sorted.forEach(c => {
    // Sell value calculation
    const base = 60 + c.level * 25;
    const elemBonus =
      c.element === "Fire"  || c.element === "Storm" ? 20 :
      c.element === "Stone" ? 30 : 10;
    const price = base + elemBonus;

    const row = document.createElement("div");
    row.className = "listItem";

    // Left: emoji + name + level + element + HP
    const left = document.createElement("div");
    const emoji = c.emoji || "‚ùì";
    left.innerHTML = `
      <div>
        <strong>${emoji} ${c.name}</strong>
      </div>
      <div style="font-size:11px;color:var(--muted);">
        Lv ${c.level} ‚Ä¢ ${c.element} ‚Ä¢ HP ${c.currentHP}/${c.maxHP}
      </div>
    `;

    // Right: Heal + value + Sell
    const right = document.createElement("div");
    right.style.display = "flex";
    right.style.alignItems = "center";
    right.style.gap = "6px";

    // Heal button ($50, full heal)
    const healBtn = document.createElement("button");
    healBtn.className = "secondary";
    healBtn.textContent = "Heal $50";
    healBtn.disabled = p.money < 50 || c.currentHP >= c.maxHP;
    healBtn.onclick = () => {
      if(p.money < 50 || c.currentHP >= c.maxHP) return;
      p.money -= 50;
      c.currentHP = c.maxHP;
      addLog("Shop", `Healed ${c.name} to full HP for $50.`);
      renderShop();
      renderHUD();
      autoSaveDebounced();
    };

    // Sell value
    const val = document.createElement("span");
    val.style.fontSize = "11px";
    val.textContent = `$${price}`;

    // Sell button
    const sellBtn = document.createElement("button");
    sellBtn.className = "danger";
    sellBtn.textContent = "Sell";
    sellBtn.onclick = () => {
      const idx = p.roster.indexOf(c); // find in real roster
      if(idx === -1) return;
      p.money += price;
      p.roster.splice(idx, 1);
      addLog("Shop", `Sold ${c.name} for $${price}.`);
      renderShop();
      renderHUD();
      autoSaveDebounced();
    };

    right.appendChild(healBtn);
    right.appendChild(val);
    right.appendChild(sellBtn);

    row.appendChild(left);
    row.appendChild(right);
    shopBody.appendChild(row);
  });
}


  // ----------------------------------------
  // Arena
  // ----------------------------------------
  const arenaOverlay=document.getElementById("arenaOverlay");
  const arenaBody=document.getElementById("arenaBody");
  const btnArenaStart=document.getElementById("btnArenaStart");
  const btnArenaClose=document.getElementById("btnArenaClose");
  const btnArenaCancel=document.getElementById("btnArenaCancel");

   function getArenaTierFromFeature(feature){
    if(feature === "arena4") return 4;
    if(feature === "arena5") return 5;
    // "arena3" or old "arena" or anything else defaults to base tier 3
    return 3;
  }

  function openArena(feature){
    if(!gameState) return;
    if(!arenaOverlay || !arenaBody || !btnArenaStart) return;

    currentArenaTier = getArenaTierFromFeature(feature || "arena3");
    arenaOverlay.classList.add("visible");
    renderArenaSelection();
  }


  function closeArena(){
    if(arenaOverlay) arenaOverlay.classList.remove("visible");
    // push you away from arena tile
    if(lastArenaPos && gameState){
      const {x,y} = lastArenaPos;
      const neighbors = [];
      if (x + 1 < MAP_W) neighbors.push({ x: x + 1, y: y });
      if (x - 1 >= 0)    neighbors.push({ x: x - 1, y: y });
      if (y + 1 < MAP_H) neighbors.push({ x: x, y: y + 1 });
      if (y - 1 >= 0)    neighbors.push({ x: x, y: y - 1 });

      if(neighbors.length){
        const p = neighbors[0];
        gameState.map.playerX=p.x;
        gameState.map.playerY=p.y;
      }
      renderMap();
      autoSaveDebounced();
    }
  }

  if(btnArenaClose) btnArenaClose.onclick = closeArena;
  if(btnArenaCancel) btnArenaCancel.onclick = closeArena;

 function renderArenaSelection(){
  if(!gameState || !gameState.player) return;
  if(!arenaBody || !btnArenaStart) return;

  const p = gameState.player;
  const roster = p.roster || [];

  arenaBody.innerHTML = "";

  const tierLabel =
    currentArenaTier === 3 ? "Base Arena (difficulty up to 3)" :
    currentArenaTier === 4 ? "Elite Arena (difficulty up to 4)" :
    "Mythic Arena (difficulty up to 5)";

  if(roster.length < 3){
    arenaBody.innerHTML = `
      <p>${tierLabel}</p>
      <p>You need at least 3 critters to challenge the arena.</p>
    `;
    btnArenaStart.disabled = true;
    return;
  }

  // Clean up selection (drop indices that no longer exist)
  if(!Array.isArray(arenaSelectedIndices)) arenaSelectedIndices = [];
  arenaSelectedIndices = arenaSelectedIndices.filter(i => i >= 0 && i < roster.length);

  // Default selection: first 3 if nothing chosen yet
  if(arenaSelectedIndices.length === 0){
    arenaSelectedIndices = [0,1,2].filter(i => i < roster.length);
  }

  arenaBody.innerHTML = `
    <p style="font-size:12px;margin-bottom:4px;">
      ${tierLabel}<br/>
      Choose <strong>3</strong> critters to enter the arena. You will face 3 random opponents.
    </p>
    <p style="font-size:11px;color:var(--muted);margin-bottom:6px;">
      Click a row to toggle selection. Selected critters are highlighted.
    </p>
    <p style="font-size:11px;color:var(--muted);margin-bottom:6px;">
      Selected: ${arenaSelectedIndices.length} / 3
    </p>
  `;

  const list = document.createElement("div");

  roster.forEach((c, idx) => {
    const selected = arenaSelectedIndices.includes(idx);
    const row = document.createElement("div");
    row.className = "listItem";
    row.style.cursor = "pointer";
    if(selected){
      row.style.borderColor = "var(--accent)";
      row.style.boxShadow = "0 0 0 1px rgba(34,197,94,.6)";
    }

    const hpLabel = `HP ${c.currentHP}/${c.maxHP}${c.currentHP <= 0 ? " (fainted)" : ""}`;

    row.innerHTML = `
      <div>
        <div><strong>${c.emoji || "‚ùì"} ${c.name}</strong></div>
        <div style="font-size:11px;color:var(--muted);">
          Lv ${c.level} ‚Ä¢ ${c.element} ‚Ä¢ ${hpLabel}
        </div>
      </div>
      <div style="font-size:11px;color:${selected ? "var(--accent)" : "var(--muted)"};">
        ${selected ? "Selected" : "Tap to select"}
      </div>
    `;

    row.onclick = () => {
      // Toggle selection
      const i = arenaSelectedIndices.indexOf(idx);
      if(i !== -1){
        arenaSelectedIndices.splice(i,1);
      } else {
        if(arenaSelectedIndices.length >= 3) {
          addLog("Arena","You can only bring 3 critters.");
          return;
        }
        arenaSelectedIndices.push(idx);
      }
      renderArenaSelection();
    };

    list.appendChild(row);
  });

  arenaBody.appendChild(list);

  // Enable Start only when exactly 3 selected
  btnArenaStart.disabled = arenaSelectedIndices.length !== 3;
}

if(btnArenaStart){
  btnArenaStart.onclick = () => {
    if(!gameState || !gameState.player) return;
    const roster = gameState.player.roster || [];
    if(roster.length < 3) return;

    if(!Array.isArray(arenaSelectedIndices) || arenaSelectedIndices.length !== 3){
      addLog("Arena","Select exactly 3 critters first.");
      renderArenaSelection();
      return;
    }

    // Build the chosen team
    const picked = arenaSelectedIndices
      .map(i => roster[i])
      .filter(Boolean);

    if(picked.length !== 3){
      addLog("Arena","Selection error. Try re-selecting your team.");
      renderArenaSelection();
      return;
    }

    // All selected must be alive
    if(picked.some(c => c.currentHP <= 0)){
      addLog("Arena","All selected critters must be healthy to enter the arena.");
      return;
    }

    // Average level of chosen team
    const avgLvl = Math.max(3, Math.round(
      picked.reduce((a,c)=>a + c.level, 0) / picked.length
    ));

    // Tier-based enemy species pool (requires getArenaSpeciesPool + currentArenaTier)
    let enemyPool = (typeof getArenaSpeciesPool === "function")
      ? getArenaSpeciesPool(currentArenaTier)
      : SPECIES;

    // Level bias by arena tier
    const tierLevelBonus =
      currentArenaTier === 3 ? 0 :
      currentArenaTier === 4 ? 2 : 4;

    // Generate enemy team
    const enemyTeam = [];
    for(let i=0;i<3;i++){
      const s = enemyPool[Math.floor(Math.random()*enemyPool.length)];
      const baseLvl = avgLvl + tierLevelBonus;
      const lvl = Math.max(3, baseLvl + ((Math.random()*4 - 2) | 0));
      enemyTeam.push(createCritterFromSpecies(s.id, lvl));
    }

    const playerTeamIdxs = [...arenaSelectedIndices];

    // Tier-based reward
    const rewardBase = 200 + avgLvl * 25;
    const tierMult =
      currentArenaTier === 3 ? 1.0 :
      currentArenaTier === 4 ? 1.6 : 2.2;
    const reward = Math.round(rewardBase * tierMult);

    addLog("Arena",`You enter a tier ${currentArenaTier} arena for $${reward}!`);
    if(arenaOverlay) arenaOverlay.classList.remove("visible");

    startBattle({
      mode: "arena",
      enemyTeam,
      playerTeamIdxs,
      activePlayerIdx: playerTeamIdxs[0],
      activeEnemyIdx: 0,
      arenaReward: reward
    });
  };
}



// ----------------------------------------
// Saving & loading (Firestore /mqUsers/{username})
// ----------------------------------------
const saveNameInput       = document.getElementById("saveNameInput");
const startUsernameInput  = document.getElementById("startUsernameInput"); // <‚Äî NEW
const startOverlay        = document.getElementById("startOverlay");
const startStatus         = document.getElementById("startStatus");
const btnNewGame          = document.getElementById("btnNewGame");
const btnLoadGame         = document.getElementById("btnLoadGame");
const btnStartClose       = document.getElementById("btnStartClose");

// helper to standardize usernames for the doc id
function normalizeUsername(u){
  return (u || "").trim().toLowerCase();
}

// ----------------------------------------
// Firestore-safe game state (no nested arrays)
// ----------------------------------------
function serializeGameState(gs){
  if(!gs) return null;

  // Flatten tiles into a 1D array of objects: {x,y, zoneType, zoneColorIndex, feature}
  const flatTiles = [];
  if(gs.map && Array.isArray(gs.map.tiles)){
    for(let y=0; y<MAP_H; y++){
      const row = gs.map.tiles[y];
      if(!Array.isArray(row)) continue;
      for(let x=0; x<MAP_W; x++){
        const t = row[x];
        if(!t) continue;
        flatTiles.push({
          x,
          y,
          zoneType: t.zoneType || "Forest",
          zoneColorIndex: t.zoneColorIndex || 1,
          feature: t.feature ?? null
        });
      }
    }
  }

  return {
    saveName: gs.saveName || "",
    createdAt: gs.createdAt || Date.now(),
    lastPlayed: Date.now(),
    player: gs.player || {
      money:0,
      potions:0,
      balls:{basic:0,great:0,ultra:0},
      roster:[]
    },
    map:{
      playerX: gs.map?.playerX ?? 2,
      playerY: gs.map?.playerY ?? (MAP_H - 2),
      tilesFlat: flatTiles    // <--- 1D; no nested arrays
    }
  };
}

function deserializeGameState(stored){
  if(!stored){
    // Fallback: brand new game
    return createNewGameState("autosave");
  }

  // Build a 2D tiles array for runtime
  const tiles2D = [];
  for(let y=0; y<MAP_H; y++){
    const row = [];
    for(let x=0; x<MAP_W; x++){
      row.push({
        zoneType:"Forest",
        zoneColorIndex:1,
        feature:null
      });
    }
    tiles2D.push(row);
  }

  // Preferred: tilesFlat (new format)
  if(stored.map && Array.isArray(stored.map.tilesFlat)){
    for(const t of stored.map.tilesFlat){
      if(!t) continue;
      const x = t.x;
      const y = t.y;
      if(
        typeof x==="number" && typeof y==="number" &&
        x>=0 && x<MAP_W && y>=0 && y<MAP_H
      ){
        tiles2D[y][x] = {
          zoneType: t.zoneType || "Forest",
          zoneColorIndex: t.zoneColorIndex || 1,
          feature: t.feature ?? null
        };
      }
    }
  }
  // Backwards-compat: if an older save somehow has tiles as 2D array,
  // we can still read it (this does NOT get written back as nested arrays).
  else if(stored.map && Array.isArray(stored.map.tiles)){
    const oldTiles = stored.map.tiles;
    for(let y=0; y<Math.min(MAP_H, oldTiles.length); y++){
      const rowIn = oldTiles[y];
      if(!Array.isArray(rowIn)) continue;
      for(let x=0; x<Math.min(MAP_W, rowIn.length); x++){
        const t = rowIn[x];
        if(t){
          tiles2D[y][x] = {
            zoneType: t.zoneType || "Forest",
            zoneColorIndex: t.zoneColorIndex || 1,
            feature: t.feature ?? null
          };
        }
      }
    }
  }
  // else: keep default Forest map

  return {
    saveName: stored.saveName || "",
    createdAt: stored.createdAt || Date.now(),
    lastPlayed: Date.now(),
    player: stored.player || {
      money:0,
      potions:0,
      balls:{basic:0,great:0,ultra:0},
      roster:[]
    },
    map:{
      tiles: tiles2D,
      playerX: stored.map?.playerX ?? 2,
      playerY: stored.map?.playerY ?? (MAP_H - 2)
    }
  };
}

function openStartMenu(){
  startOverlay.classList.add("visible");
  startStatus.textContent="";

  // if we already have a username, keep it filled in
  if(typeof currentUsername === "string" && currentUsername.trim()){
    startUsernameInput.value = currentUsername;
  }
}
btnStartClose.onclick = ()=>{ /* keep menu open; mainly cosmetic */ };

// NEW GAME ‚Äî username + save name
btnNewGame.onclick = async ()=>{
  if(!currentUser){
    startStatus.textContent = "Still connecting to Firebase...";
    return;
  }
  const usernameRaw = startUsernameInput.value.trim();
  const name        = saveNameInput.value.trim();

  if(!usernameRaw){
    startStatus.textContent = "Please enter a username.";
    return;
  }
  if(!name){
    startStatus.textContent = "Please enter a save name.";
    return;
  }

  const userKey = normalizeUsername(usernameRaw);
  if(!userKey){
    startStatus.textContent = "Invalid username.";
    return;
  }

  const ref  = doc(db, "mqUsers", userKey);
  const snap = await getDoc(ref);
  if(!snap.exists()){
    // first time this username is used
    await setDoc(ref, {
      username: usernameRaw,
      ownerUid: currentUser.uid,
      createdAt: Date.now(),
      saves: {}
    }, { merge:true });
    savesCache = {};
  } else {
    const data = snap.data() || {};
    savesCache = data.saves || {};
  }

  currentUsername = usernameRaw;
  currentSaveName = name;

  gameState = createNewGameState(name);
  await saveGame();
  startOverlay.classList.remove("visible");
  addLog("System", `New game started for "${currentUsername}" with save "${currentSaveName}".`);
  renderMap();
};

// LOAD GAME ‚Äî username + save name
btnLoadGame.onclick = async ()=>{
  if(!currentUser){
    startStatus.textContent = "Still connecting to Firebase...";
    return;
  }
  const usernameRaw = startUsernameInput.value.trim();
  const name        = saveNameInput.value.trim();

  if(!usernameRaw){
    startStatus.textContent = "Please enter a username.";
    return;
  }
  if(!name){
    startStatus.textContent = "Please enter a save name.";
    return;
  }

  const ok = await loadGameByUserAndName(usernameRaw, name);
  if(!ok){
    startStatus.textContent = `No save "${name}" found for user "${usernameRaw}".`;
  } else {
    startOverlay.classList.remove("visible");
  }
};

// Internal helper: load a save for a specific username
async function loadGameByUserAndName(usernameRaw, saveName){
  const userKey = normalizeUsername(usernameRaw);
  if(!userKey || !saveName) return false;

  const ref  = doc(db, "mqUsers", userKey);
  const snap = await getDoc(ref);
  if(!snap.exists()) return false;

  const data  = snap.data() || {};
  const saves = data.saves || {};
  const stored = saves[saveName];
  if(!stored) return false;

  currentUsername = data.username || usernameRaw;
  currentSaveName = saveName;
  savesCache      = saves;

  gameState = deserializeGameState(stored);
  saveTagEl.textContent = `${currentUsername} ‚Ä¢ ${currentSaveName}`;
  addLog("System", `Loaded "${currentSaveName}" for "${currentUsername}".`);
  renderMap();
  return true;
}

// Optional helper: still keep a loadSavesCache for any old calls.
// If no username is known yet, it just clears the cache.
async function loadSavesCache(usernameRaw){
  const nameToUse = usernameRaw || currentUsername;
  if(!nameToUse || !currentUser){
    savesCache = {};
    return;
  }
  const userKey = normalizeUsername(nameToUse);
  if(!userKey){
    savesCache = {};
    return;
  }
  const ref  = doc(db, "mqUsers", userKey);
  const snap = await getDoc(ref);
  if(!snap.exists()){
    savesCache = {};
    return;
  }
  const data = snap.data() || {};
  savesCache = data.saves || {};
}

// Save current game for the active username + save name
async function saveGame(){
  if(!currentUser || !gameState || !currentSaveName || !currentUsername) return;

  const userKey = normalizeUsername(currentUsername);
  if(!userKey) return;

  const ref       = doc(db, "mqUsers", userKey);
  const safeState = serializeGameState(gameState);  // <-- no nested arrays
  if(!safeState) return;

  // update cache with serialized state
  savesCache[currentSaveName] = safeState;

  await setDoc(ref,{
    username: currentUsername,
    ownerUid: currentUser.uid,
    lastUpdated: Date.now(),
    saves: savesCache
  },{merge:true});

  saveTagEl.textContent = `${currentUsername} ‚Ä¢ ${currentSaveName}`;
}

let saveTimeout = null;
function autoSaveDebounced(){
  if(!currentUser || !gameState) return;
  if(saveTimeout) clearTimeout(saveTimeout);
  saveTimeout = setTimeout(()=>{ saveGame().catch(console.error); }, 800);
}

// Quick load by name for *current* username
async function loadGameByName(name){
  if(!name) return false;

  // If no currentUsername yet, try to grab from the start screen input
  if(!currentUsername && startUsernameInput){
    const typed = startUsernameInput.value.trim();
    if(typed) currentUsername = typed;
  }
  if(!currentUsername) return false;

  return loadGameByUserAndName(currentUsername, name);
}

// Create a brand new game state (unchanged)
function createNewGameState(name){
  const tiles = generateMap();
  const starters = ["blazefox","tidalfin","leafling"];
  const starterId = starters[Math.floor(Math.random()*starters.length)];
  const starter = createCritterFromSpecies(starterId,3);
  return {
    saveName:name,
    createdAt:Date.now(),
    lastPlayed:Date.now(),
    player:{
      money:300,
      potions:3,
      balls:{basic:10,great:3,ultra:1},
      roster:[starter]
    },
    map:{
      tiles,
      playerX:2,
      playerY:MAP_H-2
    }
  };
}

// Quick save/load controls on right pane
const quickSaveNameInput=document.getElementById("quickSaveName");
document.getElementById("btnQuickSave").onclick = ()=>saveGame().catch(console.error);
document.getElementById("btnQuickLoad").onclick = async ()=>{
  const name = quickSaveNameInput.value.trim();
  if(!name) return;
  await loadGameByName(name);
};

  document.getElementById("btnCenter").onclick = centerOnPlayer;

  // ----------------------------------------
  // Auth bootstrap
  // ----------------------------------------
  // ----------------------------------------
// Auth bootstrap
// ----------------------------------------
onAuthStateChanged(auth, async user=>{
  if(user){
    currentUser = user;
    userTagEl.textContent = `Anon UID: ${user.uid.slice(0,8)}‚Ä¶`;
    // Username + save are chosen on the start menu now
    openStartMenu();
  }else{
    userTagEl.textContent = "Signing in anonymously‚Ä¶";
    signInAnonymously(auth).catch(err=>{
      console.error(err);
      userTagEl.textContent = "Auth error. See console.";
    });
  }
});

</script>
</body>
</html>





















