<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>üèõÔ∏è History Rush</title>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<style>
  :root{
    --ink:#0f172a; --muted:#6b7280; --bg:#fff7f7; --br:#f3e2e2; --card:#fff;
    --accent:#b91c1c; --accent-2:#991b1b; --accent-soft:#fee2e2;
    --good:#16a34a; --warn:#f59e0b; --bad:#ef4444;
    --shadow:0 10px 30px rgba(15,23,42,.08); --radius:16px; --radius-sm:12px; --tap:52px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--ink);background:var(--bg)}

  .shell{max-width:1100px;margin:0 auto;padding:10px 12px 28px}
  .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:10px 0}
  .leftrow{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .badge{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--br);border-radius:999px;background:var(--card);box-shadow:var(--shadow);font-weight:800}
  .btn{appearance:none;border:1px solid var(--br);background:var(--accent);color:#fff;border-radius:12px;padding:12px 14px;font-weight:800;cursor:pointer}
  .btn:hover{background:var(--accent-2)}
  .btn-ghost{background:#fff;color:var(--ink)}
  .btn-ghost:hover{background:#fff5f5}
  .card{background:var(--card);border:1px solid var(--br);border-radius:var(--radius);box-shadow:var(--shadow)}
  .card-head{padding:12px 14px;border-bottom:1px solid var(--br);display:flex;align-items:center;justify-content:space-between}
  .card-title{font-weight:900}
  .card-body{padding:14px}

  /* Scoreboard */
  .scorebar{display:flex;gap:10px;flex-wrap:wrap}
  .pill{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:10px;border:1px solid var(--br);background:#fff;font-weight:800}
  .dot{width:12px;height:12px;border-radius:50%}

  /* Voting */
  .voting{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px}
  .era{padding:10px;border:1px solid var(--br);border-radius:12px;background:#fff;display:flex;align-items:center;justify-content:space-between;gap:8px}
  .era[aria-disabled="true"]{opacity:.5;pointer-events:none}
  .era .pick{font-weight:900}
  .vote-row{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-top:10px}
  .timer{font-weight:900;color:#7f1d1d}

  /* Board */
  .board-wrap{position:relative;margin-top:12px}
  .board{display:grid;grid-template-columns:repeat(8,1fr);grid-auto-rows:1fr;gap:6px;position:relative}
  /* Phone fit: we aim to keep the 8x8 fully visible */
  .board{max-width:100vw;aspect-ratio:1/1}
  .tile{
    position:relative;background:#f3f4f6;border:2px solid #d1d5db;border-radius:8px;overflow:hidden;cursor:pointer;
  }
  .tile.owner-0{border-color:var(--p0)}
  .tile.owner-1{border-color:var(--p1)}
  .tile.owner-2{border-color:var(--p2)}
  .tile.owner-3{border-color:var(--p3)}
  .stack{position:absolute;left:1px;right:1px;bottom:1px;display:flex;flex-direction:column-reverse;height:80%;gap:1px}
  .seg{width:100%}
  .mini{position:absolute;inset:0;pointer-events:none}
  .mini label{position:absolute;padding:2px 6px;border-radius:8px;background:rgba(255,255,255,.85);border:1px solid var(--br);font-size:12px;font-weight:900}
  .mini .tl{top:4px;left:6px}
  .mini .tr{top:4px;right:6px}
  .mini .bl{bottom:4px;left:6px}
  .mini .br{bottom:4px;right:6px}

  /* Region underlays (soft colors behind tiles) */
  .underlays{position:absolute;inset:0;pointer-events:none;z-index:-1;display:grid;grid-template-columns:1fr 1fr;grid-template-rows:1fr 1fr;gap:6px}
  .underlays > div{border-radius:10px;opacity:.25}
  .r0{background:var(--r0)}
  .r1{background:var(--r1)}
  .r2{background:var(--r2)}
  .r3{background:var(--r3)}

  /* Modal */
  .modal-back{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:16px;z-index:1000}
  .modal{width:min(720px,96vw);background:#fff;border-radius:16px;border:1px solid var(--br);box-shadow:var(--shadow);overflow:hidden}
  .modal .head{padding:12px 14px;border-bottom:1px solid var(--br);display:flex;justify-content:space-between;align-items:center}
  .modal .body{padding:14px}
  .opts{display:grid;gap:10px}
  .opt{padding:12px;border:1px solid var(--br);border-radius:12px;background:#fff;font-weight:800;cursor:pointer}
  .opt:hover{background:#fff5f5}
  .closebar{display:flex;justify-content:flex-end;margin-top:10px}

  /* Winner overlay */
  .winner{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:1050}
  .win-card{background:#fff;border:1px solid var(--br);border-radius:18px;box-shadow:var(--shadow);padding:18px 16px;text-align:center}
  .win-card h2{margin:8px 0}

  /* Colors for players and regions (assigned at runtime) */
</style>
</head>
<body>
<div class="shell">
  <div class="topbar">
    <div class="leftrow">
      <span class="badge">üèõÔ∏è History Rush</span>
      <span id="statusBadge" class="badge">Loading‚Ä¶</span>
    </div>
    <div class="leftrow">
      <button id="fitBtn" class="btn btn-ghost" title="Fullscreen / Fit">‚õ∂ Fit</button>
      <a href="/index.html" class="btn btn-ghost">üè† Hub</a>
    </div>
  </div>

  <!-- SCOREBOARD -->
  <div class="card" id="scoreCard">
    <div class="card-head">
      <div class="card-title">Scoreboard</div>
      <div id="nextTick" class="muted"></div>
    </div>
    <div class="card-body">
      <div id="scorebar" class="scorebar"></div>
    </div>
  </div>

  <!-- VOTING -->
  <div class="card" id="voteCard" style="margin-top:12px">
    <div class="card-head">
      <div class="card-title">Choose your Era (unique picks)</div>
      <div class="timer" id="voteTimer">‚Äî</div>
    </div>
    <div class="card-body">
      <div class="voting" id="erasGrid"></div>
      <div class="vote-row">
        <div class="muted">Each player selects one unique era. After 20s, any remaining slots are filled randomly.</div>
        <div><span class="badge" id="pickedBadge">None selected</span></div>
      </div>
    </div>
  </div>

  <!-- BOARD -->
  <div class="card" id="boardCard" style="margin-top:12px; display:none">
    <div class="card-head">
      <div class="card-title">Board</div>
      <div class="muted">Tap a square to answer a question from that region.</div>
    </div>
    <div class="card-body">
      <div class="board-wrap">
        <!-- region labels -->
        <div class="mini">
          <label class="tl" id="labelTL">‚Äî</label>
          <label class="tr" id="labelTR">‚Äî</label>
          <label class="bl" id="labelBL">‚Äî</label>
          <label class="br" id="labelBR">‚Äî</label>
        </div>
        <!-- region color underlays -->
        <div class="underlays">
          <div class="r0"></div>
          <div class="r1"></div>
          <div class="r2"></div>
          <div class="r3"></div>
        </div>
        <!-- 8x8 board -->
        <div id="board" class="board"></div>
      </div>
    </div>
  </div>
</div>

<!-- QUESTION MODAL -->
<div id="modalBack" class="modal-back" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="head"><div id="modalTitle" class="card-title">Question</div>
      <button id="closeModal" class="btn btn-ghost">Close</button>
    </div>
    <div class="body">
      <div id="qText" style="font-weight:900;margin-bottom:10px">‚Äî</div>
      <div id="qOpts" class="opts"></div>
      <div id="qFeedback" class="muted" style="margin-top:8px"></div>
      <div class="closebar">
        <button id="nextQ" class="btn" style="display:none">Next Question</button>
      </div>
    </div>
  </div>
</div>

<!-- WINNER -->
<div id="winnerBack" class="winner">
  <div class="win-card">
    <h2 id="winText">üëë Winner</h2>
    <div class="muted">Returning to the lobby‚Ä¶</div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, runTransaction
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // ---------- CONFIG ----------
  const firebaseConfig = {
    apiKey: "AIzaSyB7twY7z31ucB6pGA8JC_HrVMZhA8lNaJA",
    authDomain: "bible-game-246c0.firebaseapp.com",
    projectId: "bible-game-246c0",
    storageBucket: "bible-game-246c0.appspot.com",
    messagingSenderId: "959619818996",
    appId: "1:959619818996:web:5a9fbf492e23c765e445a1"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ---------- PARAMS ----------
  const params = new URLSearchParams(location.search);
  const gameId = params.get("gameId");
  const username = params.get("username");
  if (!gameId || !username) {
    alert("Missing gameId or username. Launch from the lobby.");
  }

  // ---------- DOCS ----------
  const lobbyRef = doc(db, "lobbies", gameId);
  const stateRef = doc(db, "lobbies", gameId, "historyrush", "state");

  // ---------- CONSTANTS ----------
  const ERAS = [
    "Rome", "Ancient China", "Ancient Inca", "Ancient Aztec", "Ancient Egypt", "Ancient Mali", "Scandinavia"
  ];
  // region order (top-left, top-right, bottom-left, bottom-right)
  const REGIONS = ["TL","TR","BL","BR"];
  const REGION_IDX = {TL:0, TR:1, BL:2, BR:3};
  const REGION_LABEL_IDS = {TL:"labelTL", TR:"labelTR", BL:"labelBL", BR:"labelBR"};
  // region colors (soft underlays)
  const regionSoft = ["#a5b4fc","#86efac","#fde68a","#fca5a5"];
  document.documentElement.style.setProperty("--r0", regionSoft[0]);
  document.documentElement.style.setProperty("--r1", regionSoft[1]);
  document.documentElement.style.setProperty("--r2", regionSoft[2]);
  document.documentElement.style.setProperty("--r3", regionSoft[3]);

  // player colors
  const PLAYER_COLORS = ["#ef4444","#3b82f6","#10b981","#f59e0b"];
  let players = [];      // populated from lobby
  let isHost = false;    // from lobby.host === username

  // runtime
  let state = null;
  let myVote = null;
  let currentCellIndex = null;
  let currentEraForModal = null;
  let questionQueue = []; // subsequent questions for "Next"
  let scoreTickTimer = null;
  let voteCountdownTimer = null;

  // ---------- UTIL ----------
  const $ = (id)=>document.getElementById(id);
  function setStatus(msg){ $("statusBadge").textContent = msg; }
  function uniq(arr){ return Array.from(new Set(arr)); }
  function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }
  function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }
  function nowMs(){ return Date.now(); }

  // map name -> stable color index
  function colorIndex(name){
    const idx = players.slice().sort().indexOf(name);
    return Math.max(0, idx) % 4;
  }
  function applyPlayerColorVars(){
    document.documentElement.style.setProperty("--p0", PLAYER_COLORS[0]);
    document.documentElement.style.setProperty("--p1", PLAYER_COLORS[1]);
    document.documentElement.style.setProperty("--p2", PLAYER_COLORS[2]);
    document.documentElement.style.setProperty("--p3", PLAYER_COLORS[3]);
  }

  // get region for a cell index (0..63)
  function cellRegion(cell){
    const r = Math.floor(cell / 8), c = cell % 8;
    if (r < 4 && c < 4) return "TL";
    if (r < 4 && c >=4) return "TR";
    if (r >=4 && c < 4) return "BL";
    return "BR";
  }

  function eraForCell(cell){
    const reg = cellRegion(cell);
    const eraMap = state?.eraMap || {};
    return eraMap[reg] || null;
  }

  // compute owner (>50%) of a cell shares map
  function ownerOf(shares){
    let winner=null, max=0;
    for(const [k,v] of Object.entries(shares||{})){
      if (v>max){ max=v; winner=k; }
    }
    if (max>50) return winner;
    return null;
  }

  // region dominance:
  // each 4x4 region is partitioned into four 2x2 mini-blocks (the ‚Äú4 boxes‚Äù).
  // A player ‚Äúowns‚Äù a mini-block if they own (>50%) at least 3 of its 4 cells.
  // A region is controlled if a player owns at least 3 of the 4 mini-blocks.
  function regionController(regionKey, cells){
    const baseR = regionKey==="TL" ? 0 : regionKey==="TR" ? 0 : regionKey==="BL" ? 4 : 4;
    const baseC = regionKey==="TL" ? 0 : regionKey==="TR" ? 4 : regionKey==="BL" ? 0 : 4;
    const miniBases = [
      {r:0,c:0},{r:0,c:2},{r:2,c:0},{r:2,c:2}
    ];
    const miniOwners = []; // owner per mini-block
    for(const mb of miniBases){
      const cellsIdx = [];
      for(let dr=0; dr<2; dr++){
        for(let dc=0; dc<2; dc++){
          const rr = baseR + mb.r + dr;
          const cc = baseC + mb.c + dc;
          const i = rr*8+cc;
          cellsIdx.push(i);
        }
      }
      const owners = cellsIdx.map(i => ownerOf(cells[i]?.shares||{})).filter(Boolean);
      // count by name
      const tally = {}; owners.forEach(o=>tally[o]=(tally[o]||0)+1);
      let best=null, cnt=0;
      for(const [k,v] of Object.entries(tally)){ if (v>cnt){cnt=v; best=k;} }
      // must own >=3 of 4
      miniOwners.push(cnt>=3 ? best : null);
    }
    // overall region owner: someone who owns >=3 mini-blocks
    const tally={}; miniOwners.forEach(o=>{ if(o) tally[o]=(tally[o]||0)+1; });
    let best=null, cnt=0;
    for(const [k,v] of Object.entries(tally)){ if (v>cnt){cnt=v; best=k;} }
    return (cnt>=3) ? best : null;
  }

  // ---------- INITIALIZE UI ----------
  applyPlayerColorVars();
  $("fitBtn").onclick = async () => {
    try{
      if (!document.fullscreenElement) { await document.documentElement.requestFullscreen(); }
      else { await document.exitFullscreen(); }
    }catch(e){}
  };

  // build board tiles
  const boardEl = $("board");
  const tiles = [];
  for (let i=0;i<64;i++){
    const div = document.createElement("div");
    div.className="tile";
    div.setAttribute("data-idx", i);
    const stack = document.createElement("div"); stack.className="stack";
    div.appendChild(stack);
    div.addEventListener("click", ()=> onTileClick(i));
    boardEl.appendChild(div);
    tiles.push(div);
  }

  // ---------- LOBBY SNAP (players + host) ----------
  onSnapshot(lobbyRef, (snap)=>{
    const d = snap.data();
    if (!d) return;
    players = (d.players||[]).slice(0,4);
    isHost = (d.host === username);
    renderScorebar(); // ensures pills exist with names
  });

  // ---------- STATE SNAP ----------
  onSnapshot(stateRef, (snap)=>{
    if (!snap.exists()) {
      bootstrapState();
      return;
    }
    state = snap.data();
    // status + timers
    updateStatusBadges();
    renderScorebar();
    renderVoting();
    renderBoard();

    // winner?
    if (state.status === "finished" && state.winner){
      $("winText").textContent = `üëë ${state.winner} wins!`;
      $("winnerBack").style.display = "flex";
      setTimeout(()=>{ location.href="/index.html"; }, 3500);
    }
  });

  // ---------- BOOTSTRAP ----------
  async function bootstrapState(){
    // read lobby first
    const lob = await getDoc(lobbyRef);
    const lp = (lob.exists() && Array.isArray(lob.data().players)) ? lob.data().players.slice(0,4) : [username];
    const init = {
      status:"voting",
      votingEndsAt: Date.now()+20000, // 20s
      votes:{},
      players: lp,
      eraMap:{},             // {TL:"Rome",TR:"‚Ä¶",BL:"‚Ä¶",BR:"‚Ä¶"}
      scores:{},             // {name: points}
      lastScoreTick: Date.now(),
      winner:null,
      // 64 cells with shares: {}
      cells: Array.from({length:64}, ()=>({shares:{}}))
    };
    lp.forEach(n=> init.scores[n]=0);
    await setDoc(stateRef, init);
  }

  // ---------- STATUS / TIMERS ----------
  function updateStatusBadges(){
    const st = state?.status || "‚Äî";
    if (st==="voting"){
      setStatus("Voting");
      $("voteCard").style.display="block";
      $("boardCard").style.display="none";
      startVoteCountdown();
    } else if (st==="playing"){
      setStatus("Playing");
      $("voteCard").style.display="none";
      $("boardCard").style.display="block";
      stopVoteCountdown();
    } else if (st==="finished"){
      setStatus("Finished");
      $("voteCard").style.display="none";
      $("boardCard").style.display="none";
      stopVoteCountdown();
    }
  }
  function startVoteCountdown(){
    stopVoteCountdown();
    tickVoteTimer();
    voteCountdownTimer = setInterval(tickVoteTimer, 300);
    // host responsibility to finalize
    if (isHost) ensureScoreTicker();
  }
  function stopVoteCountdown(){
    if (voteCountdownTimer){ clearInterval(voteCountdownTimer); voteCountdownTimer=null; }
  }
  function tickVoteTimer(){
    if (!state?.votingEndsAt){ $("voteTimer").textContent="‚Äî"; return; }
    const ms = Math.max(0, state.votingEndsAt - Date.now());
    const s = Math.ceil(ms/1000);
    $("voteTimer").textContent = `Time left: ${s}s`;
    if (ms<=0 && isHost && state.status==="voting"){ finalizeVoting(); }
  }

  // ---------- VOTING ----------
  function renderVoting(){
    if (state?.status!=="voting") return;
    const used = new Set(Object.values(state.votes||{}));
    const grid = $("erasGrid");
    grid.innerHTML = "";
    for (const era of ERAS){
      const row = document.createElement("div");
      row.className="era";
      const left = document.createElement("div");
      const name = document.createElement("div"); name.className="pick"; name.textContent = era;
      const tiny = document.createElement("div"); tiny.className="muted"; tiny.textContent = used.has(era) ? "Taken" : "";
      left.appendChild(name); left.appendChild(tiny);
      const btn = document.createElement("button");
      btn.className = "btn btn-ghost";
      btn.textContent = (state.votes?.[username] === era) ? "Selected" : "Select";
      if (state.votes?.[username] && state.votes[username] !== era) btn.disabled = true;
      if (used.has(era) && state.votes?.[username] !== era) {
        row.setAttribute("aria-disabled","true");
      }
      btn.onclick = ()=> castVote(era);
      row.appendChild(left); row.appendChild(btn);
      grid.appendChild(row);
    }
    const my = state.votes?.[username];
    $("pickedBadge").textContent = my ? `Your pick: ${my}` : "None selected";
  }

  async function castVote(era){
    try{
      await runTransaction(db, async (tx)=>{
        const s = await tx.get(stateRef);
        if (!s.exists()) throw new Error("no state");
        const d = s.data();
        if (d.status!=="voting") throw new Error("voting closed");
        // uniqueness
        const used = new Set(Object.values(d.votes||{}));
        const myPrev = d.votes?.[username];
        if (used.has(era) && myPrev !== era) throw new Error("Era already taken");
        tx.update(stateRef, { [`votes.${username}`]: era });
      });
    }catch(e){ alert(e.message||"Failed to vote"); }
  }

  async function finalizeVoting(){
    // close voting, assign 4 eras (unique), fill with random if <4
    try{
      await runTransaction(db, async (tx)=>{
        const s = await tx.get(stateRef);
        if (!s.exists()) throw new Error("no state");
        const d = s.data();
        if (d.status!=="voting") return;
        const picks = Object.values(d.votes||{});
        const unique = uniq(picks);
        const remain = ERAS.filter(x=> !unique.includes(x));
        // Need 4 total
        while (unique.length < 4 && remain.length>0){
          unique.push(remain.splice(Math.floor(Math.random()*remain.length),1)[0]);
        }
        // If somehow >4 (shouldn't with uniqueness), cap at 4
        const chosen = unique.slice(0,4);
        const eraMap = {TL: chosen[0]||remain.pop()||"Rome",
                        TR: chosen[1]||remain.pop()||"Ancient China",
                        BL: chosen[2]||remain.pop()||"Ancient Egypt",
                        BR: chosen[3]||remain.pop()||"Scandinavia"};
        tx.update(stateRef, {
          status:"playing",
          eraMap,
          // ensure timers
          lastScoreTick: Date.now(),
        });
      });
    }catch(e){ console.error(e); }
  }

  // ---------- BOARD RENDER ----------
  function renderBoard(){
    if (!state) return;
    // region labels
    for(const [k, id] of Object.entries(REGION_LABEL_IDS)){
      const label = $(id);
      label.textContent = state.eraMap?.[k] || "‚Äî";
    }
    // tiles
    const cells = state.cells || [];
    for(let i=0;i<64;i++){
      const el = tiles[i];
      const shares = (cells[i] && cells[i].shares) || {};
      const stack = el.querySelector(".stack");
      stack.innerHTML = ""; // draw stack segments representing shares
      // compute owner
      const own = ownerOf(shares);
      el.classList.remove("owner-0","owner-1","owner-2","owner-3");
      if (own){
        const ci = colorIndex(own);
        el.classList.add(`owner-${ci}`);
      }
      // segments (stacked)
      // order by players stable
      const order = players.slice().sort();
      for(const p of order){
        const pct = Math.round((shares[p]||0)*10)/10;
        if (pct>0){
          const seg = document.createElement("div");
          seg.className="seg";
          seg.style.height = pct + "%";
          seg.style.background = PLAYER_COLORS[colorIndex(p)];
          seg.title = `${p}: ${pct}%`;
          stack.appendChild(seg);
        }
      }
    }
    // host scoring ticker
    if (state.status==="playing" && isHost) ensureScoreTicker();
  }

  // ---------- SCOREBOARD ----------
  function renderScorebar(){
    const bar = $("scorebar");
    const scores = state?.scores || {};
    const names = players.slice().sort();
    bar.innerHTML = "";
    for(const name of names){
      const pill = document.createElement("div"); pill.className="pill";
      const dot = document.createElement("span"); dot.className="dot"; dot.style.background = PLAYER_COLORS[colorIndex(name)];
      const nm = document.createElement("span"); nm.textContent = name;
      const sc = document.createElement("span"); sc.className="muted"; sc.textContent = `‚Äî ${scores[name]||0}`;
      pill.appendChild(dot); pill.appendChild(nm); pill.appendChild(sc);
      bar.appendChild(pill);
    }
  }

  // ---------- TILE INTERACTION / QUESTIONS ----------
  function onTileClick(idx){
    if (state?.status!=="playing") return;
    currentCellIndex = idx;
    currentEraForModal = eraForCell(idx);
    if (!currentEraForModal){ alert("No era assigned here yet."); return; }
    questionQueue = []; // reset
    openQuestion(currentEraForModal);
  }

  function openQuestion(era){
    const q = getRandomQuestion(era);
    if (!q){ alert("No questions available."); return; }
    $("modalTitle").textContent = `${era} ‚Äî Trivia`;
    $("qText").textContent = q.q;
    const opts = shuffle([q.a, ...q.wrong]);
    const box = $("qOpts"); box.innerHTML = "";
    $("qFeedback").textContent = "";
    $("nextQ").style.display = "none";
    opts.forEach(text=>{
      const b = document.createElement("button");
      b.className="opt"; b.textContent=text;
      b.onclick = ()=> evaluateAnswer(q, text===q.a);
      box.appendChild(b);
    });
    $("modalBack").style.display="flex";
  }

  $("closeModal").onclick = ()=> { $("modalBack").style.display="none"; currentCellIndex=null; };
  $("nextQ").onclick = ()=> { openQuestion(currentEraForModal); };

  async function evaluateAnswer(q, correct){
    let feedback="";
    if (correct){
      feedback="‚úÖ Correct! You gain +10% share.";
      await adjustCellShare(currentCellIndex, username, +10);
      $("nextQ").style.display = "inline-flex";
    }else{
      feedback="‚ùå Incorrect. You lose up to 20% of your share here.";
      await adjustCellShare(currentCellIndex, username, -20);
      // don't force another question; user can close or try again later
      $("nextQ").style.display = "none";
    }
    $("qFeedback").textContent = feedback;
  }

  // ---------- SHARE MATH (transactional) ----------
  async function adjustCellShare(cellIdx, player, delta){
    try{
      await runTransaction(db, async (tx)=>{
        const snap = await tx.get(stateRef);
        if (!snap.exists()) throw new Error("no state");
        const d = snap.data();
        if (d.status!=="playing") return;
        const cells = d.cells || [];
        const cell = cells[cellIdx] || {shares:{}};
        const shares = Object.assign({}, cell.shares||{});
        const cur = shares[player] || 0;
        if (delta>0){
          // If total < 100: just add up to 100
          const sum = Object.values(shares).reduce((a,b)=>a+(b||0),0);
          if (sum < 100){
            const add = Math.min(delta, 100 - sum);
            shares[player] = clamp(cur + add, 0, 100);
          } else {
            // total == 100 -> increase player by +delta and reduce others by -delta proportionally
            const others = Object.keys(shares).filter(k=>k!==player);
            const sumOthers = others.reduce((a,k)=>a+(shares[k]||0),0);
            shares[player] = clamp(cur + delta, 0, 100);
            if (sumOthers>0){
              for(const k of others){
                const cut = delta * ((shares[k]||0)/sumOthers);
                shares[k] = clamp((shares[k]||0) - cut, 0, 100);
              }
            }
            // tidy rounding so totals ~100
            const total = Object.values(shares).reduce((a,b)=>a+(b||0),0);
            const diff = 100 - total;
            shares[player] = clamp((shares[player]||0)+diff, 0, 100);
          }
        } else {
          // negative: lose up to 20% (abs), not below 0
          const lose = Math.min(Math.abs(delta), cur);
          shares[player] = clamp(cur - lose, 0, 100);
        }
        // assign back
        cells[cellIdx] = {shares};
        tx.update(stateRef, { cells });
      });
    }catch(e){ console.error(e); }
  }

  // ---------- HOST SCORING TICK ----------
  function ensureScoreTicker(){
    if (scoreTickTimer) return;
    // host computes every 20s
    scoreTickTimer = setInterval(()=> hostTick(), 1000);
  }
  async function hostTick(){
    const s = await getDoc(stateRef);
    if (!s.exists()) return;
    const d = s.data();
    if (d.status!=="playing") return;
    const last = d.lastScoreTick || 0;
    const now = Date.now();
    const remain = Math.max(0, Math.ceil((last+20000 - now)/1000));
    $("nextTick").textContent = remain>0 ? `Next scoring in ${remain}s` : `Scoring‚Ä¶`;
    if (now - last < 20000) return;

    // compute scores for this tick
    const inc = {}; (d.players||[]).forEach(n=> inc[n]=0);
    const cells = d.cells||[];
    // 1 point per owned cell
    for(let i=0;i<64;i++){
      const own = ownerOf(cells[i]?.shares||{});
      if (own) inc[own] = (inc[own]||0) + 1;
    }
    // 5 points per owned region
    const regions = ["TL","TR","BL","BR"];
    for(const rk of regions){
      const ctrl = regionController(rk, cells);
      if (ctrl) inc[ctrl] = (inc[ctrl]||0) + 5;
    }

    // accumulate
    const newScores = Object.assign({}, d.scores||{});
    for(const [k,v] of Object.entries(inc)){ newScores[k] = (newScores[k]||0) + v; }

    // winner?
    let winner=null; let top=0;
    for(const [k,v] of Object.entries(newScores)){ if (v>=50 && v>top){top=v; winner=k;} }

    await updateDoc(stateRef, {
      scores: newScores,
      lastScoreTick: now,
      winner: winner || null,
      status: winner ? "finished" : "playing"
    });
  }
const QUESTIONS = {
  "Rome": [
    {q:"Who defeated Mark Antony at the Battle of Actium (31 BC)?", a:"Octavian", wrong:["Julius Caesar","Pompey","Brutus"]},
    {q:"Which office was held by two leaders annually during the Republic?", a:"Consul", wrong:["Tribune","Praetor","Censor"]},
    {q:"What was the basic silver coin of the Roman Republic and early Empire?", a:"Denarius", wrong:["Sestertius","Aureus","Solidus"]},
    {q:"Which engineering work carried water into cities?", a:"Aqueduct", wrong:["Circus","Forum","Thermae"]},
    {q:"Which emperor built a wall across northern Britannia c. AD 122?", a:"Hadrian", wrong:["Trajan","Nero","Claudius"]},
    {q:"The famous dome with an oculus in Rome is the:", a:"Pantheon", wrong:["Curia","Colosseum","Basilica Julia"]},
    {q:"Which legal code first inscribed Roman law in the Republic?", a:"Twelve Tables", wrong:["Corpus Juris Civilis","Magna Carta","Code of Hammurabi"]},
    {q:"Who crossed the Rubicon in 49 BC?", a:"Julius Caesar", wrong:["Sulla","Crassus","Cicero"]},
    {q:"Which battle saw three legions lost to Arminius in AD 9?", a:"Teutoburg Forest", wrong:["Pharsalus","Cannae","Zama"]},
    {q:"Which emperor legalized Christianity in AD 313?", a:"Constantine", wrong:["Diocletian","Valens","Theodosius I"]},
    {q:"Which Roman road linked Rome to Brundisium?", a:"Via Appia", wrong:["Via Flaminia","Via Aemilia","Via Augusta"]},
    {q:"Which volcano buried Pompeii and Herculaneum?", a:"Vesuvius", wrong:["Etna","Stromboli","Vulcano"]},
    {q:"What title was used for the Roman peace from Augustus to Marcus Aurelius?", a:"Pax Romana", wrong:["Pax Deorum","Pax Britannica","Pax Augusta"]},
    {q:"Which emperor‚Äôs column commemorates the Dacian Wars?", a:"Trajan", wrong:["Tiberius","Domitian","Caracalla"]},
    {q:"What was the large chariot-racing stadium in Rome?", a:"Circus Maximus", wrong:["Theatre of Marcellus","Stadium of Domitian","Forum Boarium"]},
    {q:"Which general famously used war elephants against Rome?", a:"Hannibal", wrong:["Pyrrhus","Mithridates","Vercingetorix"]},
    {q:"The year AD 69 is known as the:", a:"Year of the Four Emperors", wrong:["Great Interregnum","Late Republic","Crisis of the Third Century"]},
    {q:"Which reform split the Empire into a Tetrarchy?", a:"Diocletian‚Äôs reforms", wrong:["Gracchan reforms","Marian reforms","Augustan settlement"]},
    {q:"Which province contained the city of Carthage after 146 BC?", a:"Africa", wrong:["Aegyptus","Asia","Syria"]},
    {q:"What was a Roman public bath complex called?", a:"Thermae", wrong:["Insula","Domus","Curia"]},
    {q:"Which battle ended the Second Punic War?", a:"Zama", wrong:["Cannae","Lake Trasimene","Metaurus"]},
    {q:"Which office could veto actions to protect plebeians?", a:"Tribune of the Plebs", wrong:["Aedile","Quaestor","Pontifex Maximus"]},
    {q:"Which emperor built a massive defensive line in Germany called the Limes?", a:"Domitian", wrong:["Caligula","Otho","Nerva"]},
    {q:"Which philosopher-emperor wrote the 'Meditations'?", a:"Marcus Aurelius", wrong:["Seneca","Cicero","Pliny the Younger"]},
    {q:"Which city became capital of the Eastern Roman Empire?", a:"Constantinople", wrong:["Ravenna","Antioch","Alexandria"]},
    {q:"Which revolt led by Spartacus troubled Rome in 73‚Äì71 BC?", a:"Third Servile War", wrong:["Catilinarian Conspiracy","Social War","Jugurthine War"]},
    {q:"Which emperor famously 'fiddled' during the Great Fire (legend)?", a:"Nero", wrong:["Claudius","Titus","Commodus"]},
    {q:"What was Rome‚Äôs central political and commercial area?", a:"Forum Romanum", wrong:["Campus Martius","Palatine","Velabrum"]},
    {q:"Which calendar reform created the Julian calendar?", a:"Caesar‚Äôs reform", wrong:["Sullan reform","Flavian reform","Antonine reform"]}
  ],
  "Ancient China": [
    {q:"Which concept justified dynastic change?", a:"Mandate of Heaven", wrong:["Covenant of Kings","Divine Right","Peace of Heaven"]},
    {q:"Who unified China in 221 BC?", a:"Qin Shi Huang", wrong:["Han Wudi","Liu Bang","Zhao Kuangyin"]},
    {q:"Which dynasty established long-distance Silk Road trade?", a:"Han", wrong:["Qin","Tang","Song"]},
    {q:"Who wrote 'The Art of War'?", a:"Sun Tzu", wrong:["Mozi","Mencius","Xunzi"]},
    {q:"Which philosophy emphasizes harmony with the Dao?", a:"Daoism", wrong:["Legalism","Mohism","Confucianism"]},
    {q:"Which project linked the Yellow and Yangtze rivers?", a:"Grand Canal", wrong:["Lingqu Canal","Dujiangyan","Great Wall moat"]},
    {q:"Movable-type printing was pioneered by:", a:"Bi Sheng", wrong:["Cai Lun","Zhang Heng","Shen Kuo"]},
    {q:"Paper was invented during which dynasty?", a:"Han", wrong:["Tang","Song","Yuan"]},
    {q:"Gunpowder was first formulated by:", a:"Tang alchemists", wrong:["Qin legions","Han scholars","Ming sailors"]},
    {q:"Which compass innovation aided navigation?", a:"Magnetized needle", wrong:["Sextant","Astrolabe","Chronometer"]},
    {q:"Which emperor sent Zheng He on maritime voyages?", a:"Yongle (Ming)", wrong:["Hongwu","Kangxi","Qianlong"]},
    {q:"Oracle bones are associated with which dynasty?", a:"Shang", wrong:["Zhou","Qin","Han"]},
    {q:"What did the civil service exams primarily test?", a:"Confucian classics", wrong:["Military science","Mathematics","Astronomy"]},
    {q:"Which ideology underpinned Qin administration?", a:"Legalism", wrong:["Confucianism","Daoism","Mohism"]},
    {q:"What is the name for fine Chinese pottery exported widely?", a:"Porcelain", wrong:["Earthenware","Faience","Stoneware"]},
    {q:"Which dynasty saw the rise of paper money?", a:"Song", wrong:["Han","Tang","Qing"]},
    {q:"Which city was capital under the Ming and home to the Forbidden City?", a:"Beijing", wrong:["Nanjing","Luoyang","Chang‚Äôan"]},
    {q:"What hardy rice boosted Song agriculture?", a:"Champa rice", wrong:["Sticky rice","Basmati","Red rice"]},
    {q:"The Great Wall we see largely reflects which dynasty‚Äôs work?", a:"Ming", wrong:["Qin","Han","Tang"]},
    {q:"Who compiled the 'Records of the Grand Historian'?", a:"Sima Qian", wrong:["Ban Gu","Zuo Qiuming","Sima Guang"]},
    {q:"Zhang Heng is credited with inventing a:", a:"Seismograph", wrong:["Steam engine","Gun lock","Pendulum clock"]},
    {q:"The Warring States period preceded which unifying dynasty?", a:"Qin", wrong:["Han","Sui","Tang"]},
    {q:"The tribute system centered on:", a:"Acknowledging Chinese supremacy", wrong:["Equal treaties","Colonial rule","Religious conversion"]},
    {q:"Which texts codified moral conduct and filial piety?", a:"Analects", wrong:["Daodejing","Book of Changes","Zhuangzi"]},
    {q:"The 'Four Great Inventions' include printing, paper, compass and:", a:"Gunpowder", wrong:["Steelmaking","Sails","Algebra"]},
    {q:"Who was the only female emperor in Chinese history?", a:"Wu Zetian", wrong:["Empress Dowager Cixi","Empress L√º","Lady Hao"]},
    {q:"Kublai Khan founded which dynasty in China?", a:"Yuan", wrong:["Liao","Song","Qing"]},
    {q:"Which canal system improved northern grain transport?", a:"Grand Canal", wrong:["Lingqu","Baiyang","Dujiangyan"]},
    {q:"Which spiritual system teaches the Way (Dao) and naturalness?", a:"Daoism", wrong:["Shinto","Buddhism","Zoroastrianism"]}
  ],
  "Ancient Inca": [
    {q:"The Inca ruler‚Äôs title was:", a:"Sapa Inca", wrong:["Tlatoani","Shah","Pharaoh"]},
    {q:"Inca knotted cords used for records were called:", a:"Quipu", wrong:["Codex","Runes","Script"]},
    {q:"The high fortress above Cusco is:", a:"Sacsayhuaman", wrong:["Tiwanaku","Chan Chan","Chichen Itza"]},
    {q:"Labor tax required of communities:", a:"Mit'a", wrong:["Corvee","Fealty","Gabella"]},
    {q:"Sun temple at Cusco:", a:"Coricancha", wrong:["Templo Mayor","Temple of Karnak","Qal'at"]},
    {q:"Inca relay messengers:", a:"Chasquis", wrong:["Coureurs","Heralds","Envoys"]},
    {q:"Andean terrace farming term:", a:"Andenes", wrong:["Chinampas","Polders","Paddies"]},
    {q:"Sacred landscape features were called:", a:"Huacas", wrong:["Stelae","Ziggurats","Kivas"]},
    {q:"Core social unit:", a:"Ayllu", wrong:["Clan","Phratry","Castellany"]},
    {q:"The Inca road network is known as:", a:"Qhapaq Nan", wrong:["Silk Road","Royal Road","Amber Road"]},
    {q:"Which animals were vital pack animals?", a:"Llamas", wrong:["Oxen","Horses","Camels"]},
    {q:"Freeze-dried potatoes were called:", a:"Chuno", wrong:["Taro","Poi","Gari"]},
    {q:"The Inca used no:", a:"Load-bearing wheeled vehicles", wrong:["Bridges","Farming tools","Textiles"]},
    {q:"Machu Picchu likely served as a:", a:"Royal estate", wrong:["Capital city","Fortified border","Copper mine"]},
    {q:"Conquistador who captured Atahualpa:", a:"Francisco Pizarro", wrong:["Hernan Cortes","Diego de Almagro","Vasco Nunez"]},
    {q:"Battle where Atahualpa was seized:", a:"Cajamarca", wrong:["Cuzco","Sacsayhuaman","Quito"]},
    {q:"Storehouses for food and goods:", a:"Qollqas", wrong:["Tambos","Haciendas","Longhouses"]},
    {q:"Way-stations along roads:", a:"Tambos", wrong:["Caravanserai","Mutras","Posadas"]},
    {q:"Principal sun god:", a:"Inti", wrong:["Viracocha","Quetzalcoatl","Huitzilopochtli"]},
    {q:"Architectural hallmark:", a:"Precisely cut ashlar masonry", wrong:["Mudbrick vaulting","Flying buttresses","Keystone arches"]},
    {q:"Cusco‚Äôs plan is traditionally likened to a:", a:"Puma", wrong:["Condor","Snake","Llama"]},
    {q:"Who expanded the empire dramatically in the 15th century?", a:"Pachacuti", wrong:["Moctezuma I","Huayna Capac","Tupac Yupanqui"]},
    {q:"Inca farming elevated fields and canals aimed to:", a:"Manage altitude and microclimates", wrong:["Grow rice paddies","Breed horses","Produce olives"]},
    {q:"Inca decimal administration grouped families by:", a:"Tens, hundreds, thousands", wrong:["Sevens","Dozens","Scores"]},
    {q:"After conquest, a major resistance leader was:", a:"Manco Inca", wrong:["Cuauhtemoc","Atlatl Cauac","Tecumseh"]},
    {q:"The Inca capital city:", a:"Cusco", wrong:["Tenochtitlan","Lima","La Paz"]},
    {q:"Language widely used in the empire:", a:"Quechua", wrong:["Nahuatl","Aymara","Mapudungun"]}
  ],
  "Ancient Aztec": [
    {q:"Aztec capital on Lake Texcoco:", a:"Tenochtitlan", wrong:["Texcoco","Tlaxcala","Teotihuacan"]},
    {q:"Floating garden agriculture:", a:"Chinampas", wrong:["Terraces","Polders","Raised beds"]},
    {q:"Aztec ruler title:", a:"Tlatoani", wrong:["Sapa Inca","Pharaoh","Shogun"]},
    {q:"Two calendars included the 260-day sacred calendar:", a:"Tonalpohualli", wrong:["Xiuhpohualli","Haab","Long Count"]},
    {q:"Main war/sun deity:", a:"Huitzilopochtli", wrong:["Tlaloc","Tezcatlipoca","Quetzalcoatl"]},
    {q:"Triple Alliance members were Tenochtitlan, Texcoco, and:", a:"Tlacopan", wrong:["Tlaxcala","Cholula","Xochimilco"]},
    {q:"Merchant class with long-distance trade:", a:"Pochteca", wrong:["Mamluks","Coureurs","Kshatriya"]},
    {q:"Skull rack in ritual precincts:", a:"Tzompantli", wrong:["Torc","Stela","Ziggurat"]},
    {q:"Elite warrior orders included:", a:"Jaguar and Eagle Knights", wrong:["Samurai and Ashigaru","Huscarls and Thegns","Immortals and Sparabara"]},
    {q:"Aztec writing chiefly used:", a:"Pictographs", wrong:["Alphabetic letters","Cuneiform","Runes"]},
    {q:"Templo Mayor‚Äôs twin shrines honored Tlaloc and:", a:"Huitzilopochtli", wrong:["Quetzalcoatl","Xipe Totec","Tezcatlipoca"]},
    {q:"365-day solar calendar was called the:", a:"Xiuhpohualli", wrong:["Haab","Tzolk‚Äôin","Long Count"]},
    {q:"Common money and luxury beverage ingredient:", a:"Cacao beans", wrong:["Copper ingots","Cowries","Peppercorns"]},
    {q:"Allied city that helped Cortes against the Aztecs:", a:"Tlaxcala", wrong:["Texcoco","Cholula","Maya of Palenque"]},
    {q:"Night of Spanish retreat from Tenochtitlan (1520):", a:"La Noche Triste", wrong:["Noche Roja","Sorrow of Cholula","Night of Broken Spears"]},
    {q:"Causeways and aqueducts served:", a:"Tenochtitlan", wrong:["Uxmal","Coba","Tula"]},
    {q:"Feeding blades and mirrors were often made from:", a:"Obsidian", wrong:["Bronze","Iron","Steel"]},
    {q:"Aztec schools for nobles:", a:"Calmecac", wrong:["Telpochcalli","Yachaywasi","Gurukula"]},
    {q:"Poet-king of Texcoco in the Triple Alliance:", a:"Nezahualcoyotl", wrong:["Moctezuma II","Ahuitzotl","Itzcoatl"]},
    {q:"Ritual 'flower wars' were fought partly to:", a:"Capture sacrificial prisoners", wrong:["Seize farmland","Win tribute gold","Spread smallpox"]},
    {q:"Last Aztec emperor executed in 1525:", a:"Cuauhtemoc", wrong:["Moctezuma II","Cuitlahuac","Ahuitzotl"]},
    {q:"The great market of the capital region was in:", a:"Tlatelolco", wrong:["Texcoco","Atzcapotzalco","Itzapalapa"]},
    {q:"Aztec empire structure is best described as:", a:"Tributary empire", wrong:["Directly administered provinces","Federal democracy","City-state league only"]},
    {q:"Codex Mendoza records:", a:"Tribute lists and conquests", wrong:["Zodiac omens","Spanish laws","Maya astronomy"]},
    {q:"Aztec ballgame name:", a:"Ollamaliztli", wrong:["Ulama","Pok-a-Tok","Pitz"]},
    {q:"The deity associated with rain and fertility:", a:"Tlaloc", wrong:["Xipe Totec","Tepeyollotl","Xiuhtecuhtli"]},
    {q:"Cortes first met the Mexica during the reign of:", a:"Moctezuma II", wrong:["Itzcoatl","Nezahualpilli","Axayacatl"]}
  ],
  "Ancient Egypt": [
    {q:"Unifier traditionally credited as first pharaoh:", a:"Narmer (Menes)", wrong:["Djoser","Sneferu","Khufu"]},
    {q:"Egyptian sacred writing system:", a:"Hieroglyphics", wrong:["Cuneiform","Linear B","Ogham"]},
    {q:"River lifeline of Egypt:", a:"Nile", wrong:["Euphrates","Jordan","Tigris"]},
    {q:"Old Kingdom is famed primarily for:", a:"Pyramid building", wrong:["Empire abroad","Monotheism","Sea trade"]},
    {q:"The Great Sphinx stands at:", a:"Giza", wrong:["Saqqara","Abydos","Dashur"]},
    {q:"Female pharaoh who built a mortuary temple at Deir el-Bahri:", a:"Hatshepsut", wrong:["Nefertiti","Cleopatra VII","Sobekneferu"]},
    {q:"Akhenaten promoted worship of:", a:"Aten", wrong:["Amun","Ptah","Osiris"]},
    {q:"The 'Boy King' whose intact tomb was found in 1922:", a:"Tutankhamun", wrong:["Ramesses II","Seti I","Thutmose III"]},
    {q:"Who deciphered hieroglyphics using the Rosetta Stone?", a:"Jean-Francois Champollion", wrong:["Schliemann","Carter","Rawlinson"]},
    {q:"Mummy organs were stored in:", a:"Canopic jars", wrong:["Amphorae","Cysts","Capids"]},
    {q:"Weighing of the heart was judged against the feather of:", a:"Ma'at", wrong:["Isis","Nun","Sekhmet"]},
    {q:"Pharaoh‚Äôs chief official was the:", a:"Vizier", wrong:["Nomarch","Scribe","High steward"]},
    {q:"Temple complex with Great Hypostyle Hall:", a:"Karnak", wrong:["Luxor","Edfu","Abu Simbel"]},
    {q:"Battle between Ramesses II and the Hittites:", a:"Kadesh", wrong:["Megiddo","Thermopylae","Issus"]},
    {q:"The royal necropolis of the New Kingdom:", a:"Valley of the Kings", wrong:["Mastaba Field","Giza Plateau","Saqqara Ridge"]},
    {q:"Egypt‚Äôs writing on papyrus used a cursive form called:", a:"Hieratic", wrong:["Demotic","Uncial","Runic"]},
    {q:"Later simplified script widely used for administration:", a:"Demotic", wrong:["Hieratic","Nabataean","Kharosthi"]},
    {q:"What natural event fertilized fields annually?", a:"Nile inundation", wrong:["Monsoon winds","Desert dew","Mediterranean tides"]},
    {q:"The double crown (Pschent) symbolized:", a:"Upper and Lower Egypt", wrong:["Sun and Moon","Earth and Sky","Life and Death"]},
    {q:"Egyptian funerary figurines placed in tombs:", a:"Ushabti", wrong:["Kachina","Tanagra","Pazyryk"]},
    {q:"The capital during Akhenaten‚Äôs reign:", a:"Akhetaten (Amarna)", wrong:["Memphis","Thebes","Pi-Ramesses"]},
    {q:"The famous rock temples relocted in modern times:", a:"Abu Simbel", wrong:["Edfu","Philae","Kom Ombo"]},
    {q:"Foreign rulers in the Second Intermediate Period:", a:"Hyksos", wrong:["Sea Peoples","Hittites","Assyrians"]},
    {q:"Egypt‚Äôs main building material for pyramids at Giza:", a:"Limestone", wrong:["Granite only","Basalt","Marble"]},
    {q:"'Book of the Dead' is best described as:", a:"Funerary spells and guidance", wrong:["Dynastic annals","Epic poetry","Medical papyri only"]},
    {q:"The god of embalming with a jackal head:", a:"Anubis", wrong:["Sobek","Thoth","Horus"]},
    {q:"Egyptians tracked time with a calendar of:", a:"365 days", wrong:["354 days","400 days","360 days only"]},
    {q:"Queen famous for liaisons with Roman leaders:", a:"Cleopatra VII", wrong:["Arsinoe II","Nefertari","Berenice IV"]},
    {q:"Which pharaoh left numerous colossal statues and battled the Sea Peoples?", a:"Ramesses III", wrong:["Tutankhamun","Djoser","Amenemhat I"]}
  ],
  "Ancient Mali": [
    {q:"Founder of the Mali Empire celebrated in epic tradition:", a:"Sundiata Keita", wrong:["Sunni Ali","Askia Muhammad","Osei Tutu"]},
    {q:"Emperor famed for lavish pilgrimage in 1324:", a:"Mansa Musa", wrong:["Sundiata","Askia the Great","Idris Alooma"]},
    {q:"Scholarly city on the Niger:", a:"Timbuktu", wrong:["Carthage","Axum","Kilwa"]},
    {q:"University center in Timbuktu:", a:"Sankore", wrong:["Nalanda","Al-Azhar","Qarawiyyin"]},
    {q:"Key Saharan trade goods:", a:"Gold and salt", wrong:["Tea and porcelain","Spices and silk","Furs and amber"]},
    {q:"River integral to Malian agriculture and trade:", a:"Niger", wrong:["Congo","Zambezi","Senegal only"]},
    {q:"Title 'Mansa' means:", a:"King or emperor", wrong:["Priest","War chief","Tax collector"]},
    {q:"Desert salt mines crucial to trade:", a:"Taghaza", wrong:["Wadi Halfa","Zincir","Mopti"]},
    {q:"Renowned travelers who wrote about Mali:", a:"Ibn Battuta", wrong:["Marco Polo","Ibn Khaldun only","Herodotus"]},
    {q:"Professional oral historians and musicians:", a:"Griots", wrong:["Skalds","Bards","Gamelan"]},
    {q:"Important trading town south of Timbuktu:", a:"Djenne", wrong:["Gao","Koumbi Saleh","Marrakesh"]},
    {q:"Common architectural material in Mali‚Äôs mosques:", a:"Mud-brick (adobe)", wrong:["Marble","Granite","Basalt"]},
    {q:"The empire that rose in Gao after Mali‚Äôs decline:", a:"Songhai", wrong:["Kanem-Bornu","Benin","Ashanti"]},
    {q:"Tuareg seized Timbuktu in:", a:"1433", wrong:["1230","1324","1501"]},
    {q:"Malian manuscripts were written primarily in:", a:"Arabic", wrong:["Ge'ez","Coptic","Berber Tifinagh"]},
    {q:"Caravans crossed the Sahara using:", a:"Camels", wrong:["Horses","Oxen","Elephants"]},
    {q:"The wealthy pilgrimage of Mansa Musa reportedly caused:", a:"Gold inflation in Cairo", wrong:["Famine in Fez","War in Tunis","Floods on the Nile"]},
    {q:"Earlier West African empire that preceded Mali:", a:"Ghana (Wagadou)", wrong:["Benin","Nri","Kongo"]},
    {q:"Ethno-linguistic group of Mali‚Äôs core elites:", a:"Mande", wrong:["Hausa","Fulani","Tuareg"]},
    {q:"Traditional harp-lute of griots:", a:"Kora", wrong:["Balafon only","Ngoni","Xalam"]},
    {q:"A noted mosque in Timbuktu built under Mansa Musa:", a:"Djinguereber Mosque", wrong:["Hassan II Mosque","Kutubiyya","Great Mosque of Damascus"]},
    {q:"Mali‚Äôs political center is sometimes identified as:", a:"Niani", wrong:["Kano","If·∫π","Timbuktu only"]},
    {q:"Common unit for weighing gold dust:", a:"Scales with small weights", wrong:["Bronze coins","Silver drachma","Cowry standard only"]},
    {q:"Merchants linking Maghreb and Sahel were largely:", a:"Berber and Arab traders", wrong:["Phoenicians","Portuguese","Franks"]},
    {q:"The Sahel is a:", a:"Semi-arid zone south of the Sahara", wrong:["Dense rainforest","High mountain chain","Coastal marsh"]},
    {q:"Islam spread in Mali primarily through:", a:"Trade and elites", wrong:["Conquest by Turks","Missionaries from India","Chinese fleets"]},
    {q:"City on the Niger that later became Songhai‚Äôs capital:", a:"Gao", wrong:["Accra","Bamako","Agadez"]}
  ],
"Scandinavia": [
    {q:"The Viking raid traditionally marking the era‚Äôs start hit:", a:"Lindisfarne (AD 793)", wrong:["Hastings","York","Paris"]},
    {q:"Merchant/port settlement in Sweden:", a:"Birka", wrong:["York","Ribe","Kaupang"]},
    {q:"Parliamentary assembly in Iceland:", a:"Althing", wrong:["Storting","Tingvalla","Diet"]},
    {q:"Warriors serving Byzantine emperors:", a:"Varangian Guard", wrong:["Huscarls","Cataphracts","Immortals"]},
    {q:"Runic alphabets are known as:", a:"Futhark", wrong:["Ogam","Cyrillic","Glagolitic"]},
    {q:"Stone monuments with inscriptions:", a:"Runestones", wrong:["Menhirs","Stelae","Dolmens"]},
    {q:"Which king gave name to Bluetooth technology?", a:"Harald Bluetooth", wrong:["Harald Hardrada","Sweyn Forkbeard","Cnut the Great"]},
    {q:"Large ship burial discovered in Norway:", a:"Oseberg ship", wrong:["Mary Rose","Vasa","Cutty Sark"]},
    {q:"Viking rule area in England:", a:"Danelaw", wrong:["Pictland","Mercia","Wessex"]},
    {q:"Greenland was settled by:", a:"Erik the Red", wrong:["Leif Erikson","Rollo","Harald Fairhair"]},
    {q:"Norse exploration of North America:", a:"Vinland", wrong:["Markland","Avalon","Hy-Brasil"]},
    {q:"Leif Erikson is credited with reaching:", a:"North America", wrong:["Sicily","Africa","Persia"]},
    {q:"Norse myth warrior maidens:", a:"Valkyries", wrong:["Naiads","Furies","Norns only"]},
    {q:"Epic prose/poetic collections on Norse myth:", a:"Eddas", wrong:["Sagas","Chronicles","Annals"]},
    {q:"Viking trading town in Denmark:", a:"Ribe", wrong:["York","Bergen","Novgorod only"]},
    {q:"Which battle (1066) curtailed Viking power in England?", a:"Stamford Bridge", wrong:["Hastings","Maldon","Clontarf"]},
    {q:"Elite household warriors of Anglo-Scandinavian kings:", a:"Huscarls", wrong:["Samurai","Cataphracts","Jinetes"]},
    {q:"Norse poets and bards:", a:"Skalds", wrong:["Griots","Troubadours","Minstrels"]},
    {q:"Typical Viking cargo ship:", a:"Knarr", wrong:["Caravel","Galley","Carrack"]},
    {q:"Fierce fighters famed for battle frenzy:", a:"Berserkers", wrong:["Condottieri","Janissaries","Hoplites"]},
    {q:"Royal stones with large runic inscriptions in Denmark:", a:"Jelling stones", wrong:["Rosetta Stone","Behistun","Moabite Stone"]},
    {q:"Norse world tree is called:", a:"Yggdrasil", wrong:["Asphodel","Bodhi","Irminsul only"]},
    {q:"Center of Viking trade in Russia heavily linked to Scandinavians:", a:"Novgorod", wrong:["Moscow","Kiev only","Smolensk"]},
    {q:"Norse thunder god:", a:"Thor", wrong:["Tyr","Loki","Baldur"]},
    {q:"The Norse term for a legal assembly:", a:"Thing", wrong:["Sejm","Diet","Witenagemot"]},
    {q:"Vikings collected tribute from England called:", a:"Danegeld", wrong:["Ransom","Scutage","Peter‚Äôs Pence"]},
    {q:"Common myth about helmets that is false:", a:"They had horns", wrong:["They were iron","They were conical","They had nose guards"]},
    {q:"Later conversion of Scandinavia was mainly to:", a:"Christianity", wrong:["Islam","Buddhism","Zoroastrianism"]},
    {q:"City captured by Vikings and known as Jorvik:", a:"York", wrong:["London","Canterbury","Winchester"]}
  ]
};
  function getRandomQuestion(era){
    const bank = QUESTIONS[era]||[];
    if (!bank.length) return null;
    return bank[Math.floor(Math.random()*bank.length)];
  }

  // ---------- ERA ‚Üí QUESTION ROUTING ----------
  // already handled by eraForCell(cellIdx) which maps via region

</script>
</body>
</html>

