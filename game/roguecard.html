<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Red Rising: Rogue Deck Grid</title>
<style>
  :root{
    --bg:#07090f;
    --panel:#0f172a;
    --card:#111827;
    --muted:#94a3b8;
    --ink:#e2e8f0;
    --line:#1f2937;
    --accent:#38bdf8;
    --danger:#f97316;
    --heal:#22c55e;
    --poison:#a855f7;
    --stun:#facc15;
    --rar-common:#94a3b8;
    --rar-rare:#60a5fa;
    --rar-epic:#c084fc;
    --rar-legend:#fbbf24;
    --low:#f87171;
    --gold:#f59e0b;
    --silver:#94a3b8;
    --obsidian:#64748b;
    --violet:#a78bfa;
    --yellow:#fde047;
    --red:#ef4444;
    --gray:#9ca3af;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:"Segoe UI",system-ui,sans-serif;background:var(--bg);color:var(--ink)}
  header{padding:12px 18px;border-bottom:1px solid var(--line);background:#0b1020;position:sticky;top:0;z-index:10}
  header h1{margin:0;font-size:18px;letter-spacing:.6px}
  #root{max-width:1280px;margin:0 auto;padding:16px;display:grid;gap:16px}
  .stats{display:flex;flex-wrap:wrap;gap:8px}
  .pill{padding:6px 10px;border-radius:999px;background:var(--panel);border:1px solid var(--line);font-weight:700;font-size:12px;color:var(--muted)}
  .arena{display:grid;gap:16px;grid-template-columns:1fr 1fr}
  .boardWrap{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:12px;display:grid;gap:10px}
  .boardTitle{font-weight:800;font-size:13px;color:var(--muted);text-transform:uppercase;letter-spacing:.8px}
  .grid{display:grid;grid-template-columns:repeat(5, 1fr);gap:8px;min-height:420px}
  .tileSlot{background:#0b132a;border:1px dashed #1f2a44;border-radius:12px;min-height:76px;position:relative}
  .tile{
    background:var(--card);
    border:1px solid #1e293b;
    border-radius:12px;
    padding:8px;
    display:grid;
    gap:4px;
    cursor:grab;
    position:relative;
    box-shadow:0 12px 24px rgba(0,0,0,.28);
    transition:transform .15s ease;
  }
  .tile:active{cursor:grabbing;transform:scale(.98)}
  .tileHeader{display:flex;justify-content:space-between;align-items:center}
  .tileName{font-weight:800;font-size:12px}
  .tileFaction{font-size:10px;padding:2px 6px;border-radius:999px;border:1px solid #1f2937}
  .tileBody{font-size:11px;color:var(--muted);display:flex;flex-wrap:wrap;gap:6px}
  .tileStats{display:flex;gap:8px;font-size:11px;color:#cbd5f5}
  .rarity{font-size:10px;font-weight:800;padding:2px 6px;border-radius:999px}
  .rarity.common{background:var(--rar-common);color:#0f172a}
  .rarity.rare{background:var(--rar-rare);color:#0f172a}
  .rarity.epic{background:var(--rar-epic);color:#0f172a}
  .rarity.legend{background:var(--rar-legend);color:#0f172a}
  .tileAura{position:absolute;inset:-4px;border-radius:14px;pointer-events:none;opacity:.35;filter:blur(1px)}
  .aura-boost{background:radial-gradient(circle, rgba(59,130,246,.8), rgba(0,0,0,0))}
  .aura-heal{background:radial-gradient(circle, rgba(34,197,94,.8), rgba(0,0,0,0))}
  .aura-red{background:radial-gradient(circle, rgba(239,68,68,.7), rgba(0,0,0,0))}
  .aura-violet{background:radial-gradient(circle, rgba(167,139,250,.7), rgba(0,0,0,0))}
  .tileStatus{position:absolute;right:6px;top:6px;display:flex;gap:4px}
  .statusPill{font-size:10px;font-weight:800;padding:2px 4px;border-radius:999px;color:#0f172a}
  .status-poison{background:var(--poison);color:white}
  .status-stun{background:var(--stun);color:#0f172a}
  .status-buff{background:#38bdf8;color:#0f172a}
  .reserve{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:12px;display:grid;gap:10px}
  .reserveSlots{display:flex;flex-wrap:wrap;gap:10px;min-height:96px}
  .trash{border:2px dashed #f97316;border-radius:16px;padding:12px;text-align:center;color:#fca5a5;font-weight:700}
  .controls{display:flex;flex-wrap:wrap;gap:8px}
  button{background:linear-gradient(180deg,#38bdf8,#0284c7);border:1px solid #0369a1;color:#0b1020;font-weight:800;padding:10px 14px;border-radius:12px;cursor:pointer}
  button.secondary{background:linear-gradient(180deg,#94a3b8,#475569);border-color:#334155;color:#0f172a}
  button:disabled{opacity:.5;cursor:not-allowed}
  .log{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:12px;max-height:190px;overflow:auto;font-size:12px;color:#cbd5f5}
  .modal{position:fixed;inset:0;background:rgba(3,7,18,.7);display:none;align-items:center;justify-content:center;z-index:20}
  .modal.active{display:flex}
  .sheet{background:#0b1020;border:1px solid var(--line);border-radius:16px;padding:16px;max-width:980px;width:90%;display:grid;gap:12px}
  .choiceGrid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
  .choiceCard{border:1px solid #1f2937;border-radius:14px;background:#0f172a;padding:12px;display:grid;gap:6px;cursor:pointer}
  .choiceCard:hover{border-color:#38bdf8;box-shadow:0 0 18px rgba(56,189,248,.35)}
  .hint{font-size:12px;color:var(--muted)}
  .fxLayer{position:fixed;inset:0;pointer-events:none;z-index:30}
  .beam{position:absolute;height:3px;border-radius:999px;transform-origin:left center;animation:beam .5s ease-out forwards}
  .beam.fire{background:linear-gradient(90deg,#f97316,#facc15)}
  .beam.rail{background:linear-gradient(90deg,#38bdf8,#f0f9ff)}
  .beam.heal{background:linear-gradient(90deg,#22c55e,#bbf7d0)}
  .beam.poison{background:linear-gradient(90deg,#a855f7,#f5d0fe)}
  .beam.stun{background:linear-gradient(90deg,#facc15,#fef08a)}
  @keyframes beam{to{opacity:0;transform:scaleX(1.1)}}
  .pulse{position:absolute;inset:-2px;border-radius:14px;border:2px solid rgba(56,189,248,.7);animation:pulse 1s ease-out}
  @keyframes pulse{to{opacity:0;transform:scale(1.1)}}
  .regionTag{font-weight:800;color:#38bdf8}
  @media (max-width: 980px){
    .arena{grid-template-columns:1fr}
    .grid{min-height:320px}
  }
</style>
</head>
<body>
<header>
  <h1>Red Rising: Rogue Deck Grid</h1>
  <div class="stats">
    <div class="pill">Round: <span id="round">1</span></div>
    <div class="pill">Region: <span id="region">Mars Lowlands</span></div>
    <div class="pill">Threat: <span id="threat">1.0x</span></div>
    <div class="pill">Boss In: <span id="bossCounter">5</span></div>
    <div class="pill">Deck: <span id="deckCount">0</span>/25</div>
  </div>
</header>
<div id="root">
  <div class="controls">
    <button id="btnStart">Start Run</button>
    <button id="btnNext" disabled>Resolve Round</button>
    <button id="btnReset" class="secondary">Restart</button>
  </div>
  <div class="arena">
    <div class="boardWrap">
      <div class="boardTitle">Your Grid 5x5</div>
      <div id="playerGrid" class="grid"></div>
    </div>
    <div class="boardWrap">
      <div class="boardTitle">Enemy Grid</div>
      <div id="enemyGrid" class="grid"></div>
    </div>
  </div>
  <div class="reserve">
    <div class="boardTitle">New Tiles (drag onto grid)</div>
    <div id="reserveSlots" class="reserveSlots"></div>
    <div id="trash" class="trash">Trash — drag a tile here to delete</div>
  </div>
  <div class="boardWrap">
    <div class="boardTitle">Battle Log</div>
    <div id="log" class="log"></div>
  </div>
</div>

<div id="draftModal" class="modal">
  <div class="sheet">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <strong>Draft: Choose 1</strong>
      <span id="draftHint" class="hint"></span>
    </div>
    <div id="draftChoices" class="choiceGrid"></div>
  </div>
</div>

<div id="detailModal" class="modal">
  <div class="sheet">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <strong>Tile Breakdown</strong>
      <button class="secondary" onclick="toggleDetail(false)">Close</button>
    </div>
    <div id="detailBody" class="hint"></div>
  </div>
</div>

<div id="fxLayer" class="fxLayer"></div>

<script>
const GRID_SIZE = 25;
const ROWS = 5;
const COLS = 5;
const RARITIES = ["common","rare","epic","legend"];
const FACTIONS = ["Low Colors","Golds","Silvers","Obsidians"];
const REGION_TABLE = [
  {name:"Mars Lowlands", favored:["Low Colors"]},
  {name:"Luna Vaults", favored:["Golds","Silvers"]},
  {name:"Polar Siege", favored:["Obsidians","Low Colors"]},
  {name:"Core Conclave", favored:["Golds"]},
  {name:"Rim Battlefront", favored:["Obsidians","Silvers"]}
];

const TILES = [
  {name:"Darrow", faction:"Golds", rarity:"legend", hp:220, dmg:36, fireRate:1.1, priority:"highest", type:"unit", tags:["leader","cleave"], ability:"Inspire adjacent allies +20% dmg." , aura:"boost"},
  {name:"Sevro", faction:"Golds", rarity:"epic", hp:170, dmg:28, fireRate:1.5, priority:"snipers", type:"unit", tags:["howler"], ability:"Double-fire every 3 rounds."},
  {name:"Mustang", faction:"Golds", rarity:"epic", hp:160, dmg:12, fireRate:1.0, priority:"healers", type:"unit", tags:["strategist"], ability:"Start: shields diagonal allies (+30% max hp).", aura:"boost"},
  {name:"Lysander", faction:"Golds", rarity:"rare", hp:120, dmg:20, fireRate:1.1, priority:"highest", type:"unit", tags:["duelist"], ability:"Rail slug at start for bonus damage."},
  {name:"Cassius", faction:"Golds", rarity:"rare", hp:130, dmg:22, fireRate:1.2, priority:"highest", type:"unit", tags:["blade"], ability:"Adjacent Golds gain +15% fire rate.", aura:"boost"},

  {name:"Eo", faction:"Low Colors", rarity:"rare", hp:140, dmg:10, fireRate:1.0, priority:"lowest", type:"unit", tags:["song"], ability:"Heal adjacent allies 18 each round.", aura:"heal"},
  {name:"Dancer", faction:"Low Colors", rarity:"rare", hp:130, dmg:16, fireRate:1.0, priority:"highest", type:"unit", tags:["red"], ability:"Adjacent Reds gain +25% dmg.", aura:"red"},
  {name:"Harmony", faction:"Low Colors", rarity:"epic", hp:150, dmg:18, fireRate:0.9, priority:"highest", type:"unit", tags:["red"], ability:"Adjacent Reds +30% dmg, non-Reds -10% dmg.", aura:"red"},
  {name:"Gray Shock Troop", faction:"Low Colors", rarity:"common", hp:110, dmg:14, fireRate:1.2, priority:"snipers", type:"unit", tags:["gray"], ability:"Targets Golds first."},
  {name:"Gray Lurcher", faction:"Low Colors", rarity:"rare", hp:120, dmg:18, fireRate:1.1, priority:"golds", type:"unit", tags:["gray"], ability:"+35% damage vs Golds."},
  {name:"Yellow Medica", faction:"Low Colors", rarity:"rare", hp:140, dmg:6, fireRate:1.0, priority:"lowest", type:"unit", tags:["yellow"], ability:"Heal adjacent allies 24 each round.", aura:"heal"},
  {name:"Violet Muse", faction:"Low Colors", rarity:"epic", hp:120, dmg:8, fireRate:1.0, priority:"lowest", type:"unit", tags:["violet"], ability:"Adjacent allies gain +15% dmg & +10% fire rate.", aura:"violet"},

  {name:"Quicksilver", faction:"Silvers", rarity:"legend", hp:180, dmg:6, fireRate:0.8, priority:"lowest", type:"unit", tags:["wealth"], ability:"Raise rare+ draft odds by 8%."},
  {name:"Silver Broker", faction:"Silvers", rarity:"rare", hp:120, dmg:8, fireRate:1.0, priority:"lowest", type:"unit", tags:["support"], ability:"Adjacent allies +12% fire rate.", aura:"boost"},
  {name:"Silver Booster", faction:"Silvers", rarity:"epic", hp:140, dmg:12, fireRate:1.0, priority:"highest", type:"unit", tags:["support"], ability:"Adjacent allies +18% ability potency.", aura:"boost"},

  {name:"Ragnar", faction:"Obsidians", rarity:"legend", hp:260, dmg:30, fireRate:1.0, priority:"highest", type:"unit", tags:["berserker"], ability:"Adjacent allies +10% dmg, self heals 12 per round.", aura:"boost"},
  {name:"Faa", faction:"Obsidians", rarity:"epic", hp:240, dmg:26, fireRate:0.9, priority:"highest", type:"unit", tags:["tyrant"], ability:"Adjacent non-Golds -12% dmg, Golds +10% dmg."},
  {name:"Obsidian Raider", faction:"Obsidians", rarity:"rare", hp:200, dmg:24, fireRate:1.0, priority:"highest", type:"unit", tags:["raider"], ability:"Rail volley at start of round."},
  {name:"Obsidian Shield", faction:"Obsidians", rarity:"rare", hp:260, dmg:12, fireRate:0.8, priority:"highest", type:"unit", tags:["tank"], ability:"Adjacent allies gain +15% max HP.", aura:"boost"},

  {name:"Railgun Battery", faction:"Low Colors", rarity:"epic", hp:140, dmg:0, fireRate:0, priority:"highest", type:"ability", tags:["ability"], ability:"Start: fires a rail slug (60 dmg) at highest HP."},
  {name:"Grim Snare", faction:"Low Colors", rarity:"rare", hp:120, dmg:0, fireRate:0, priority:"highest", type:"ability", tags:["ability"], ability:"Start: stun 2 enemies for 1 turn."},
  {name:"Poison Dart Rig", faction:"Low Colors", rarity:"rare", hp:120, dmg:0, fireRate:0, priority:"highest", type:"ability", tags:["ability"], ability:"Start: apply poison (12 dmg x 2) to 3 enemies."}
];

const ENEMY_POOL = TILES.map(tile => ({...tile}));

const state = {
  round: 1,
  threat: 1,
  bossCounter: 5,
  deck: Array(GRID_SIZE).fill(null),
  enemy: Array(GRID_SIZE).fill(null),
  reserve: [],
  drafting: false,
  picksThisPhase: 0,
  regionIndex: 0,
  goldDraftBoost: 0,
  gameOn: false
};

const playerGrid = document.getElementById("playerGrid");
const enemyGrid = document.getElementById("enemyGrid");
const reserveSlots = document.getElementById("reserveSlots");
const logEl = document.getElementById("log");
const draftModal = document.getElementById("draftModal");
const draftChoices = document.getElementById("draftChoices");
const draftHint = document.getElementById("draftHint");
const fxLayer = document.getElementById("fxLayer");

function log(msg){
  const entry = document.createElement("div");
  entry.textContent = msg;
  logEl.appendChild(entry);
  logEl.scrollTop = logEl.scrollHeight;
}

function rarityWeights(){
  const progress = Math.floor((state.round - 1) / 5);
  const base = {common:60, rare:26, epic:11, legend:3};
  base.common = Math.max(20, base.common - progress * 4);
  base.rare += progress * 2;
  base.epic += progress * 1.2;
  base.legend += progress * 0.8;
  const silverBoost = state.goldDraftBoost || 0;
  base.rare += silverBoost;
  base.epic += silverBoost * 0.6;
  return base;
}

function weightedPick(weights){
  const entries = Object.entries(weights);
  const total = entries.reduce((s,[,v])=>s+v,0);
  let r = Math.random() * total;
  for(const [k,v] of entries){
    if((r -= v) <= 0) return k;
  }
  return entries[0][0];
}

function makeTile(def, isEnemy = false){
  const rarityMult = {common:1, rare:1.1, epic:1.2, legend:1.35};
  const threat = isEnemy ? state.threat : 1;
  const baseHp = def.hp * (isEnemy ? 0.18 * threat : 1);
  const baseDmg = def.dmg * (isEnemy ? 0.5 * threat : 1);
  const hpBoost = isEnemy ? 1 : (5 + Math.random() * 3);
  const maxHp = Math.round(baseHp * rarityMult[def.rarity] * (isEnemy ? 1 : hpBoost));
  return {
    id: Math.random().toString(36).slice(2),
    name: def.name,
    faction: def.faction,
    rarity: def.rarity,
    hp: maxHp,
    maxHp: maxHp,
    baseMaxHp: maxHp,
    dmg: Math.round(baseDmg),
    fireRate: def.fireRate || 1,
    priority: def.priority,
    type: def.type,
    tags: def.tags || [],
    ability: def.ability,
    aura: def.aura || null,
    poison: 0,
    stun: 0,
    buffs: {dmg:1, fire:1, ability:1, hp:1},
    lastShot: 0,
    enemy: isEnemy
  };
}

function renderGrid(){
  playerGrid.innerHTML = "";
  enemyGrid.innerHTML = "";
  state.deck.forEach((tile, idx) => {
    const slot = document.createElement("div");
    slot.className = "tileSlot";
    slot.dataset.index = idx;
    slot.addEventListener("dragover", e => e.preventDefault());
    slot.addEventListener("drop", e => handleDrop(e, idx, false));
    if(tile){
      slot.appendChild(renderTile(tile));
    }
    playerGrid.appendChild(slot);
  });
  state.enemy.forEach((tile, idx) => {
    const slot = document.createElement("div");
    slot.className = "tileSlot";
    if(tile){
      slot.appendChild(renderTile(tile, true));
    }
    enemyGrid.appendChild(slot);
  });
  updateHeader();
}

function renderTile(tile, locked = false){
  const div = document.createElement("div");
  div.className = "tile";
  div.dataset.id = tile.id;
  if(!locked){
    div.draggable = true;
    div.addEventListener("dragstart", e => handleDrag(e, tile.id));
  }
  div.addEventListener("click", () => showDetail(tile));
  const factionColor = factionStyle(tile.faction);
  const aura = tile.aura ? `<div class="tileAura aura-${tile.aura}"></div>` : "";
  div.innerHTML = `
    ${aura}
    <div class="tileHeader">
      <div class="tileName">${tile.name}</div>
      <span class="rarity ${tile.rarity}">${tile.rarity.toUpperCase()}</span>
    </div>
    <div class="tileHeader">
      <span class="tileFaction" style="color:${factionColor};border-color:${factionColor}">${tile.faction}</span>
      <span class="tileStats">HP ${tile.hp}/${tile.maxHp}</span>
    </div>
    <div class="tileStats">
      <span>DMG ${Math.round(tile.dmg * tile.buffs.dmg)}</span>
      <span>FR ${tile.fireRate.toFixed(1)}</span>
      <span>PRI ${tile.priority}</span>
    </div>
    <div class="tileBody">${tile.tags.map(tag => `<span>${tag}</span>`).join(" • ")}</div>
    <div class="tileStatus">${renderStatus(tile)}</div>
  `;
  return div;
}

function renderStatus(tile){
  let html = "";
  if(tile.poison > 0) html += `<span class="statusPill status-poison">POISON ${tile.poison}</span>`;
  if(tile.stun > 0) html += `<span class="statusPill status-stun">STUN</span>`;
  if(tile.buffs.dmg > 1 || tile.buffs.fire > 1 || tile.buffs.ability > 1){
    html += `<span class="statusPill status-buff">BUFF</span>`;
  }
  return html;
}

function factionStyle(faction){
  if(faction === "Low Colors") return "var(--low)";
  if(faction === "Golds") return "var(--gold)";
  if(faction === "Silvers") return "var(--silver)";
  if(faction === "Obsidians") return "var(--obsidian)";
  return "var(--muted)";
}

function updateHeader(){
  document.getElementById("round").textContent = state.round;
  document.getElementById("region").innerHTML = `<span class="regionTag">${REGION_TABLE[state.regionIndex].name}</span>`;
  document.getElementById("threat").textContent = `${state.threat.toFixed(2)}x`;
  document.getElementById("bossCounter").textContent = state.bossCounter;
  document.getElementById("deckCount").textContent = state.deck.filter(Boolean).length;
}

function handleDrag(e, id){
  e.dataTransfer.setData("text/plain", id);
}

function handleDrop(e, targetIdx, fromReserve){
  e.preventDefault();
  const id = e.dataTransfer.getData("text/plain");
  if(!id) return;
  const tileIndex = state.deck.findIndex(t => t && t.id === id);
  const reserveIndex = state.reserve.findIndex(t => t.id === id);
  const targetTile = state.deck[targetIdx];
  if(tileIndex >= 0){
    state.deck[targetIdx] = state.deck[tileIndex];
    state.deck[tileIndex] = targetTile;
  } else if(reserveIndex >= 0){
    if(state.deck[targetIdx]){
      const swapped = state.deck[targetIdx];
      state.deck[targetIdx] = state.reserve[reserveIndex];
      state.reserve[reserveIndex] = swapped;
    } else {
      state.deck[targetIdx] = state.reserve.splice(reserveIndex, 1)[0];
    }
  }
  renderGrid();
  renderReserve();
}

function renderReserve(){
  reserveSlots.innerHTML = "";
  state.reserve.forEach(tile => {
    const div = renderTile(tile);
    div.draggable = true;
    div.addEventListener("dragstart", e => handleDrag(e, tile.id));
    reserveSlots.appendChild(div);
  });
}

function setupTrash(){
  const trash = document.getElementById("trash");
  trash.addEventListener("dragover", e => e.preventDefault());
  trash.addEventListener("drop", e => {
    e.preventDefault();
    const id = e.dataTransfer.getData("text/plain");
    if(!id) return;
    const deckIndex = state.deck.findIndex(t => t && t.id === id);
    const reserveIndex = state.reserve.findIndex(t => t.id === id);
    if(deckIndex >= 0) state.deck[deckIndex] = null;
    if(reserveIndex >= 0) state.reserve.splice(reserveIndex, 1);
    renderGrid();
    renderReserve();
  });
}

function showDraft(){
  state.drafting = true;
  draftChoices.innerHTML = "";
  const regionFavored = REGION_TABLE[state.regionIndex].favored;
  const weights = rarityWeights();
  const picks = Array.from({length:3}, () => {
    const rarity = weightedPick(weights);
    const pool = TILES.filter(tile => tile.rarity === rarity);
    const favoredPool = pool.filter(tile => regionFavored.includes(tile.faction));
    const choicePool = favoredPool.length ? favoredPool : pool;
    return choicePool[Math.floor(Math.random() * choicePool.length)];
  });
  picks.forEach(def => {
    const card = document.createElement("div");
    card.className = "choiceCard";
    card.innerHTML = `
      <strong>${def.name}</strong>
      <div class="hint">${def.faction} • ${def.rarity.toUpperCase()}</div>
      <div class="hint">HP ${def.hp} • DMG ${def.dmg || 0} • FR ${def.fireRate || 0}</div>
      <div class="hint">${def.ability}</div>
    `;
    card.addEventListener("click", () => selectDraft(def));
    draftChoices.appendChild(card);
  });
  draftHint.textContent = `Pick ${state.picksThisPhase + 1} of 3`;
  draftModal.classList.add("active");
}

function selectDraft(def){
  const tile = makeTile(def, false);
  state.reserve.push(tile);
  if(def.name === "Quicksilver"){
    state.goldDraftBoost += 4;
    log("Quicksilver increases your rare draft odds.");
  }
  draftModal.classList.remove("active");
  state.drafting = false;
  state.picksThisPhase += 1;
  renderReserve();
  if(state.picksThisPhase < 3){
    setTimeout(showDraft, 350);
  } else {
    state.picksThisPhase = 0;
    spawnEnemyWave();
  }
}

function spawnEnemyWave(){
  state.enemy = Array(GRID_SIZE).fill(null);
  const isBoss = state.bossCounter === 1;
  const enemyCount = 10 + Math.floor(state.round / 2);
  const favored = REGION_TABLE[state.regionIndex].favored;
  const pool = ENEMY_POOL.filter(tile => tile.type !== "ability");
  for(let i = 0; i < enemyCount; i++){
    const rarity = weightedPick(isBoss ? {common:35, rare:35, epic:20, legend:10} : rarityWeights());
    const candidates = pool.filter(tile => tile.rarity === rarity);
    const favoredPool = candidates.filter(tile => favored.includes(tile.faction));
    const pickPool = favoredPool.length ? favoredPool : candidates;
    const def = pickPool[Math.floor(Math.random() * pickPool.length)];
    const tile = makeTile(def, true);
    const emptyIndices = state.enemy.map((t, idx) => t ? null : idx).filter(v => v !== null);
    if(!emptyIndices.length) break;
    const idx = emptyIndices[Math.floor(Math.random() * emptyIndices.length)];
    state.enemy[idx] = tile;
  }
  log(isBoss ? "Boss wave approaches!" : "Enemy wave approaches.");
  document.getElementById("btnNext").disabled = false;
  renderGrid();
}

function getAdjacents(index){
  const row = Math.floor(index / COLS);
  const col = index % COLS;
  const indices = [];
  for(let r = row - 1; r <= row + 1; r++){
    for(let c = col - 1; c <= col + 1; c++){
      if(r === row && c === col) continue;
      if(r >= 0 && r < ROWS && c >= 0 && c < COLS){
        indices.push(r * COLS + c);
      }
    }
  }
  return indices;
}

function applyAuras(){
  state.deck.forEach(tile => {
    if(tile){
      tile.buffs = {dmg:1, fire:1, ability:1, hp:1};
    }
  });
  state.deck.forEach((tile, idx) => {
    if(!tile) return;
    const adj = getAdjacents(idx).map(i => state.deck[i]).filter(Boolean);
    if(tile.name === "Darrow"){
      adj.forEach(t => t.buffs.dmg += 0.2);
    }
    if(tile.name === "Cassius"){
      adj.filter(t => t.faction === "Golds").forEach(t => t.buffs.fire += 0.15);
    }
    if(tile.name === "Yellow Medica" || tile.name === "Eo"){
      adj.forEach(t => t.buffs.ability += 0.2);
    }
    if(tile.name === "Violet Muse"){
      adj.forEach(t => {t.buffs.dmg += 0.15; t.buffs.fire += 0.1;});
    }
    if(tile.name === "Dancer"){
      adj.filter(t => t.tags.includes("red")).forEach(t => t.buffs.dmg += 0.25);
    }
    if(tile.name === "Harmony"){
      adj.forEach(t => {
        if(t.tags.includes("red")) t.buffs.dmg += 0.3;
        else t.buffs.dmg -= 0.1;
      });
    }
    if(tile.name === "Ragnar"){
      adj.forEach(t => t.buffs.dmg += 0.1);
    }
    if(tile.name === "Faa"){
      adj.forEach(t => {
        if(t.faction === "Golds") t.buffs.dmg += 0.1;
        else t.buffs.dmg -= 0.12;
      });
    }
    if(tile.name === "Silver Broker"){
      adj.forEach(t => t.buffs.fire += 0.12);
    }
    if(tile.name === "Silver Booster"){
      adj.forEach(t => t.buffs.ability += 0.18);
    }
    if(tile.name === "Obsidian Shield"){
      adj.forEach(t => t.buffs.hp += 0.15);
    }
  });
  state.deck.forEach(tile => {
    if(tile){
      tile.maxHp = Math.round(tile.baseMaxHp * tile.buffs.hp);
      tile.hp = Math.min(tile.hp, tile.maxHp);
    }
  });
}

function resolveAbilities(){
  state.deck.forEach((tile, idx) => {
    if(!tile || tile.type === "unit") return;
    if(tile.name === "Railgun Battery"){
      const target = pickTarget(state.enemy, "highest");
      if(target){
        fireBeam(tile, target, "rail");
        target.hp -= Math.round(60 * tile.buffs.ability);
      }
    }
    if(tile.name === "Grim Snare"){
      const targets = pickTargets(state.enemy, 2);
      targets.forEach(t => { t.stun = Math.max(t.stun, 1); fireBeam(tile, t, "stun");});
    }
    if(tile.name === "Poison Dart Rig"){
      const targets = pickTargets(state.enemy, 3);
      targets.forEach(t => { t.poison += 12; fireBeam(tile, t, "poison");});
    }
  });
  state.deck.forEach((tile, idx) => {
    if(!tile || tile.type !== "unit") return;
    const adj = getAdjacents(idx).map(i => state.deck[i]).filter(Boolean);
    if(tile.name === "Eo" || tile.name === "Yellow Medica"){
      adj.forEach(t => {
        const heal = Math.round((tile.name === "Eo" ? 18 : 24) * tile.buffs.ability);
        t.hp = Math.min(t.maxHp, t.hp + heal);
        fireBeam(tile, t, "heal");
      });
    }
    if(tile.name === "Ragnar"){
      tile.hp = Math.min(tile.maxHp, tile.hp + 12);
    }
    if(tile.name === "Obsidian Raider"){
      const target = pickTarget(state.enemy, "highest");
      if(target){
        fireBeam(tile, target, "rail");
        target.hp -= Math.round(48 * tile.buffs.ability);
      }
    }
    if(tile.name === "Lysander"){
      const target = pickTarget(state.enemy, "highest");
      if(target){
        fireBeam(tile, target, "rail");
        target.hp -= Math.round(45 * tile.buffs.ability);
      }
    }
    if(tile.name === "Sevro" && state.round % 3 === 0){
      const target = pickTarget(state.enemy, "snipers");
      if(target){
        fireBeam(tile, target, "fire");
        target.hp -= Math.round(tile.dmg * 1.5);
      }
    }
  });
}

function resolvePoisons(){
  state.deck.forEach(tile => {
    if(tile && tile.poison > 0){
      tile.hp -= Math.round(tile.poison * 0.6);
      tile.poison = Math.max(0, tile.poison - 4);
    }
  });
  state.enemy.forEach(tile => {
    if(tile && tile.poison > 0){
      tile.hp -= Math.round(tile.poison * 0.6);
      tile.poison = Math.max(0, tile.poison - 4);
    }
  });
}

function resolveAttacks(){
  const attackerPairs = [];
  state.deck.forEach(tile => {
    if(tile && tile.type === "unit" && tile.hp > 0){
      attackerPairs.push({attacker: tile, defenders: state.enemy});
    }
  });
  state.enemy.forEach(tile => {
    if(tile && tile.type === "unit" && tile.hp > 0){
      attackerPairs.push({attacker: tile, defenders: state.deck});
    }
  });
  attackerPairs.forEach(pair => {
    const {attacker, defenders} = pair;
    if(attacker.stun > 0){
      attacker.stun -= 1;
      return;
    }
    const target = pickTarget(defenders, attacker.priority);
    if(!target) return;
    const base = Math.round(attacker.dmg * attacker.buffs.dmg);
    const dmg = attacker.faction === "Low Colors" && attacker.name === "Gray Lurcher" && target.faction === "Golds"
      ? Math.round(base * 1.35)
      : base;
    fireBeam(attacker, target, "fire");
    target.hp -= dmg;
  });
}

function pickTarget(list, priority){
  const living = list.filter(tile => tile && tile.hp > 0);
  if(!living.length) return null;
  if(priority === "highest"){
    return living.sort((a,b) => b.hp - a.hp)[0];
  }
  if(priority === "lowest"){
    return living.sort((a,b) => a.hp - b.hp)[0];
  }
  if(priority === "golds"){
    const golds = living.filter(t => t.faction === "Golds");
    if(golds.length) return golds[0];
  }
  if(priority === "snipers"){
    const ranged = living.filter(t => t.fireRate >= 1.2);
    if(ranged.length) return ranged[0];
  }
  if(priority === "healers"){
    const healers = living.filter(t => t.ability && t.ability.toLowerCase().includes("heal"));
    if(healers.length) return healers[0];
  }
  return living[Math.floor(Math.random() * living.length)];
}

function pickTargets(list, count){
  return list.filter(t => t && t.hp > 0).slice(0, count);
}

function cleanup(){
  state.deck.forEach((tile, idx) => {
    if(tile && tile.hp <= 0) state.deck[idx] = null;
  });
  state.enemy.forEach((tile, idx) => {
    if(tile && tile.hp <= 0) state.enemy[idx] = null;
  });
}

function resolveRound(){
  if(state.drafting || !state.gameOn) return;
  applyAuras();
  resolveAbilities();
  resolveAttacks();
  resolvePoisons();
  cleanup();
  renderGrid();
  const enemiesLeft = state.enemy.filter(Boolean).length;
  const alliesLeft = state.deck.filter(tile => tile && tile.type === "unit").length;
  if(enemiesLeft === 0){
    log("Enemy wave defeated! Draft new reinforcement.");
    advanceRound();
  } else if(alliesLeft === 0){
    log("Your forces fell. The run restarts.");
    resetGame();
  } else {
    log("Both sides trade fire.");
  }
}

function advanceRound(){
  state.round += 1;
  state.threat *= 1.06;
  state.bossCounter -= 1;
  if(state.bossCounter === 0){
    state.bossCounter = 5;
    log("Boss battle won, the threat escalates.");
  }
  if(state.round % 3 === 0){
    state.regionIndex = (state.regionIndex + 1) % REGION_TABLE.length;
    log(`Entering ${REGION_TABLE[state.regionIndex].name}.`);
  }
  document.getElementById("btnNext").disabled = true;
  showDraft();
}

function fireBeam(attacker, target, kind){
  const attackerEl = document.querySelector(`[data-id="${attacker.id}"]`);
  const targetEl = document.querySelector(`[data-id="${target.id}"]`);
  if(!attackerEl || !targetEl) return;
  const rectA = attackerEl.getBoundingClientRect();
  const rectB = targetEl.getBoundingClientRect();
  const ax = rectA.left + rectA.width / 2;
  const ay = rectA.top + rectA.height / 2;
  const bx = rectB.left + rectB.width / 2;
  const by = rectB.top + rectB.height / 2;
  const dx = bx - ax;
  const dy = by - ay;
  const length = Math.hypot(dx, dy);
  const angle = Math.atan2(dy, dx) * (180 / Math.PI);
  const beam = document.createElement("div");
  beam.className = `beam ${kind}`;
  beam.style.width = `${length}px`;
  beam.style.left = `${ax}px`;
  beam.style.top = `${ay}px`;
  beam.style.transform = `rotate(${angle}deg)`;
  fxLayer.appendChild(beam);
  setTimeout(() => beam.remove(), 520);
  const pulse = document.createElement("div");
  pulse.className = "pulse";
  targetEl.appendChild(pulse);
  setTimeout(() => pulse.remove(), 700);
}

function resetGame(){
  state.round = 1;
  state.threat = 1;
  state.bossCounter = 5;
  state.regionIndex = 0;
  state.deck = Array(GRID_SIZE).fill(null);
  state.enemy = Array(GRID_SIZE).fill(null);
  state.reserve = [];
  state.picksThisPhase = 0;
  state.goldDraftBoost = 0;
  state.gameOn = true;
  logEl.innerHTML = "";
  renderGrid();
  renderReserve();
  showDraft();
}

function showDetail(tile){
  const detailModal = document.getElementById("detailModal");
  const detailBody = document.getElementById("detailBody");
  detailBody.innerHTML = `
    <strong>${tile.name}</strong><br/>
    Faction: ${tile.faction}<br/>
    Rarity: ${tile.rarity.toUpperCase()}<br/>
    Type: ${tile.type}<br/>
    HP: ${tile.hp}/${tile.maxHp}<br/>
    DMG: ${tile.dmg}<br/>
    Fire Rate: ${tile.fireRate}<br/>
    Priority: ${tile.priority}<br/>
    Ability: ${tile.ability || "None"}<br/>
    Status: ${tile.poison ? "Poisoned" : "Clear"}${tile.stun ? " / Stunned" : ""}
  `;
  detailModal.classList.add("active");
}

function toggleDetail(show){
  const detailModal = document.getElementById("detailModal");
  if(!show) detailModal.classList.remove("active");
}

document.getElementById("btnStart").addEventListener("click", () => {
  state.gameOn = true;
  resetGame();
});

document.getElementById("btnNext").addEventListener("click", resolveRound);

document.getElementById("btnReset").addEventListener("click", resetGame);

setupTrash();
renderGrid();
renderReserve();
</script>
</body>
</html>
