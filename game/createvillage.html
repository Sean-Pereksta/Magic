<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üéóÔ∏è Build Your Village</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b1020; --panel:#0f1a33; --glass:rgba(255,255,255,.06);
      --ink:#e6f0ff; --muted:#9db0c4; --line:rgba(255,255,255,.08);
      --accent:#67e8f9; --glow:0 8px 28px rgba(0,0,0,.35), 0 0 32px rgba(103,232,249,.12);
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:20px; font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--ink);
      background: radial-gradient(80vw 80vh at 20% -10%, #0f2346 0%, #0b1020 45%, #090d19 100%);
    }
    .shell{ max-width:1100px; margin:0 auto; display:grid; grid-template-columns: 1fr 280px; gap:18px }
    @media (max-width:900px){ .shell{ grid-template-columns: 1fr } }
    .card{
      background: linear-gradient(180deg, var(--glass), transparent);
      border:1px solid var(--line); border-radius:14px; padding:14px; backdrop-filter: blur(8px);
      box-shadow: var(--glow);
    }
    .header{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px; }
    .title{ font-weight:900; letter-spacing:.3px }
    .idchip{ font-size:12px; color:var(--muted) }

    .grid-wrap{ padding:12px; }
    .grid{ display:grid; grid-template-columns: repeat(16, 30px); gap:2px; justify-content:center; }
    .cell{
      width:30px; height:30px; background:#0a1426; border:1px solid #22314f; border-radius:4px;
      position:relative; overflow:hidden;
      transition: filter .15s ease, border-color .2s ease;
    }
    .cell:hover{ filter: brightness(1.08); border-color:#385182 }

    .structure-icon{
      position:absolute; inset:0; display:grid; place-items:center; pointer-events:none;
      font-size:17px;
    }

    .sidebar .box{ margin-bottom:14px }
    .balance{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px; border:1px solid var(--line); border-radius:12px; background:rgba(255,255,255,.04);
      font-weight:800;
    }
    .power{
      display:grid; grid-template-columns: 1fr 1fr 1fr; gap:6px; text-align:center;
      padding:8px; border:1px solid var(--line); border-radius:12px; background:rgba(255,255,255,.04);
      font-variant-numeric: tabular-nums;
    }
    .power b{ display:block; font-size:16px }
    .power small{ color:var(--muted) }

    .palette{ display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:10px; }
    .tile{
      border:1px solid var(--line); border-radius:10px; background:#0b1831; padding:8px 8px 6px;
      cursor:pointer; text-align:center;
      transition: filter .15s ease, border-color .2s ease, transform .03s ease;
    }
    .tile:hover{ filter:brightness(1.06); border-color:rgba(103,232,249,.35) }
    .tile.active{ outline:2px solid #67e8f9; box-shadow: 0 0 0 2px rgba(103,232,249,.15) inset; }
    .building{ width:30px; height:30px; margin:0 auto 4px; border-radius:6px; border:2px solid #0b1831; }
    .label{ font-size:12px; color:var(--muted) }
    .label b{ color:#eaf2ff }

    .btn{
      appearance:none; border:1px solid var(--line); color:var(--ink);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      padding:10px 14px; border-radius:10px; font-weight:800; cursor:pointer; letter-spacing:.2px;
      transition: transform .03s ease, filter .15s ease, border-color .2s ease;
    }
    .btn:hover{ filter:brightness(1.06); border-color:rgba(103,232,249,.35) }
    .btn:active{ transform: translateY(1px) }
    .btn-primary{ color:#06131a; background: linear-gradient(180deg, #67e8f9, #22d3ee); border:none; }

    /* Colors for preview tiles (backgrounds only; emoji overlay supplies icon) */
    .wall{              background:black }
    .strongWall{        background:orange }
    .archerTower{       background:#ef4444 }
    .trap{              background:#10b981 }
    .lightningStriker{  background:#3b82f6 }
    .troopStructure{    background:#a78bfa }
    .sniperTower{       background:#6b7280 }
    .cannonTower{       background:#6b7280 }
    .necromancerTower{  background:#3b0764 }
    .eraser{            background:#ffffff; position:relative }
    .eraser::after{ content:"‚úñ"; position:absolute; color:black; font-size:16px; top:2px; left:7px }
  </style>
</head>
<body>
  <div class="shell">
    <div class="card">
      <div class="header">
        <div class="title">üéóÔ∏è Build Your Village</div>
        <div id="userLabel" class="idchip">Not logged in</div>
      </div>

      <div class="grid-wrap">
        <div id="villageGrid" class="grid"></div>
      </div>
    </div>

    <div class="sidebar">
      <div class="card box">
        <div class="balance"><span>üí∞ Balance</span><span id="balanceBox">0</span></div>
        <div class="power" id="powerBox">
          <div><small>Attack</small><b id="powAtk">0</b></div>
          <div><small>Defense</small><b id="powDef">0</b></div>
          <div><small>Total</small><b id="powTot">0</b></div>
        </div>
      </div>

      <div class="card box">
        <h3 style="margin:0 0 8px">Build Menu</h3>
        <div id="palette" class="palette"></div>
        <div style="color:#9db0c4; font-size:12px; margin-top:6px">
          Hotkeys: <b>1‚Äì9</b> to select, <b>E</b>/<b>Esc</b> to Erase.
        </div>
      </div>

      <div class="card box" style="display:flex; gap:10px; flex-wrap:wrap">
        <button id="saveBtn" class="btn btn-primary">üìÇ Save Village</button>
        <button id="backLobbyBtn" class="btn">‚üµ Lobby</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    /* ---------- Username via URL or localStorage ---------- */
    const params = new URLSearchParams(location.search);
    let currentUsername = params.get("username") || localStorage.getItem("username") || null;
    if (currentUsername) localStorage.setItem("username", currentUsername);

    let currentBucks = 0;

    const firebaseConfig = {
      apiKey: "AIzaSyB7twY7z31ucB6pGA8JC_HrVMZhA8lNaJA",
      authDomain: "bible-game-246c0.firebaseapp.com",
      projectId: "bible-game-246c0",
      storageBucket: "bible-game-246c0.appspot.com",
      messagingSenderId: "959619818996",
      appId: "1:959619818996:web:9fbf492e23c765e445a1"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    /* ---------- Shared Emoji Map (mirror this in battle) ---------- */
    const STRUCTURE_EMOJI = {
      wall: "üß±",
      strongWall: "üß±",
      archerTower: "üèπ",
      trap: "ü™§",
      lightningStriker: "‚ö°",
      troopStructure: "üè∞",
      sniperTower: "üéØ",
      cannonTower: "üí£",
      necromancerTower: "üíÄ"
    };

    /* ---------- Stats & Palette ---------- */
    const buildingStats = {
      wall:             { attack: 0,  defense: 2, cost: 5  },
      strongWall:       { attack: 0,  defense: 5, cost: 15 },
      archerTower:      { attack: 4,  defense: 1, cost: 25 },
      trap:             { attack: 3,  defense: 3, cost: 20 },
      lightningStriker: { attack: 6,  defense: 1, cost: 20 },
      troopStructure:   { attack: 5,  defense: 2, cost: 20 },
      sniperTower:      { attack: 15, defense: 1, cost: 50 },
      cannonTower:      { attack: 10, defense: 2, cost: 35 },
      necromancerTower: { attack: 7,  defense: 4, cost: 40 }
    };

    const buildingTypes = [
      { type: "wall",             name: "Wall" },
      { type: "strongWall",       name: "Strong Wall" },
      { type: "archerTower",      name: "Archer" },
      { type: "trap",             name: "Trap" },
      { type: "lightningStriker", name: "Lightning" },
      { type: "troopStructure",   name: "Troops" },
      { type: "sniperTower",      name: "Sniper" },
      { type: "cannonTower",      name: "Cannon" },
      { type: "necromancerTower", name: "Necro" },
      { type: "eraser",           name: "Erase" }
    ];

    let selectedType = null;
    const gridSize = 16;
    const gridData = [];

    const gridEl      = document.getElementById("villageGrid");
    const paletteEl   = document.getElementById("palette");
    const userLabelEl = document.getElementById("userLabel");
    const balanceEl   = document.getElementById("balanceBox");
    const powAtkEl    = document.getElementById("powAtk");
    const powDefEl    = document.getElementById("powDef");
    const powTotEl    = document.getElementById("powTot");

    /* ---------- UI Builders ---------- */
    function renderPalette(){
      paletteEl.innerHTML = "";
      buildingTypes.forEach((b, idx) => {
        const tile = document.createElement("div");
        tile.className = "tile";
        tile.dataset.type = b.type;

        const box = document.createElement("div");
        box.className = `building ${b.type}`;
        tile.appendChild(box);

        const label = document.createElement("div");
        label.className = "label";
        if (b.type !== "eraser") {
          const emoji = STRUCTURE_EMOJI[b.type] || "";
          label.innerHTML = `<b>${emoji} ${b.name}</b><br>$${buildingStats[b.type].cost}`;
        } else {
          label.innerHTML = `<b>Erase</b><br><span style="opacity:.6">E / Esc</span>`;
        }
        tile.appendChild(label);

        tile.onclick = () => selectType(b.type);
        paletteEl.appendChild(tile);

        if (idx === 0 && !selectedType) selectType(b.type);
      });
      highlightSelection();
    }

    function selectType(type){
      selectedType = type;
      highlightSelection();
    }
    function highlightSelection(){
      document.querySelectorAll(".tile").forEach(t=>{
        t.classList.toggle("active", t.dataset.type === selectedType);
      });
    }

    function buildGrid(){
      gridEl.innerHTML = "";
      for (let y = 0; y < gridSize; y++){
        for (let x = 0; x < gridSize; x++){
          const cell = document.createElement("div");
          cell.className = "cell";
          cell.dataset.x = x;
          cell.dataset.y = y;
          cell.onclick = () => placeBuilding(cell, x, y);
          gridEl.appendChild(cell);
        }
      }
    }

    /* ---------- Placement / Erase (with emoji overlay) ---------- */
    function placeBuilding(cell, x, y){
      if (!selectedType) return;
      const idx = gridData.findIndex(t => t.x === x && t.y === y);

      if (selectedType === "eraser"){
        if (idx !== -1){
          const removed = gridData[idx];
          const refund  = (buildingStats[removed.type]?.cost ?? 0);
          if (refund > 0) { currentBucks += refund; updateBalance(); }
          gridData.splice(idx, 1);
          paintCell(cell, null); // clear
          updatePowerUI();
        }
        return;
      }

      const cost = buildingStats[selectedType].cost;
      if (currentBucks < cost) {
        alert(`Insufficient bucks. You have ${currentBucks}, need ${cost}.`);
        return;
      }

      currentBucks -= cost;
      updateBalance();

      const tile = { x, y, type: selectedType };
      if (idx !== -1) {
        gridData[idx] = tile;
      } else {
        gridData.push(tile);
      }
      paintCell(cell, selectedType);
      updatePowerUI();
    }

    function paintCell(cell, type){
      cell.className = "cell" + (type ? ` ${type}` : "");
      // wipe old icon
      const old = cell.querySelector(".structure-icon");
      if (old) old.remove();
      if (type){
        const ic = document.createElement("div");
        ic.className = "structure-icon";
        ic.textContent = STRUCTURE_EMOJI[type] || "";
        cell.appendChild(ic);
      }
    }

    function updateBalance(){ balanceEl.textContent = `${currentBucks}`; }
    function calcPower(){
      let atk = 0, def = 0;
      for (const t of gridData){
        const s = buildingStats[t.type];
        if (s) { atk += s.attack; def += s.defense; }
      }
      return { attack: atk, defense: def, total: atk + def };
    }
    function updatePowerUI(){
      const p = calcPower();
      powAtkEl.textContent = p.attack;
      powDefEl.textContent = p.defense;
      powTotEl.textContent = p.total;
    }
    function paintExisting(){
      document.querySelectorAll(".cell").forEach(cell=>{
        const x = +cell.dataset.x, y = +cell.dataset.y;
        const m = gridData.find(t => t.x===x && t.y===y);
        paintCell(cell, m ? m.type : null);
      });
      updatePowerUI();
    }

    /* ---------- Save / Load ---------- */
    async function saveVillage(){
      if (!currentUsername) { alert("No username provided!"); return; }
      const pwd = prompt("Enter your password:"); if (!pwd) return alert("Password required.");

      const uRef  = doc(db, "users", currentUsername);
      const uSnap = await getDoc(uRef);
      if (!uSnap.exists() || uSnap.data().password !== pwd) return alert("Authentication failed.");

      await setDoc(uRef, { bucks: currentBucks }, { merge: true });
      const vRef = doc(db, "villages", currentUsername);
      await setDoc(vRef, { owner: currentUsername, grid: gridData, power: calcPower() });

      alert(`Village saved! Remaining balance: ${currentBucks} bucks.`);
    }

    async function loadInitial(){
      if (!currentUsername){
        userLabelEl.textContent = "Not logged in";
        return;
      }
      userLabelEl.textContent = `Logged in as: ${currentUsername}`;

      const uRef  = doc(db, "users", currentUsername);
      const uSnap = await getDoc(uRef);
      if (!uSnap.exists()) { alert("User record missing!"); return; }

      let stored = uSnap.data().bucks || 0;

      const vRef  = doc(db, "villages", currentUsername);
      const vSnap = await getDoc(vRef);
      if (!vSnap.exists()){
        if (stored === 0){ stored = 200; await setDoc(uRef, { bucks: stored }, { merge: true }); }
      } else {
        gridData.push(...(vSnap.data().grid || []));
        paintExisting();
      }

      currentBucks = stored;
      updateBalance();
      updatePowerUI();
    }

    /* ---------- Nav helper (keeps ?username=) ---------- */
    function goTo(path){
      const qs = currentUsername ? `?username=${encodeURIComponent(currentUsername)}` : "";
      location.href = `${path}${qs}`;
    }

    /* ---------- Hotkeys ---------- */
    function setupHotkeys(){
      const keys = ["wall","strongWall","archerTower","trap","lightningStriker","troopStructure","sniperTower","cannonTower","necromancerTower"];
      document.addEventListener("keydown", (e)=>{
        if (e.key === "Escape" || e.key.toLowerCase() === "e") { selectType("eraser"); return; }
        const n = parseInt(e.key,10);
        if (!isNaN(n) && n>=1 && n<=keys.length){ selectType(keys[n-1]); }
      });
    }

    /* ---------- Boot ---------- */
    document.addEventListener("DOMContentLoaded", ()=>{
      buildGrid();
      renderPalette();
      loadInitial();
      setupHotkeys();

      document.getElementById("saveBtn").onclick = saveVillage;
      document.getElementById("backLobbyBtn").onclick = () => goTo("/game/villagelobby.html");
    });
  </script>
</body>
</html>



